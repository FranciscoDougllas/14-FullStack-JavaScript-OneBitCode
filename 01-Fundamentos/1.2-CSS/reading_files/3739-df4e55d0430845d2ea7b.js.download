(self.webpackChunkcircle=self.webpackChunkcircle||[]).push([[3739],{84895:(e,t,i)=>{"use strict";i.d(t,{uM:()=>ci,Xp:()=>Ni,a5:()=>Bt,Vy:()=>Oi,pE:()=>ll,MQ:()=>Cs,eC:()=>ni,hE:()=>Jr,vX:()=>er,PJ:()=>fr,Yt:()=>mr,g:()=>yr,Ag:()=>la,ln:()=>Hn,K0:()=>cr,uX:()=>tr,fC:()=>va,VP:()=>nr,m$:()=>sr,IX:()=>pa,xn:()=>Zr,YC:()=>Xr,ud:()=>ar,UP:()=>Jn,I3:()=>zn,Fd:()=>Yn,VM:()=>Kr,cH:()=>oa,pk:()=>rr,BK:()=>qn,Go:()=>gr,lj:()=>ca,K6:()=>Qr,Dl:()=>Wn,zK:()=>$n,GP:()=>Wr});var s={};i.r(s),i.d(s,{fixNegotiationNeeded:()=>O,shimAddTrackRemoveTrack:()=>M,shimAddTrackRemoveTrackWithNative:()=>D,shimGetDisplayMedia:()=>w,shimGetSendersWithDtmf:()=>R,shimGetStats:()=>_,shimGetUserMedia:()=>C,shimMediaStream:()=>I,shimOnTrack:()=>A,shimPeerConnection:()=>N,shimSenderReceiverGetStats:()=>L});var n={};i.r(n),i.d(n,{shimAddTransceiver:()=>W,shimCreateAnswer:()=>K,shimCreateOffer:()=>q,shimGetDisplayMedia:()=>U,shimGetParameters:()=>H,shimGetUserMedia:()=>x,shimOnTrack:()=>B,shimPeerConnection:()=>F,shimRTCDataChannel:()=>V,shimReceiverGetStats:()=>$,shimRemoveStream:()=>j,shimSenderGetStats:()=>G});var r={};i.r(r),i.d(r,{shimAudioContext:()=>ie,shimCallbacksAPI:()=>Q,shimConstraints:()=>Z,shimCreateOfferLegacy:()=>te,shimGetUserMedia:()=>Y,shimLocalStreamsAPI:()=>J,shimRTCIceServerUrls:()=>X,shimRemoteStreamsAPI:()=>z,shimTrackEventTransceiver:()=>ee});var a={};i.r(a),i.d(a,{removeExtmapAllowMixed:()=>ce,shimAddIceCandidateNullOrEmpty:()=>ue,shimConnectionState:()=>de,shimMaxMessageSize:()=>oe,shimParameterlessSetLocalDescription:()=>he,shimRTCIceCandidate:()=>re,shimRTCIceCandidateRelayProtocol:()=>ae,shimSendThrowTypeError:()=>le});var o=i(22222),l=i(20531),d=i(44586),c=i(72307),u=i.n(c);let h=!0,p=!0;function v(e,t,i){const s=e.match(t);return s&&s.length>=i&&parseInt(s[i],10)}function g(e,t,i){if(!e.RTCPeerConnection)return;const s=e.RTCPeerConnection.prototype,n=s.addEventListener;s.addEventListener=function(e,s){if(e!==t)return n.apply(this,arguments);const r=e=>{const t=i(e);t&&(s.handleEvent?s.handleEvent(t):s(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(s,r),n.apply(this,[e,r])};const r=s.removeEventListener;s.removeEventListener=function(e,i){if(e!==t||!this._eventMap||!this._eventMap[t])return r.apply(this,arguments);if(!this._eventMap[t].has(i))return r.apply(this,arguments);const s=this._eventMap[t].get(i);return this._eventMap[t].delete(i),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,r.apply(this,[e,s])},Object.defineProperty(s,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function m(e){return"boolean"!==typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(h=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function f(e){return"boolean"!==typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(p=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function y(){if("object"===typeof window){if(h)return;"undefined"!==typeof console&&"function"===typeof console.log&&console.log.apply(console,arguments)}}function k(e,t){p&&console.warn(e+" is deprecated, please use "+t+" instead.")}function T(e){return"[object Object]"===Object.prototype.toString.call(e)}function b(e){return T(e)?Object.keys(e).reduce((function(t,i){const s=T(e[i]),n=s?b(e[i]):e[i],r=s&&!Object.keys(n).length;return void 0===n||r?t:Object.assign(t,{[i]:n})}),{}):e}function S(e,t,i){t&&!i.has(t.id)&&(i.set(t.id,t),Object.keys(t).forEach((s=>{s.endsWith("Id")?S(e,e.get(t[s]),i):s.endsWith("Ids")&&t[s].forEach((t=>{S(e,e.get(t),i)}))})))}function P(e,t,i){const s=i?"outbound-rtp":"inbound-rtp",n=new Map;if(null===t)return n;const r=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&r.push(e)})),r.forEach((t=>{e.forEach((i=>{i.type===s&&i.trackId===t.id&&S(e,i,n)}))})),n}const E=y;function C(e,t){const i=e&&e.navigator;if(!i.mediaDevices)return;const s=function(e){if("object"!==typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((i=>{if("require"===i||"advanced"===i||"mediaSource"===i)return;const s="object"===typeof e[i]?e[i]:{ideal:e[i]};void 0!==s.exact&&"number"===typeof s.exact&&(s.min=s.max=s.exact);const n=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==s.ideal){t.optional=t.optional||[];let e={};"number"===typeof s.ideal?(e[n("min",i)]=s.ideal,t.optional.push(e),e={},e[n("max",i)]=s.ideal,t.optional.push(e)):(e[n("",i)]=s.ideal,t.optional.push(e))}void 0!==s.exact&&"number"!==typeof s.exact?(t.mandatory=t.mandatory||{},t.mandatory[n("",i)]=s.exact):["min","max"].forEach((e=>{void 0!==s[e]&&(t.mandatory=t.mandatory||{},t.mandatory[n(e,i)]=s[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},n=function(e,n){if(t.version>=61)return n(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"===typeof e.audio){const t=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=s(e.audio)}if(e&&"object"===typeof e.video){let r=e.video.facingMode;r=r&&("object"===typeof r?r:{ideal:r});const a=t.version<66;if(r&&("user"===r.exact||"environment"===r.exact||"user"===r.ideal||"environment"===r.ideal)&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||a)){let t;if(delete e.video.facingMode,"environment"===r.exact||"environment"===r.ideal?t=["back","rear"]:"user"!==r.exact&&"user"!==r.ideal||(t=["front"]),t)return i.mediaDevices.enumerateDevices().then((i=>{i=i.filter((e=>"videoinput"===e.kind));let a=i.find((e=>t.some((t=>e.label.toLowerCase().includes(t)))));return!a&&i.length&&t.includes("back")&&(a=i[i.length-1]),a&&(e.video.deviceId=r.exact?{exact:a.deviceId}:{ideal:a.deviceId}),e.video=s(e.video),E("chrome: "+JSON.stringify(e)),n(e)}))}e.video=s(e.video)}return E("chrome: "+JSON.stringify(e)),n(e)},r=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=function(e,t,s){n(e,(e=>{i.webkitGetUserMedia(e,t,(e=>{s&&s(r(e))}))}))}.bind(i),i.mediaDevices.getUserMedia){const e=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(t){return n(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(r(e))))))}}}function w(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"===typeof t?e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then((t=>{const s=i.video&&i.video.width,n=i.video&&i.video.height,r=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:r||3}},s&&(i.video.mandatory.maxWidth=s),n&&(i.video.mandatory.maxHeight=n),e.navigator.mediaDevices.getUserMedia(i)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}function I(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function A(e){if("object"===typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(i=>{let s;s=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.track.id)):{track:i.track};const n=new Event("track");n.track=i.track,n.receiver=s,n.transceiver={receiver:s},n.streams=[t.stream],this.dispatchEvent(n)})),t.stream.getTracks().forEach((i=>{let s;s=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.id)):{track:i};const n=new Event("track");n.track=i,n.receiver=s,n.transceiver={receiver:s},n.streams=[t.stream],this.dispatchEvent(n)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else g(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function R(e){if("object"===typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,s){let n=i.apply(this,arguments);return n||(n=t(this,e),this._senders.push(n)),n};const s=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){s.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const s=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],s.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"===typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function _(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,s]=arguments;if(arguments.length>0&&"function"===typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!==typeof e))return t.apply(this,[]);const n=function(e){const t={};return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{i[t]=e.stat(t)})),t[i.id]=i})),t},r=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const s=function(e){i(r(n(e)))};return t.apply(this,[s,e])}return new Promise(((e,i)=>{t.apply(this,[function(t){e(r(n(t)))},i])})).then(i,s)}}function L(e){if(!("object"===typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>P(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),g(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>P(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,i,s;return this.getSenders().forEach((i=>{i.track===e&&(t?s=!0:t=i)})),this.getReceivers().forEach((t=>(t.track===e&&(i?s=!0:i=t),t.track===e))),s||t&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function D(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){if(!i)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const s=t.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(s)&&this._shimmedLocalStreams[i.id].push(s):this._shimmedLocalStreams[i.id]=[i,s],s};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{const t=this.getSenders().find((t=>t.track===e));if(t)throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();i.apply(this,arguments);const s=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(s)};const s=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],s.apply(this,arguments)};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const i=this._shimmedLocalStreams[t].indexOf(e);-1!==i&&this._shimmedLocalStreams[t].splice(i,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),n.apply(this,arguments)}}function M(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return D(e);const i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=i.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const s=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{const t=this.getSenders().find((t=>t.track===e));if(t)throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const i=new e.MediaStream(t.getTracks());this._streams[t.id]=i,this._reverseStreams[i.id]=t,t=i}s.apply(this,[t])};const n=e.RTCPeerConnection.prototype.removeStream;function r(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const s=e._reverseStreams[t],n=e._streams[s.id];i=i.replace(new RegExp(n.id,"g"),s.id)})),new RTCSessionDescription({type:t.type,sdp:i})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},n.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,i){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const s=[].slice.call(arguments,1);if(1!==s.length||!s[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const n=this.getSenders().find((e=>e.track===t));if(n)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const r=this._streams[i.id];if(r)r.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const s=new e.MediaStream([t]);this._streams[i.id]=s,this._reverseStreams[s.id]=i,this.addStream(s)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],s={[t](){const e=arguments;return arguments.length&&"function"===typeof arguments[0]?i.apply(this,[t=>{const i=r(this,t);e[0].apply(null,[i])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):i.apply(this,arguments).then((e=>r(this,e)))}};e.RTCPeerConnection.prototype[t]=s[t]}));const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const s=e._reverseStreams[t],n=e._streams[s.id];i=i.replace(new RegExp(s.id,"g"),n.id)})),new RTCSessionDescription({type:t.type,sdp:i})}(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const o=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=o.get.apply(this);return""===e.type?e:r(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((i=>{this._streams[i].getTracks().find((t=>e.track===t))&&(t=this._streams[i])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function N(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],s={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=s[t]}))}function O(e,t){g(e,"negotiationneeded",(e=>{const i=e.target;if(!(t.version<72||i.getConfiguration&&"plan-b"===i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return e}))}function x(e,t){const i=e&&e.navigator,s=e&&e.MediaStreamTrack;if(i.getUserMedia=function(e,t,s){k("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(e).then(t,s)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const e=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])},t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(i){return"object"===typeof i&&"object"===typeof i.audio&&(i=JSON.parse(JSON.stringify(i)),e(i.audio,"autoGainControl","mozAutoGainControl"),e(i.audio,"noiseSuppression","mozNoiseSuppression")),t(i)},s&&s.prototype.getSettings){const t=s.prototype.getSettings;s.prototype.getSettings=function(){const i=t.apply(this,arguments);return e(i,"mozAutoGainControl","autoGainControl"),e(i,"mozNoiseSuppression","noiseSuppression"),i}}if(s&&s.prototype.applyConstraints){const t=s.prototype.applyConstraints;s.prototype.applyConstraints=function(i){return"audio"===this.kind&&"object"===typeof i&&(i=JSON.parse(JSON.stringify(i)),e(i,"autoGainControl","mozAutoGainControl"),e(i,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[i])}}}}function U(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===i.video?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)})}function B(e){"object"===typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function F(e,t){if("object"!==typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],s={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=s[t]}));const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},s=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,n,r]=arguments;return s.apply(this,[e||null]).then((e=>{if(t.version<53&&!n)try{e.forEach((e=>{e.type=i[e.type]||e.type}))}catch(s){if("TypeError"!==s.name)throw s;e.forEach(((t,s)=>{e.set(s,Object.assign({},t,{type:i[t.type]||t.type}))}))}return e})).then(n,r)}}function G(e){if("object"!==typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function $(e){if("object"!==typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),g(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function j(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){k("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function V(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function W(e){if("object"!==typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let e=arguments[1]&&arguments[1].sendEncodings;void 0===e&&(e=[]),e=[...e];const i=e.length>0;i&&e.forEach((e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const s=t.apply(this,arguments);if(i){const{sender:t}=s,i=t.getParameters();(!("encodings"in i)||1===i.encodings.length&&0===Object.keys(i.encodings[0]).length)&&(i.encodings=e,t.sendEncodings=e,this.setParametersPromises.push(t.setParameters(i).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return s})}function H(e){if("object"!==typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function q(e){if("object"!==typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function K(e){if("object"!==typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function J(e){if("object"===typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((i=>t.call(this,i,e))),e.getVideoTracks().forEach((i=>t.call(this,i,e)))},e.RTCPeerConnection.prototype.addTrack=function(e,...i){return i&&i.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const i=e.getTracks();this.getSenders().forEach((e=>{i.includes(e.track)&&this.removeTrack(e)}))})}}function z(e){if("object"===typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const i=new Event("addstream");i.stream=t,e.dispatchEvent(i)}))}),t.apply(e,arguments)}}}function Q(e){if("object"!==typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,i=t.createOffer,s=t.createAnswer,n=t.setLocalDescription,r=t.setRemoteDescription,a=t.addIceCandidate;t.createOffer=function(e,t){const s=arguments.length>=2?arguments[2]:arguments[0],n=i.apply(this,[s]);return t?(n.then(e,t),Promise.resolve()):n},t.createAnswer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],n=s.apply(this,[i]);return t?(n.then(e,t),Promise.resolve()):n};let o=function(e,t,i){const s=n.apply(this,[e]);return i?(s.then(t,i),Promise.resolve()):s};t.setLocalDescription=o,o=function(e,t,i){const s=r.apply(this,[e]);return i?(s.then(t,i),Promise.resolve()):s},t.setRemoteDescription=o,o=function(e,t,i){const s=a.apply(this,[e]);return i?(s.then(t,i),Promise.resolve()):s},t.addIceCandidate=o}function Y(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>i(Z(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,i,s){t.mediaDevices.getUserMedia(e).then(i,s)}.bind(t))}function Z(e){return e&&void 0!==e.video?Object.assign({},e,{video:b(e.video)}):e}function X(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){const t=[];for(let i=0;i<e.iceServers.length;i++){let s=e.iceServers[i];void 0===s.urls&&s.url?(k("RTCIceServer.url","RTCIceServer.urls"),s=JSON.parse(JSON.stringify(s)),s.urls=s.url,delete s.url,t.push(s)):t.push(e.iceServers[i])}e.iceServers=t}return new t(e,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function ee(e){"object"===typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function te(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){"undefined"!==typeof e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio",{direction:"recvonly"}),"undefined"!==typeof e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const i=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveVideo||i||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function ie(e){"object"!==typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var se=i(57539),ne=i.n(se);function re(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"===typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substring(2)),e.candidate&&e.candidate.length){const i=new t(e),s=ne().parseCandidate(e.candidate);for(const e in s)e in i||Object.defineProperty(i,e,{value:s[e]});return i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}},i}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,g(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function ae(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||g(e,"icecandidate",(e=>{if(e.candidate){const t=ne().parseCandidate(e.candidate.candidate);"relay"===t.type&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e}))}function oe(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return"undefined"===typeof this._sctp?null:this._sctp}});const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return"undefined"===typeof this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(function(e){if(!e||!e.sdp)return!1;const t=ne().splitSections(e.sdp);return t.shift(),t.some((e=>{const t=ne().parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))}(arguments[0])){const e=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const i=parseInt(t[1],10);return i!==i?-1:i}(arguments[0]),i=function(e){let i=65536;return"firefox"===t.browser&&(i=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),i}(e),s=function(e,i){let s=65536;"firefox"===t.browser&&57===t.version&&(s=65535);const n=ne().matchPrefix(e.sdp,"a=max-message-size:");return n.length>0?s=parseInt(n[0].substring(19),10):"firefox"===t.browser&&-1!==i&&(s=2147483637),s}(arguments[0],e);let n;n=0===i&&0===s?Number.POSITIVE_INFINITY:0===i||0===s?Math.max(i,s):Math.min(i,s);const r={};Object.defineProperty(r,"maxMessageSize",{get:()=>n}),this._sctp=r}return i.apply(this,arguments)}}function le(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const i=e.send;e.send=function(){const s=arguments[0],n=s.length||s.size||s.byteLength;if("open"===e.readyState&&t.sctp&&n>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return i.apply(e,arguments)}}const i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=i.apply(this,arguments);return t(e,this),e},g(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function de(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const i=new Event("connectionstatechange",e);t.dispatchEvent(i)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}}))}function ce(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const i=t.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:i}):t.sdp=i}return i.apply(this,arguments)}}function ue(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.addIceCandidate;i&&0!==i.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function he(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.setLocalDescription;i&&0!==i.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!==typeof e||e.type&&e.sdp)return i.apply(this,arguments);if(e={type:e.type,sdp:e.sdp},!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer"}if(e.sdp||"offer"!==e.type&&"answer"!==e.type)return i.apply(this,[e]);return("offer"===e.type?this.createOffer:this.createAnswer).apply(this).then((e=>i.apply(this,[e])))})}const pe=function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){const i=y,o=function(e){const t={browser:null,version:null};if("undefined"===typeof e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:i}=e;if(i.mozGetUserMedia)t.browser="firefox",t.version=v(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection)t.browser="chrome",t.version=v(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!e.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=v(i.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}(e),l={browserDetails:o,commonShim:a,extractVersion:v,disableLog:m,disableWarnings:f,sdp:se};switch(o.browser){case"chrome":if(!s||!N||!t.shimChrome)return i("Chrome shim is not included in this adapter release."),l;if(null===o.version)return i("Chrome shim can not determine version, not shimming."),l;i("adapter.js shimming chrome."),l.browserShim=s,ue(e,o),he(e),C(e,o),I(e),N(e,o),A(e),M(e,o),R(e),_(e),L(e),O(e,o),re(e),ae(e),de(e),oe(e,o),le(e),ce(e,o);break;case"firefox":if(!n||!F||!t.shimFirefox)return i("Firefox shim is not included in this adapter release."),l;i("adapter.js shimming firefox."),l.browserShim=n,ue(e,o),he(e),x(e,o),F(e,o),B(e),j(e),G(e),$(e),V(e),W(e),H(e),q(e),K(e),re(e),de(e),oe(e,o),le(e);break;case"safari":if(!r||!t.shimSafari)return i("Safari shim is not included in this adapter release."),l;i("adapter.js shimming safari."),l.browserShim=r,ue(e,o),he(e),X(e),te(e),Q(e),J(e),z(e),ee(e),Y(e),ie(e),re(e),ae(e),oe(e,o),le(e),ce(e,o);break;default:i("Unsupported browser!")}return l}({window:"undefined"===typeof window?void 0:window}),ve=pe;var ge=i(56387),me=i.n(ge);function fe(e){for(var t=arguments.length,i=Array(t>1?t-1:0),s=1;s<t;s++)i[s-1]=arguments[s];throw Error("[Immer] minified error nr: "+e+(i.length?" "+i.map((function(e){return"'"+e+"'"})).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function ye(e){return!!e&&!!e[rt]}function ke(e){var t;return!!e&&(function(e){if(!e||"object"!=typeof e)return!1;var t=Object.getPrototypeOf(e);if(null===t)return!0;var i=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;return i===Object||"function"==typeof i&&Function.toString.call(i)===at}(e)||Array.isArray(e)||!!e[nt]||!!(null===(t=e.constructor)||void 0===t?void 0:t[nt])||we(e)||Ie(e))}function Te(e,t,i){void 0===i&&(i=!1),0===be(e)?(i?Object.keys:ot)(e).forEach((function(s){i&&"symbol"==typeof s||t(s,e[s],e)})):e.forEach((function(i,s){return t(s,i,e)}))}function be(e){var t=e[rt];return t?t.i>3?t.i-4:t.i:Array.isArray(e)?1:we(e)?2:Ie(e)?3:0}function Se(e,t){return 2===be(e)?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function Pe(e,t){return 2===be(e)?e.get(t):e[t]}function Ee(e,t,i){var s=be(e);2===s?e.set(t,i):3===s?e.add(i):e[t]=i}function Ce(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}function we(e){return et&&e instanceof Map}function Ie(e){return tt&&e instanceof Set}function Ae(e){return e.o||e.t}function Re(e){if(Array.isArray(e))return Array.prototype.slice.call(e);var t=lt(e);delete t[rt];for(var i=ot(t),s=0;s<i.length;s++){var n=i[s],r=t[n];!1===r.writable&&(r.writable=!0,r.configurable=!0),(r.get||r.set)&&(t[n]={configurable:!0,writable:!0,enumerable:r.enumerable,value:e[n]})}return Object.create(Object.getPrototypeOf(e),t)}function _e(e,t){return void 0===t&&(t=!1),De(e)||ye(e)||!ke(e)||(be(e)>1&&(e.set=e.add=e.clear=e.delete=Le),Object.freeze(e),t&&Te(e,(function(e,t){return _e(t,!0)}),!0)),e}function Le(){fe(2)}function De(e){return null==e||"object"!=typeof e||Object.isFrozen(e)}function Me(e){var t=dt[e];return t||fe(18,e),t}function Ne(){return Ze}function Oe(e,t){t&&(Me("Patches"),e.u=[],e.s=[],e.v=t)}function xe(e){Ue(e),e.p.forEach(Fe),e.p=null}function Ue(e){e===Ze&&(Ze=e.l)}function Be(e){return Ze={p:[],l:Ze,h:e,m:!0,_:0}}function Fe(e){var t=e[rt];0===t.i||1===t.i?t.j():t.g=!0}function Ge(e,t){t._=t.p.length;var i=t.p[0],s=void 0!==e&&e!==i;return t.h.O||Me("ES5").S(t,e,s),s?(i[rt].P&&(xe(t),fe(4)),ke(e)&&(e=$e(t,e),t.l||Ve(t,e)),t.u&&Me("Patches").M(i[rt].t,e,t.u,t.s)):e=$e(t,i,[]),xe(t),t.u&&t.v(t.u,t.s),e!==st?e:void 0}function $e(e,t,i){if(De(t))return t;var s=t[rt];if(!s)return Te(t,(function(n,r){return je(e,s,t,n,r,i)}),!0),t;if(s.A!==e)return t;if(!s.P)return Ve(e,s.t,!0),s.t;if(!s.I){s.I=!0,s.A._--;var n=4===s.i||5===s.i?s.o=Re(s.k):s.o,r=n,a=!1;3===s.i&&(r=new Set(n),n.clear(),a=!0),Te(r,(function(t,r){return je(e,s,n,t,r,i,a)})),Ve(e,n,!1),i&&e.u&&Me("Patches").N(s,i,e.u,e.s)}return s.o}function je(e,t,i,s,n,r,a){if(ye(n)){var o=$e(e,n,r&&t&&3!==t.i&&!Se(t.R,s)?r.concat(s):void 0);if(Ee(i,s,o),!ye(o))return;e.m=!1}else a&&i.add(n);if(ke(n)&&!De(n)){if(!e.h.D&&e._<1)return;$e(e,n),t&&t.A.l||Ve(e,n)}}function Ve(e,t,i){void 0===i&&(i=!1),!e.l&&e.h.D&&e.m&&_e(t,i)}function We(e,t){var i=e[rt];return(i?Ae(i):e)[t]}function He(e,t){if(t in e)for(var i=Object.getPrototypeOf(e);i;){var s=Object.getOwnPropertyDescriptor(i,t);if(s)return s;i=Object.getPrototypeOf(i)}}function qe(e){e.P||(e.P=!0,e.l&&qe(e.l))}function Ke(e){e.o||(e.o=Re(e.t))}function Je(e,t,i){var s=we(t)?Me("MapSet").F(t,i):Ie(t)?Me("MapSet").T(t,i):e.O?function(e,t){var i=Array.isArray(e),s={i:i?1:0,A:t?t.A:Ne(),P:!1,I:!1,R:{},l:t,t:e,k:null,o:null,j:null,C:!1},n=s,r=ct;i&&(n=[s],r=ut);var a=Proxy.revocable(n,r),o=a.revoke,l=a.proxy;return s.k=l,s.j=o,l}(t,i):Me("ES5").J(t,i);return(i?i.A:Ne()).p.push(s),s}function ze(e){return ye(e)||fe(22,e),function e(t){if(!ke(t))return t;var i,s=t[rt],n=be(t);if(s){if(!s.P&&(s.i<4||!Me("ES5").K(s)))return s.t;s.I=!0,i=Qe(t,n),s.I=!1}else i=Qe(t,n);return Te(i,(function(t,n){s&&Pe(s.t,t)===n||Ee(i,t,e(n))})),3===n?new Set(i):i}(e)}function Qe(e,t){switch(t){case 2:return new Map(e);case 3:return Array.from(e)}return Re(e)}var Ye,Ze,Xe="undefined"!=typeof Symbol&&"symbol"==typeof Symbol("x"),et="undefined"!=typeof Map,tt="undefined"!=typeof Set,it="undefined"!=typeof Proxy&&void 0!==Proxy.revocable&&"undefined"!=typeof Reflect,st=Xe?Symbol.for("immer-nothing"):((Ye={})["immer-nothing"]=!0,Ye),nt=Xe?Symbol.for("immer-draftable"):"__$immer_draftable",rt=Xe?Symbol.for("immer-state"):"__$immer_state",at=("undefined"!=typeof Symbol&&Symbol.iterator,""+Object.prototype.constructor),ot="undefined"!=typeof Reflect&&Reflect.ownKeys?Reflect.ownKeys:void 0!==Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Object.getOwnPropertyNames,lt=Object.getOwnPropertyDescriptors||function(e){var t={};return ot(e).forEach((function(i){t[i]=Object.getOwnPropertyDescriptor(e,i)})),t},dt={},ct={get:function(e,t){if(t===rt)return e;var i=Ae(e);if(!Se(i,t))return function(e,t,i){var s,n=He(t,i);return n?"value"in n?n.value:null===(s=n.get)||void 0===s?void 0:s.call(e.k):void 0}(e,i,t);var s=i[t];return e.I||!ke(s)?s:s===We(e.t,t)?(Ke(e),e.o[t]=Je(e.A.h,s,e)):s},has:function(e,t){return t in Ae(e)},ownKeys:function(e){return Reflect.ownKeys(Ae(e))},set:function(e,t,i){var s=He(Ae(e),t);if(null==s?void 0:s.set)return s.set.call(e.k,i),!0;if(!e.P){var n=We(Ae(e),t),r=null==n?void 0:n[rt];if(r&&r.t===i)return e.o[t]=i,e.R[t]=!1,!0;if(Ce(i,n)&&(void 0!==i||Se(e.t,t)))return!0;Ke(e),qe(e)}return e.o[t]===i&&(void 0!==i||t in e.o)||Number.isNaN(i)&&Number.isNaN(e.o[t])||(e.o[t]=i,e.R[t]=!0),!0},deleteProperty:function(e,t){return void 0!==We(e.t,t)||t in e.t?(e.R[t]=!1,Ke(e),qe(e)):delete e.R[t],e.o&&delete e.o[t],!0},getOwnPropertyDescriptor:function(e,t){var i=Ae(e),s=Reflect.getOwnPropertyDescriptor(i,t);return s?{writable:!0,configurable:1!==e.i||"length"!==t,enumerable:s.enumerable,value:i[t]}:s},defineProperty:function(){fe(11)},getPrototypeOf:function(e){return Object.getPrototypeOf(e.t)},setPrototypeOf:function(){fe(12)}},ut={};Te(ct,(function(e,t){ut[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}})),ut.deleteProperty=function(e,t){return ut.set.call(this,e,t,void 0)},ut.set=function(e,t,i){return ct.set.call(this,e[0],t,i,e[0])};var ht=function(){function e(e){var t=this;this.O=it,this.D=!0,this.produce=function(e,i,s){if("function"==typeof e&&"function"!=typeof i){var n=i;i=e;var r=t;return function(e){var t=this;void 0===e&&(e=n);for(var s=arguments.length,a=Array(s>1?s-1:0),o=1;o<s;o++)a[o-1]=arguments[o];return r.produce(e,(function(e){var s;return(s=i).call.apply(s,[t,e].concat(a))}))}}var a;if("function"!=typeof i&&fe(6),void 0!==s&&"function"!=typeof s&&fe(7),ke(e)){var o=Be(t),l=Je(t,e,void 0),d=!0;try{a=i(l),d=!1}finally{d?xe(o):Ue(o)}return"undefined"!=typeof Promise&&a instanceof Promise?a.then((function(e){return Oe(o,s),Ge(e,o)}),(function(e){throw xe(o),e})):(Oe(o,s),Ge(a,o))}if(!e||"object"!=typeof e){if(void 0===(a=i(e))&&(a=e),a===st&&(a=void 0),t.D&&_e(a,!0),s){var c=[],u=[];Me("Patches").M(e,a,c,u),s(c,u)}return a}fe(21,e)},this.produceWithPatches=function(e,i){if("function"==typeof e)return function(i){for(var s=arguments.length,n=Array(s>1?s-1:0),r=1;r<s;r++)n[r-1]=arguments[r];return t.produceWithPatches(i,(function(t){return e.apply(void 0,[t].concat(n))}))};var s,n,r=t.produce(e,i,(function(e,t){s=e,n=t}));return"undefined"!=typeof Promise&&r instanceof Promise?r.then((function(e){return[e,s,n]})):[r,s,n]},"boolean"==typeof(null==e?void 0:e.useProxies)&&this.setUseProxies(e.useProxies),"boolean"==typeof(null==e?void 0:e.autoFreeze)&&this.setAutoFreeze(e.autoFreeze)}var t=e.prototype;return t.createDraft=function(e){ke(e)||fe(8),ye(e)&&(e=ze(e));var t=Be(this),i=Je(this,e,void 0);return i[rt].C=!0,Ue(t),i},t.finishDraft=function(e,t){var i=(e&&e[rt]).A;return Oe(i,t),Ge(void 0,i)},t.setAutoFreeze=function(e){this.D=e},t.setUseProxies=function(e){e&&!it&&fe(20),this.O=e},t.applyPatches=function(e,t){var i;for(i=t.length-1;i>=0;i--){var s=t[i];if(0===s.path.length&&"replace"===s.op){e=s.value;break}}i>-1&&(t=t.slice(i+1));var n=Me("Patches").$;return ye(e)?n(e,t):this.produce(e,(function(e){return n(e,t)}))},e}(),pt=new ht,vt=pt.produce;pt.produceWithPatches.bind(pt),pt.setAutoFreeze.bind(pt),pt.setUseProxies.bind(pt),pt.applyPatches.bind(pt),pt.createDraft.bind(pt),pt.finishDraft.bind(pt);const gt=function(e,t){if(Object.is(e,t))return!0;if("object"!==typeof e||null===e||"object"!==typeof t||null===t)return!1;const i=Object.keys(e);if(i.length!==Object.keys(t).length)return!1;for(let s=0;s<i.length;s++)if(!Object.prototype.hasOwnProperty.call(t,i[s])||!Object.is(e[i[s]],t[i[s]]))return!1;return!0};const mt=function(e){let t;const i=new Set,s=(e,s)=>{const n="function"===typeof e?e(t):e;if(n!==t){const e=t;t=s?n:Object.assign({},t,n),i.forEach((i=>i(t,e)))}},n=()=>t,r={setState:s,getState:n,subscribe:(e,s,r)=>s||r?((e,s=n,r=Object.is)=>{let a=s(t);function o(){const i=s(t);if(!r(a,i)){const t=a;e(a=i,t)}}return i.add(o),()=>i.delete(o)})(e,s,r):(i.add(e),()=>i.delete(e)),destroy:()=>i.clear()};return t=e(s,n,r),r};var ft=i(70766),yt=Object.defineProperty,kt=Object.defineProperties,Tt=Object.getOwnPropertyDescriptors,bt=Object.getOwnPropertySymbols,St=Object.getPrototypeOf,Pt=Object.prototype.hasOwnProperty,Et=Object.prototype.propertyIsEnumerable,Ct=Reflect.get,wt=(e,t,i)=>t in e?yt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,It=(e,t)=>{for(var i in t||(t={}))Pt.call(t,i)&&wt(e,i,t[i]);if(bt)for(var i of bt(t))Et.call(t,i)&&wt(e,i,t[i]);return e},At=(e,t)=>kt(e,Tt(t)),Rt=(e,t)=>{var i={};for(var s in e)Pt.call(e,s)&&t.indexOf(s)<0&&(i[s]=e[s]);if(null!=e&&bt)for(var s of bt(e))t.indexOf(s)<0&&Et.call(e,s)&&(i[s]=e[s]);return i},_t=(e,t,i)=>Ct(St(e),i,t),Lt=(e,t,i)=>new Promise(((s,n)=>{var r=e=>{try{o(i.next(e))}catch(Se){n(Se)}},a=e=>{try{o(i.throw(e))}catch(Se){n(Se)}},o=e=>e.done?s(e.value):Promise.resolve(e.value).then(r,a);o((i=i.apply(e,t)).next())})),Dt=((e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports))(((e,t)=>{t.exports={version:"0.12.23",license:"MIT",repository:{type:"git",url:"https://github.com/100mslive/web-sdks.git",directory:"packages/hms-video-store"},main:"dist/index.cjs.js",module:"dist/index.js",typings:"dist/index.d.ts",files:["dist","src"],engines:{node:">=12"},exports:{".":{require:"./dist/index.cjs.js",import:"./dist/index.js",default:"./dist/index.js"}},sideEffects:!1,scripts:{prestart:"rm -rf dist && yarn types:build",start:'concurrently "yarn dev" "yarn types"',dev:"node ../../scripts/dev","build:only":"node ../../scripts/build",build:"yarn build:only && yarn types:build",types:"tsc -w","types:build":"tsc -p tsconfig.json",format:"prettier --write src/**/*.ts",test:"jest --maxWorkers=1","test:watch":"jest --watch","test:coverage":"jest --coverage",lint:"eslint -c ../../.eslintrc .","lint:fix":"yarn lint --fix",prepare:"yarn build",size:"size-limit",analyze:"size-limit --why",docs:"rm -rf ./docs && typedoc && rm -f ./docs/README.md && mkdir ./docs/home &&mv ./docs/modules.md ./docs/home/content.md && node ../../scripts/docs-store && npx prettier --write './docs/**/*'"},name:"@100mslive/hms-video-store",author:"100ms",dependencies:{eventemitter2:"^6.4.9",immer:"^9.0.6","lodash.isequal":"^4.5.0",reselect:"4.0.0","sdp-transform":"^2.14.1","ua-parser-js":"^1.0.1",uuid:"^8.3.2","webrtc-adapter":"^8.0.0",zustand:"3.5.7"},devDependencies:{"@types/dom-screen-wake-lock":"^1.0.1","@types/lodash.isequal":"^4.5.8","@types/sdp-transform":"^2.4.4","@types/ua-parser-js":"^0.7.36","@types/uuid":"^8.3.0","jest-canvas-mock":"^2.3.1","jsdom-worker":"^0.3.0",tslib:"^2.2.0"},description:"@100mslive Core SDK which abstracts the complexities of webRTC while providing a reactive store for data management with a unidirectional data flow",keywords:["video","webrtc","conferencing","100ms"],gitHead:"b82ff1de51cc685dc6fb0bff9a36d69f4120fd65"}})),Mt=(e=>(e.Disconnected="Disconnected",e.Preview="Preview",e.Connecting="Connecting",e.Connected="Connected",e.Reconnecting="Reconnecting",e.Disconnecting="Disconnecting",e.Failed="Failed",e))(Mt||{}),Nt=()=>({room:{id:"",isConnected:!1,name:"",peers:[],localPeer:"",roomState:"Disconnected",recording:{browser:{running:!1},server:{running:!1},hls:{running:!1}},rtmp:{running:!1},hls:{running:!1,variants:[]},sessionId:""},peers:{},tracks:{},playlist:{audio:{list:{},selection:{id:"",hasPrevious:!1,hasNext:!1},progress:0,volume:0,currentTime:0,playbackRate:1},video:{list:{},selection:{id:"",hasPrevious:!1,hasNext:!1},progress:0,volume:0,currentTime:0,playbackRate:1}},messages:{byID:{},allIDs:[]},speakers:{},connectionQualities:{},settings:{audioInputDeviceId:"",audioOutputDeviceId:"",videoInputDeviceId:""},devices:{audioInput:[],audioOutput:[],videoInput:[]},roles:{},roleChangeRequests:[],errors:[],sessionStore:{},templateAppData:{},polls:{},whiteboards:{},hideLocalPeer:!1}),Ot=()=>({peerStats:{},remoteTrackStats:{},localTrackStats:{},localPeer:{id:""}}),xt=(e=>(e.CHAT="chat",e))(xt||{}),Ut=(e=>(e.INFO="info",e.ERROR="error",e))(Ut||{}),Bt=(e=>(e.PEER_JOINED="PEER_JOINED",e.PEER_LEFT="PEER_LEFT",e.PEER_LIST="PEER_LIST",e.NEW_MESSAGE="NEW_MESSAGE",e.ERROR="ERROR",e.RECONNECTING="RECONNECTING",e.RECONNECTED="RECONNECTED",e.TRACK_ADDED="TRACK_ADDED",e.TRACK_REMOVED="TRACK_REMOVED",e.TRACK_MUTED="TRACK_MUTED",e.TRACK_UNMUTED="TRACK_UNMUTED",e.TRACK_DEGRADED="TRACK_DEGRADED",e.TRACK_RESTORED="TRACK_RESTORED",e.TRACK_DESCRIPTION_CHANGED="TRACK_DESCRIPTION_CHANGED",e.ROLE_UPDATED="ROLE_UPDATED",e.CHANGE_TRACK_STATE_REQUEST="CHANGE_TRACK_STATE_REQUEST",e.CHANGE_MULTI_TRACK_STATE_REQUEST="CHANGE_MULTI_TRACK_STATE_REQUEST",e.ROOM_ENDED="ROOM_ENDED",e.REMOVED_FROM_ROOM="REMOVED_FROM_ROOM",e.DEVICE_CHANGE_UPDATE="DEVICE_CHANGE_UPDATE",e.PLAYLIST_TRACK_ENDED="PLAYLIST_TRACK_ENDED",e.NAME_UPDATED="NAME_UPDATED",e.METADATA_UPDATED="METADATA_UPDATED",e.POLL_CREATED="POLL_CREATED",e.POLL_STARTED="POLL_STARTED",e.POLL_STOPPED="POLL_STOPPED",e.POLL_VOTES_UPDATED="POLL_VOTES_UPDATED",e.POLLS_LIST="POLLS_LIST",e.HAND_RAISE_CHANGED="HAND_RAISE_CHANGED",e.TRANSCRIPTION_STATE_UPDATED="TRANSCRIPTION_STATE_UPDATED",e))(Bt||{}),Ft=(e=>(e.audio="audio",e.video="video",e))(Ft||{});function Gt(e,t){let i,s;if(t)for(let n of t.auxiliaryTracks){let t=e[n];Vt(t)&&(s=$t(t)?t:s,i=jt(t)?t:i)}return{video:i,audio:s}}function $t(e){return e&&"audio"===e.type}function jt(e){return e&&"video"===e.type}function Vt(e){return e&&"screen"===e.source}function Wt(e){return e&&"audioplaylist"===e.source}function Ht(e){return e&&"videoplaylist"===e.source}function qt(e){return!!e&&!(null==e||!e.degraded)}function Kt(e,t){return!(!t||!e.tracks[t])&&e.tracks[t].enabled}function Jt(e){var t;let i=!1,s=!1,n=!1;return null!=(t=null==e?void 0:e.publishParams)&&t.allowed&&(i=e.publishParams.allowed.includes("video"),s=e.publishParams.allowed.includes("audio"),n=e.publishParams.allowed.includes("screen")),{video:i,audio:s,screen:n}}var zt=(e=>(e[e.VERBOSE=0]="VERBOSE",e[e.DEBUG=1]="DEBUG",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.TIME=4]="TIME",e[e.TIMEEND=5]="TIMEEND",e[e.ERROR=6]="ERROR",e[e.NONE=7]="NONE",e))(zt||{}),Qt="undefined"!=typeof window&&"undefined"!=typeof window.expect,Yt=class{static v(e,...t){this.log(0,e,...t)}static d(e,...t){this.log(1,e,...t)}static i(e,...t){this.log(2,e,...t)}static w(e,...t){this.log(3,e,...t)}static e(e,...t){this.log(6,e,...t)}static time(e){this.log(4,"[HMSPerformanceTiming]",e)}static timeEnd(e){this.log(5,"[HMSPerformanceTiming]",e,e)}static cleanup(){performance.clearMarks(),performance.clearMeasures()}static log(e,t,...i){if(!(this.level.valueOf()>e.valueOf()))switch(e){case 0:console.log(t,...i);break;case 1:console.debug(t,...i);break;case 2:console.info(t,...i);break;case 3:console.warn(t,...i);break;case 6:console.error(t,...i);break;case 4:performance.mark(i[0]);break;case 5:{let e=i[0];try{let i=performance.measure(e,e);this.log(1,t,e,null==i?void 0:i.duration),performance.clearMarks(e),performance.clearMeasures(e)}catch(we){this.log(1,t,e,we)}break}}}};Yt.level=Qt?7:0;var Zt,Xt,ei,ti,ii,si=class{constructor(e){this.tracks=new Array,this.nativeStream=e,this.id=e.id}updateId(e){this.id=e}},ni=new l.UAParser,ri="undefined"!=typeof window,ai="undefined"==typeof window&&!(null!=(Zt=ni.getBrowser().name)&&Zt.toLowerCase().includes("electron")),oi=()=>"mobile"===ni.getDevice().type,li=null==(ei=null==(Xt=ni.getBrowser())?void 0:Xt.name)?void 0:ei.toLowerCase().includes("safari"),di="firefox"===(null==(ii=null==(ti=ni.getBrowser())?void 0:ti.name)?void 0:ii.toLowerCase()),ci=(e=>(e.CUSTOM="CUSTOM",e.LOCAL="LOCAL",e.HMS="HMS",e))(ci||{});var ui=function(){if(ri&&window){let e=window.location.hostname;return"localhost"===e||"127.0.0.1"===e?"LOCAL":e.includes("app.100ms.live")?"HMS":"CUSTOM"}return"CUSTOM"}(),hi={WebSocketConnectionErrors:{FAILED_TO_CONNECT:1e3,WEBSOCKET_CONNECTION_LOST:1003,ABNORMAL_CLOSE:1006},APIErrors:{SERVER_ERRORS:2e3,INIT_CONFIG_NOT_AVAILABLE:2002,ENDPOINT_UNREACHABLE:2003,INVALID_TOKEN_FORMAT:2004},TracksErrors:{GENERIC_TRACK:3e3,CANT_ACCESS_CAPTURE_DEVICE:3001,DEVICE_NOT_AVAILABLE:3002,DEVICE_IN_USE:3003,DEVICE_LOST_MIDWAY:3004,NOTHING_TO_RETURN:3005,INVALID_VIDEO_SETTINGS:3006,CODEC_CHANGE_NOT_PERMITTED:3007,AUTOPLAY_ERROR:3008,OVER_CONSTRAINED:3009,NO_AUDIO_DETECTED:3010,SYSTEM_DENIED_PERMISSION:3011,CURRENT_TAB_NOT_SHARED:3012,AUDIO_PLAYBACK_ERROR:3013,SELECTED_DEVICE_MISSING:3014,NO_DATA:3015},WebrtcErrors:{CREATE_OFFER_FAILED:4001,CREATE_ANSWER_FAILED:4002,SET_LOCAL_DESCRIPTION_FAILED:4003,SET_REMOTE_DESCRIPTION_FAILED:4004,ICE_FAILURE:4005,ICE_DISCONNECTED:4006,STATS_FAILED:4007},WebsocketMethodErrors:{SERVER_ERRORS:5e3,ALREADY_JOINED:5001,CANNOT_JOIN_PREVIEW_IN_PROGRESS:5002},GenericErrors:{NOT_CONNECTED:6e3,SIGNALLING:6001,UNKNOWN:6002,NOT_READY:6003,JSON_PARSING_FAILED:6004,TRACK_METADATA_MISSING:6005,RTC_TRACK_MISSING:6006,PEER_METADATA_MISSING:6007,INVALID_ROLE:6008,PREVIEW_IN_PROGRESS:6009,MISSING_MEDIADEVICES:6010,MISSING_RTCPEERCONNECTION:6011,LOCAL_STORAGE_ACCESS_DENIED:6012,VALIDATION_FAILED:6013},PlaylistErrors:{NO_ENTRY_TO_PLAY:8001,NO_ENTRY_IS_PLAYING:8002}},pi=class e extends Error{constructor(t,i,s,n,r,a=!1){super(n),this.code=t,this.name=i,this.message=n,this.description=r,this.isTerminal=a,Object.setPrototypeOf(this,e.prototype),this.action=s.toString()}toAnalyticsProperties(){return{error_name:this.name,error_code:this.code,error_message:this.message,error_description:this.description,action:this.action,is_terminal:this.isTerminal}}addNativeError(e){this.nativeError=e}toString(){var e;return`{\n      code: ${this.code};\n      name: ${this.name};\n      action: ${this.action};\n      message: ${this.message};\n      description: ${this.description};\n      isTerminal: ${this.isTerminal};\n      nativeError: ${null==(e=this.nativeError)?void 0:e.message};\n    }`}};function vi(e){switch(e){case"join":return"JOIN";case"offer":return"PUBLISH";case"answer":return"SUBSCRIBE";case"track-update":return"TRACK";default:return"NONE"}}var gi=["join","offer","answer","trickle","on-error","JOIN"],mi={WebSocketConnectionErrors:{FailedToConnect:(e,t="")=>new pi(hi.WebSocketConnectionErrors.FAILED_TO_CONNECT,"WebsocketFailedToConnect",e,`[WS]: ${t}`,`[WS]: ${t}`),WebSocketConnectionLost:(e,t="")=>new pi(hi.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,"WebSocketConnectionLost",e,"Network connection lost",t),AbnormalClose:(e,t="")=>new pi(hi.WebSocketConnectionErrors.ABNORMAL_CLOSE,"WebSocketAbnormalClose",e,"Websocket closed abnormally",t)},APIErrors:{ServerErrors:(e,t,i="",s=!0)=>new pi(e,"ServerErrors",t,`[${t}]: Server error ${i}`,i,s),EndpointUnreachable:(e,t="")=>new pi(hi.APIErrors.ENDPOINT_UNREACHABLE,"EndpointUnreachable",e,`Endpoint is not reachable - ${t}`,t),InvalidTokenFormat:(e,t="")=>new pi(hi.APIErrors.INVALID_TOKEN_FORMAT,"InvalidTokenFormat",e,`Token is not in proper JWT format - ${t}`,t,!0),InitConfigNotAvailable:(e,t="")=>new pi(hi.APIErrors.INIT_CONFIG_NOT_AVAILABLE,"InitError",e,`[INIT]: ${t}`,`[INIT]: ${t}`)},TracksErrors:{GenericTrack:(e,t="")=>new pi(hi.TracksErrors.GENERIC_TRACK,"GenericTrack",e,`[TRACK]: ${t}`,`[TRACK]: ${t}`),CantAccessCaptureDevice:(e,t,i="")=>new pi(hi.TracksErrors.CANT_ACCESS_CAPTURE_DEVICE,"CantAccessCaptureDevice",e,`User denied permission to access capture device - ${t}`,i),DeviceNotAvailable:(e,t,i="")=>new pi(hi.TracksErrors.DEVICE_NOT_AVAILABLE,"DeviceNotAvailable",e,`[TRACK]: Capture device is no longer available - ${t}`,i),DeviceInUse:(e,t,i="")=>new pi(hi.TracksErrors.DEVICE_IN_USE,"DeviceInUse",e,`[TRACK]: Capture device is in use by another application - ${t}`,i),DeviceLostMidway:(e,t,i="")=>new pi(hi.TracksErrors.DEVICE_LOST_MIDWAY,"DeviceLostMidway",e,`Lost access to capture device midway - ${t}`,i),NothingToReturn:(e,t="",i="There is no media to return. Please select either video or audio or both.")=>new pi(hi.TracksErrors.NOTHING_TO_RETURN,"NothingToReturn",e,i,t),InvalidVideoSettings:(e,t="")=>new pi(hi.TracksErrors.INVALID_VIDEO_SETTINGS,"InvalidVideoSettings",e,"Cannot enable simulcast when no video settings are provided",t),AutoplayBlocked:(e,t="")=>new pi(hi.TracksErrors.AUTOPLAY_ERROR,"AutoplayBlocked",e,"Autoplay blocked because the user didn't interact with the document first",t),CodecChangeNotPermitted:(e,t="")=>new pi(hi.TracksErrors.CODEC_CHANGE_NOT_PERMITTED,"CodecChangeNotPermitted",e,"Codec can't be changed mid call.",t),OverConstrained:(e,t,i="")=>new pi(hi.TracksErrors.OVER_CONSTRAINED,"OverConstrained",e,`[TRACK]: Requested constraints cannot be satisfied with the device hardware - ${t}`,i),NoAudioDetected:(e,t="Please check the mic or use another audio input")=>new pi(hi.TracksErrors.NO_AUDIO_DETECTED,"NoAudioDetected",e,"No audio input detected from microphone",t),SystemDeniedPermission:(e,t,i="")=>new pi(hi.TracksErrors.SYSTEM_DENIED_PERMISSION,"SystemDeniedPermission",e,`Operating System denied permission to access capture device - ${t}`,i),CurrentTabNotShared:()=>new pi(hi.TracksErrors.CURRENT_TAB_NOT_SHARED,"CurrentTabNotShared","TRACK","The app requires you to share the current tab","You must screen share the current tab in order to proceed"),AudioPlaybackError:e=>new pi(hi.TracksErrors.AUDIO_PLAYBACK_ERROR,"Audio playback error","TRACK",e,e),SelectedDeviceMissing:e=>new pi(hi.TracksErrors.SELECTED_DEVICE_MISSING,"SelectedDeviceMissing","TRACK",`Could not detect selected ${e} device`,`Please check connection to the ${e} device`,!1),NoDataInTrack:e=>new pi(hi.TracksErrors.NO_DATA,"Track does not have any data","TRACK",e,"This could possibily due to another application taking priority over the access to camera or microphone or due to an incoming call")},WebrtcErrors:{CreateOfferFailed:(e,t="")=>new pi(hi.WebrtcErrors.CREATE_OFFER_FAILED,"CreateOfferFailed",e,`[${e.toString()}]: Failed to create offer. `,t),CreateAnswerFailed:(e,t="")=>new pi(hi.WebrtcErrors.CREATE_ANSWER_FAILED,"CreateAnswerFailed",e,`[${e.toString()}]: Failed to create answer. `,t),SetLocalDescriptionFailed:(e,t="")=>new pi(hi.WebrtcErrors.SET_LOCAL_DESCRIPTION_FAILED,"SetLocalDescriptionFailed",e,`[${e.toString()}]: Failed to set offer. `,t),SetRemoteDescriptionFailed:(e,t="")=>new pi(hi.WebrtcErrors.SET_REMOTE_DESCRIPTION_FAILED,"SetRemoteDescriptionFailed",e,`[${e.toString()}]: Failed to set answer. `,t,!0),ICEFailure:(e,t="",i=!1)=>new pi(hi.WebrtcErrors.ICE_FAILURE,"ICEFailure",e,`[${e.toString()}]: Ice connection state FAILED`,t,i),ICEDisconnected:(e,t="")=>new pi(hi.WebrtcErrors.ICE_DISCONNECTED,"ICEDisconnected",e,`[${e.toString()}]: Ice connection state DISCONNECTED`,t),StatsFailed:(e,t="")=>new pi(hi.WebrtcErrors.STATS_FAILED,"StatsFailed",e,`Failed to WebRTC get stats - ${t}`,t)},WebsocketMethodErrors:{ServerErrors:(e,t,i)=>new pi(e,"ServerErrors",t,i,i,gi.includes(t)),AlreadyJoined:(e,t="")=>new pi(hi.WebsocketMethodErrors.ALREADY_JOINED,"AlreadyJoined",e,"[JOIN]: You have already joined this room.",t),CannotJoinPreviewInProgress:(e,t="")=>new pi(hi.WebsocketMethodErrors.CANNOT_JOIN_PREVIEW_IN_PROGRESS,"CannotJoinPreviewInProgress",e,"[JOIN]: Cannot join if preview is in progress",t)},GenericErrors:{NotConnected:(e,t="")=>new pi(hi.GenericErrors.NOT_CONNECTED,"NotConnected",e,"Client is not connected",t),Signalling:(e,t)=>new pi(hi.GenericErrors.SIGNALLING,"Signalling",e,`Unknown signalling error: ${e.toString()} ${t} `,t),Unknown:(e,t)=>new pi(hi.GenericErrors.UNKNOWN,"Unknown",e,`Unknown exception: ${t}`,t),NotReady:(e,t="")=>new pi(hi.GenericErrors.NOT_READY,"NotReady",e,t,t),JsonParsingFailed:(e,t,i="")=>new pi(hi.GenericErrors.JSON_PARSING_FAILED,"JsonParsingFailed",e,`Failed to parse JSON message - ${t}`,i),TrackMetadataMissing:(e,t="")=>new pi(hi.GenericErrors.TRACK_METADATA_MISSING,"TrackMetadataMissing",e,"Track Metadata Missing",t),RTCTrackMissing:(e,t="")=>new pi(hi.GenericErrors.RTC_TRACK_MISSING,"RTCTrackMissing",e,"RTC Track missing",t),PeerMetadataMissing:(e,t="")=>new pi(hi.GenericErrors.PEER_METADATA_MISSING,"PeerMetadataMissing",e,"Peer Metadata Missing",t),ValidationFailed:(e,t)=>new pi(hi.GenericErrors.VALIDATION_FAILED,"ValidationFailed","VALIDATION",e,t?JSON.stringify(t):""),InvalidRole:(e,t)=>new pi(hi.GenericErrors.INVALID_ROLE,"InvalidRole",e,"Invalid role. Join with valid role",t,!0),PreviewAlreadyInProgress:(e,t="")=>new pi(hi.GenericErrors.PREVIEW_IN_PROGRESS,"PreviewAlreadyInProgress",e,"[Preview]: Cannot join if preview is in progress",t),LocalStorageAccessDenied:(e="Access to localStorage has been denied")=>new pi(hi.GenericErrors.LOCAL_STORAGE_ACCESS_DENIED,"LocalStorageAccessDenied","NONE","LocalStorageAccessDenied",e),MissingMediaDevices:()=>new pi(hi.GenericErrors.MISSING_MEDIADEVICES,"MissingMediaDevices","JOIN","navigator.mediaDevices is undefined. 100ms SDK won't work on this website as WebRTC is not supported on HTTP endpoints(missing navigator.mediaDevices). Please ensure you're using the SDK either on localhost or a valid HTTPS endpoint.","",!0),MissingRTCPeerConnection:()=>new pi(hi.GenericErrors.MISSING_RTCPEERCONNECTION,"MissingRTCPeerConnection","JOIN","RTCPeerConnection which is a core requirement for WebRTC call was not found, this could be due to an unsupported browser or browser extensions blocking WebRTC","",!0)},MediaPluginErrors:{PlatformNotSupported:(e,t="")=>new pi(7001,"PlatformNotSupported",e,"Check HMS Docs to see the list of supported platforms",t),InitFailed:(e,t="")=>new pi(7002,"InitFailed",e,"Plugin init failed",t),ProcessingFailed:(e,t="")=>new pi(7003,"ProcessingFailed",e,"Plugin processing failed",t),AddAlreadyInProgress:(e,t="")=>new pi(7004,"AddAlreadyInProgress",e,"Plugin add already in progress",t),DeviceNotSupported:(e,t="")=>new pi(7005,"DeviceNotSupported",e,"Check HMS Docs to see the list of supported devices",t)},PlaylistErrors:{NoEntryToPlay:(e,t)=>new pi(hi.PlaylistErrors.NO_ENTRY_TO_PLAY,"NoEntryToPlay",e,"Reached end of playlist",t),NoEntryPlaying:(e,t)=>new pi(hi.PlaylistErrors.NO_ENTRY_IS_PLAYING,"NoEntryIsPlaying",e,"No entry is playing at this time",t)}},fi=class{constructor(){this.valuesMap=new Map}getItem(e){return this.valuesMap.has(e)?String(this.valuesMap.get(e)):null}setItem(e,t){this.valuesMap.set(e,t)}removeItem(e){this.valuesMap.delete(e)}clear(){this.valuesMap.clear()}key(e){if(0===arguments.length)throw new TypeError("Failed to execute 'key' on 'Storage': 1 argument required, but only 0 present.");return Array.from(this.valuesMap.keys())[e]}get length(){return this.valuesMap.size}},yi=class{constructor(e){this.key=e,this.storage=null}getStorage(){try{return ri&&!this.storage&&((()=>{try{ri&&!localStorage&&(window.localStorage=new fi)}catch(Pe){Yt.e("Error initialising localStorage",mi.GenericErrors.LocalStorageAccessDenied())}})(),this.storage=window.localStorage),this.storage}catch(e){return Yt.e("Error initialising localStorage",mi.GenericErrors.LocalStorageAccessDenied()),null}}get(){var e;let t=null==(e=this.getStorage())?void 0:e.getItem(this.key);return t?JSON.parse(t):void 0}set(e){var t;let i=JSON.stringify(e);null==(t=this.getStorage())||t.setItem(this.key,i)}clear(){var e;null==(e=this.getStorage())||e.removeItem(this.key)}},ki=()=>{let e,t=new yi("hms-analytics-deviceId"),i=t.get();return i?e=i:(e=(0,d.Z)(),t.set(e)),e},Ti="[VALIDATIONS]";function bi(e){return null!=e}var Si=()=>{if(!bi(RTCPeerConnection)){let e=mi.GenericErrors.MissingRTCPeerConnection();throw Yt.e(Ti,e),e}},Pi=()=>{if(!bi(navigator.mediaDevices)){let e=mi.GenericErrors.MissingMediaDevices();throw Yt.e(Ti,e),e}},Ei=Dt().version;function Ci(e="prod",t){let i="LOCAL"!==ui&&"prod"===e?"prod":"debug";if(ai)return Ii({os:"web_nodejs",os_version:process.version,sdk:"web",sdk_version:Ei,env:i,domain:ui,is_prebuilt:!(null==t||!t.isPrebuilt),framework:"node",framework_version:process.version,framework_sdk_version:null==t?void 0:t.sdkVersion});let s=ni.getOS(),n=ni.getDevice(),r=ni.getBrowser(),a=wi(`web_${s.name}`),o=s.version||"",l=wi(`${r.name}_${r.version}`),d=l;return n.type&&(d=`${wi(`${n.vendor}_${n.type}`)}/${l}`),Ii({os:a,os_version:o,sdk:"web",sdk_version:Ei,device_model:d,env:i,domain:ui,is_prebuilt:!(null==t||!t.isPrebuilt),framework:null==t?void 0:t.type,framework_version:null==t?void 0:t.version,framework_sdk_version:null==t?void 0:t.sdkVersion})}function wi(e){return e.replace(/ /g,"_")}var Ii=(e,t=",")=>Object.keys(e).filter((t=>bi(e[t]))).map((t=>`${t}:${e[t]}`)).join(t),Ai=class{constructor({name:e,level:t,properties:i,includesPII:s,timestamp:n}){this.metadata={peer:{},userAgent:Ci()},this.name=e,this.level=t,this.includesPII=s||!1,this.properties=i||{},this.timestamp=n||(new Date).getTime(),this.event_id=(0,d.Z)(),this.device_id=ki()}toSignalParams(){return{name:this.name,info:At(It({},this.properties),{timestamp:this.timestamp,domain:ui}),timestamp:(new Date).getTime()}}},Ri=class{static connect(e,t,i=new Date,s=new Date,n){let r=this.eventNameFor("connect",void 0===e),a=e?2:1,o=this.getPropertiesWithError(At(It({},t),{[this.KEY_REQUESTED_AT]:null==i?void 0:i.getTime(),[this.KEY_RESPONDED_AT]:null==s?void 0:s.getTime(),endpoint:n}),e);return new Ai({name:r,level:a,properties:o})}static disconnect(e,t){let i=e?2:1,s=this.getPropertiesWithError(t,e);return new Ai({name:"disconnected",level:i,properties:s})}static preview(e){var t=e,{error:i}=t,s=Rt(t,["error"]);let n=this.eventNameFor("preview",void 0===i),r=i?2:1,a=this.getPropertiesWithError(s,i);return new Ai({name:n,level:r,properties:a})}static join(e){var t=e,{error:i}=t,s=Rt(t,["error"]);let n=this.eventNameFor("join",void 0===i),r=i?2:1,a=this.getPropertiesWithError(At(It({},s),{is_preview_called:!!s.is_preview_called}),i);return new Ai({name:n,level:r,properties:a})}static publish({devices:e,settings:t,error:i}){let s=this.eventNameFor("publish",void 0===i),n=i?2:1,r=this.getPropertiesWithError({devices:e,audio:null==t?void 0:t.audio,video:null==t?void 0:t.video},i);return new Ai({name:s,level:n,properties:r})}static hlsPlayerError(e){return new Ai({name:"hlsPlayerError",level:2,properties:this.getErrorProperties(e)})}static subscribeFail(e){let t=this.eventNameFor("subscribe",!1),i=this.getErrorProperties(e);return new Ai({name:t,level:2,properties:i})}static leave(){return new Ai({name:"leave",level:1})}static autoplayError(){return new Ai({name:"autoplayError",level:2})}static audioPlaybackError(e){return new Ai({name:"audioPlaybackError",level:2,properties:this.getErrorProperties(e)})}static audioRecovered(e){return new Ai({name:"audioRecovered",level:0,properties:{message:e}})}static deviceChange({isUserSelection:e,selection:t,type:i,devices:s,error:n}){let r=this.eventNameFor(n?"publish":`device.${i}`,void 0===n),a=n?2:1,o=this.getPropertiesWithError({selection:t,devices:s,isUserSelection:e},n);return new Ai({name:r,level:a,properties:o})}static performance(e){let t=e.toAnalyticsProperties();return new Ai({name:"perf.stats",level:1,properties:t})}static rtcStats(e){let t=e.toAnalyticsProperties();return new Ai({name:"rtc.stats",level:1,properties:t})}static rtcStatsFailed(e){return new Ai({name:"rtc.stats.failed",level:2,properties:this.getErrorProperties(e)})}static degradationStats(e,t){let i={degradedAt:e.degradedAt,trackId:e.trackId};if(!t&&e.degradedAt instanceof Date){let t=new Date,s=t.valueOf()-e.degradedAt.valueOf();i=At(It({},i),{duration:s,restoredAt:t})}return new Ai({name:"video.degradation.stats",level:1,properties:i})}static audioDetectionFail(e,t){let i=this.getPropertiesWithError({device:t},e);return new Ai({name:"audiopresence.failed",level:2,properties:i})}static previewNetworkQuality(e){return new Ai({name:"perf.networkquality.preview",level:e.error?2:1,properties:e})}static publishStats(e){return new Ai({name:"publisher.stats",level:1,properties:e})}static subscribeStats(e){return new Ai({name:"subscriber.stats",level:1,properties:e})}static getKrispUsage(e){return new Ai({name:"krisp.usage",level:1,properties:{duration:e}})}static krispStart(){return new Ai({name:"krisp.start",level:1})}static krispStop(){return new Ai({name:"krisp.stop",level:1})}static interruption({started:e,type:t,reason:i,deviceInfo:s}){return new Ai({name:""+(e?"interruption.start":"interruption.stop"),level:1,properties:It({reason:i,type:t},s)})}static eventNameFor(e,t){return`${e}.${t?"success":"failed"}`}static getPropertiesWithError(e,t){let i=this.getErrorProperties(t);return e=It(It({},i),e)}static getErrorProperties(e){return e?e instanceof pi?e.toAnalyticsProperties():{error_name:e.name,error_message:e.message,error_description:e.cause}:{}}};Ri.KEY_REQUESTED_AT="requested_at",Ri.KEY_RESPONDED_AT="responded_at";var _i=e=>e?`{\n    trackId: ${e.id};\n    kind: ${e.kind};\n    enabled: ${e.enabled};\n    muted: ${e.muted};\n    readyState: ${e.readyState};\n  }`:"",Li=class{constructor(e,t,i){this.logIdentifier="",this.isTrackNotPublishing=()=>"ended"===this.nativeTrack.readyState||this.nativeTrack.muted,this.stream=e,this.nativeTrack=t,this.source=i}get enabled(){return this.nativeTrack.enabled}get trackId(){return this.firstTrackId||this.sdpTrackId||this.nativeTrack.id}getMediaTrackSettings(){return this.nativeTrack.getSettings()}setEnabled(e){return Lt(this,null,(function*(){this.nativeTrack.enabled=e}))}setSdpTrackId(e){this.sdpTrackId=e}setFirstTrackId(e){this.firstTrackId=e}sendInterruptionEvent({started:e,reason:t}){return Ri.interruption({started:e,type:this.type,reason:t,deviceInfo:{deviceId:this.nativeTrack.getSettings().deviceId,groupId:this.nativeTrack.getSettings().groupId}})}cleanup(){var e;Yt.d("[HMSTrack]","Stopping track",this.toString()),null==(e=this.nativeTrack)||e.stop()}toString(){var e;return`{\n      streamId: ${this.stream.id};\n      peerId: ${this.peerId};\n      trackId: ${this.trackId};\n      mid: ${(null==(e=this.transceiver)?void 0:e.mid)||"-"};\n      logIdentifier: ${this.logIdentifier};\n      source: ${this.source};\n      enabled: ${this.enabled};\n      nativeTrack: ${_i(this.nativeTrack)};\n    }`}},Di=class extends Li{constructor(e,t,i){if(super(e,t,i),this.type="audio",this.audioElement=null,"audio"!==t.kind)throw new Error("Expected 'track' kind = 'audio'")}getVolume(){return this.audioElement?Math.floor(100*this.audioElement.volume):null}setVolume(e){return Lt(this,null,(function*(){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");yield this.subscribeToAudio(0!==e&&this.enabled),this.audioElement&&(this.audioElement.volume=e/100)}))}setAudioElement(e){Yt.d("[HMSAudioTrack]",this.logIdentifier,"adding audio element",`${this}`,e),this.audioElement=e}getAudioElement(){return this.audioElement}getOutputDevice(){return this.outputDevice}cleanup(){super.cleanup(),this.audioElement&&(this.audioElement.srcObject=null,this.audioElement.remove(),this.audioElement=null)}setOutputDevice(e){return Lt(this,null,(function*(){var t;if(e){if(!this.audioElement)return Yt.d("[HMSAudioTrack]",this.logIdentifier,"no audio element to set output",`${this}`),void(this.outputDevice=e);try{"function"==typeof this.audioElement.setSinkId&&(di||(yield null==(t=this.audioElement)?void 0:t.setSinkId(e.deviceId)),this.outputDevice=e)}catch(ye){Yt.d("[HMSAudioTrack]","error in setSinkId",ye)}}else Yt.d("[HMSAudioTrack]",this.logIdentifier,"device is null",`${this}`)}))}subscribeToAudio(e){return Lt(this,null,(function*(){this.stream instanceof pn&&(yield this.stream.setAudio(e,this.trackId,this.logIdentifier))}))}},Mi=new class{constructor(){this.storage=new yi("hms-device-selection"),this.remember=!1,this.TAG="[HMSDeviceStorage]"}setDevices(e){this.devices=e}rememberDevices(e){this.remember=e}updateSelection(e,{deviceId:t,groupId:i}){if(!this.devices||!this.remember)return;let s=this.devices[e].find((e=>this.isSame({deviceId:t,groupId:i},e)));if(!s)return void Yt.w(this.TAG,`Could not find device with deviceId: ${t}, groupId: ${i}`);let n=this.storage.get()||{};n[e]=s,this.storage.set(n)}getSelection(){if(this.remember)return this.storage.get()}cleanup(){this.remember=!1,this.devices=void 0}isSame(e,t){return e.deviceId===t.deviceId&&(e.groupId===t.groupId||!e.groupId)}},Ni=(e=>(e.TRANSFORM="TRANSFORM",e.ANALYZE="ANALYZE",e))(Ni||{}),Oi=(e=>(e.PLATFORM_NOT_SUPPORTED="PLATFORM_NOT_SUPPORTED",e.DEVICE_NOT_SUPPORTED="DEVICE_NOT_SUPPORTED",e))(Oi||{}),xi=class{static failure(e,t){let i=It({plugin_name:e},t.toAnalyticsProperties());return new Ai({name:"mediaPlugin.failed",level:2,properties:i})}static audioPluginFailure(e,t,i){let s=It({plugin_name:e,sampleRate:t},i.toAnalyticsProperties());return new Ai({name:"mediaPlugin.failed",level:2,properties:s})}static audioPluginStats({pluginName:e,duration:t,loadTime:i,sampleRate:s}){return new Ai({name:"mediaPlugin.stats",level:1,properties:{plugin_name:e,duration:t,load_time:i,sampleRate:s}})}static added(e,t){return new Ai({name:"mediaPlugin.added",level:1,properties:{plugin_name:e,added_at:t}})}static stats({pluginName:e,duration:t,loadTime:i,avgPreProcessingTime:s,avgProcessingTime:n,inputFrameRate:r,pluginFrameRate:a}){return new Ai({name:"mediaPlugin.stats",level:1,properties:{plugin_name:e,duration:t,load_time:i,avg_preprocessing_time:s,avg_processing_time:n,input_frame_rate:r,plugin_frame_rate:a}})}},Ui=class{constructor(e){this.eventBus=e,this.TAG="[AudioPluginsAnalytics]",this.initTime={},this.addedTimestamps={},this.pluginAdded={},this.pluginSampleRate={}}added(e,t){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.pluginSampleRate[e]=t,this.eventBus.analytics.publish(xi.added(e,this.addedTimestamps[e]))}removed(e){if(this.pluginAdded[e]){let t={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],sampleRate:this.pluginSampleRate[e]};this.eventBus.analytics.publish(xi.audioPluginStats(t)),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(this.eventBus.analytics.publish(xi.audioPluginFailure(e,this.pluginSampleRate[e],t)),this.clean(e))}initWithTime(e,t){return Lt(this,null,(function*(){if(this.initTime[e])return void Yt.i(this.TAG,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);let i;try{i=yield this.timeInMs(t),Yt.i(this.TAG,`Time taken for Plugin ${e} initialization : ${i}`)}catch(ye){let i=mi.MediaPluginErrors.InitFailed("AUDIO_PLUGINS",`failed during initialization of plugin${ye.message||ye}`);throw Yt.e(this.TAG,i),this.failure(e,i),i}i&&(this.initTime[e]=i)}))}timeInMs(e){return Lt(this,null,(function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)}))}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.pluginAdded[e],delete this.pluginSampleRate[e]}},Bi=class{constructor(e,t,i){this.eventBus=t,this.TAG="[AudioPluginsManager]",this.pluginAddInProgress=!1,this.hmsTrack=e,this.pluginsMap=new Map,this.analytics=new Ui(t),this.createAudioContext(),this.room=i}getPlugins(){return Array.from(this.pluginsMap.keys())}addPlugin(e){return Lt(this,null,(function*(){var t,i;let s=null==(t=e.getName)?void 0:t.call(e);if(s){if(this.pluginAddInProgress){let e=mi.MediaPluginErrors.AddAlreadyInProgress("AUDIO_PLUGINS","Add Plugin is already in Progress");throw this.analytics.added(s,this.audioContext.sampleRate),this.analytics.failure(s,e),Yt.w("can't add another plugin when previous add is in progress"),e}if("HMSKrispPlugin"===e.getName()){if(null==(i=this.room)||!i.isNoiseCancellationEnabled){let e="Krisp Noise Cancellation is not enabled for this room";if(0===this.pluginsMap.size)throw Error(e);return void Yt.w(this.TAG,e)}this.eventBus.analytics.publish(Ri.krispStart())}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e)}finally{this.pluginAddInProgress=!1}}else Yt.w("no name provided by the plugin")}))}addPluginInternal(e){return Lt(this,null,(function*(){var t,i;let s=null==(t=e.getName)?void 0:t.call(e);if(this.pluginsMap.get(s))Yt.w(this.TAG,`plugin - ${s} already added.`);else{yield this.validateAndThrow(s,e),null==(i=e.setEventBus)||i.call(e,this.eventBus);try{0===this.pluginsMap.size?yield this.initAudioNodes():this.prevAudioNode&&this.prevAudioNode.disconnect(),this.analytics.added(s,this.audioContext.sampleRate),yield this.analytics.initWithTime(s,(()=>Lt(this,null,(function*(){return e.init()})))),this.pluginsMap.set(s,e),yield this.processPlugin(e),yield this.connectToDestination(),yield this.updateProcessedTrack()}catch(we){throw Yt.e(this.TAG,"failed to add plugin",we),we}}}))}validatePlugin(e){return e.checkSupport(this.audioContext)}validateAndThrow(e,t){return Lt(this,null,(function*(){let i=this.validatePlugin(t);if(i.isSupported)Yt.i(this.TAG,`plugin is supported,- ${t.getName()}`);else{if(this.analytics.added(e,this.audioContext.sampleRate),"PLATFORM_NOT_SUPPORTED"===i.errType){let t=mi.MediaPluginErrors.PlatformNotSupported("AUDIO_PLUGINS","platform not supported, see docs");throw this.analytics.failure(e,t),yield this.cleanup(),t}if("DEVICE_NOT_SUPPORTED"===i.errType){let t=mi.MediaPluginErrors.DeviceNotSupported("AUDIO_PLUGINS","audio device not supported, see docs");throw this.analytics.failure(e,t),yield this.cleanup(),t}}}))}removePlugin(e){return Lt(this,null,(function*(){if("HMSKrispPlugin"===e.getName())this.eventBus.analytics.publish(Ri.krispStop());yield this.removePluginInternal(e),0===this.pluginsMap.size?(yield this.cleanup(),Yt.i(this.TAG,"No plugins left, stopping plugins loop"),yield this.hmsTrack.setProcessedTrack(void 0)):yield this.reprocessPlugins()}))}cleanup(){return Lt(this,null,(function*(){var e,t,i;for(let s of this.pluginsMap.values())yield this.removePluginInternal(s);yield this.hmsTrack.setProcessedTrack(void 0),null==(e=this.sourceNode)||e.disconnect(),null==(t=this.prevAudioNode)||t.disconnect(),null==(i=this.outputTrack)||i.stop(),this.sourceNode=void 0,this.destinationNode=void 0,this.prevAudioNode=void 0,this.outputTrack=void 0}))}closeContext(){return Lt(this,null,(function*(){var e;null==(e=this.audioContext)||e.close(),this.audioContext=void 0}))}reprocessPlugins(){return Lt(this,null,(function*(){if(0===this.pluginsMap.size||!this.sourceNode)return;let e=Array.from(this.pluginsMap.values());yield this.cleanup(),yield this.initAudioNodes();for(let t of e)yield this.addPlugin(t);this.updateProcessedTrack()}))}initAudioNodes(){return Lt(this,null,(function*(){if(this.audioContext){if(!this.sourceNode){let e=new MediaStream([this.hmsTrack.nativeTrack]);this.sourceNode=this.audioContext.createMediaStreamSource(e)}this.destinationNode||(this.destinationNode=this.audioContext.createMediaStreamDestination(),this.outputTrack=this.destinationNode.stream.getAudioTracks()[0])}}))}updateProcessedTrack(){return Lt(this,null,(function*(){try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(e){throw Yt.e(this.TAG,"error in setting processed track",e),e}}))}processPlugin(e){return Lt(this,null,(function*(){try{let t=yield e.processAudioTrack(this.audioContext,this.prevAudioNode||this.sourceNode);this.prevAudioNode&&this.prevAudioNode.connect(t),this.prevAudioNode=t}catch(ke){let i=e.getName();Yt.e(this.TAG,`error in processing plugin ${i}`,ke),yield this.removePluginInternal(e)}}))}connectToDestination(){return Lt(this,null,(function*(){try{this.prevAudioNode&&this.destinationNode&&this.prevAudioNode.context===this.destinationNode.context&&this.prevAudioNode.connect(this.destinationNode)}catch(e){Yt.e(this.TAG,"error in connecting to destination node",e)}}))}removePluginInternal(e){return Lt(this,null,(function*(){var t;let i=null==(t=e.getName)?void 0:t.call(e);this.pluginsMap.get(i)?(Yt.i(this.TAG,`removing plugin ${i}`),this.pluginsMap.delete(i),e.stop(),this.analytics.removed(i)):Yt.w(this.TAG,`plugin - ${i} not found to remove.`)}))}createAudioContext(){this.audioContext||(-1!==navigator.userAgent.indexOf("Firefox")?this.audioContext=new AudioContext:this.audioContext=new AudioContext({sampleRate:48e3}))}};function Fi(e,t=""){if("chrome"===ve.browserDetails.browser&&"NotAllowedError"===e.name&&e.message.includes("denied by system"))return mi.TracksErrors.SystemDeniedPermission("TRACK",t,e.message);if("firefox"===ve.browserDetails.browser&&"NotFoundError"===e.name){let i=mi.TracksErrors.SystemDeniedPermission("TRACK",t,e.message);return i.description=`Capture device is either blocked at Operating System level or not available - ${t}`,i}switch(e.name){case"OverconstrainedError":return mi.TracksErrors.OverConstrained("TRACK",t,e.constraint);case"NotAllowedError":return mi.TracksErrors.CantAccessCaptureDevice("TRACK",t,e.message);case"NotFoundError":return mi.TracksErrors.DeviceNotAvailable("TRACK",t,e.message);case"NotReadableError":return mi.TracksErrors.DeviceInUse("TRACK",t,e.message);case"TypeError":return mi.TracksErrors.NothingToReturn("TRACK",e.message);default:return function(e,t){let i=e.toLowerCase();return i.includes("device not found")?mi.TracksErrors.DeviceNotAvailable("TRACK",t,e):i.includes("permission denied")?mi.TracksErrors.CantAccessCaptureDevice("TRACK",t,e):mi.TracksErrors.GenericTrack("TRACK",e)}(e.message,t)}}function Gi(e,t){let i=Fi(e,t);return i.addNativeError(e),i}function $i(e){return Lt(this,null,(function*(){try{return(yield navigator.mediaDevices.getUserMedia({audio:!!e&&e.toConstraints()})).getAudioTracks()[0]}catch(t){throw Gi(t,"audio")}}))}function ji(e){return Lt(this,null,(function*(){try{return(yield navigator.mediaDevices.getUserMedia({video:!!e&&e.toConstraints()})).getVideoTracks()[0]}catch(t){throw Gi(t,"video")}}))}function Vi(e){return"canvas"in e||"MediaStreamAudioDestinationNode"===e.label||""===e.label}var Wi={audioContext:null,getAudioContext(){return this.audioContext||(this.audioContext=new AudioContext),this.audioContext},resumeContext(){return Lt(this,null,(function*(){try{return yield this.getAudioContext().resume()}catch(Pe){Yt.e("AudioContext",Pe)}}))}},Hi=(e=>(e.SPEAKERPHONE="SPEAKERPHONE",e.WIRED="WIRED",e.BLUETOOTH="BLUETOOTH",e.EARPIECE="EARPIECE",e))(Hi||{}),qi=e=>{if(!e)return Yt.e("[DeviceManager]:","No device label provided"),"SPEAKERPHONE";let t=e.toLowerCase();return t.includes("speakerphone")?"SPEAKERPHONE":t.includes("wired")?"WIRED":/airpods|buds|wireless|bluetooth/gi.test(t)?"BLUETOOTH":t.includes("earpiece")?"EARPIECE":"SPEAKERPHONE"},Ki=class{constructor(e=1/0){this.capacity=e,this.storage=[]}size(){return this.storage.length}toList(){return this.storage.slice(0)}enqueue(e){this.size()===this.capacity&&this.dequeue(),this.storage.push(e)}dequeue(){return this.storage.shift()}aggregate(e){return e(this.storage)}},Ji="(function workerSetup() {\n  function ticker() {\n    self.postMessage('tick');\n  }\n  self.onmessage = function (event) {\n    const [data, time] = event.data;\n    switch (data) {\n      case 'start':\n        setTimeout(ticker, time);\n        break;\n      default:\n        break;\n    }\n  };\n})()";function zi(e){if(e<0)throw Error("`ms` should be a positive integer");return new Promise((t=>{setTimeout(t,e)}))}function Qi(e){if(e<0)throw Error("`ms` should be a positive integer");if("undefined"==typeof Worker)return zi(e);let t=new Worker(URL.createObjectURL(new Blob([Ji],{type:"application/javascript"})));return t.postMessage(["start",e]),new Promise((e=>{t.onmessage=i=>{"tick"===i.data&&(e(),t.terminate())}}))}function Yi(e,t=300){let i;return function(...s){clearTimeout(i),i=void 0;let n=this;i=setTimeout((()=>{e.apply(n,s)}),t)}}var Zi=class{constructor(e,t,i){this.track=e,this.audioLevelEvent=t,this.silenceEvent=i,this.TAG="[TrackAudioLevelMonitor]",this.audioLevel=0,this.isMonitored=!1,this.interval=100,this.historyInterval=700,this.history=new Ki(this.historyInterval/this.interval),this.detectSilence=()=>Lt(this,null,(function*(){let e=0;for(;this.isMonitored;){if(this.track.enabled){if(!this.isSilentThisInstant())break;if(e++,e>50){this.silenceEvent.publish({track:this.track});break}}yield zi(20)}}));try{let e=new MediaStream([this.track.nativeTrack]);this.analyserNode=this.createAnalyserNodeForStream(e);let t=this.analyserNode.frequencyBinCount;this.dataArray=new Uint8Array(t)}catch(ye){Yt.w(this.TAG,"Unable to initialize AudioContext",ye)}}start(){this.stop(),this.isMonitored=!0,Yt.d(this.TAG,"Starting track Monitor",`${this.track}`),this.loop().then((()=>Yt.d(this.TAG,"Stopping track Monitor",`${this.track}`)))}stop(){this.analyserNode?(this.sendAudioLevel(0),this.isMonitored=!1):Yt.d(this.TAG,"AudioContext not initialized")}loop(){return Lt(this,null,(function*(){for(;this.isMonitored;)this.sendAudioLevel(this.getMaxAudioLevelOverPeriod()),yield zi(this.interval)}))}sendAudioLevel(e=0){if(e=e>35?e:0,Math.abs(this.audioLevel-e)>5){this.audioLevel=e;let t={track:this.track,audioLevel:this.audioLevel};this.audioLevelEvent.publish(t)}}getMaxAudioLevelOverPeriod(){if(!this.analyserNode)return void Yt.d(this.TAG,"AudioContext not initialized");let e=this.calculateAudioLevel();return void 0!==e&&this.history.enqueue(e),this.history.aggregate((e=>Math.max(...e)))}calculateAudioLevel(){if(!this.analyserNode||!this.dataArray)return void Yt.d(this.TAG,"AudioContext not initialized");this.analyserNode.getByteTimeDomainData(this.dataArray);let e=.009,t=e;for(let s of this.dataArray)t=Math.max(t,(s-128)/128);let i=(Math.log(e)-Math.log(t))/Math.log(e);return Math.ceil(Math.min(Math.max(100*i,0),100))}isSilentThisInstant(){if(this.analyserNode&&this.dataArray)return this.analyserNode.getByteTimeDomainData(this.dataArray),this.dataArray.every((e=>128===e||0===e));Yt.d(this.TAG,"AudioContext not initialized")}createAnalyserNodeForStream(e){let t=Wi.getAudioContext(),i=t.createMediaStreamSource(e),s=t.createAnalyser();return s.fftSize=2048,i.connect(s),s}},Xi=(e=>(e.SIP="sip",e.REGULAR="regular",e))(Xi||{}),es=(e=>(e.NONE="none",e.INITIALISED="initialised",e.STARTED="started",e.PAUSED="paused",e.RESUMED="resumed",e.STOPPED="stopped",e.FAILED="failed",e))(es||{}),ts=(e=>(e.DVR="dvr",e.NO_DVR="no-dvr",e))(ts||{}),is=(e=>(e.REGULAR="regular",e.SCREEN="screen",e.COMPOSITE="composite",e))(is||{}),ss=(e=>(e.INITIALISED="initialised",e.STARTED="started",e.STOPPED="stopped",e.FAILED="failed",e))(ss||{}),ns=(e=>(e.CAPTION="caption",e))(ns||{}),rs={f:"high",h:"medium",q:"low"},as=(e=>(e.VOICE="voice",e.MUSIC="music",e))(as||{}),os=(e=>(e.videoInput="videoInput",e.audioInput="audioInput",e.audioOutput="audioOutput",e))(os||{}),ls=class{constructor(){this._volume=1,this._codec="opus",this._maxBitrate=32,this._deviceId="default",this._audioMode="voice",this._advanced=[{googEchoCancellation:{exact:!0}},{googExperimentalEchoCancellation:{exact:!0}},{autoGainControl:{exact:!0}},{noiseSuppression:{exact:!0}},{googHighpassFilter:{exact:!0}},{googAudioMirroring:{exact:!0}}]}volume(e){if(!(0<=e&&e<=1))throw Error("volume can only be in range [0.0, 1.0]");return this._volume=e,this}codec(e){return this._codec=e,this}maxBitrate(e){if(e&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate="music"===this._audioMode?320:e,this}deviceId(e){return this._deviceId=e,this}audioMode(e="voice"){return this._audioMode=e,"music"===this._audioMode?this._maxBitrate=320:this._maxBitrate=32,this}advanced(e){return this._advanced=e,this}build(){return new ds(this._volume,this._codec,this._maxBitrate,this._deviceId,this._advanced,this._audioMode)}},ds=class{constructor(e,t,i,s,n,r){this.volume=e,this.codec=t,this.maxBitrate=i,this.deviceId=s,this.advanced=n,this.audioMode=r,"music"===this.audioMode?this.maxBitrate=320:this.maxBitrate=32}toConstraints(){return{deviceId:this.deviceId,advanced:"music"===this.audioMode?[]:this.advanced}}toAnalyticsProperties(){return{audio_bitrate:this.maxBitrate,audio_codec:this.codec}}},cs=class{constructor(){this._width=320,this._height=180,this._codec="vp8",this._maxFramerate=30,this._maxBitrate=150,this._advanced=[]}setWidth(e){return this._width=e,this}setHeight(e){return this._height=e,this}codec(e){return this._codec=e,this}maxFramerate(e){if(e&&e<=0)throw Error("maxFramerate should be >= 1");return this._maxFramerate=e,this}maxBitrate(e,t=!0){if("number"==typeof e&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,!this._maxBitrate&&t&&(this._maxBitrate=15e4),this}deviceId(e){return this._deviceId=e,this}advanced(e){return this._advanced=e,this}facingMode(e){return this._facingMode=e,this}build(){return new us(this._width,this._height,this._codec,this._maxFramerate,this._deviceId,this._advanced,this._maxBitrate,this._facingMode)}},us=class{constructor(e,t,i,s,n,r,a,o){this.width=e,this.height=t,this.codec=i,this.maxFramerate=s,this.maxBitrate=a,this.deviceId=n,this.advanced=r,this.facingMode=o}toConstraints(e){let t="ideal";e&&(t="max");let i=this.improviseConstraintsAspect();return{width:{[t]:i.width},height:{[t]:i.height},frameRate:this.maxFramerate,deviceId:this.deviceId,facingMode:this.facingMode}}toAnalyticsProperties(){return{width:this.width,height:this.height,video_bitrate:this.maxBitrate,framerate:this.maxFramerate,video_codec:this.codec,facingMode:this.facingMode}}improviseConstraintsAspect(){return oi()&&this.height&&this.width&&this.height>this.width?{width:this.height,height:this.width}:{width:this.width,height:this.height}}},hs=class{constructor(){this._video=(new cs).build(),this._audio=(new ls).build(),this._screen=(new cs).build(),this._simulcast=!1}video(e){return this._video=e,this}audio(e){return this._audio=e,this}screen(e){return this._screen=e,this}simulcast(e){return this._simulcast=e,this}build(){if(null===this._audio&&null===this._video)throw mi.TracksErrors.NothingToReturn("TRACK");if(null===this._video&&this._simulcast)throw mi.TracksErrors.InvalidVideoSettings("TRACK","Cannot enable simulcast when no video settings are provided");return new ps(this._video,this._audio,this._simulcast,this._screen||void 0)}},ps=class{constructor(e,t,i,s=null){this.video=e,this.audio=t,this.simulcast=i,this.screen=s}toAnalyticsProperties(){let e={audio_enabled:null!==this.audio,video_enabled:null!==this.video};return this.audio&&(e=It(It({},this.audio.toAnalyticsProperties()),e)),this.video&&(e=It(It({},this.video.toAnalyticsProperties()),e)),e}};function vs(e,t){return function(i){return!u()(e[i],t[i])}}var gs,ms,fs=class e extends Di{constructor(e,t,i,s,n=(new ls).build(),r){super(e,t,i),this.eventBus=s,this.room=r,this.TAG="[HMSLocalAudioTrack]",this.tracksCreated=new Set,this.isPublished=!1,this.handleVisibilityChange=()=>Lt(this,null,(function*(){this.shouldReacquireTrack()?"hidden"===document.visibilityState?this.eventBus.analytics.publish(this.sendInterruptionEvent({started:!0,reason:"visibility-change"})):(Yt.d(this.TAG,"On visibile replacing track as it is not publishing"),yield this.replaceTrackWith(this.settings),this.eventBus.analytics.publish(this.sendInterruptionEvent({started:!1,reason:"visibility-change"}))):Yt.d(this.TAG,`visibiltiy: ${document.visibilityState}`,`${this}`)})),this.handleTrackMute=()=>{Yt.d(this.TAG,"muted natively");let e="hidden"===document.visibilityState?"visibility-change":"incoming-call";this.eventBus.analytics.publish(this.sendInterruptionEvent({started:!0,reason:e}))},this.handleTrackUnmute=()=>Lt(this,null,(function*(){Yt.d(this.TAG,"unmuted natively");let e="hidden"===document.visibilityState?"visibility-change":"incoming-call";this.eventBus.analytics.publish(this.sendInterruptionEvent({started:!1,reason:e})),yield this.setEnabled(this.enabled),this.eventBus.localAudioUnmutedNatively.publish()})),this.replaceSenderTrack=()=>Lt(this,null,(function*(){this.transceiver&&"sendonly"===this.transceiver.direction?yield this.transceiver.sender.replaceTrack(this.processedTrack||this.nativeTrack):Yt.d(this.TAG,`transceiver for ${this.trackId} not available or not connected yet`)})),this.shouldReacquireTrack=()=>{var e;return Vi(this.nativeTrack)||this.isTrackNotPublishing()||(null==(e=this.audioLevelMonitor)?void 0:e.isSilentThisInstant())},this.handleSettingsChange=e=>Lt(this,null,(function*(){let t=this.stream,i=vs(e,this.settings);(i("maxBitrate")||i("audioMode"))&&e.maxBitrate&&(yield t.setMaxBitrateAndFramerate(this,e)),(i("advanced")||i("audioMode"))&&(yield this.replaceTrackWith(e))})),this.handleDeviceChange=(e,t=!1)=>Lt(this,null,(function*(){if(vs(e,this.settings)("deviceId")){this.manuallySelectedDeviceId=t?this.manuallySelectedDeviceId:e.deviceId,Yt.d(this.TAG,"device change","manual selection:",this.manuallySelectedDeviceId,"new device:",e.deviceId),yield this.replaceTrackWith(e);let i=this.nativeTrack.getSettings().groupId;!t&&e.deviceId&&(Mi.updateSelection("audioInput",{deviceId:e.deviceId,groupId:i}),this.eventBus.deviceChange.publish({isUserSelection:!0,type:"audioInput",selection:{deviceId:e.deviceId,groupId:i}}))}})),e.tracks.push(this),this.addTrackEventListeners(t),this.settings=n,n.deviceId!==t.getSettings().deviceId&&!Vi(t)&&(this.settings=this.buildNewSettings({deviceId:t.getSettings().deviceId})),this.pluginsManager=new Bi(this,s,r),this.setFirstTrackId(t.id),"regular"===i&&document.addEventListener("visibilitychange",this.handleVisibilityChange)}clone(t){let i=new e(t,this.nativeTrack.clone(),this.source,this.eventBus,this.settings,this.room);return i.peerId=this.peerId,this.pluginsManager.pluginsMap.size>0&&this.pluginsManager.pluginsMap.forEach((e=>{i.addPlugin(e).catch((t=>Yt.e(this.TAG,"Plugin add failed while migrating",e,t)))})),i}getManuallySelectedDeviceId(){return this.manuallySelectedDeviceId}resetManuallySelectedDeviceId(){this.manuallySelectedDeviceId=void 0}updateTrack(e){return Lt(this,null,(function*(){e.enabled=this.enabled,yield this.stream.replaceStreamTrack(this.nativeTrack,e),this.nativeTrack=e,yield this.replaceSenderTrack(),this.audioLevelMonitor&&this.initAudioLevelMonitor()}))}replaceTrackWith(e){return Lt(this,null,(function*(){let t=this.nativeTrack;null==t||t.stop(),this.removeTrackEventListeners(t),this.tracksCreated.forEach((e=>e.stop())),this.tracksCreated.clear();try{let i=yield $i(e);this.addTrackEventListeners(i),this.tracksCreated.add(i),Yt.d(this.TAG,"replaceTrack, Previous track stopped",t,"newTrack",i),yield this.updateTrack(i)}catch(ye){let t=yield $i(this.settings);throw this.addTrackEventListeners(t),this.tracksCreated.add(t),yield this.updateTrack(t),this.isPublished&&this.eventBus.analytics.publish(Ri.publish({error:ye})),ye}try{yield this.pluginsManager.reprocessPlugins()}catch(ye){this.eventBus.audioPluginFailed.publish(ye)}}))}setEnabled(t){return Lt(this,null,(function*(){t!==this.enabled&&(t&&this.shouldReacquireTrack()&&(yield this.replaceTrackWith(this.settings)),yield _t(e.prototype,this,"setEnabled").call(this,t),t&&(this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId})),this.eventBus.localAudioEnabled.publish({enabled:t,track:this}))}))}isPublishedTrackId(e){return this.publishedTrackId===e}setSettings(e,t=!1){return Lt(this,null,(function*(){let i=this.buildNewSettings(e);Vi(this.nativeTrack)||(yield this.handleDeviceChange(i,t),yield this.handleSettingsChange(i)),this.settings=i}))}getPlugins(){return this.pluginsManager.getPlugins()}addPlugin(e){return Lt(this,null,(function*(){return this.pluginsManager.addPlugin(e)}))}removePlugin(e){return Lt(this,null,(function*(){return this.pluginsManager.removePlugin(e)}))}validatePlugin(e){return this.pluginsManager.validatePlugin(e)}setProcessedTrack(e){return Lt(this,null,(function*(){e?e!==this.processedTrack&&(this.processedTrack=e):this.processedTrack=void 0,yield this.replaceSenderTrack()}))}initAudioLevelMonitor(){this.audioLevelMonitor&&this.destroyAudioLevelMonitor(),Yt.d(this.TAG,"Monitor Audio Level for",this,this.getMediaTrackSettings().deviceId),this.audioLevelMonitor=new Zi(this,this.eventBus.trackAudioLevelUpdate,this.eventBus.localAudioSilence),this.audioLevelMonitor.start(),this.audioLevelMonitor.detectSilence()}destroyAudioLevelMonitor(){var e;null==(e=this.audioLevelMonitor)||e.stop(),this.audioLevelMonitor=void 0}cleanup(){return Lt(this,null,(function*(){var t;_t(e.prototype,this,"cleanup").call(this),yield this.pluginsManager.cleanup(),yield this.pluginsManager.closeContext(),this.transceiver=void 0,null==(t=this.processedTrack)||t.stop(),this.tracksCreated.forEach((e=>e.stop())),this.tracksCreated.clear(),this.isPublished=!1,this.destroyAudioLevelMonitor(),document.removeEventListener("visibilitychange",this.handleVisibilityChange)}))}getTrackIDBeingSent(){return this.processedTrack?this.processedTrack.id:this.nativeTrack.id}getTrackBeingSent(){return this.processedTrack||this.nativeTrack}addTrackEventListeners(e){e.addEventListener("mute",this.handleTrackMute),e.addEventListener("unmute",this.handleTrackUnmute)}removeTrackEventListeners(e){e.removeEventListener("mute",this.handleTrackMute),e.removeEventListener("unmute",this.handleTrackUnmute)}buildNewSettings(e){let{volume:t,codec:i,maxBitrate:s,deviceId:n,advanced:r,audioMode:a}=It(It({},this.settings),e);return new ds(t,i,s,n,r,a)}},ys=class e extends Di{setEnabled(t){return Lt(this,null,(function*(){t!==this.enabled&&(yield _t(e.prototype,this,"setEnabled").call(this,t),yield this.subscribeToAudio(t))}))}},ks=class extends Li{constructor(e,t,i){if(super(e,t,i),this.type="video",this.sinkCount=0,this.reTriggerPlay=({videoElement:e})=>{setTimeout((()=>{e.play().catch((e=>{Yt.w("[HMSVideoTrack]","failed to play",e.message)}))}),0)},"video"!==t.kind)throw new Error("Expected 'track' kind = 'video'")}setVideoHandler(e){this.videoHandler=e}hasSinks(){return this.sinkCount>0}getSinks(){return this.videoHandler.getVideoElements()||[]}attach(e){this.videoHandler.addVideoElement(e)}detach(e){this.videoHandler.removeVideoElement(e)}addSink(e){this.addSinkInternal(e,this.nativeTrack)}removeSink(e){null!==e.srcObject&&(e.srcObject=null,this.reduceSinkCount())}cleanup(){super.cleanup(),this.videoHandler.cleanup()}addSinkInternal(e,t){let i=e.srcObject;if(null!==i&&i instanceof MediaStream){let e=i.getVideoTracks()[0];if((null==e?void 0:e.id)===t.id){if(!e.muted&&"live"===e.readyState)return;this.reduceSinkCount()}else this.reduceSinkCount()}this.addPropertiesToElement(e);let s=new MediaStream([t]);e.srcObject=s,this.reTriggerPlay({videoElement:e}),this.sinkCount++}handleTrackUnmute(){this.getSinks().forEach((e=>this.reTriggerPlay({videoElement:e})))}reduceSinkCount(){this.sinkCount>0&&this.sinkCount--}addPropertiesToElement(e){li||(e.autoplay=!0),e.playsInline=!0,e.muted=!0,e.controls=!1}},Ts={none:-1,low:0,medium:1,high:2},bs=(e,t)=>{let i="high",s=t.width>t.height?"width":"height",n=[...e].sort(((e,t)=>Ts[e.layer]-Ts[t.layer])),r=t[s]*((null==window?void 0:window.devicePixelRatio)||1);for(let a=0;a<n.length;a++){let{resolution:e,layer:t}=n[a],o=e[s];if(r<=o){i=t;break}{let e=n[a+1];if((r-o)/((e?e.resolution[s]:Number.POSITIVE_INFINITY)-o)<.5){i=t;break}}}return i},Ss=new class{constructor(){this.TAG="[HMSIntersectionObserverWrapper]",this.listeners=new WeakMap,this.observe=(e,t)=>{var i;this.createObserver(),this.unobserve(e),null==(i=this.intersectionObserver)||i.observe(e),this.listeners.set(e,t)},this.unobserve=e=>{var t;null==(t=this.intersectionObserver)||t.unobserve(e),this.listeners.delete(e)},this.createObserver=()=>{this.isSupported()&&!this.intersectionObserver&&(this.intersectionObserver=new IntersectionObserver(this.handleIntersection))},this.handleIntersection=e=>{var t;for(let i of e)null==(t=this.listeners.get(i.target))||t(i)},this.createObserver()}isSupported(){let e=ri&&"undefined"!=typeof window.IntersectionObserver;return e||Yt.w(this.TAG,"IntersectionObserver is not supported, fallback will be used instead"),e}},Ps=new class{constructor(){this.TAG="[HMSResizeObserverWrapper]",this.listeners=new WeakMap,this.observe=(e,t,i={box:"border-box"})=>{var s;this.createObserver(),this.unobserve(e),null==(s=this.resizeObserver)||s.observe(e,i),this.listeners.set(e,t)},this.unobserve=e=>{var t;null==(t=this.resizeObserver)||t.unobserve(e),this.listeners.delete(e)},this.createObserver=()=>{this.isSupported()&&!this.resizeObserver&&(this.resizeObserver=new ResizeObserver(Yi(this.handleResize,300)))},this.handleResize=e=>{var t;for(let i of e)null==(t=this.listeners.get(i.target))||t(i)},this.createObserver()}isSupported(){let e=ri&&"undefined"!=typeof window.ResizeObserver;return e||Yt.w(this.TAG,"Resize Observer is not supported"),e}},Es=class{constructor(e){this.track=e,this.TAG="[VideoElementManager]",this.videoElements=new Set,this.entries=new WeakMap,this.handleIntersection=e=>Lt(this,null,(function*(){let t="visible"===getComputedStyle(e.target).visibility;this.track.enabled&&(e.isIntersecting&&t||!document.contains(e.target))?(Yt.d(this.TAG,"add sink intersection",`${this.track}`,this.id),this.entries.set(e.target,e.boundingClientRect),yield this.selectMaxLayer(),yield this.track.addSink(e.target)):(Yt.d(this.TAG,"remove sink intersection",`${this.track}`,this.id),yield this.track.removeSink(e.target))})),this.handleResize=e=>Lt(this,null,(function*(){!this.track.enabled||!(this.track instanceof cn)||(this.entries.set(e.target,e.contentRect),yield this.selectMaxLayer())})),this.cleanup=()=>{this.videoElements.forEach((e=>{var t,i;e.srcObject=null,null==(t=this.resizeObserver)||t.unobserve(e),null==(i=this.intersectionObserver)||i.unobserve(e)})),this.videoElements.clear(),this.resizeObserver=void 0,this.intersectionObserver=void 0},this.init(),this.id=(0,d.Z)()}updateSinks(e=!1){for(let t of this.videoElements)this.track.enabled?this.track.addSink(t,e):this.track.removeSink(t,e)}addVideoElement(e){return Lt(this,null,(function*(){var t;this.videoElements.has(e)||(this.init(),Yt.d(this.TAG,`Adding video element for ${this.track}`,this.id),this.videoElements.add(e),this.videoElements.size>=10&&Yt.w(this.TAG,`${this.track}`,`the track is added to ${this.videoElements.size} video elements, while this may be intentional, it's likely that there is a bug leading to unnecessary creation of video elements in the UI`),null!=(t=this.intersectionObserver)&&t.isSupported()?this.intersectionObserver.observe(e,this.handleIntersection):ri&&(this.isElementInViewport(e)?this.track.addSink(e):this.track.removeSink(e)),this.resizeObserver?this.resizeObserver.observe(e,this.handleResize):this.track instanceof cn&&(yield this.track.setPreferredLayer(this.track.getPreferredLayer())))}))}removeVideoElement(e){var t,i;this.track.removeSink(e),this.videoElements.delete(e),this.entries.delete(e),null==(t=this.resizeObserver)||t.unobserve(e),null==(i=this.intersectionObserver)||i.unobserve(e),Yt.d(this.TAG,`Removing video element for ${this.track}`)}getVideoElements(){return Array.from(this.videoElements)}init(){ri&&(this.resizeObserver=Ps,this.intersectionObserver=Ss)}isElementInViewport(e){let t=e.offsetTop,i=e.offsetLeft,s=e.offsetWidth,n=e.offsetHeight,{hidden:r}=e,{opacity:a,display:o}=getComputedStyle(e);for(;e.offsetParent;)t+=(e=e.offsetParent).offsetTop,i+=e.offsetLeft;return t<window.pageYOffset+window.innerHeight&&i<window.pageXOffset+window.innerWidth&&t+n>window.pageYOffset&&i+s>window.pageXOffset&&!r&&(""===a||parseFloat(a)>0)&&"none"!==o}selectMaxLayer(){return Lt(this,null,(function*(){if(!(this.track instanceof cn)||0===this.videoElements.size)return;let e;for(let t of this.videoElements){let i=this.entries.get(t);if(!i)continue;let{width:s,height:n}=i;if(0===s||0===n)continue;let r=bs(this.track.getSimulcastDefinitions(),{width:s,height:n});e=e?Ts[r]>Ts[e]?r:e:r}e&&(Yt.d(this.TAG,`selecting max layer ${e} for the track`,`${this.track}`),yield this.track.setPreferredLayer(e))}))}},Cs=(e=>(e.TRANSFORM="TRANSFORM",e.ANALYZE="ANALYZE",e))(Cs||{}),ws=(e=>(e["2D"]="2d",e.WEBGL="webgl",e.WEBGL2="webgl2",e))(ws||{}),Is=class{constructor(){this.total=0,this.count=0}add(e){this.count++,this.total+=e}getAvg(){return Math.floor(this.total/this.count)}reset(){this.total=0,this.count=0}},As=class{constructor(e){this.eventBus=e,this.TAG="[VideoPluginsAnalytics]",this.initTime={},this.preProcessingAvgs=new Is,this.addedTimestamps={},this.processingAvgs={},this.pluginAdded={},this.pluginInputFrameRate={},this.pluginFrameRate={}}added(e,t,i){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.processingAvgs[e]=new Is,t&&(this.pluginInputFrameRate[e]=t,this.pluginFrameRate[e]=i||t),this.eventBus.analytics.publish(xi.added(e,this.addedTimestamps[e]))}removed(e){var t;if(this.pluginAdded[e]){let i={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],avgPreProcessingTime:this.preProcessingAvgs.getAvg(),avgProcessingTime:null==(t=this.processingAvgs[e])?void 0:t.getAvg(),inputFrameRate:this.pluginInputFrameRate[e],pluginFrameRate:this.pluginFrameRate[e]};this.eventBus.analytics.publish(xi.stats(i)),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(this.eventBus.analytics.publish(xi.failure(e,t)),this.clean(e))}initWithTime(e,t){return Lt(this,null,(function*(){if(this.initTime[e])return void Yt.i(this.TAG,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);let i;try{i=yield this.timeInMs(t),Yt.i(this.TAG,`Time taken for Plugin ${e} initialization : ${i}`)}catch(ye){let i=mi.MediaPluginErrors.InitFailed("VIDEO_PLUGINS",`failed during initialization of plugin${ye.message||ye}`);throw Yt.e(this.TAG,i),this.failure(e,i),i}i&&(this.initTime[e]=i)}))}preProcessWithTime(e){return Lt(this,null,(function*(){let t=yield this.timeInMs(e);this.preProcessingAvgs.add(t)}))}processWithTime(e,t){return Lt(this,null,(function*(){var i;let s;try{s=yield this.timeInMs(t)}catch(we){let i=mi.MediaPluginErrors.ProcessingFailed("VIDEO_PLUGINS",`Failed during processing of plugin${we.message||we}`);throw Yt.e(this.TAG,i),this.failure(e,i),i}s&&(null==(i=this.processingAvgs[e])||i.add(s))}))}timeInMs(e){return Lt(this,null,(function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)}))}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.processingAvgs[e],delete this.pluginAdded[e],delete this.pluginInputFrameRate[e],delete this.pluginFrameRate[e]}},Rs=320,_s=240,Ls=class{constructor(e,t){this.TAG="[VideoPluginsManager]",this.pluginsLoopRunning=!1,this.pluginsLoopState="paused",this.pluginAddInProgress=!1,this.reusableWorker=function(){if("undefined"==typeof Worker)return{sleep:e=>zi(e)};let e=new Worker(URL.createObjectURL(new Blob([Ji],{type:"application/javascript"})));return{sleep:t=>(e.postMessage(["start",t]),new Promise((t=>{e.onmessage=e=>{"tick"===e.data&&t()}})))}}(),this.hmsTrack=e,this.pluginsMap=new Map,this.pluginNumFramesToSkip={},this.pluginNumFramesSkipped={},this.analytics=new As(t),this.canvases=new Array}getPlugins(){return Array.from(this.pluginsMap.keys())}addPlugin(e,t){return Lt(this,null,(function*(){var i;if(this.pluginAddInProgress){let t=null==(i=e.getName)?void 0:i.call(e);if(!t||""===t)return void Yt.w("no name provided by the plugin");let s=mi.MediaPluginErrors.AddAlreadyInProgress("VIDEO_PLUGINS","Add Plugin is already in Progress");throw this.analytics.failure(t,s),Yt.w("can't add another plugin when previous add is in progress"),s}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e,t)}finally{this.pluginAddInProgress=!1}}))}addPluginInternal(e,t){return Lt(this,null,(function*(){var i,s;let n=null==(i=e.getName)?void 0:i.call(e);if(!n||""===n)return void Yt.w("no name provided by the plugin");if(this.pluginsMap.has(n))return void Yt.w(this.TAG,`plugin - ${e.getName()} already added.`);let r=this.hmsTrack.getMediaTrackSettings().frameRate||24,a=0;t&&t>0?(Yt.i(this.TAG,`adding plugin ${e.getName()} with framerate ${t}`),t<r&&(a=Math.ceil(r/t)-1),this.analytics.added(n,r,t)):(Yt.i(this.TAG,`adding plugin ${e.getName()}`),this.analytics.added(n,r)),Yt.i(this.TAG,"numFrames to skip processing",a),this.pluginNumFramesToSkip[n]=a,this.pluginNumFramesSkipped[n]=a,this.validateAndThrow(n,e);try{if(yield this.analytics.initWithTime(n,(()=>Lt(this,null,(function*(){return yield e.init()})))),this.pluginsMap.set(n,e),this.pluginsMap.size+1>this.canvases.length)for(let e=this.canvases.length;e<=this.pluginsMap.size;e++)this.canvases[e]=document.createElement("canvas");yield this.startPluginsLoop(null==(s=e.getContextType)?void 0:s.call(e))}catch(_e){throw Yt.e(this.TAG,"failed to add plugin",_e),yield this.removePlugin(e),_e}}))}validatePlugin(e){return e.checkSupport()}validateAndThrow(e,t){let i=this.validatePlugin(t);if(i.isSupported)Yt.i(this.TAG,`plugin is supported,- ${t.getName()}`);else{let t;switch(i.errType){case"PLATFORM_NOT_SUPPORTED":throw t=mi.MediaPluginErrors.PlatformNotSupported("VIDEO_PLUGINS","platform not supported, see docs"),this.analytics.failure(e,t),t;case"DEVICE_NOT_SUPPORTED":throw t=mi.MediaPluginErrors.DeviceNotSupported("VIDEO_PLUGINS","video device not supported, see docs"),this.analytics.failure(e,t),t}}}removePlugin(e){return Lt(this,null,(function*(){let t=e.getName();this.pluginsMap.get(t)?(Yt.i(this.TAG,`removing plugin ${t}`),this.removePluginEntry(t),0===this.pluginsMap.size&&(Yt.i(this.TAG,"No plugins left, stopping plugins loop"),yield this.stopPluginsLoop()),e.stop(),this.analytics.removed(t)):Yt.w(this.TAG,`plugin - ${t} not found to remove.`)}))}removePluginEntry(e){this.pluginsMap.delete(e),this.pluginNumFramesToSkip[e]&&delete this.pluginNumFramesToSkip[e],this.pluginNumFramesSkipped[e]&&delete this.pluginNumFramesSkipped[e]}waitForRestart(){return Lt(this,null,(function*(){if(this.pluginsLoopRunning&&"running"!==this.pluginsLoopState)for(;"paused"===this.pluginsLoopState;)yield Qi(100)}))}cleanup(){return Lt(this,null,(function*(){var e;for(let t of this.pluginsMap.values())yield this.removePlugin(t);null==(e=this.outputTrack)||e.stop()}))}initElementsAndStream(e){this.inputCanvas||(this.inputCanvas=document.createElement("canvas")),this.outputCanvas=document.createElement("canvas"),this.inputVideo||(this.inputVideo=document.createElement("video")),this.inputCanvas.getContext("2d"),this.outputCanvas.getContext(e||"2d");let t=this.outputCanvas.captureStream();this.outputTrack=t.getVideoTracks()[0]}startPluginsLoop(e){return Lt(this,null,(function*(){if(!this.pluginsLoopRunning){this.initElementsAndStream(e),this.pluginsLoopRunning=!0;try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(ke){throw this.pluginsLoopRunning=!1,Yt.e(this.TAG,"error in setting processed track",ke),ke}this.pluginsLoop().then((()=>{Yt.d(this.TAG,"processLoop stopped")}))}}))}stopPluginsLoop(){return Lt(this,null,(function*(){var e;this.pluginsLoopRunning=!1,yield this.hmsTrack.setProcessedTrack(void 0),this.resetCanvases(),null==(e=this.outputTrack)||e.stop(),this.inputVideo&&(this.inputVideo.srcObject=null,this.inputVideo=void 0)}))}pluginsLoop(){return Lt(this,null,(function*(){for(;this.pluginsLoopRunning;){let e=this.hmsTrack.getMediaTrackSettings().frameRate||24,t=Math.floor(1e3/e);if(!this.hmsTrack.enabled||"ended"===this.hmsTrack.nativeTrack.readyState){"running"===this.pluginsLoopState&&this.resetCanvases(),this.pluginsLoopState="paused",yield this.reusableWorker.sleep(t);continue}let i=0;try{yield this.analytics.preProcessWithTime((()=>Lt(this,null,(function*(){return yield this.doPreProcessing()}))));let e=Date.now();yield this.processFramesThroughPlugins(),i=Math.floor(Date.now()-e),i>t&&(i=t)}catch(ye){Yt.e(this.TAG,"error in plugins loop",ye)}this.pluginsLoopState="running",yield this.reusableWorker.sleep(t-i)}}))}doPreProcessing(){return Lt(this,null,(function*(){yield this.addTrackToVideo(),yield this.updateInputCanvas()}))}processFramesThroughPlugins(){return Lt(this,null,(function*(){this.canvases[0]=this.inputCanvas;let e=0;for(let t of this.pluginsMap.values()){let i=t.getName();if(t){try{let s=this.checkIfSkipRequired(i);if("TRANSFORM"===t.getPluginType()){let n=(e,n)=>Lt(this,null,(function*(){try{yield t.processVideoFrame(e,n,s)}catch(_e){Yt.e(this.TAG,`error in processing plugin ${i}`,_e)}}));if(s)e===this.pluginsMap.size-1?yield n(this.canvases[e],this.outputCanvas):yield n(this.canvases[e],this.canvases[e+1]);else{let t=this.canvases[e],s=this.canvases[e+1];e===this.pluginsMap.size-1?yield this.analytics.processWithTime(i,(()=>Lt(this,null,(function*(){return n(t,this.outputCanvas)})))):yield this.analytics.processWithTime(i,(()=>Lt(this,null,(function*(){return n(t,s)}))))}}else"ANALYZE"===t.getPluginType()&&!s&&(yield this.analytics.processWithTime(i,(()=>Lt(this,null,(function*(){return yield t.processVideoFrame(this.inputCanvas)})))))}catch(ye){Yt.e(this.TAG,`error in processing plugin ${i}`,ye),yield this.removePlugin(t)}e++}}}))}addTrackToVideo(){return Lt(this,null,(function*(){var e;if(!this.inputVideo)return;let t=this.inputVideo.srcObject;null!==t&&t instanceof MediaStream&&(null==(e=t.getVideoTracks()[0])?void 0:e.id)===this.hmsTrack.nativeTrack.id||(this.inputVideo.pause(),this.inputVideo.srcObject=new MediaStream([this.hmsTrack.nativeTrack]),this.inputVideo.muted=!0,this.inputVideo.playsInline=!0,yield this.inputVideo.play())}))}updateInputCanvas(){return Lt(this,null,(function*(){if(!this.inputCanvas||!this.inputVideo)return;let{width:e=Rs,height:t=_s}=this.hmsTrack.getMediaTrackSettings();this.inputCanvas.height!==t&&(this.inputCanvas.height=t),this.inputCanvas.width!==e&&(this.inputCanvas.width=e),this.inputCanvas.getContext("2d").drawImage(this.inputVideo,0,0,e,t)}))}resetCanvases(){if(!this.outputCanvas||!this.inputCanvas)return;let e=this.inputCanvas.getContext("2d");e&&(e.fillStyle="rgb(0, 0, 0)",e.fillRect(0,0,this.outputCanvas.width,this.outputCanvas.height)),this.canvases=[]}checkIfSkipRequired(e){let t=!1;return this.pluginNumFramesSkipped[e]<this.pluginNumFramesToSkip[e]?(this.pluginNumFramesSkipped[e]++,t=!0):(t=!1,this.pluginNumFramesSkipped[e]=0),t}},Ds=class{constructor(e,t){this.TAG="[MediaStreamPluginsManager]",this.plugins=new Set,this.analytics=new As(e),this.room=t}addPlugins(e){e.forEach((e=>{var t;if("HMSEffectsPlugin"===e.getName())if(null==(t=this.room)||!t.isEffectsEnabled){let e="Effects Virtual Background is not enabled for this room";if(0===this.plugins.size)throw Error(e);return void Yt.w(this.TAG,e)}this.plugins.add(e)}))}removePlugins(e){e.forEach((e=>{e.stop(),this.analytics.removed(e.getName()),this.plugins.delete(e)}))}applyPlugins(e){let t=e;for(let i of this.plugins){let e=i.getName();try{t=i.apply(t),this.analytics.added(e)}catch(we){this.analytics.failure(e,we),Yt.e("Could not apply plugin",we,e)}}return t}getPlugins(){return Array.from(this.plugins).map((e=>e.getName()))}},Ms=["init_response_time","ws_connect_time","on_policy_change_time","local_audio_track_time","local_video_track_time","peer_list_time","room_state_time","join_response_time"],Ns=class{constructor(){this.eventPerformanceMeasures={}}start(e){performance.mark(e)}end(e){var t;try{this.eventPerformanceMeasures[e]=performance.measure(e,e),Yt.d("[HMSPerformanceTiming]",e,null==(t=this.eventPerformanceMeasures[e])?void 0:t.duration)}catch(Te){Yt.w("[AnalyticsTimer]",`Error in measuring performance for event ${e}`,{error:Te})}}getTimeTaken(e){var t;return null==(t=this.eventPerformanceMeasures[e])?void 0:t.duration}getTimes(...e){return[...Ms,...e].reduce(((e,t)=>At(It({},e),{[t]:this.getTimeTaken(t)})),{})}cleanup(){this.eventPerformanceMeasures={}}},Os={isAudioMuted:!1,isVideoMuted:!1,audioInputDeviceId:"default",audioOutputDeviceId:"default",videoDeviceId:"default",audioMode:"voice"},xs=class e{constructor(e,t,i,s,n){this.store=e,this.observer=t,this.deviceManager=i,this.eventBus=s,this.analyticsTimer=n,this.TAG="[LocalTrackManager]",this.setScreenCaptureHandleConfig()}getTracksToPublish(){return Lt(this,arguments,(function*(e=Os){let t=this.getAVTrackSettings(e);if(!t)return[];let i=!!t.audio,s=!!t.video,n=[],{videoTrack:r,audioTrack:a}=yield this.updateCurrentLocalTrackSettings(t),o=(null==r?void 0:r.stream)||(null==a?void 0:a.stream),l=!(!r||!this.store.getTrackById(r.trackId)),d=!(!a||!this.store.getTrackById(a.trackId));if(l&&d)return[];let c={audio:i&&!a&&(!e.isAudioMuted||"empty"),video:s&&!r&&(!e.isVideoMuted||"empty")};c.audio&&this.analyticsTimer.start("local_audio_track_time"),c.video&&this.analyticsTimer.start("local_video_track_time");try{Yt.d(this.TAG,"Init Local Tracks",{fetchTrackOptions:c}),n=yield this.getLocalTracks(c,t,o)}catch(u){n=yield this.retryGetLocalTracks(u,t,c,o)}return c.audio&&this.analyticsTimer.end("local_audio_track_time"),c.video&&this.analyticsTimer.end("local_video_track_time"),r&&s&&!l&&n.push(r),a&&i&&!d&&n.push(a),n}))}getLocalTracks(){return Lt(this,arguments,(function*(e={audio:!0,video:!0},t,i){try{let s=yield this.getNativeLocalTracks(e,t);return this.createHMSLocalTracks(s,t,i)}catch(ye){throw this.eventBus.analytics.publish(Ri.publish({devices:this.deviceManager.getDevices(),error:ye,settings:t})),ye}}))}getNativeLocalTracks(){return Lt(this,arguments,(function*(e={audio:!1,video:!1},t){let i=new ps(!0===e.video?t.video:null,!0===e.audio?t.audio:null,t.simulcast),s=[];return(i.audio||i.video)&&s.push(...yield this.getAVTracks(i)),s.push(...this.getEmptyTracks(e)),s}))}optimizeScreenShareConstraint(e,t){return Lt(this,null,(function*(){var i,s,n;if("boolean"==typeof t.video||null==(i=t.video)||!i.width||null==(s=t.video)||!s.height)return;let r=this.store.getPublishParams();if(!r||null==(n=r.allowed)||!n.includes("screen"))return;let a=document.createElement("video");a.srcObject=e,a.addEventListener("loadedmetadata",(()=>Lt(this,null,(function*(){let{videoWidth:i,videoHeight:s}=a,n=r.screen,o=n.width*n.height,l=i/s,d=n.width/n.height;if(l>d){let n=t.video,r=l/d,a=Math.sqrt(r);i*s>o?(n.width=i/a,n.height=s/a):(n.height=s*a,n.width=i*a),yield e.getVideoTracks()[0].applyConstraints(n)}}))))}))}getLocalScreen(e,t=!1){return Lt(this,null,(function*(){var i;let s,n=yield this.getOrDefaultScreenshareConfig(e),r=this.getScreenshareSettings(n.videoOnly),a={video:At(It({},null==r?void 0:r.video.toConstraints(!0)),{displaySurface:n.displaySurface}),preferCurrentTab:n.preferCurrentTab,selfBrowserSurface:n.selfBrowserSurface,surfaceSwitching:n.surfaceSwitching,systemAudio:n.systemAudio};if(null!=r&&r.audio){let e=null==(i=null==r?void 0:r.audio)?void 0:i.toConstraints();delete e.advanced,a.audio=At(It({},e),{autoGainControl:!1,noiseSuppression:!1,googAutoGainControl:!1,echoCancellation:!1})}else null!=e&&e.forceCurrentTab&&e.preferCurrentTab&&e.cropElement&&(a.audio={echoCancellation:!0,noiseSuppression:!0});try{Yt.d("retrieving screenshare with ",{config:n},{constraints:a}),s=yield navigator.mediaDevices.getDisplayMedia(a),t&&(yield this.optimizeScreenShareConstraint(s,a))}catch(xe){Yt.w(this.TAG,"error in getting screenshare - ",xe);let t=Gi(xe,"screen");throw this.eventBus.analytics.publish(Ri.publish({error:t,devices:this.deviceManager.getDevices(),settings:new ps(null==r?void 0:r.video,null==r?void 0:r.audio,!1)})),t}let o=[],l=new hn(s),d=s.getVideoTracks()[0],c=new Bs(l,d,"screen",this.eventBus,null==r?void 0:r.video,this.store.getRoom());c.setSimulcastDefinitons(this.store.getSimulcastDefinitionsForPeer(this.store.getLocalPeer(),"screen"));try{let e=this.validateCurrentTabCapture(c,n.forceCurrentTab);c.isCurrentTab=e,yield c.cropTo(n.cropTarget)}catch(xe){throw s.getTracks().forEach((e=>e.stop())),xe}o.push(c);let u=s.getAudioTracks()[0];if(u){let e=new fs(l,u,"screen",this.eventBus,null==r?void 0:r.audio,this.store.getRoom());o.push(e)}return Yt.v(this.TAG,"getLocalScreen",o),o}))}setScreenCaptureHandleConfig(e){var t;null==(t=navigator.mediaDevices)||!t.setCaptureHandleConfig||this.isInIframe()||(e=e||{},Object.assign(e,{handle:(0,d.Z)(),exposeOrigin:!1,permittedOrigins:[window.location.origin]}),Yt.d("setting capture handle - ",e.handle),navigator.mediaDevices.setCaptureHandleConfig(e),this.captureHandleIdentifier=e.handle)}validateCurrentTabCapture(e,t){let i=e.getCaptureHandle(),s=!(!this.captureHandleIdentifier||(null==i?void 0:i.handle)!==this.captureHandleIdentifier);if(t&&!s)throw Yt.e(this.TAG,"current tab was not shared with forceCurrentTab as true"),mi.TracksErrors.CurrentTabNotShared();return s}requestPermissions(){return Lt(this,null,(function*(){try{(yield navigator.mediaDevices.getUserMedia({audio:!0,video:!0})).getTracks().forEach((e=>e.stop()))}catch(e){Yt.e(this.TAG,e)}}))}static getEmptyVideoTrack(e){var t,i,s;let n=(null==(t=null==e?void 0:e.getSettings())?void 0:t.width)||320,r=(null==(i=null==e?void 0:e.getSettings())?void 0:i.height)||240;gs||((gs=document.createElement("canvas")).width=n,gs.height=r,null==(s=gs.getContext("2d"))||s.fillRect(0,0,n,r)),ms||(ms=setInterval((()=>{let e=null==gs?void 0:gs.getContext("2d");e&&e.fillRect(0,0,1,1)}),1e3));let a=gs.captureStream(1).getVideoTracks()[0];return a.enabled=!1,a}static getEmptyAudioTrack(){let e=Wi.getAudioContext(),t=e.createOscillator(),i=e.createMediaStreamDestination();t.connect(i),t.start();let s=i.stream.getAudioTracks()[0];return s.enabled=!1,s}static cleanup(){clearInterval(ms),ms=void 0,gs=void 0}getAVTracks(e){return Lt(this,null,(function*(){try{let t=yield navigator.mediaDevices.getUserMedia({audio:!!e.audio&&e.audio.toConstraints(),video:!!e.video&&e.video.toConstraints()});return t.getVideoTracks().concat(t.getAudioTracks())}catch(ke){yield this.deviceManager.init();let i=!(this.deviceManager.hasWebcamPermission||!e.video),s=!(this.deviceManager.hasMicrophonePermission||!e.audio);throw Gi(ke,this.getErrorType(i,s))}}))}getAVTrackSettings(e){let t=this.getAudioSettings(e),i=this.getVideoSettings(e);return t||i?(new hs).video(i).audio(t).build():null}isInIframe(){try{return window.self!==window.top}catch(e){return!0}}retryGetLocalTracks(e,t,i,s){return Lt(this,null,(function*(){if(!(e instanceof pi&&"TRACK"===e.action))return Yt.w(this.TAG,"Fetch AV Tracks failed - unknown exception",e),this.observer.onFailure(e),[];{this.observer.onFailure(e);let n=e.code===hi.TracksErrors.OVER_CONSTRAINED,r=e.message.includes("audio"),a=e.message.includes("video");if(n){let n=(new hs).video(new us).audio(new ds).build();Yt.w(this.TAG,"Fetch AV Tracks failed with overconstrained error",{fetchTrackOptions:i},{error:e});try{return yield this.getLocalTracks(i,n,s)}catch(Se){let n=Se instanceof pi?Se.nativeError:Se,r=Se;if("OverconstrainedError"===(null==n?void 0:n.name)){let e=mi.TracksErrors.GenericTrack("TRACK","Overconstrained error after dropping all constraints");e.addNativeError(n),r=e}return yield this.retryGetLocalTracks(r,t,i,s)}}i.audio=r?"empty":i.audio,i.video=a?"empty":i.video,Yt.w(this.TAG,"Fetch AV Tracks failed",{fetchTrackOptions:i},e);try{return yield this.getLocalTracks(i,t,s)}catch(_e){return Yt.w(this.TAG,"Fetch empty tacks failed",_e),i.audio=i.audio&&"empty",i.video=i.video&&"empty",this.observer.onFailure(_e),yield this.getLocalTracks(i,t,s)}}}))}getErrorType(e,t){return e&&t?"audio, video":e?"video":t?"audio":"unknown(video or audio)"}getEmptyTracks(t){let i=[];return"empty"===t.audio&&i.push(e.getEmptyAudioTrack()),"empty"===t.video&&i.push(e.getEmptyVideoTrack()),i}updateCurrentLocalTrackSettings(e){return Lt(this,null,(function*(){let t=this.store.getLocalPeerTracks(),i=t.find((e=>"video"===e.type&&"regular"===e.source)),s=t.find((e=>"audio"===e.type&&"regular"===e.source)),n=t.find((e=>"video"===e.type&&"screen"===e.source));null!=e&&e.video&&(yield null==i?void 0:i.setSettings(e.video)),null!=e&&e.audio&&(yield null==s?void 0:s.setSettings(e.audio));let r=this.getScreenshareSettings(!0);return null!=r&&r.video&&(yield null==n?void 0:n.setSettings(null==r?void 0:r.video)),{videoTrack:i,audioTrack:s}}))}getAudioSettings(e){var t;let i=this.store.getPublishParams();if(!i||null==(t=i.allowed)||!t.includes("audio"))return null;let s=this.store.getLocalPeer(),n=null==s?void 0:s.audioTrack,r=(null==n?void 0:n.settings.deviceId)||e.audioInputDeviceId;return(new ls).codec(i.audio.codec).maxBitrate(i.audio.bitRate).deviceId(r||Os.audioInputDeviceId).build()}getVideoSettings(e){var t;let i=this.store.getPublishParams();if(!i||null==(t=i.allowed)||!t.includes("video"))return null;let s=this.store.getLocalPeer(),n=null==s?void 0:s.videoTrack,r=(null==n?void 0:n.settings.deviceId)||e.videoDeviceId,a=i.video;return(new cs).codec(a.codec).maxBitrate(a.bitRate).maxFramerate(a.frameRate).setWidth(a.width).setHeight(a.height).deviceId(r||Os.videoDeviceId).build()}getScreenshareSettings(e=!1){var t;let i=this.store.getPublishParams();if(!i||null==(t=i.allowed)||!t.includes("screen"))return null;let s=i.screen;return{video:(new cs).maxBitrate(s.bitRate,!1).codec(s.codec).maxFramerate(s.frameRate).setWidth(s.width).setHeight(s.height).build(),audio:e?void 0:(new ls).build()}}getOrDefaultScreenshareConfig(e){return Lt(this,null,(function*(){var t;let i=Object.assign({videoOnly:!1,audioOnly:!1,forceCurrentTab:!1,preferCurrentTab:!1,selfBrowserSurface:"exclude",surfaceSwitching:"include",systemAudio:"exclude",displaySurface:"monitor"},e||{});return i.forceCurrentTab&&(i.videoOnly=!0,i.preferCurrentTab=!0,i.selfBrowserSurface="include",i.surfaceSwitching="exclude"),i.preferCurrentTab&&(i.selfBrowserSurface="include",i.displaySurface=void 0),i.cropElement&&null!=(t=window.CropTarget)&&t.fromElement&&(i.cropTarget=yield window.CropTarget.fromElement(i.cropElement)),i}))}createHMSLocalTracks(e,t,i){let s=e.find((e=>"video"===e.kind)),n=e.find((e=>"audio"===e.kind));i?e.forEach((e=>null==i?void 0:i.nativeStream.addTrack(e))):i=new hn(new MediaStream(e));let r=[];if(n&&null!=t&&t.audio){let e=new fs(i,n,"regular",this.eventBus,t.audio,this.store.getRoom());r.push(e)}if(s&&null!=t&&t.video){let e=new Bs(i,s,"regular",this.eventBus,t.video,this.store.getRoom());e.setSimulcastDefinitons(this.store.getSimulcastDefinitionsForPeer(this.store.getLocalPeer(),"regular")),r.push(e)}return r}};function Us(e,t){return function(i){return!u()(e[i],t[i])}}var Bs=class e extends ks{constructor(e,t,i,s,n=(new cs).build(),r){super(e,t,i),this.eventBus=s,this.room=r,this._layerDefinitions=[],this.TAG="[HMSLocalVideoTrack]",this.enabledStateBeforeBackground=!1,this.isCurrentTab=!1,this.isPublished=!1,this.replaceSenderTrack=e=>Lt(this,null,(function*(){this.transceiver&&"sendonly"===this.transceiver.direction?yield this.transceiver.sender.replaceTrack(e):Yt.d(this.TAG,`transceiver for ${this.trackId} not available or not connected yet`)})),this.buildNewSettings=e=>{let{width:t,height:i,codec:s,maxFramerate:n,maxBitrate:r,deviceId:a,advanced:o,facingMode:l}=It(It({},this.settings),e);return new us(t,i,s,n,a,o,r,l)},this.handleSettingsChange=e=>Lt(this,null,(function*(){let t=this.stream,i=Us(e,this.settings);if(i("maxBitrate")&&e.maxBitrate&&(yield t.setMaxBitrateAndFramerate(this)),i("width")||i("height")||i("advanced"))if("video"===this.source){let t=yield this.replaceTrackWith(e);yield this.replaceSender(t,this.enabled),this.nativeTrack=t,yield this.processPlugins(),this.videoHandler.updateSinks()}else yield this.nativeTrack.applyConstraints(e.toConstraints())})),this.handleDeviceChange=(e,t=!1)=>Lt(this,null,(function*(){if(Us(e,this.settings)("deviceId")&&"regular"===this.source){if(this.enabled){delete e.facingMode;let t=yield this.replaceTrackWith(e);yield this.replaceSender(t,this.enabled),this.nativeTrack=t,yield this.processPlugins(),this.videoHandler.updateSinks()}let i=this.nativeTrack.getSettings().groupId;!t&&e.deviceId&&(Mi.updateSelection("videoInput",{deviceId:e.deviceId,groupId:i}),this.eventBus.deviceChange.publish({isUserSelection:!0,type:"video",selection:{deviceId:e.deviceId,groupId:i}}))}})),this.handleTrackMute=()=>{Yt.d(this.TAG,"muted natively"),this.eventBus.analytics.publish(this.sendInterruptionEvent({started:!0,reason:"incoming-call"})),this.eventBus.localVideoEnabled.publish({enabled:!1,track:this})},this.handleTrackUnmuteNatively=()=>Lt(this,null,(function*(){Yt.d(this.TAG,"unmuted natively"),this.eventBus.analytics.publish(this.sendInterruptionEvent({started:!1,reason:"incoming-call"})),this.handleTrackUnmute(),this.eventBus.localVideoEnabled.publish({enabled:this.enabled,track:this}),this.eventBus.localVideoUnmutedNatively.publish(),yield this.setEnabled(this.enabled)})),this.removeOrReplaceProcessedTrack=e=>Lt(this,null,(function*(){e?e!==this.processedTrack&&(this.processedTrack=e):this.processedTrack=void 0,yield this.replaceSenderTrack(this.processedTrack||this.nativeTrack)})),this.handleVisibilityChange=()=>Lt(this,null,(function*(){"hidden"===document.visibilityState?(this.enabledStateBeforeBackground=this.enabled,this.enabled&&(yield this.setEnabled(!1)),this.eventBus.analytics.publish(this.sendInterruptionEvent({started:!0,reason:"visibility-change"}))):(Yt.d(this.TAG,"visibility visible, restoring track state",this.enabledStateBeforeBackground),this.enabledStateBeforeBackground&&(yield this.setEnabled(!0)),this.eventBus.analytics.publish(this.sendInterruptionEvent({started:!1,reason:"visibility-change"})))})),this.addTrackEventListeners(t),e.tracks.push(this),this.setVideoHandler(new Es(this)),this.settings=n,n.deviceId!==t.getSettings().deviceId&&t.enabled&&(this.settings=this.buildNewSettings({deviceId:t.getSettings().deviceId})),this.pluginsManager=new Ls(this,s),this.mediaStreamPluginsManager=new Ds(s,r),this.setFirstTrackId(this.trackId),this.eventBus.localAudioUnmutedNatively.subscribe(this.handleTrackUnmute),ri&&"regular"===i&&oi()&&document.addEventListener("visibilitychange",this.handleVisibilityChange)}clone(t){let i=new e(t,this.nativeTrack.clone(),this.source,this.eventBus,this.settings,this.room);return i.peerId=this.peerId,this.pluginsManager.pluginsMap.size>0&&this.pluginsManager.pluginsMap.forEach((e=>{i.addPlugin(e).catch((t=>Yt.e(this.TAG,"Plugin add failed while migrating",e,t)))})),this.mediaStreamPluginsManager.plugins.size>0&&i.addStreamPlugins(Array.from(this.mediaStreamPluginsManager.plugins)),i}setSimulcastDefinitons(e){this._layerDefinitions=e}getSimulcastDefinitions(){return this._layerDefinitions}setEnabled(t){return Lt(this,null,(function*(){var i;if(t!==this.enabled){if("regular"===this.source){let s;s=t?yield this.replaceTrackWith(this.settings):yield this.replaceTrackWithBlank(),yield this.replaceSender(s,t),null==(i=this.nativeTrack)||i.stop(),this.nativeTrack=s,yield _t(e.prototype,this,"setEnabled").call(this,t),t&&(yield this.pluginsManager.waitForRestart(),yield this.processPlugins(),this.settings=this.buildNewSettings({deviceId:s.getSettings().deviceId})),this.videoHandler.updateSinks()}this.eventBus.localVideoEnabled.publish({enabled:t,track:this})}}))}processPlugins(){return Lt(this,null,(function*(){try{if(this.pluginsManager.getPlugins().length>0)return;if(this.mediaStreamPluginsManager.getPlugins().length>0){let e=this.mediaStreamPluginsManager.applyPlugins(new MediaStream([this.nativeTrack])).getVideoTracks()[0];yield this.setProcessedTrack(e)}else yield this.setProcessedTrack();this.videoHandler.updateSinks()}catch(ke){console.error("error in processing plugin(s)",ke)}}))}addStreamPlugins(e){return Lt(this,null,(function*(){if(this.pluginsManager.getPlugins().length>0)throw Error("Plugins of type HMSMediaStreamPlugin and HMSVideoPlugin cannot be used together");this.mediaStreamPluginsManager.addPlugins(e),yield this.processPlugins()}))}removeStreamPlugins(e){return Lt(this,null,(function*(){this.mediaStreamPluginsManager.removePlugins(e),yield this.processPlugins()}))}isPublishedTrackId(e){return this.publishedTrackId===e}addSink(e){this.addSinkInternal(e,this.processedTrack||this.nativeTrack)}setSettings(e,t=!1){return Lt(this,null,(function*(){let i=this.buildNewSettings(e);yield this.handleDeviceChange(i,t),this.enabled&&!Vi(this.nativeTrack)?(yield this.pluginsManager.waitForRestart(),yield this.handleSettingsChange(i),this.settings=i):this.settings=i}))}getPlugins(){return this.mediaStreamPluginsManager.getPlugins().length>0?this.mediaStreamPluginsManager.getPlugins():this.pluginsManager.getPlugins()}addPlugin(e,t){return Lt(this,null,(function*(){if(this.mediaStreamPluginsManager.getPlugins().length>0)throw Error("Plugins of type HMSVideoPlugin and HMSMediaStreamPlugin cannot be used together");return this.pluginsManager.addPlugin(e,t)}))}removePlugin(e){return Lt(this,null,(function*(){return this.pluginsManager.removePlugin(e)}))}validatePlugin(e){return this.pluginsManager.validatePlugin(e)}cleanup(){return Lt(this,null,(function*(){var t;this.eventBus.localAudioUnmutedNatively.unsubscribe(this.handleTrackUnmute),this.removeTrackEventListeners(this.nativeTrack),_t(e.prototype,this,"cleanup").call(this),this.transceiver=void 0,yield this.pluginsManager.cleanup(),null==(t=this.processedTrack)||t.stop(),this.isPublished=!1,ri&&oi()&&document.removeEventListener("visibilitychange",this.handleVisibilityChange)}))}cropTo(e){return Lt(this,null,(function*(){if(e&&"screen"===this.source)try{this.nativeTrack.cropTo&&(yield this.nativeTrack.cropTo(e))}catch(Te){throw Yt.e(this.TAG,"failed to crop screenshare capture - ",Te),mi.TracksErrors.GenericTrack("TRACK","failed to crop screenshare capture")}}))}getCaptureHandle(){if(this.nativeTrack.getCaptureHandle)return this.nativeTrack.getCaptureHandle()}setProcessedTrack(e){return Lt(this,null,(function*(){this.nativeTrack.enabled?(yield this.removeOrReplaceProcessedTrack(e),this.videoHandler.updateSinks()):this.processedTrack=e}))}getTrackIDBeingSent(){return this.getTrackBeingSent().id}getTrackBeingSent(){return this.enabled&&this.processedTrack||this.nativeTrack}switchCamera(){return Lt(this,null,(function*(){var e;let t=this.getMediaTrackSettings().facingMode;if(!t||"regular"!==this.source)return void Yt.d(this.TAG,"facingMode not supported");let i="environment"===t?"user":"environment";null==(e=this.nativeTrack)||e.stop();let s=yield this.replaceTrackWith(this.buildNewSettings({facingMode:i,deviceId:void 0}));yield this.replaceSender(s,this.enabled),this.nativeTrack=s,yield this.processPlugins(),this.videoHandler.updateSinks(),this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId,facingMode:i}),Mi.updateSelection("videoInput",{deviceId:this.settings.deviceId,groupId:this.nativeTrack.getSettings().groupId})}))}replaceTrackWith(e){return Lt(this,null,(function*(){let t=this.nativeTrack;this.removeTrackEventListeners(t),null==t||t.stop();try{let i=yield ji(e);return this.addTrackEventListeners(i),Yt.d(this.TAG,"replaceTrack, Previous track stopped",t,"newTrack",i),"default"===this.settings.deviceId&&(this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId})),i}catch(ye){let t=yield ji(this.settings);throw this.addTrackEventListeners(t),yield this.replaceSender(t,this.enabled),this.nativeTrack=t,yield this.processPlugins(),this.videoHandler.updateSinks(),this.isPublished&&this.eventBus.analytics.publish(Ri.publish({error:ye})),ye}}))}replaceTrackWithBlank(){return Lt(this,null,(function*(){let e=this.nativeTrack,t=xs.getEmptyVideoTrack(e);return this.removeTrackEventListeners(e),this.addTrackEventListeners(t),null==e||e.stop(),Yt.d(this.TAG,"replaceTrackWithBlank, Previous track stopped",e,"newTrack",t),t}))}replaceSender(e,t){return Lt(this,null,(function*(){t?yield this.replaceSenderTrack(this.processedTrack||e):yield this.replaceSenderTrack(e),this.stream.replaceStreamTrack(this.nativeTrack,e)}))}addTrackEventListeners(e){e.addEventListener("mute",this.handleTrackMute),e.addEventListener("unmute",this.handleTrackUnmuteNatively)}removeTrackEventListeners(e){e.removeEventListener("mute",this.handleTrackMute),e.removeEventListener("unmute",this.handleTrackUnmuteNatively)}},Fs="renegotiation-callback-id",Gs="ion-sfu",$s="SUBSCRIBE_ICE_CONNECTION_CALLBACK_ID",js=Math.pow(2,31)-1,Vs="device-change",Ws="local-audio-enabled",Hs="local-video-enabled",qs="local-video-unmuted-natively",Ks="local-audio-unmuted-natively",Js="stats-update",zs="track-degraded",Qs="track-restored",Ys="track-audio-level-update",Zs="local-audio-silence",Xs="analytics",en="audio-plugin-failed",tn="policy-change",sn="local-role-update",nn="audio-track-update",rn="audio-track-added",an="audio-track-removed",on="autoplay-error",ln="leave",dn="_handraise",cn=class e extends ks{constructor(e,t,i,s){super(e,t,i),this._degraded=!1,this._degradedAt=null,this._layerDefinitions=[],this.history=new un,this.preferredLayer="high",this.disableNoneLayerRequest=!1,this.disableNoneLayerRequest=!!s,this.setVideoHandler(new Es(this))}setTrackId(e){this.bizTrackId=e}get trackId(){return this.bizTrackId||super.trackId}get degraded(){return this._degraded}get degradedAt(){return this._degradedAt}setEnabled(t){return Lt(this,null,(function*(){t!==this.enabled&&(_t(e.prototype,this,"setEnabled").call(this,t),this.videoHandler.updateSinks(!0))}))}setPreferredLayer(e){return Lt(this,null,(function*(){if("none"!==e){if(this.preferredLayer=e,this.shouldSendVideoLayer(e,"preferLayer")){if(!this.hasSinks())return void Yt.d(`[Remote Track] ${this.logIdentifier}\n        streamId=${this.stream.id} \n        trackId=${this.trackId}\n        saving ${e}, source=${this.source}\n        Track does not have any sink`);yield this.requestLayer(e,"preferLayer"),this.pushInHistory(`uiPreferLayer-${e}`)}}else Yt.w("layer none will be ignored")}))}getSimulcastLayer(){return this.stream.getSimulcastLayer()}getLayer(){return this.stream.getVideoLayer()}getPreferredLayer(){return this.preferredLayer}getPreferredLayerDefinition(){return this._layerDefinitions.find((e=>e.layer===this.preferredLayer))}replaceTrack(e){this.nativeTrack=e.nativeTrack,e.transceiver&&(this.transceiver=e.transceiver,this.stream.updateId(e.stream.id)),this.videoHandler.updateSinks()}addSink(t,i=!0){return Lt(this,null,(function*(){Vi(this.nativeTrack)?yield this.requestLayer(this.preferredLayer,"addSink"):(_t(e.prototype,this,"addSink").call(this,t),i&&(yield this.updateLayer("addSink"))),this.pushInHistory("uiSetLayer-high")}))}removeSink(t,i=!0){return Lt(this,null,(function*(){_t(e.prototype,this,"removeSink").call(this,t),i&&(yield this.updateLayer("removeSink")),this._degraded=!1,this.pushInHistory("uiSetLayer-none")}))}getSimulcastDefinitions(){return[...this._layerDefinitions]}setSimulcastDefinitons(e){this._layerDefinitions=e}setLayerFromServer(e){this._degraded=this.getDegradationValue(e),this._degradedAt=this._degraded?new Date:this._degradedAt;let t=e.current_layer;return Yt.d(`[Remote Track] ${this.logIdentifier} \n      streamId=${this.stream.id} \n      trackId=${this.trackId}\n      layer update from sfu\n      currLayer=${e.current_layer}\n      preferredLayer=${e.expected_layer}\n      sub_degraded=${e.subscriber_degraded}\n      pub_degraded=${e.publisher_degraded}\n      isDegraded=${this._degraded}`),this.stream.setVideoLayerLocally(t,this.logIdentifier,"setLayerFromServer"),this.pushInHistory(`sfuLayerUpdate-${t}`),this._degraded}getDegradationValue(e){return this.enabled&&(e.publisher_degraded||e.subscriber_degraded)&&"none"===e.current_layer}updateLayer(e){return Lt(this,null,(function*(){let t=this.preferredLayer;this.enabled&&this.hasSinks()?t=this.preferredLayer:this.disableNoneLayerRequest||(t="none"),this.shouldSendVideoLayer(t,e)&&(yield this.requestLayer(t,e))}))}pushInHistory(e){}requestLayer(e,t){return Lt(this,null,(function*(){try{let i=yield this.stream.setVideoLayer(e,this.trackId,this.logIdentifier,t);return Yt.d(`[Remote Track] ${this.logIdentifier} \n      streamId=${this.stream.id}\n      trackId=${this.trackId}\n      Requested layer ${e}, source=${t}`),i}catch(ye){throw Yt.d(`[Remote Track] ${this.logIdentifier} \n      streamId=${this.stream.id}\n      trackId=${this.trackId}\n      Failed to set layer ${e}, source=${t}\n      error=${ye.message}`),ye}}))}shouldSendVideoLayer(e,t){let i=this.getLayer();return!(!this.degraded||"none"!==e)||(i!==e||(Yt.d(`[Remote Track] ${this.logIdentifier}`,`Not sending update, already on layer ${e}, source=${t}`),!1))}},un=class{constructor(){this.history=[]}push(e){e.time=(new Date).toISOString().split("T")[1],this.history.push(e)}},hn=class extends si{constructor(){super(...arguments),this.TAG="[HMSLocalStream]",this.connection=null}setConnection(e){this.connection=e}addTransceiver(e,t){let i=this.connection.addTransceiver(e.getTrackBeingSent(),{streams:[this.nativeStream],direction:"sendonly",sendEncodings:this.getTrackEncodings(e,t)});return this.setPreferredCodec(i,e.nativeTrack.kind),e.transceiver=i,i}setMaxBitrateAndFramerate(e,t){return Lt(this,null,(function*(){var i;yield null==(i=this.connection)?void 0:i.setMaxBitrateAndFramerate(e,t)}))}setPreferredCodec(e,t){}replaceStreamTrack(e,t){this.nativeStream.addTrack(t),this.nativeStream.removeTrack(e)}removeSender(e){var t,i;if(!this.connection||"closed"===this.connection.connectionState)return void Yt.d(this.TAG,"publish connection is not initialised or closed");let s=null==(t=e.transceiver)?void 0:t.sender;if(!s)return void Yt.w(this.TAG,`No sender found for trackId=${e.trackId}`);null==(i=this.connection)||i.removeTrack(s);let n=this.tracks.indexOf(e);-1!==n?this.tracks.splice(n,1):Yt.w(this.TAG,`Cannot find ${e.trackId} in locally stored tracks`)}getTrackEncodings(e,t){let i=[];if(e instanceof Bs)if(t.length>0)Yt.d(this.TAG,"Simulcast enabled with layers",t),i.push(...t);else{let t={active:this.nativeStream.active};e.settings.maxBitrate&&!ai&&(t.maxBitrate=e.settings.maxBitrate),i.push(t)}return i}},pn=class extends si{constructor(e,t){super(e),this.audio=!0,this.video="none",this.connection=t}setAudio(e,t,i){return Lt(this,null,(function*(){this.audio!==e&&(this.audio=e,Yt.d(`[Remote stream] ${i||""} \n    streamId=${this.id}\n    trackId=${t}\n    subscribing audio - ${this.audio}`),yield this.connection.sendOverApiDataChannelWithResponse({params:{subscribed:this.audio,track_id:t},method:"prefer-audio-track-state"}))}))}setVideoLayerLocally(e,t,i){this.video=e,Yt.d(`[Remote stream] ${t}\n    streamId=${this.id}\n    source: ${i}\n    Setting layer field to=${e}`)}setVideoLayer(e,t,i,s){return Yt.d(`[Remote stream] ${i} \n      streamId=${this.id}\n      trackId=${t} \n      source: ${s} request ${e} layer`),this.setVideoLayerLocally(e,i,s),this.connection.sendOverApiDataChannelWithResponse({params:{max_spatial_layer:this.video,track_id:t},method:"prefer-video-track-state"})}getSimulcastLayer(){return this.video}getVideoLayer(){return this.video}isAudioSubscribed(){return this.audio}},vn=(e,t,i,s)=>Lt(void 0,null,(function*(){var n;let r,a={};if(null!=(n=t.transceiver)&&n.sender.track){try{r=yield t.transceiver.sender.getStats();let e={},n={},o={};null==r||r.forEach((t=>{switch(t.type){case"outbound-rtp":n[t.id]=t;break;case"remote-inbound-rtp":o[t.ssrc]=t;break;case"codec":e[t.id]=t.mimeType}})),Object.keys(It({},n)).forEach((r=>{var l,d;let c,u=null==(l=n[r])?void 0:l.codecId,h=u?e[u]:void 0;h&&(c=h.substring(h.indexOf("/")+1));let p=At(It({},n[r]),{rid:null==(d=n[r])?void 0:d.rid}),v=o[p.ssrc];a[r]=At(It({},p),{bitrate:kn("bytesSent",p,null==s?void 0:s[r]),packetsLost:null==v?void 0:v.packetsLost,jitter:null==v?void 0:v.jitter,roundTripTime:null==v?void 0:v.roundTripTime,totalRoundTripTime:null==v?void 0:v.totalRoundTripTime,peerName:i,peerID:t.peerId,enabled:t.enabled,codec:c})}))}catch(fe){e.analytics.publish(Ri.rtcStatsFailed(mi.WebrtcErrors.StatsFailed("TRACK",`Error getting local track stats ${t.trackId} - ${fe.message}`))),Yt.w("[HMSWebrtcStats]","Error in getting local track stats",t,fe,fe.name)}return a}})),gn=(e,t,i,s)=>Lt(void 0,null,(function*(){var n;let r;try{r=yield null==(n=t.transceiver)?void 0:n.receiver.getStats()}catch(Se){e.analytics.publish(Ri.rtcStatsFailed(mi.WebrtcErrors.StatsFailed("TRACK",`Error getting remote track stats ${t.trackId} - ${Se.message}`))),Yt.w("[HMSWebrtcStats]","Error in getting remote track stats",t,Se)}let a=mn(r),o=kn("bytesReceived",a,s),l=Tn("packetsLost",a,s);return null!=a&&a.remote&&Object.assign(a.remote,{packetsLostRate:Tn("packetsLost",a.remote,null==s?void 0:s.remote)}),a&&At(It({},a),{bitrate:o,packetsLostRate:l,peerID:t.peerId,enabled:t.enabled,peerName:i,codec:a.codec})})),mn=e=>{let t,i,s={};null==e||e.forEach((e=>{switch(e.type){case"inbound-rtp":case"outbound-rtp":t=e;break;case"remote-inbound-rtp":i=e;break;case"codec":s[e.id]=e.mimeType}}));let n,r=null!=t&&t.codecId?s[t.codecId]:void 0;return r&&(n=r.substring(r.indexOf("/")+1)),t&&Object.assign(t,{remote:i,codec:n})},fn=(e,t,i)=>{let s=yn(t),n=kn("publish"===e?"bytesSent":"bytesReceived",s,i&&i[e]);return s&&Object.assign(s,{bitrate:n})},yn=e=>{let t;return null==e||e.forEach((i=>{"transport"===i.type&&(t=null==e?void 0:e.get(i.selectedCandidatePairId))})),t||null==e||e.forEach((e=>{"candidate-pair"===e.type&&e.selected&&(t=e)})),t},kn=(e,t,i)=>8*Tn(e,t,i),Tn=(e,t,i)=>{let s=t&&t[e],n=i?i[e]:null;return[t,i,bi(s),bi(n)].every((e=>!!e))?1e3*bn(s,n,null==t?void 0:t.timestamp,null==i?void 0:i.timestamp):0},bn=(e,t,i,s)=>bi(e)&&bi(t)&&i&&s?(e-t)/(i-s):0,Sn=class{constructor(e,t,i,s){var n;this.store=e,this.eventBus=t,this.publishConnection=i,this.subscribeConnection=s,this.TAG="[HMSWebrtcStats]",this.peerStats={},this.remoteTrackStats={},this.localTrackStats={},this.getLocalPeerStats=()=>this.peerStats[this.localPeerID],this.getRemoteTrackStats=e=>this.remoteTrackStats[e],this.getAllRemoteTracksStats=()=>this.remoteTrackStats,this.getLocalTrackStats=()=>this.localTrackStats,this.updateStats=()=>Lt(this,null,(function*(){yield this.updateLocalPeerStats(),yield this.updateLocalTrackStats(),yield this.updateRemoteTrackStats()})),this.updateLocalPeerStats=()=>Lt(this,null,(function*(){var e,t,i,s;let n,r=this.getLocalPeerStats();try{n=yield null==(e=this.publishConnection)?void 0:e.getStats()}catch(Ee){this.eventBus.analytics.publish(Ri.rtcStatsFailed(mi.WebrtcErrors.StatsFailed("PUBLISH",Ee.message))),Yt.w(this.TAG,"Error in getting publish stats",Ee)}let a,o=n&&fn("publish",n,r);try{a=yield null==(t=this.subscribeConnection)?void 0:t.getStats()}catch(Ee){this.eventBus.analytics.publish(Ri.rtcStatsFailed(mi.WebrtcErrors.StatsFailed("SUBSCRIBE",Ee.message))),Yt.w(this.TAG,"Error in getting subscribe stats",Ee)}let l=a&&fn("subscribe",a,r),{packetsLost:d,jitter:c}=(e=>{let t={packetsLost:0,jitter:0};return null==e||e.forEach((e=>{e.packetsLost&&(t.packetsLost+=e.packetsLost),e.jitter>t.jitter&&(t.jitter=e.jitter)})),t})(a),u=bn(d,null==(i=null==r?void 0:r.subscribe)?void 0:i.packetsLost,null==l?void 0:l.timestamp,null==(s=null==r?void 0:r.subscribe)?void 0:s.timestamp),h=l&&Object.assign(l,{packetsLostRate:u,jitter:c,packetsLost:d});this.peerStats[this.localPeerID]={publish:o,subscribe:h}})),this.updateRemoteTrackStats=()=>Lt(this,null,(function*(){var e;let t=Array.from(this.store.getTracksMap().values()).filter((e=>e instanceof cn||e instanceof ys)),i=t.map((e=>e.trackId));Object.keys(this.remoteTrackStats).forEach((e=>{i.includes(e)||delete this.remoteTrackStats[e]}));for(let s of t){let t=s.peerId&&(null==(e=this.store.getPeerById(s.peerId))?void 0:e.name),i=this.getRemoteTrackStats(s.trackId),n=yield gn(this.eventBus,s,t,i);n&&(this.remoteTrackStats[s.trackId]=n)}})),this.updateLocalTrackStats=()=>Lt(this,null,(function*(){var e;let t=this.store.getLocalPeerTracks().reduce(((e,t)=>(e[t.getTrackIDBeingSent()]=t,e)),{}),i=((e,t)=>Array.from(new Set(e.concat(t))))(Object.keys(this.localTrackStats),Object.keys(t));for(let s of i){let i=t[s];if(i){let t=null==(e=this.store.getLocalPeer())?void 0:e.name,n=yield vn(this.eventBus,i,t,this.localTrackStats[s]);n&&(this.localTrackStats[s]=n)}else delete this.localTrackStats[s]}})),this.localPeerID=null==(n=this.store.getLocalPeer())?void 0:n.peerId}setPeerConnections({publish:e,subscribe:t}){this.publishConnection=e,this.subscribeConnection=t}getPublishPeerConnection(){return this.publishConnection}getSubscribePeerConnection(){return this.subscribeConnection}},Pn=class{constructor(e,t){this.store=e,this.eventBus=t,this.TAG="[HMSWebrtcInternals]",this.interval=1e3,this.isMonitored=!1,this.handleStatsUpdate=()=>Lt(this,null,(function*(){var e;yield null==(e=this.hmsStats)?void 0:e.updateStats(),this.hmsStats&&this.eventBus.statsUpdate.publish(this.hmsStats)}))}getCurrentStats(){return this.hmsStats}getPublishPeerConnection(){var e;return null==(e=this.hmsStats)?void 0:e.getPublishPeerConnection()}getSubscribePeerConnection(){var e;return null==(e=this.hmsStats)?void 0:e.getSubscribePeerConnection()}onStatsChange(e){return this.eventBus.statsUpdate.subscribe(e),()=>{this.eventBus.statsUpdate.unsubscribe(e)}}setPeerConnections({publish:e,subscribe:t}){this.hmsStats?this.hmsStats.setPeerConnections({publish:e,subscribe:t}):this.hmsStats=new Sn(this.store,this.eventBus,e,t)}start(){return Lt(this,null,(function*(){this.isMonitored?Yt.d(this.TAG,"Already started"):(this.stop(),this.isMonitored=!0,Yt.d(this.TAG,"Starting Webrtc Stats Monitor"),this.startLoop().then((()=>Yt.d(this.TAG,"Stopping Webrtc Stats Monitor"))).catch((e=>{this.eventBus.analytics.publish(Ri.rtcStatsFailed(mi.WebrtcErrors.StatsFailed("PUBLISH",e.message))),Yt.e(this.TAG,e.message)})))}))}stop(){this.isMonitored=!1}startLoop(){return Lt(this,null,(function*(){for(;this.isMonitored;)yield this.handleStatsUpdate(),yield zi(this.interval)}))}cleanup(){this.stop(),this.eventBus.statsUpdate.removeAllListeners()}},En=class{constructor({peerId:e,name:t,isLocal:i,customerUserId:s,metadata:n,role:r,joinedAt:a,groups:o,realtime:l,type:d}){this.customerUserId="",this.metadata="",this.auxiliaryTracks=[],this.name=t,this.peerId=e,this.isLocal=i,this.customerUserId=s,this.metadata=n,this.joinedAt=a,this.groups=o,this.realtime=l,this.type=d,r&&(this.role=r)}get isHandRaised(){var e;return!(null==(e=this.groups)||!e.includes(dn))}updateRole(e){this.role=e}updateName(e){this.name=e}updateNetworkQuality(e){this.networkQuality=e}updateMetadata(e){this.metadata=e}updateGroups(e){this.groups=e}toString(){var e,t,i,s;return`{\n      name: ${this.name};\n      role: ${null==(e=this.role)?void 0:e.name};\n      peerId: ${this.peerId};\n      customerUserId: ${this.customerUserId};\n      ${this.audioTrack?`audioTrack: ${null==(t=this.audioTrack)?void 0:t.trackId};`:""}\n      ${this.videoTrack?`videoTrack: ${null==(i=this.videoTrack)?void 0:i.trackId};`:""}\n      groups: ${null==(s=this.groups)?void 0:s.join()}\n    }`}},Cn=class{};Cn.makePeerId=()=>(0,d.Z)();var wn=class extends En{constructor(e){super(At(It({},e),{peerId:Cn.makePeerId(),isLocal:!0})),this.isLocal=!0,this.auxiliaryTracks=[],this.asRole=e.asRole}isInPreview(){return!!this.asRole}toString(){var e,t,i;return`{\n      name: ${this.name};\n      role: ${null==(e=this.role)?void 0:e.name};\n      peerId: ${this.peerId};\n      customerUserId: ${this.customerUserId};\n      ${this.asRole?`asRole: ${this.asRole.name};`:""}\n      ${this.audioTrack?`audioTrack: ${null==(t=this.audioTrack)?void 0:t.trackId};`:""}\n      ${this.videoTrack?`videoTrack: ${null==(i=this.videoTrack)?void 0:i.trackId};`:""}\n    }`}},In=class extends En{constructor(e){super(At(It({},e),{isLocal:!1})),this.isLocal=!1,this.auxiliaryTracks=[],this.fromRoomState=!1,this.fromRoomState=!!e.fromRoomState}},An=(e,t)=>new In({peerId:e.peer_id,name:e.info.name,role:t.getPolicyForRole(e.role),customerUserId:e.info.user_id,metadata:e.info.data,groups:e.groups,type:e.info.type}),Rn=class{constructor(e,t,i){this.transport=e,this.store=t,this.options=i,this.isEnd=!1,this.iterator=null,this.total=0,this.defaultPaginationLimit=10}validateConnection(){if(!this.transport||!this.store)throw Error("Use usePaginatedParticipants or hmsActions.getPeerListIterator after preview or join has happened")}hasNext(){return!this.isEnd}getTotal(){return this.total}findPeers(){return Lt(this,null,(function*(){var e;this.validateConnection();let t=yield this.transport.signal.findPeers(At(It({},this.options||{}),{limit:(null==(e=this.options)?void 0:e.limit)||this.defaultPaginationLimit}));return this.updateState(t),this.processPeers(t.peers)}))}next(){return Lt(this,null,(function*(){var e;let t;return this.validateConnection(),this.iterator||this.isEnd?this.iterator?(t=yield this.transport.signal.peerIterNext({iterator:this.iterator,limit:(null==(e=this.options)?void 0:e.limit)||this.defaultPaginationLimit}),this.updateState(t),this.processPeers(t.peers)):[]:yield this.findPeers()}))}processPeers(e){let t=[];return e.forEach((e=>{let i=An(e,this.store);t.push(i)})),t}updateState(e){this.isEnd=e.eof,this.total=e.total,e.iterator&&(this.iterator=e.iterator)}},_n=class{constructor(e){this.TAG="[AudioContextManager]",this.audioContext=new AudioContext,this.source=this.audioContext.createMediaElementSource(e),this.source.connect(this.audioContext.destination)}resumeContext(){return Lt(this,null,(function*(){"suspended"===this.audioContext.state&&(yield this.audioContext.resume(),Yt.d(this.TAG,"AudioContext is resumed"))}))}getAudioTrack(){return this.destinationNode&&this.source.disconnect(this.destinationNode),this.destinationNode=this.audioContext.createMediaStreamDestination(),this.source.connect(this.destinationNode),this.destinationNode.stream.getAudioTracks()[0]}cleanup(){"closed"!==this.audioContext.state&&this.audioContext.close().catch((e=>{Yt.d(this.TAG,"AudioContext close error",e.message)}))}},Ln=class extends ge.EventEmitter2{on(e,t){return super.on(e,t)}off(e,t){return super.off(e,t)}emit(e,t){return super.emit(e,t)}listeners(e){return super.listeners(e)}},Dn=class extends Ln{constructor(){super(...arguments),this.audioElement=null,this.TAG="[PlaylistAudioManager]",this.seeked=!1}play(e){return Lt(this,null,(function*(){return this.audioElement=this.getAudioElement(),new Promise(((t,i)=>{this.audioElement=this.getAudioElement(),this.audioElement.src=e,this.seeked=!1,this.audioElement.onerror=()=>{let t=`Error loading ${e}`;Yt.e(this.TAG,t),this.stop(),i(t)},this.audioElement.oncanplaythrough=()=>Lt(this,null,(function*(){try{if(!this.audioElement)return;if(this.audioContextManager.resumeContext(),this.track)this.seeked?this.seeked=!1:(yield this.audioElement.play(),t([this.track]));else{yield this.audioElement.play();let e=this.audioContextManager.getAudioTrack();this.track=e,t([e])}}catch(we){Yt.e(this.TAG,"Error playing audio",e,we.message),i(we)}})),this.audioElement.onseeked=()=>{this.seeked=!0}}))}))}getTracks(){return this.track?[this.track.id]:[]}getElement(){return this.audioElement||(this.audioElement=this.getAudioElement()),this.audioElement}stop(){var e,t,i;null==(e=this.audioElement)||e.pause(),null==(t=this.audioElement)||t.removeAttribute("src"),this.audioElement=null,null==(i=this.audioContextManager)||i.cleanup(),this.track=void 0}getAudioElement(){if(this.audioElement)return this.audioElement;let e=document.createElement("audio");return e.crossOrigin="anonymous",e.addEventListener("timeupdate",(e=>this.emit("progress",e))),e.addEventListener("ended",(()=>{this.emit("ended",null)})),this.audioContextManager=new _n(e),e}},Mn=class extends Ln{constructor(){super(...arguments),this.TAG="[PlaylistVideoManager]",this.videoElement=null,this.canvasContext=null,this.tracks=[],this.DEFAUL_FPS=24,this.seeked=!1,this.drawImage=()=>{var e,t,i;this.videoElement&&!this.videoElement.paused&&!this.videoElement.ended&&(null==(i=this.canvasContext)||i.drawImage(this.videoElement,0,0,null==(e=this.canvas)?void 0:e.width,null==(t=this.canvas)?void 0:t.height),this.timer=setTimeout((()=>{this.drawImage()}),1e3/this.DEFAUL_FPS))}}play(e){return this.videoElement=this.getVideoElement(),this.createCanvas(),new Promise(((t,i)=>{this.videoElement=this.getVideoElement(),this.videoElement.src=e,this.seeked=!1,this.videoElement.onerror=()=>{let t=`Error loading ${e}`;Yt.e(this.TAG,t),this.stop(),i(t)},this.videoElement.oncanplaythrough=()=>Lt(this,null,(function*(){var s,n,r;try{if(!this.videoElement)return;if(this.canvas.width=this.videoElement.videoWidth,this.canvas.height=this.videoElement.videoHeight,0===this.tracks.length){this.clearCanvasAndTracks();let e=this.canvas.captureStream();if(!e)return void Yt.e(this.TAG,"Browser does not support captureStream");this.videoElement.onplay=this.drawImage,yield this.audioContextManager.resumeContext(),yield this.videoElement.play();let i=this.audioContextManager.getAudioTrack();e.addTrack(i),e.getTracks().forEach((e=>{this.tracks.push(e)})),t(this.tracks)}else this.seeked?(this.seeked=!1,null==(r=this.canvasContext)||r.drawImage(this.videoElement,0,0,null==(s=this.canvas)?void 0:s.width,null==(n=this.canvas)?void 0:n.height)):(yield this.videoElement.play(),t(this.tracks))}catch(_e){Yt.e(this.TAG,"Error playing video",e,_e.message),i(_e)}})),this.videoElement.onseeked=()=>{this.seeked=!0}}))}getTracks(){return this.tracks.map((e=>e.id))}getElement(){return this.videoElement||(this.videoElement=this.getVideoElement()),this.videoElement}stop(){var e,t,i;null==(e=this.videoElement)||e.pause(),null==(t=this.videoElement)||t.removeAttribute("src"),this.videoElement=null,null==(i=this.audioContextManager)||i.cleanup(),this.clearCanvasAndTracks()}clearCanvasAndTracks(){var e;this.tracks=[],null==(e=this.canvasContext)||e.clearRect(0,0,this.canvas.width,this.canvas.height),clearTimeout(this.timer)}getVideoElement(){if(this.videoElement)return this.videoElement;let e=document.createElement("video");return e.crossOrigin="anonymous",e.addEventListener("timeupdate",(e=>this.emit("progress",e))),e.addEventListener("ended",(()=>{this.emit("ended",null)})),this.audioContextManager=new _n(e),e}createCanvas(){this.canvas||(this.canvas=document.createElement("canvas"),this.canvasContext=this.canvas.getContext("2d"))}},Nn={list:[],currentIndex:-1,isAutoplayOn:!0},On={list:[],currentIndex:-1,isAutoplayOn:!0},xn=class extends Ln{constructor(e,t){super(),this.sdk=e,this.eventBus=t,this.state={audio:It({},Nn),video:It({},On)},this.TAG="[PlaylistManager]",this.handlePausePlaylist=e=>Lt(this,[e],(function*({enabled:e,track:t}){var i;if(e)return;let s;"audioplaylist"===t.source&&(s="audio"),"videoplaylist"===t.source&&(s="video"),s&&(null==(i=this.getElement(s))||i.pause())})),this.addTrack=(e,t)=>Lt(this,null,(function*(){yield this.sdk.addTrack(e,t),Yt.d(this.TAG,"Playlist track added",_i(e))})),this.removeTrack=e=>Lt(this,null,(function*(){yield this.sdk.removeTrack(e,!0),Yt.d(this.TAG,"Playlist track removed",e)})),this.audioManager=new Dn,this.videoManager=new Mn,this.addListeners()}getList(e="audio"){return this.state[e].list}setList(e){e&&0!==e.length?e.forEach((e=>{this.state[e.type].list.find((t=>t.id===e.id))||this.state[e.type].list.push(e)})):Yt.w(this.TAG,"Please pass in a list of HMSPlaylistItem's")}clearList(e){return Lt(this,null,(function*(){this.isPlaying(e)&&(yield this.stop(e)),this.state[e].list=[]}))}removeItem(e,t){return Lt(this,null,(function*(){let{list:i,currentIndex:s}=this.state[t],n=i.findIndex((t=>e===t.id));return n>-1&&(s===n&&this.isPlaying(t)&&(yield this.stop(t)),i.splice(n,1),!0)}))}seek(e,t="audio"){let{currentIndex:i}=this.state[t];if(-1===i)throw mi.PlaylistErrors.NoEntryToPlay("PLAYLIST","No item is currently playing");let s=this.getElement(t);if(s){let t=Math.max(s.currentTime+e,0);s.currentTime=Math.min(t,s.duration)}}seekTo(e,t="audio"){let{currentIndex:i}=this.state[t];if(-1===i)throw mi.PlaylistErrors.NoEntryToPlay("PLAYLIST","No item is currently playing");if(e<0)throw Error("value cannot be negative");let s=this.getElement(t);s&&(s.currentTime=Math.min(e,s.duration))}setVolume(e,t="audio"){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");let i=this.getElement(t);i&&(i.volume=.01*e)}getVolume(e="audio"){let t=this.getElement(e);return t?Math.floor(100*t.volume):0}getCurrentTime(e="audio"){let t=this.getElement(e);return(null==t?void 0:t.currentTime)||0}getCurrentIndex(e="audio"){return this.state[e].currentIndex}getCurrentProgress(e="audio"){var t;let{list:i,currentIndex:s}=this.state[e],n=null==(t=i[s])?void 0:t.url,r=this.getElement(e);return n&&r?Math.floor(r.currentTime/r.duration*100):0}getCurrentSelection(e="audio"){let{list:t,currentIndex:i}=this.state[e];if(-1!==i)return t[i]}isPlaying(e="audio"){let t=this.getElement(e);return!!t&&!t.paused}setIsAutoplayOn(e="audio",t){this.state[e].isAutoplayOn=t}getPlaybackRate(e="audio"){let t=this.getElement(e);return t?t.playbackRate:1}setPlaybackRate(e="audio",t){if(t<.25||t>2)throw Error("Please pass a value between 0.25 and 2.0");let i=this.getElement(e);i&&(i.playbackRate=t)}setEnabled(e,t){return Lt(this,arguments,(function*(e,{id:t,type:i="audio"}){let s=this.state[i].list.findIndex((e=>e.id===t));if(!t||-1===s)return void Yt.w(this.TAG,"Pass a valid id");let n=this.state[i].list[s].url;e?yield this.play(n,i):yield this.pause(n,i),this.state[i].currentIndex=s,this.setDuration(i)}))}playNext(){return Lt(this,arguments,(function*(e="audio"){let{list:t,currentIndex:i}=this.state[e];if(i>=t.length-1)throw mi.PlaylistErrors.NoEntryToPlay("PLAYLIST","Reached end of playlist");yield this.play(t[i+1].url,e),this.state[e].currentIndex=i+1,this.setDuration(e)}))}playPrevious(){return Lt(this,arguments,(function*(e="audio"){let{list:t,currentIndex:i}=this.state[e];if(i<=0)throw mi.PlaylistErrors.NoEntryToPlay("PLAYLIST","Reached start of playlist");yield this.play(t[i-1].url,e),this.state[e].currentIndex=i-1,this.setDuration(e)}))}stop(){return Lt(this,arguments,(function*(e="audio"){var t;let i="audio"===e?this.audioManager:this.videoManager;null==(t=i.getElement())||t.pause(),yield this.removeTracks(e),i.stop(),this.state[e].currentIndex=-1}))}cleanup(){this.state={audio:It({},Nn),video:It({},On)},this.eventBus.localAudioEnabled.unsubscribe(this.handlePausePlaylist),this.eventBus.localVideoEnabled.unsubscribe(this.handlePausePlaylist),this.audioManager.stop(),this.videoManager.stop()}onProgress(e){this.videoManager.on("progress",(()=>{try{e({type:"video",progress:this.getCurrentProgress("video")})}catch(Te){Yt.e(this.TAG,"Error in onProgress callback")}})),this.audioManager.on("progress",(()=>{try{e({type:"audio",progress:this.getCurrentProgress("audio")})}catch(Te){Yt.e(this.TAG,"Error in onProgress callback")}}))}onNewTrackStart(e){this.on("newTrackStart",e)}onPlaylistEnded(e){this.on("playlistEnded",e)}onCurrentTrackEnded(e){this.on("currentTrackEnded",e)}getElement(e="audio"){return"audio"===e?this.audioManager.getElement():this.videoManager.getElement()}removeTracks(){return Lt(this,arguments,(function*(e="audio"){let t=("audio"===e?this.audioManager:this.videoManager).getTracks();for(let i of t)yield this.removeTrack(i)}))}play(e){return Lt(this,arguments,(function*(e,t="audio"){let i="audio"===t?this.audioManager:this.videoManager,s=i.getElement();if(this.isItemCurrentlyPlaying(e,t))Yt.w(this.TAG,`The ${t} is currently playing`);else if(null!=s&&s.src.includes(e))yield s.play();else{null==s||s.pause();let n=yield i.play(e);for(let e of n)yield this.addTrack(e,"audio"===t?"audioplaylist":"videoplaylist")}}))}isItemCurrentlyPlaying(e,t){let i=this.getElement(t);return!(!i||i.paused||!i.src.includes(e))}setDuration(e="audio"){let t=this.getElement(e),{list:i,currentIndex:s}=this.state[e];i[s]&&(i[s].duration=(null==t?void 0:t.duration)||0),this.emit("newTrackStart",i[s])}pause(e){return Lt(this,arguments,(function*(e,t="audio"){let i=this.getElement(t);i&&!i.paused&&i.src.includes(e)?(i.pause(),Yt.d(this.TAG,"paused url",e)):Yt.w(this.TAG,"The passed in url is not currently playing")}))}addListeners(){this.audioManager.on("ended",(()=>this.handleEnded("audio"))),this.videoManager.on("ended",(()=>this.handleEnded("video"))),this.eventBus.localAudioEnabled.subscribe(this.handlePausePlaylist),this.eventBus.localVideoEnabled.subscribe(this.handlePausePlaylist)}handleEnded(){return Lt(this,arguments,(function*(e="audio"){let{list:t,currentIndex:i,isAutoplayOn:s}=this.state[e];i===t.length-1?(yield this.stop(e),this.emit("playlistEnded",e)):s?this.playNext(e):yield this.pause(t[i].url,e),this.emit("currentTrackEnded",t[i])}))}},Un=e=>e.room,Bn=((0,o.P1)((e=>e.errors),(e=>0===e.length?null:e.at(-1))),(0,o.P1)(Un,(e=>e.id)),e=>e.peers),Fn=e=>e.messages.byID,Gn=e=>e.messages.allIDs,$n=e=>e.tracks,jn=e=>e.settings,Vn=e=>e.appData,Wn=e=>e.speakers,Hn=(0,o.P1)([Un],(e=>e&&e.isConnected)),qn=((0,o.P1)([Hn,Un],((e,t)=>e?void 0!==t.peerCount?t.peerCount||1:t.peers.length:Math.max(void 0!==t.peerCount?t.peerCount:t.peers.length-1,0))),(0,o.P1)([Un,Bn,e=>e.hideLocalPeer],((e,t,i)=>i?e.peers.filter((t=>e.localPeer!==t)).map((e=>t[e])):e.peers.map((e=>t[e]))))),Kn=(0,o.P1)($n,(e=>Object.values(e))),Jn=(0,o.P1)(Un,Bn,((e,t)=>t[e.localPeer])),zn=(0,o.P1)(Un,(e=>e.localPeer)),Qn=((0,o.P1)(Jn,(e=>null==e?void 0:e.name)),(0,o.P1)(Jn,(e=>null==e?void 0:e.roleName)),(0,o.P1)(Jn,(e=>null==e?void 0:e.audioTrack))),Yn=(0,o.P1)(Jn,(e=>null==e?void 0:e.videoTrack)),Zn=(0,o.P1)(Jn,(e=>null==e?void 0:e.auxiliaryTracks)),Xn=(0,o.P1)([Qn,Yn,Zn],((e,t,i)=>{let s=i?[...i]:[];return e&&s.unshift(e),t&&s.unshift(t),s})),er=((0,o.P1)(qn,(e=>e.filter((e=>!e.isLocal)))),(0,o.P1)(Bn,Wn,((e,t)=>{let i=Object.entries(t).sort(((e,t)=>{var i,s;let n=(null==(i=e[1])?void 0:i.audioLevel)||0;return((null==(s=t[1])?void 0:s.audioLevel)||0)>n?1:-1}));if(i.length>0&&i[0][1].audioLevel&&i[0][1].audioLevel>0){let t=i[0][1].peerID;if(t in e)return e[t]}return null}))),tr=e=>{let t=Jn(e);return Kt(e,null==t?void 0:t.audioTrack)},ir=e=>{let t=Jn(e);return Kt(e,null==t?void 0:t.videoTrack)},sr=e=>{let t=Jn(e);return function(e,t){return!(!t||!e.tracks[t])&&e.tracks[t].displayEnabled}(e,null==t?void 0:t.videoTrack)},nr=(0,o.P1)(Jn,$n,((e,t)=>{let{video:i,audio:s}=Gt(t,e);return!(!i&&!s)})),rr=(0,o.P1)(Bn,$n,((e,t)=>{let i;for(let s in e){let n=e[s],{video:r,audio:a}=Gt(t,n);if(r)return n;a&&!i&&(i=n)}return i})),ar=(0,o.P1)(rr,(e=>!!e)),or=((0,o.P1)(Bn,$n,((e,t)=>{for(let i in e){let s=e[i],{audio:n,video:r}=Gt(t,s);if(!r&&n)return s}})),(0,o.P1)(Bn,$n,((e,t)=>{let i=[],s=[];for(let n in e){let r=e[n],{video:a,audio:o}=Gt(t,r);a?i.push(r):o&&s.push(r)}return i.concat(s)})),(0,o.P1)(Bn,$n,((e,t)=>{for(let i in t){let s=t[i];if(Ht(s)&&jt(s)&&s.peerId)return e[s.peerId]}})),(0,o.P1)(Bn,$n,((e,t)=>{for(let i in t){let s=t[i];if(Wt(s)&&s.peerId)return e[s.peerId]}})),(0,o.P1)(Kn,(e=>e.filter(qt))),(0,o.P1)(Gn,(e=>e.length)),(0,o.P1)(Fn,(e=>Object.values(e).filter((e=>!e.read)).length)),(0,o.P1)(Gn,Fn,((e,t)=>{let i=[];return e.forEach((e=>{i.push(t[e])})),i}))),lr=(0,o.P1)(or,(e=>e.filter((e=>{var t;return!e.recipientPeer&&!(e.recipientRoles&&(null==(t=e.recipientRoles)?void 0:t.length)>0)})))),dr=((0,o.P1)(lr,(e=>e.filter((e=>!e.read)).length)),(0,o.P1)([Un],(e=>e&&e.roomState))),cr=(0,o.P1)(dr,(e=>"Preview"===e)),ur=((0,o.P1)(Un,(e=>"Disconnected"!==e.roomState)),(0,o.P1)(Un,(e=>!(!e.transcriptions||e.transcriptions.length<=0)&&e.transcriptions.some((e=>"caption"===e.mode&&"started"===e.state)))),e=>e.roles),hr=((0,o.P1)([ur],(e=>Object.keys(e))),(0,o.P1)([Jn,ur],((e,t)=>null!=e&&e.roleName?t[e.roleName]:null))),pr=(0,o.P1)([e=>{var t;return null==(t=e.preview)?void 0:t.asRole},ur],((e,t)=>e?t[e]:null)),vr=((0,o.P1)([hr],(e=>{var t;return!(null==(t=null==e?void 0:e.subscribeParams)||!t.subscribeToRoles)&&e.subscribeParams.subscribeToRoles.length>0})),(0,o.P1)(hr,(e=>null==e?void 0:e.permissions))),gr=(0,o.P1)(Un,(e=>e.recording)),mr=((0,o.P1)(Un,(e=>e.rtmp)),(0,o.P1)(Un,(e=>e.hls))),fr=((0,o.P1)(Un,(e=>e.transcriptions)),(0,o.P1)(Un,(e=>e.sessionId)),(0,o.P1)(Un,(e=>e.startedAt)),(0,o.P1)(Un,(e=>!!e.isLargeRoom)),(0,o.P1)(Un,(e=>!!e.isEffectsEnabled)),(0,o.P1)(Un,(e=>!!e.isVBEnabled)),(0,o.P1)(Un,(e=>e.effectsKey))),yr=(0,o.P1)(qn,(e=>e.filter((e=>e.isHandRaised)))),kr=((0,o.P1)((e=>e.whiteboards),(e=>Object.values(e)[0])),(e="audio")=>t=>t.playlist[e].list),Tr=(e="audio")=>t=>t.playlist[e].selection,br=(e="audio")=>t=>t.playlist[e].progress,Sr=(e="audio")=>t=>t.playlist[e].currentTime,Pr=(e="audio")=>t=>t.playlist[e].playbackRate,Er=(e="audio")=>t=>t.playlist[e].volume,Cr=(e="audio")=>(0,o.P1)(kr(e),(e=>Object.values(e))),wr=(e="audio")=>(0,o.P1)(kr(e),Tr(e),((e,t)=>{if(t.id)return e[t.id]})),Ir={selection:Tr("audio"),progress:br("audio"),currentTime:Sr("audio"),playbackRate:Pr("audio"),volume:Er("audio"),list:Cr("audio"),selectedItem:wr("audio")},Ar={selection:Tr("video"),progress:br("video"),currentTime:Sr("video"),playbackRate:Pr("video"),volume:Er("video"),list:Cr("video"),selectedItem:wr("video")};function Rr(e){return t=>i=>e(i,t)}var _r="HMS-Store:",Lr=class{static v(e,...t){this.log(0,e,...t)}static d(...e){this.log(1,...e)}static i(...e){this.log(2,...e)}static w(...e){this.log(3,...e)}static e(...e){this.log(6,...e)}static time(e){this.log(4,"[HMSPerformanceTiming]",e)}static timeEnd(e){this.log(5,"[HMSPerformanceTiming]",e,e)}static cleanup(){performance.clearMarks(),performance.clearMeasures()}static log(e,...t){if(!(this.level.valueOf()>e.valueOf()))switch(e){case 0:console.log(_r,...t);break;case 1:console.debug(_r,...t);break;case 2:console.info(_r,...t);break;case 3:console.warn(_r,...t);break;case 6:console.error(_r,...t);break;case 4:performance.mark(t[1]);break;case 5:{let e=t[0],i=t[1];try{let t=performance.measure(i,i);this.log(1,e,i,null==t?void 0:t.duration),performance.clearMarks(i),performance.clearMeasures(i)}catch(we){this.log(1,e,i,we)}break}}}};Lr.level=0;var Dr=(e,t)=>t,Mr=(e,t)=>t,Nr=(e,t)=>t,Or=(0,o.P1)([Bn,Dr],((e,t)=>t?e[t]:null)),xr=(0,o.P1)([$n,Mr],((e,t)=>t?e[t]:null)),Ur=(0,o.P1)([$n,Mr],((e,t)=>{if(!t)return null;let i=e[t];return"video"===(null==i?void 0:i.type)?i:null})),Br=(0,o.P1)([$n,Mr],((e,t)=>{if(!t)return null;let i=e[t];return"audio"===(null==i?void 0:i.type)?i:null})),Fr=(0,o.P1)([$n,Mr],((e,t)=>{if(!t)return null;let i=e[t];return"audio"===(null==i?void 0:i.type)&&"screen"===(null==i?void 0:i.source)?i:null})),Gr=(0,o.P1)([$n,Mr],((e,t)=>{if(!t)return null;let i=e[t];return"video"===(null==i?void 0:i.type)&&"screen"===(null==i?void 0:i.source)?i:null})),$r=(0,o.P1)([e=>e.polls,(e,t)=>t],((e,t)=>t?e[t]:null)),jr=Rr(Or);Rr((0,o.P1)([Vn,(e,t)=>t],((e,t)=>{if(e)return t?e[t]:e})));Rr((0,o.P1)(Or,(e=>null==e?void 0:e.name))),Rr((0,o.P1)(Or,(e=>null==e?void 0:e.type)));var Vr=Rr(xr),Wr=Rr(Ur),Hr=(Rr(Br),Rr(Fr),Rr(Gr),Rr(((e,t)=>{let i=Or(e,t);if(i&&i.videoTrack&&""!==i.videoTrack)return e.tracks[i.videoTrack]})),Rr(((e,t)=>{let i=Or(e,t);if(i&&i.audioTrack&&""!==i.audioTrack)return e.tracks[i.audioTrack]}))),qr=(Rr(((e,t)=>{let i=Or(e,t);return(null==i?void 0:i.auxiliaryTracks.map((t=>e.tracks[t])))||[]})),(e,t)=>t?e.speakers[t]:null),Kr=(Rr((0,o.P1)(qr,(e=>(null==e?void 0:e.audioLevel)||0))),Rr((0,o.P1)(((e,t)=>{let i=Hr(t)(e);return qr(e,null==i?void 0:i.id)}),(e=>(null==e?void 0:e.audioLevel)||0)))),Jr=Rr(((e,t)=>{if(t)return e.connectionQualities[t]})),zr=(Rr(((e,t)=>{let i=Or(e,t);if(i){let t=null==i?void 0:i.auxiliaryTracks.find((t=>$t(e.tracks[t])));return t?e.tracks[t]:void 0}})),Rr((0,o.P1)($n,Or,((e,t)=>{let i=null==t?void 0:t.auxiliaryTracks.find((t=>{let i=e[t];return Ht(i)&&jt(i)}));return i?e[i]:void 0}))),Rr((0,o.P1)($n,Or,((e,t)=>{let i=null==t?void 0:t.auxiliaryTracks.find((t=>{let i=e[t];return Ht(i)&&$t(i)}));return i?e[i]:void 0}))),Rr((0,o.P1)($n,Or,((e,t)=>{let i=null==t?void 0:t.auxiliaryTracks.find((t=>{let i=e[t];return Wt(i)&&$t(i)}));return i?e[i]:void 0}))),Rr((0,o.P1)($n,Or,((e,t)=>Gt(e,t))))),Qr=e=>(0,o.P1)(zr(e),(e=>e.video)),Yr=e=>(0,o.P1)(zr(e),(e=>e.audio)),Zr=Rr(((e,t)=>{let i=Or(e,t);return Kt(e,null==i?void 0:i.audioTrack)})),Xr=Rr(((e,t)=>{let i=Or(e,t);return Kt(e,null==i?void 0:i.videoTrack)})),ea=Rr(((e,t)=>{if(t&&e.tracks[t])return 0===e.tracks[t].volume})),ta=(Rr(((e,t)=>{let i=Or(e,t);return ea(null==i?void 0:i.audioTrack)(e)})),Rr(((e,t)=>{let i=Yr(t)(e);return ea(null==i?void 0:i.id)(e)})),Rr(((e,t)=>{let i=xr(e,t);if(i)return"audio"!==i.type?void Lr.w("Please pass audio track here"):i.volume}))),ia=(Rr(((e,t)=>{let i=Or(e,t);return ta(null==i?void 0:i.audioTrack)(e)})),Rr(((e,t)=>{let i=Yr(t)(e);return ta(null==i?void 0:i.id)(e)})),Rr(((e,t)=>{let i=xr(e,t);if(i)return"video"!==i.type?void Lr.w("Please pass video track here"):i.layer})),(0,o.P1)([or,zn,Dr],((e,t,i)=>{if(i)return e.filter((e=>{var s;return!(!(e.recipientPeer||null!=(s=e.recipientRoles)&&s.length)||e.sender&&![t,i].includes(e.sender))&&[t,i].includes(e.recipientPeer)}))}))),sa=(0,o.P1)([or,Nr],((e,t)=>{if(t)return e.filter((e=>{var i,s;return!(null==(i=e.recipientRoles)||!i.length)&&(null==(s=e.recipientRoles)?void 0:s.includes(t))}))})),na=(0,o.P1)(or,(e=>e.filter((e=>{var t;return!e.recipientPeer&&!(null!=(t=e.recipientRoles)&&t.length)})))),ra=(0,o.P1)([sa,Nr],(e=>e?e.filter((e=>!e.read)).length:0)),aa=(0,o.P1)([ia,Dr],(e=>e?e.filter((e=>!e.read)).length:0)),oa=((0,o.P1)(na,(e=>e.filter((e=>!e.read)).length)),Rr(ia),Rr(sa),Rr(ra),Rr(aa),e=>(0,o.P1)(jr(e),(e=>{try{return null!=e&&e.metadata&&""!==e.metadata?JSON.parse(e.metadata):{}}catch(ke){return console.error("cannot parse peer metadata",ke),{}}}))),la=e=>(0,o.P1)(jr(e),(e=>!(null==e||!e.isHandRaised))),da=Rr($r),ca=((0,o.P1)([Bn,$n],((e,t)=>Object.values(e).map((e=>{var i;return{peer:e,isAudioEnabled:!!e.audioTrack&&(null==(i=t[e.audioTrack])?void 0:i.enabled)}})))),(0,o.P1)([e=>e.roleChangeRequests[0]||null,Bn,ur],((e,t,i)=>e?{requestedBy:e.requestedBy?t[e.requestedBy]:void 0,role:i[e.roleName],token:e.token}:null))),ua=((0,o.P1)([hr],(e=>Jt(e))),(0,o.P1)([pr],(e=>Jt(e))),(0,o.P1)([Yn,$n],((e,t)=>{let i=null;return e&&(i=t[e]),(null==i?void 0:i.plugins)||[]}))),ha=(0,o.P1)([Qn,$n],((e,t)=>{let i=null;return e&&(i=t[e]),(null==i?void 0:i.plugins)||[]})),pa=e=>(0,o.P1)([ua],(t=>t.includes(e))),va=e=>(0,o.P1)([ha],(t=>t.includes(e))),ga={0:"PEER_JOINED",1:"PEER_LEFT",8:"ROLE_UPDATED",10:"NAME_UPDATED",11:"METADATA_UPDATED",12:"HAND_RAISE_CHANGED"},ma={0:"TRACK_ADDED",1:"TRACK_REMOVED",2:"TRACK_MUTED",3:"TRACK_UNMUTED",5:"TRACK_DEGRADED",6:"TRACK_RESTORED",4:"TRACK_DESCRIPTION_CHANGED"},fa={0:"POLL_CREATED",1:"POLL_STARTED",2:"POLL_STOPPED",4:"POLL_VOTES_UPDATED",3:"POLLS_LIST"},ya="TRANSCRIPTION_STATE_UPDATED",ka="hmsNotification",Ta=class{constructor(e){this.id=0,this.onNotification=(e,t)=>{let i=i=>{if(t){let e;if(e=Array.isArray(t)?t.includes(i.type):t===i.type,!e)return}e(i)};return this.eventEmitter.addListener(ka,i),()=>{this.eventEmitter.removeListener(ka,i)}},this.store=e,this.eventEmitter=new ge.EventEmitter2({maxListeners:Object.keys(Bt).length})}sendPlaylistTrackEnded(e){let t=this.createNotification("PLAYLIST_TRACK_ENDED",e,"info");this.emitEvent(t)}sendDeviceChange(e){var t;let i=this.createNotification("DEVICE_CHANGE_UPDATE",e,e.error?"error":"info",`Selected ${e.type} device - ${null==(t=e.selection)?void 0:t.label}`);this.emitEvent(i)}sendLeaveRoom(e){var t;let i=null==(t=e.requestedBy)?void 0:t.name,s=this.createNotification(e.roomEnded||!i?"ROOM_ENDED":"REMOVED_FROM_ROOM",e,"info",`${e.roomEnded?"Room ended":"Removed from room"} ${i?`by ${i}`:""}`);this.emitEvent(s)}sendPeerList(e){if(0===e.length)return;let t=this.createNotification("PEER_LIST",e,"info");this.emitEvent(t)}sendPeerUpdate(e,t){let i=this.store.getState(jr(null==t?void 0:t.id))||t,s=ga[e];if(s&&i){let e=this.createNotification(s,i,"info");this.emitEvent(e)}}sendTrackUpdate(e,t){let i=this.store.getState(Vr(t)),s=ma[e];if(s){let e=this.createNotification(s,i,"info");this.emitEvent(e)}}sendMessageReceived(e){let t=this.createNotification("NEW_MESSAGE",e,"info");this.emitEvent(t)}sendError(e){let t=this.createNotification("ERROR",e,"error");this.emitEvent(t)}sendReconnecting(e){let t=this.createNotification("RECONNECTING",e,"error");this.emitEvent(t)}sendReconnected(){let e=this.createNotification("RECONNECTED",null,"info");this.emitEvent(e)}sendChangeTrackStateRequest(e){let t=this.createNotification("CHANGE_TRACK_STATE_REQUEST",e,"info");this.emitEvent(t)}sendChangeMultiTrackStateRequest(e){let t=this.createNotification("CHANGE_MULTI_TRACK_STATE_REQUEST",e,"info");this.emitEvent(t)}sendPollUpdate(e,t){let i=fa[e],s=this.store.getState(da(t));if(i){let e=this.createNotification(i,s,"info");this.emitEvent(e)}}sendTranscriptionUpdate(e){let t=this.createNotification(ya,e,"info");this.emitEvent(t)}emitEvent(e){this.eventEmitter.emit(ka,e)}createNotification(e,t,i,s=""){return this.id++,{id:this.id,type:e,message:s,data:t,severity:i}}},ba=class{constructor(e){this.queuedUpdates={},this.timers={},this.DEFAULT_INTERVAL_MS=50,this.store=e}setState(e,t,i=this.DEFAULT_INTERVAL_MS){this.queuedUpdates[t]=this.queuedUpdates[t]||[],this.queuedUpdates[t].push(e),!this.timers[t]&&(window?this.timers[t]=window.setTimeout((()=>this.setStateBatched(t)),i):this.setStateBatched(t))}setStateBatched(e){var t;if((null==(t=this.queuedUpdates[e])?void 0:t.length)>0){let t=t=>{this.queuedUpdates[e].forEach((e=>{try{e(t)}catch(be){Lr.w("failed to update store",be)}}))};console.time(`timed-${e}`),this.store.namedSetState(t,e),console.timeEnd(`timed-${e}`)}delete this.queuedUpdates[e],window&&this.timers[e]&&(window.clearTimeout(this.timers[e]),delete this.timers[e])}};var Sa,Pa,Ea=(e,t)=>{let i=_a(Object.keys(e),Object.keys(t));for(let s of i){let i=e[s],n=t[s];wa(i,n)?Object.assign(i,n):Ia(i,n)?delete e[s]:Aa(i,n)&&(e[s]=n)}},Ca=(e,t)=>{e.plugins&&Ra(e.plugins,t.plugins)&&(t.plugins=e.plugins),"video"===e.type&&e.layerDefinitions&&Ra(e.layerDefinitions,t.layerDefinitions)&&(t.layerDefinitions=e.layerDefinitions)},wa=(e,t)=>e&&t,Ia=(e,t)=>e&&!t,Aa=(e,t)=>!e&&t,Ra=(e,t)=>{if(e===t||0===e.length&&0===(null==t?void 0:t.length))return!0;if(!e||!t||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0},_a=(e,t)=>{let i=new Set;for(let s of e)i.add(s);for(let s of t)i.add(s);return Array.from(i)},La=class e{static convertPeer(e){var t,i,s;return{id:e.peerId,name:e.name,roleName:null==(t=e.role)?void 0:t.name,isLocal:e.isLocal,videoTrack:null==(i=e.videoTrack)?void 0:i.trackId,audioTrack:null==(s=e.audioTrack)?void 0:s.trackId,auxiliaryTracks:e.auxiliaryTracks.map((e=>e.trackId)),customerUserId:e.customerUserId,metadata:e.metadata,joinedAt:e.joinedAt,groups:e.groups,isHandRaised:e.isHandRaised,type:e.type}}static convertTrack(e,t){let i={id:e.trackId,source:e.source,type:e.type,enabled:e.enabled,displayEnabled:e.enabled,peerId:e.peerId||t};return this.enrichTrack(i,e),i}static enrichTrack(t,i){let s=i.getMediaTrackSettings();i instanceof ys&&(t.volume=i.getVolume()||0),e.updateDeviceID(t,i),e.enrichLocalTrack(t,i),"video"===t.type&&("screen"===t.source?(t.displaySurface=s.displaySurface,e.enrichScreenTrack(t,i)):"regular"===t.source&&(t.facingMode=s.facingMode),t.height=s.height,t.width=s.width,e.enrichVideoTrack(t,i)),e.enrichPluginsDetails(t,i)}static enrichLocalTrack(e,t){(t instanceof Bs||t instanceof fs)&&(e.isPublished=t.isPublished)}static updateDeviceID(e,t){var i;e.deviceID=t instanceof Bs||t instanceof fs?t.settings.deviceId:null==(i=t.getMediaTrackSettings())?void 0:i.deviceId}static enrichVideoTrack(e,t){t instanceof cn&&(e.layer=t.getLayer(),e.preferredLayer=t.getPreferredLayer(),e.degraded=t.degraded),(t instanceof cn||t instanceof Bs)&&(Ra(t.getSimulcastDefinitions(),e.layerDefinitions)||(e.layerDefinitions=t.getSimulcastDefinitions()))}static enrichScreenTrack(e,t){var i,s;if(t instanceof Bs){let n=null==(i=t.getCaptureHandle)?void 0:i.call(t);(null==n?void 0:n.handle)!==(null==(s=e.captureHandle)?void 0:s.handle)&&(e.captureHandle=n),t.isCurrentTab&&(e.displaySurface="selfBrowser")}}static enrichPluginsDetails(e,t){(t instanceof Bs||t instanceof fs)&&(Ra(t.getPlugins(),e.plugins)||(e.plugins=t.getPlugins()))}static convertRoom(t,i){let{recording:s,rtmp:n,hls:r,transcriptions:a}=e.convertRecordingStreamingState(t.recording,t.rtmp,t.hls,t.transcriptions);return{id:t.id,name:t.name,localPeer:i,recording:s,rtmp:n,hls:r,transcriptions:a,sessionId:t.sessionId,startedAt:t.startedAt,joinedAt:t.joinedAt,peerCount:t.peerCount,isLargeRoom:t.large_room_optimization,isEffectsEnabled:t.isEffectsEnabled,disableNoneLayerRequest:t.disableNoneLayerRequest,isVBEnabled:t.isVBEnabled,effectsKey:t.effectsKey,isHipaaEnabled:t.isHipaaEnabled,isNoiseCancellationEnabled:t.isNoiseCancellationEnabled}}static convertMessage(e,t){var i,s,n,r;return{sender:null==(i=e.peer)?void 0:i.peer_id,senderName:null==(s=e.peer)?void 0:s.info.name,senderRole:null==(n=e.peer)?void 0:n.role,senderUserId:null==(r=e.peer)?void 0:r.info.user_id,recipientPeer:e.private?t:void 0,recipientRoles:e.roles,time:new Date(e.timestamp),type:e.info.type,message:e.info.message,id:e.message_id}}static convertRoles(e){let t={};return e&&e.forEach((e=>{t[e.name]=e})),t}static convertRoleChangeRequest(e){var t;return{requestedBy:null==(t=e.requestedBy)?void 0:t.peerId,roleName:e.role.name,token:e.token}}static convertException(e){return{code:e.code,action:e.action,name:e.name,message:e.message,description:e.description,isTerminal:e.isTerminal,nativeError:e.nativeError,timestamp:new Date}}static convertDeviceChangeUpdate(e){let t={devices:e.devices,selection:e.selection,type:e.type};return e.error&&(t.error=this.convertException(e.error)),t}static convertPlaylist(e){return{audio:this.getConvertedPlaylistType(e,"audio"),video:this.getConvertedPlaylistType(e,"video")}}static convertPlaylistItem(e,t){let i=t.type,s=e.getCurrentSelection(i),n=e.isPlaying(i),r=t.url===(null==s?void 0:s.url);return At(It({},t),{type:t.type,selected:r,playing:r&&n})}static getConvertedPlaylistType(t,i){let s={},n=t.getCurrentSelection(i),r=t.getCurrentProgress(i),a=t.getVolume(i),o=t.getList(i),l=t.getCurrentIndex(i);return t.getList(i).forEach((i=>{s[i.id]=e.convertPlaylistItem(t,i)})),{list:s,selection:{id:null==n?void 0:n.id,hasPrevious:l>0,hasNext:l<o.length-1},progress:r,volume:a,currentTime:t.getCurrentTime(i),playbackRate:t.getPlaybackRate(i)}}static convertRecordingStreamingState(e,t,i,s){var n;return{recording:{browser:It({running:!1},null==e?void 0:e.browser),server:It({running:!1},null==e?void 0:e.server),hls:It({running:!1},null==e?void 0:e.hls)},rtmp:It({running:!1},t),hls:{variants:(null==(n=null==i?void 0:i.variants)?void 0:n.map((e=>e)))||[],running:!(null==i||!i.running),error:null==i?void 0:i.error},transcriptions:s||[]}}},Da=class{constructor(e,t,i,s){this.playlistManager=e,this.syncPlaylistState=i,this.store=s,this.type=t}play(e){return Lt(this,null,(function*(){e?yield this.playlistManager.setEnabled(!0,{id:e,type:this.type}):Lr.w("Please pass id to play")}))}pause(){return Lt(this,null,(function*(){let e="audio"===this.type?Ir:Ar,t=this.store.getState(e.selection);t.id?yield this.playlistManager.setEnabled(!1,{id:t.id,type:this.type}):Lr.w("No item is currently playing to pause")}))}playNext(){return Lt(this,null,(function*(){yield this.playlistManager.playNext(this.type)}))}playPrevious(){return Lt(this,null,(function*(){yield this.playlistManager.playPrevious(this.type)}))}seek(e){this.playlistManager.seek(e,this.type),this.syncPlaylistState(`seekOn${this.type}Playlist`)}seekTo(e){this.playlistManager.seekTo(e,this.type),this.syncPlaylistState(`seekToOn${this.type}Playlist`)}setVolume(e){this.playlistManager.setVolume(e,this.type),this.syncPlaylistState(`setVolumeOn${this.type}Playlist`)}setList(e){this.playlistManager.setList(e),this.syncPlaylistState(`setListOn${this.type}Playlist`)}stop(){return Lt(this,null,(function*(){yield this.playlistManager.stop(this.type),this.syncPlaylistState(`stop${this.type}Playlist`)}))}setIsAutoplayOn(e){this.playlistManager.setIsAutoplayOn(this.type,e)}setPlaybackRate(e){this.playlistManager.setPlaybackRate(this.type,e),this.syncPlaylistState(`set${this.type}PlaybackRate`)}removeItem(e){return Lt(this,null,(function*(){let t=yield this.playlistManager.removeItem(e,this.type);return t&&this.syncPlaylistState(`remove${this.type}PlaylistItem`),t}))}clearList(){return Lt(this,null,(function*(){yield this.playlistManager.clearList(this.type),this.syncPlaylistState(`clear${this.type}Playlist`)}))}},Ma=class{constructor(e,t){this.sdk=e,this.setLocally=t}get sdkSessionStore(){return this.sdk.getSessionStore()}set(e,t){return Lt(this,null,(function*(){let{value:i}=yield this.sdkSessionStore.set(String(e),t);this.setLocally({key:e,value:i})}))}observe(e){return Lt(this,null,(function*(){let t=Array.isArray(e)?e.map((e=>String(e))):[String(e)];yield this.sdkSessionStore.observe(t)}))}unobserve(e){return Lt(this,null,(function*(){let t=Array.isArray(e)?e.map((e=>String(e))):[String(e)];yield this.sdkSessionStore.unobserve(t)}))}},Na=class{constructor(e,t){this.intervalMs=100,this.shouldMonitor=!1,this.hasStarted=!1,this.unsubs=[],this.analysers={},this.store=e,this.actions=t}start(){return Lt(this,null,(function*(){if(this.hasStarted)return;this.hasStarted=!0,Lr.d("starting audio level monitor for remote peers",this.store);let e=this.store.getState(Hn);Lr.d("starting audio levels is connected to room",e),e&&(yield this.monitorAudioLevels());let t=this.store.subscribe(this.monitorAudioLevels.bind(this),Hn);this.unsubs.push(t)}))}stop(){return Lt(this,null,(function*(){this.hasStarted&&(this.hasStarted=!1,this.shouldMonitor=!1,this.unsubs.forEach((e=>e())),Lr.d("stopped audio level monitor for remote peers"))}))}monitorAudioLevels(){return Lt(this,null,(function*(){if(!this.store.getState(Hn))return void(this.shouldMonitor&&(Lr.i("room no longer connected, stopping audio level monitoring for remote"),this.shouldMonitor=!1));if(this.shouldMonitor)return;Lr.i("monitoring audio levels"),this.shouldMonitor=!0;let e=()=>{this.shouldMonitor?(this.logAllPeersAudioLevels(),setTimeout(e,this.intervalMs)):Lr.i("stopped monitoring audio levels")};setTimeout(e,1e3)}))}logAllPeersAudioLevels(){return Lt(this,null,(function*(){var e;if(!window.__triggerBeamEvent__)return;let t=this.store.getState(qn).filter((e=>!!e.audioTrack)),i=[];for(let s of t){let t=this.actions.getTrackById(s.audioTrack||""),n=null==(e=null==t?void 0:t.stream)?void 0:e.nativeStream;if(s.joinedAt&&n){let e=yield this.getAudioLevel(s,n);e.level>0&&i.push(e)}}if(i.length>0){let e={event:"app-audio-level",data:i};Lr.d("logging audio levels",i),window.__triggerBeamEvent__(JSON.stringify(e))}}))}getAudioLevel(e,t){return Lt(this,null,(function*(){this.analysers[t.id]||(this.analysers[t.id]=this.createAnalyserNode(t));let i=this.analysers[t.id],s=this.calculateAudioLevel(i);return{peerId:e.id,peerName:e.name,level:s}}))}createAnalyserNode(e){this.audioContext||(this.audioContext=new AudioContext);let t=this.audioContext.createAnalyser();return this.audioContext.createMediaStreamSource(e).connect(t),t}calculateAudioLevel(e){let t=new Uint8Array(e.fftSize);e.getByteTimeDomainData(t);let i=.009,s=i;for(let r of t)s=Math.max(s,(r-128)/128);let n=(Math.log(i)-Math.log(s))/Math.log(i);return Math.ceil(Math.min(Math.max(100*n,0),100))}},Oa={name:"diagnostics-role",priority:1,publishParams:{allowed:["audio","video"],audio:{bitRate:32,codec:"opus"},video:{bitRate:100,codec:"vp8",frameRate:30,height:720,width:1280},screen:{bitRate:100,codec:"vp8",frameRate:10,height:1080,width:1920}},subscribeParams:{subscribeToRoles:[],maxSubsBitRate:3200},permissions:{browserRecording:!1,changeRole:!1,endRoom:!1,hlsStreaming:!1,mute:!1,pollRead:!1,pollWrite:!1,removeOthers:!1,rtmpStreaming:!1,unmute:!1}},xa=class{constructor(){this.networkScores=[],this.lastPushedAt=0}pushScore(e){!e||e<0||(0===this.networkScores.length?(this.networkScores.push(e),this.lastPushedAt=Date.now()):this.addPendingCQSTillNow())}addPendingCQSTillNow(){if(this.networkScores.length>0){let e=(Date.now()-this.lastPushedAt)/1e3;for(;e>0;)this.networkScores.push(this.networkScores[this.networkScores.length-1]),e-=1;this.lastPushedAt=Date.now()}}getCQS(){return this.networkScores.reduce(((e,t)=>e+t),0)/this.networkScores.length}},Ua=e=>e[e.length-1],Ba=(e,t)=>{let i=e.filter((e=>(e=>!!e&&!isNaN(e))(t(e))));return i.reduce(((e,i)=>e+(t(i)||0)),0)/i.length},Fa=class{constructor(e){this.sdk=e,this.peerStatsList=[],this.localAudioTrackStatsList=[],this.localVideoTrackStatsList=[],this.remoteAudioTrackStatsList=[],this.remoteVideoTrackStatsList=[]}handleStatsUpdate(e){return Lt(this,null,(function*(){var t,i,s,n,r,a,o,l;let d=e.getLocalPeerStats();d&&this.peerStatsList.push(d);let c=null==(s=null==(i=null==(t=this.sdk.getLocalPeer())?void 0:t.audioTrack)?void 0:i.nativeTrack)?void 0:s.id,u=null==(a=null==(r=null==(n=this.sdk.getLocalPeer())?void 0:n.videoTrack)?void 0:r.nativeTrack)?void 0:a.id,h=e.getLocalTrackStats();h&&(c&&this.localAudioTrackStatsList.push(h[c]),u&&this.localVideoTrackStatsList.push(h[u]));let p=yield null==(l=null==(o=this.sdk.getWebrtcInternals())?void 0:o.getSubscribePeerConnection())?void 0:l.getStats();null==p||p.forEach((e=>{if("inbound-rtp"===e.type){let t="audio"===e.kind?this.remoteAudioTrackStatsList:this.remoteVideoTrackStatsList,i=kn("bytesReceived",e,Ua(t));t.push(At(It({},e),{bitrate:i}))}}))}))}buildReport(){var e,t,i,s,n,r,a,o;let l=null==(e=Ua(this.peerStatsList))?void 0:e.publish,d=null==(t=Ua(this.peerStatsList))?void 0:t.subscribe,c=null!=l&&l.responsesReceived?((null==l?void 0:l.totalRoundTripTime)||0)/l.responsesReceived:0,u=null!=d&&d.responsesReceived?((null==d?void 0:d.totalRoundTripTime)||0)/d.responsesReceived:0,h=Number(((c+u)/2*1e3).toFixed(2)),p=(null==(i=Ua(this.remoteAudioTrackStatsList))?void 0:i.packetsReceived)||0,v=(null==(s=Ua(this.remoteVideoTrackStatsList))?void 0:s.packetsReceived)||0,g=this.localAudioTrackStatsList.map((e=>e?Ba(Object.values(e),(e=>e.bitrate)):0)),m=this.localVideoTrackStatsList.map((e=>e?Ba(Object.values(e),(e=>e.bitrate)):0)),f=Ua(this.localAudioTrackStatsList),y=Ua(this.localVideoTrackStatsList);return{combined:{roundTripTime:h,packetsReceived:p+v,packetsLost:(null==d?void 0:d.packetsLost)||0,bytesSent:(null==l?void 0:l.bytesSent)||0,bytesReceived:(null==d?void 0:d.bytesReceived)||0,bitrateSent:Ba(this.peerStatsList,(e=>{var t;return null==(t=e.publish)?void 0:t.bitrate})),bitrateReceived:Ba(this.peerStatsList,(e=>{var t;return null==(t=e.subscribe)?void 0:t.bitrate}))},audio:{roundTripTime:h,packetsReceived:p,packetsLost:(null==(n=Ua(this.remoteAudioTrackStatsList))?void 0:n.packetsLost)||0,bytesReceived:(null==(r=Ua(this.remoteAudioTrackStatsList))?void 0:r.bytesReceived)||0,bitrateSent:Ba(g,(e=>e)),bitrateReceived:Ba(this.remoteAudioTrackStatsList,(e=>e.bitrate)),bytesSent:f?Object.values(f).reduce(((e,t)=>e+(t.bytesSent||0)),0):0},video:{roundTripTime:h,packetsLost:(null==(a=Ua(this.remoteVideoTrackStatsList))?void 0:a.packetsLost)||0,bytesReceived:(null==(o=Ua(this.remoteVideoTrackStatsList))?void 0:o.bytesReceived)||0,packetsReceived:v,bitrateSent:Ba(m,(e=>e)),bitrateReceived:Ba(this.remoteVideoTrackStatsList,(e=>e.bitrate)),bytesSent:y?Object.values(y).reduce(((e,t)=>e+(t.bytesSent||0)),0):0}}}},Ga=(e=>(e[e.STARTING=0]="STARTING",e[e.INIT_FETCHED=1]="INIT_FETCHED",e[e.SIGNAL_CONNECTED=2]="SIGNAL_CONNECTED",e[e.ICE_ESTABLISHED=3]="ICE_ESTABLISHED",e[e.MEDIA_CAPTURED=4]="MEDIA_CAPTURED",e[e.MEDIA_PUBLISHED=5]="MEDIA_PUBLISHED",e[e.COMPLETED=6]="COMPLETED",e))(Ga||{}),$a=class{constructor(e,t,i,s){this.sdk=e,this.sdkListener=t,this.progressCallback=i,this.completionCallback=s,this.wsConnected=!1,this.initConnected=!1,this.isPublishICEConnected=!1,this.isSubscribeICEConnected=!1,this.gatheredPublishICECandidates=[],this.gatheredSubscribeICECandidates=[],this.errors=[],this.isAudioTrackCaptured=!1,this.isVideoTrackCaptured=!1,this.isAudioTrackPublished=!1,this.isVideoTrackPublished=!1,this.cqsCalculator=new xa,this.timestamp=Date.now(),this.onRoomUpdate=this.sdkListener.onRoomUpdate.bind(this.sdkListener),this.onPeerUpdate=this.sdkListener.onPeerUpdate.bind(this.sdkListener),this.onMessageReceived=this.sdkListener.onMessageReceived.bind(this.sdkListener),this.onReconnected=this.sdkListener.onReconnected.bind(this.sdkListener),this.onRoleChangeRequest=this.sdkListener.onRoleChangeRequest.bind(this.sdkListener),this.onRoleUpdate=this.sdkListener.onRoleUpdate.bind(this.sdkListener),this.onChangeTrackStateRequest=this.sdkListener.onChangeTrackStateRequest.bind(this.sdkListener),this.onChangeMultiTrackStateRequest=this.sdkListener.onChangeMultiTrackStateRequest.bind(this.sdkListener),this.onRemovedFromRoom=this.sdkListener.onRemovedFromRoom.bind(this.sdkListener),this.onNetworkQuality=null==(Sa=this.sdkListener.onNetworkQuality)?void 0:Sa.bind(this.sdkListener),this.onPreview=this.sdkListener.onPreview.bind(this.sdkListener),this.onDeviceChange=null==(Pa=this.sdkListener.onDeviceChange)?void 0:Pa.bind(this.sdkListener),this.onSessionStoreUpdate=this.sdkListener.onSessionStoreUpdate.bind(this.sdkListener),this.onPollsUpdate=this.sdkListener.onPollsUpdate.bind(this.sdkListener),this.onWhiteboardUpdate=this.sdkListener.onWhiteboardUpdate.bind(this.sdkListener),this.handleConnectionQualityUpdate=e=>{let t=e.find((e=>{var t,i;return e.peerID===(null==(i=null==(t=this.sdk)?void 0:t.store.getLocalPeer())?void 0:i.peerId)}));this.cqsCalculator.pushScore(null==t?void 0:t.downlinkQuality)},this.statsCollector=new Fa(e),this.state=0}get state(){return this._state}set state(e){var t;void 0===e||void 0!==this._state&&e<this._state||(this._state=e,null==(t=this.progressCallback)||t.call(this,e))}onICESuccess(e){e?this.isPublishICEConnected=!0:this.isSubscribeICEConnected=!0,this.isPublishICEConnected&&this.isSubscribeICEConnected&&(this.state=3)}onSelectedICECandidatePairChange(e,t){t?this.selectedPublishICECandidate=e:this.selectedSubscribeICECandidate=e}onICECandidate(e,t){t?this.gatheredPublishICECandidates.push(e):this.gatheredSubscribeICECandidates.push(e)}onMediaPublished(e){switch(e.type){case"audio":this.isAudioTrackPublished=!0;break;case"video":this.isVideoTrackPublished=!0}this.isVideoTrackPublished&&this.isAudioTrackPublished&&(this.state=5)}onInitSuccess(e){this.websocketURL=e,this.initConnected=!0,this.state=1}onSignallingSuccess(){this.wsConnected=!0,this.state=2}onJoin(e){var t,i;this.sdkListener.onJoin(e),null==(t=this.sdk.getWebrtcInternals())||t.onStatsChange((e=>this.statsCollector.handleStatsUpdate(e))),null==(i=this.sdk.getWebrtcInternals())||i.start(),this.cleanupTimer=window.setTimeout((()=>{this.cleanupAndReport()}),2e4)}onError(e){this.sdkListener.onError(e),this.errors.push(e),null!=e&&e.isTerminal&&this.cleanupAndReport()}onTrackUpdate(e,t,i){if(this.sdkListener.onTrackUpdate(e,t,i),i.isLocal&&0===e){switch(t.type){case"audio":this.isAudioTrackCaptured=!0;break;case"video":this.isVideoTrackCaptured=!0}this.isVideoTrackCaptured&&this.isAudioTrackCaptured&&(this.state=4)}}onReconnecting(e){this.sdkListener.onReconnecting(e),this.cqsCalculator.addPendingCQSTillNow()}cleanupAndReport(){var e;clearTimeout(this.cleanupTimer),this.cleanupTimer=void 0,5===this.state&&(this.state=6),null==(e=this.completionCallback)||e.call(this,this.buildReport()),this.sdk.leave()}buildReport(){this.cqsCalculator.addPendingCQSTillNow();let e=this.cqsCalculator.getCQS(),t=this.statsCollector.buildReport();return{testTimestamp:this.timestamp,connectivityState:this.state,errors:this.errors,signallingReport:{isConnected:this.wsConnected,isInitConnected:this.initConnected,websocketUrl:this.websocketURL},mediaServerReport:{stats:t,connectionQualityScore:e,isPublishICEConnected:this.isPublishICEConnected,isSubscribeICEConnected:this.isSubscribeICEConnected,publishICECandidatePairSelected:this.selectedPublishICECandidate,subscribeICECandidatePairSelected:this.selectedSubscribeICECandidate,publishIceCandidatesGathered:this.gatheredPublishICECandidates,subscribeIceCandidatesGathered:this.gatheredSubscribeICECandidates}}}},ja=class{constructor(e){this.recording={server:{running:!1},browser:{running:!1},hls:{running:!1}},this.rtmp={running:!1},this.hls={running:!1,variants:[]},this.transcriptions=[],this.id=e}},Va=(e,t,i)=>Lt(void 0,null,(function*(){let s=Error("something went wrong during fetch");for(let n=0;n<4;n++)try{let s=yield fetch(e,t),n=yield s.clone().json();if(i&&i.length&&!s.ok&&i.includes(n.code))throw mi.APIErrors.ServerErrors(n.code,"GET_TOKEN",n.message,!1);return s}catch(be){s=be}throw["Failed to fetch","NetworkError"].some((e=>s.message.includes(e)))?mi.APIErrors.EndpointUnreachable("GET_TOKEN",s.message):s})),Wa=class{constructor(e,t){this.sdk=e,this.sdkListener=t,this.recordedAudio="https://100ms.live/test-audio.wav",this.sdk.setIsDiagnostics(!0),this.initSdkWithLocalPeer()}get localPeer(){var e;return null==(e=this.sdk)?void 0:e.store.getLocalPeer()}checkBrowserSupport(){Pi(),Si()}requestPermission(e){return Lt(this,null,(function*(){try{let t=yield navigator.mediaDevices.getUserMedia(e);return t.getTracks().forEach((e=>e.stop())),yield this.sdk.deviceManager.init(!0),{audio:t.getAudioTracks().length>0,video:t.getVideoTracks().length>0}}catch(ke){throw Gi(ke,this.sdk.localTrackManager.getErrorType(!!e.video,!!e.audio))}}))}startCameraCheck(e){return Lt(this,null,(function*(){var t,i,s,n;if(this.initSdkWithLocalPeer(),!this.localPeer)throw new Error("Local peer not found");this.sdk.store.setSimulcastEnabled(!1),this.localPeer.role=At(It({},Oa),{publishParams:At(It({},Oa.publishParams),{allowed:["video"]})});let r=(new hs).video((new cs).deviceId(e||"default").build()).build(),a=yield null==(t=this.sdk)?void 0:t.localTrackManager.getLocalTracks({audio:!1,video:!0},r),o=null==a?void 0:a.find((e=>"video"===e.type));if(!o)throw new Error("No video track found");null==(i=this.sdk)||i.deviceManager.init(!0),this.localPeer.videoTrack=o,null==(n=null==(s=this.sdk)?void 0:s.listener)||n.onPeerUpdate(9,[this.localPeer])}))}stopCameraCheck(){var e,t;null==(t=null==(e=this.localPeer)?void 0:e.videoTrack)||t.cleanup(),this.localPeer&&(this.localPeer.videoTrack=void 0)}startMicCheck(e){return Lt(this,arguments,(function*({inputDevice:e,onError:t,onStop:i,time:s=1e4}){var n,r,a,o;this.initSdkWithLocalPeer((e=>{this.stopMicCheck(),null==t||t(e)}));let l=yield this.getLocalAudioTrack(e);if(null==(n=this.sdk)||n.deviceManager.init(!0),!this.localPeer)throw new Error("Local peer not found");if(!l)throw new Error("No audio track found");this.localPeer.audioTrack=l,null==(r=this.sdk)||r.initPreviewTrackAudioLevelMonitor(),null==(o=null==(a=this.sdk)?void 0:a.listener)||o.onPeerUpdate(9,[this.localPeer]),this.mediaRecorder=new MediaRecorder(l.stream.nativeStream);let d=[];this.mediaRecorder.ondataavailable=function(e){d.push(e.data)},this.mediaRecorder.onstop=()=>{var e,t;let i=new Blob(d,{type:null==(e=this.mediaRecorder)?void 0:e.mimeType});this.recordedAudio=URL.createObjectURL(i),null==(t=this.onStopMicCheck)||t.call(this)},this.mediaRecorder.start();let c=setTimeout((()=>{this.stopMicCheck()}),s);this.onStopMicCheck=()=>{clearTimeout(c),null==i||i()}}))}stopMicCheck(){var e,t,i;null==(e=this.mediaRecorder)||e.stop(),null==(i=null==(t=this.localPeer)?void 0:t.audioTrack)||i.cleanup(),this.localPeer&&(this.localPeer.audioTrack=void 0)}getRecordedAudio(){return this.recordedAudio}startConnectivityCheck(e,t,i){return Lt(this,null,(function*(){if(!this.sdk)throw new Error("SDK not found");this.connectivityCheck=new $a(this.sdk,this.sdkListener,e,t);let s=yield this.getAuthToken(i);yield this.sdk.leave(),yield this.sdk.join({authToken:s,userName:"diagnostics-test"},this.connectivityCheck),this.sdk.addConnectionQualityListener({onConnectionQualityUpdate:e=>{var t;null==(t=this.connectivityCheck)||t.handleConnectionQualityUpdate(e)}})}))}stopConnectivityCheck(){return Lt(this,null,(function*(){var e;return null==(e=this.connectivityCheck)?void 0:e.cleanupAndReport()}))}initSdkWithLocalPeer(e){var t,i,s;this.sdkListener&&(null==(t=this.sdk)||t.initStoreAndManagers(At(It({},this.sdkListener),{onError:t=>{null==e||e(t),this.sdkListener.onError(t)}})));let n=new wn({name:"diagnostics-peer",role:Oa,type:"regular"});null==(i=this.sdk)||i.store.addPeer(n);let r=new ja("diagnostics-room");this.sdk.store.setRoom(r),this.sdkListener.onRoomUpdate("ROOM_PEER_COUNT_UPDATED",r),null==(s=this.sdk)||s.deviceManager.init(!0)}getAuthToken(e){return Lt(this,null,(function*(){let t=new URL("https://api.100ms.live/v2/diagnostics/token");e&&t.searchParams.append("region",e);let i=yield Va(t.toString(),{method:"GET"},[429,500,501,502,503,504,505,506,507,508,509,510,511]),s=yield i.json();if(!i.ok)throw mi.APIErrors.ServerErrors(s.code,"GET_TOKEN",s.message,!1);let{token:n}=s;if(!n)throw Error(s.message);return n}))}getLocalAudioTrack(e){return Lt(this,null,(function*(){var t;if(!this.localPeer)return;this.localPeer.role=At(It({},Oa),{publishParams:At(It({},Oa.publishParams),{allowed:["audio"]})});let i=(new hs).audio((new ls).deviceId(e||"default").build()).build(),s=yield null==(t=this.sdk)?void 0:t.localTrackManager.getLocalTracks({audio:!0,video:!1},i);return null==s?void 0:s.find((e=>"audio"===e.type))}))}},Ha=class{constructor(e,t,i){this.isRoomJoinCalled=!1,this.ignoredMessageTypes=[],this.setProgress=({type:e,progress:t})=>{this.setState((i=>{i.playlist[e].progress=t,i.playlist[e].currentTime=this.sdk.getPlaylistManager().getCurrentTime(e)}),"playlistProgress")},this.syncPlaylistState=e=>{this.setState((e=>{Object.assign(e.playlist,La.convertPlaylist(this.sdk.getPlaylistManager()))}),e)},this.sendPeerUpdateNotification=(e,t)=>{let i=this.store.getState(jr(t.peerId)),s=ga[e]||"peerUpdate";if(8===e)this.syncRoomState(s),this.updateMidCallPreviewRoomState(e,t);else if([0,1].includes(e))this.syncRoomState(s),i||(i=this.store.getState(jr(t.peerId)));else if([12,13,14].includes(e))this.syncRoomState(s),i||(i=this.store.getState(jr(t.peerId)));else{let e=La.convertPeer(t);this.setState((t=>{let s=t.peers[e.id];wa(s,e)&&(Ra(s.auxiliaryTracks,e.auxiliaryTracks)&&(s.auxiliaryTracks=e.auxiliaryTracks),Object.assign(s,e)),i=e}),s)}this.hmsNotifications.sendPeerUpdate(e,i)},this.getSDKHMSPeer=e=>this.sdk.getPeerMap()[e],this.setState=(e,t)=>this.store.namedSetState(e,t),this.store=e,this.sdk=t,this.hmsNotifications=i,this.sessionStore=new Ma(this.sdk,this.setSessionStoreValueLocally.bind(this)),this.actionBatcher=new ba(e)}submitSessionFeedback(e,t){return this.sdk.submitSessionFeedback(e,t)}getLocalTrack(e){return this.sdk.store.getLocalPeerTracks().find((t=>t.trackId===e))}get interactivityCenter(){return this.sdk.getInteractivityCenter()}setPlaylistSettings(e){this.sdk.updatePlaylistSettings(e)}refreshDevices(){return Lt(this,null,(function*(){yield this.sdk.refreshDevices()}))}unblockAudio(){return Lt(this,null,(function*(){yield this.sdk.getAudioOutput().unblockAutoplay()}))}setVolume(e,t){return Lt(this,null,(function*(){t?yield this.setTrackVolume(e,t):(yield this.sdk.getAudioOutput().setVolume(e),this.syncRoomState("setOutputVolume"))}))}setAudioOutputDevice(e){return Lt(this,null,(function*(){(yield this.sdk.getAudioOutput().setDevice(e))&&this.setState((t=>{t.settings.audioOutputDeviceId=e}),"setAudioOutputDevice")}))}setPreferredLayer(e,t){return Lt(this,null,(function*(){var i;let s=this.getTrackById(e);if(s)if(s instanceof cn){if("none"===t)return void Lr.d("layer none will be ignored");if((null==(i=this.store.getState(Wr(e)))?void 0:i.preferredLayer)===t)return void Lr.d(`preferred layer is already ${t}`);this.setState((i=>{let s=i.tracks[e];s&&(s.preferredLayer=t)}),"setPreferredLayer"),yield s.setPreferredLayer(t)}else Lr.d(`track ${e} is not a remote video track`);else this.logPossibleInconsistency(`track ${e} not present, unable to set preffer layer`)}))}getNativeTrackById(e){var t;return null==(t=this.sdk.store.getTrackById(e))?void 0:t.nativeTrack}getTrackById(e){return this.sdk.store.getTrackById(e)}getAuthTokenByRoomCode(e,t){return this.sdk.getAuthTokenByRoomCode(e,t)}preview(e){return Lt(this,null,(function*(){let t=this.store.getState(dr);if("Preview"!==t&&"Connecting"!==t)try{"Connected"!==t&&this.setState((e=>{e.room.roomState="Connecting"}),"connecting"),yield this.sdkPreviewWithListeners(e)}catch(Te){throw Lr.e("Cannot show preview. Failed to connect to room - ",Te),Te}else this.logPossibleInconsistency("attempting to call preview while room is in preview/connecting")}))}cancelMidCallPreview(){return Lt(this,null,(function*(){return this.sdk.cancelMidCallPreview()}))}join(e){return Lt(this,null,(function*(){if(this.isRoomJoinCalled)this.logPossibleInconsistency("room join is called again");else try{this.isRoomJoinCalled=!0,this.setState((e=>{e.room.roomState="Connecting"}),"join"),yield this.sdkJoinWithListeners(e)}catch(ke){throw this.isRoomJoinCalled=!1,Lr.e("Failed to connect to room - ",ke),ke}}))}leave(){return Lt(this,null,(function*(){let e=!0;this.store.getState(Hn)||(e=!1,this.logPossibleInconsistency("room leave is called when no room is connected"));let t=this.store.getState(dr);return this.setState((e=>{e.room.roomState="Disconnecting"}),"leaving"),this.sdk.leave(e).then((()=>{this.resetState("leave"),this.beamSpeakerLabelsLogger&&this.beamSpeakerLabelsLogger.stop().catch(Lr.e),Lr.i("left room")})).catch((e=>{Lr.e("error in leaving room - ",e),this.setState((e=>{e.room.roomState=t}),"revertLeave")}))}))}setScreenShareEnabled(e,t){return Lt(this,null,(function*(){"boolean"==typeof t&&(t={audioOnly:t});try{e?yield this.startScreenShare(t):yield this.stopScreenShare()}catch(Te){throw this.hmsNotifications.sendError(La.convertException(Te)),Te}}))}addTrack(e,t="regular"){return Lt(this,null,(function*(){yield this.sdk.addTrack(e,t),this.syncRoomState("addTrack")}))}removeTrack(e){return Lt(this,null,(function*(){yield this.sdk.removeTrack(e),this.syncRoomState("removeTrack")}))}setLocalAudioEnabled(e){return Lt(this,null,(function*(){let t=this.store.getState(Qn);t&&(yield this.setEnabledTrack(t,e))}))}setLocalVideoEnabled(e){return Lt(this,null,(function*(){let t=this.store.getState(Yn);t&&(yield this.setEnabledTrack(t,e))}))}setEnabledTrack(e,t){return Lt(this,null,(function*(){var i;if((null==(i=this.store.getState().tracks[e])?void 0:i.enabled)===t)return void this.logPossibleInconsistency(`local track[${e}] enabled state - ${t}`);this.setState((i=>{i.tracks[e]?i.tracks[e].displayEnabled=t:this.logPossibleInconsistency("track id not found for setEnabled")}),"displayEnabled");try{yield this.setEnabledSDKTrack(e,t),this.syncRoomState("setEnabled")}catch(be){throw this.setState((i=>{i.tracks[e].displayEnabled=!t}),"rollbackDisplayEnabled"),this.hmsNotifications.sendError(La.convertException(be)),be}let s=t?3:2;this.hmsNotifications.sendTrackUpdate(s,e)}))}setAudioSettings(e){return Lt(this,null,(function*(){let t=this.store.getState(Qn);t&&(yield this.setSDKLocalAudioTrackSettings(t,e),this.syncRoomState("setAudioSettings"))}))}setVideoSettings(e){return Lt(this,null,(function*(){let t=this.store.getState(Yn);t&&(yield this.setSDKLocalVideoTrackSettings(t,e),this.syncRoomState("setVideoSettings"))}))}switchCamera(){return Lt(this,null,(function*(){let e=this.store.getState(Yn);if(e){let t=this.sdk.store.getLocalPeerTracks().find((t=>t.trackId===e));t&&(yield t.switchCamera(),this.syncRoomState("switchCamera"))}}))}sendMessage(e){this.sendBroadcastMessage(e)}sendBroadcastMessage(e,t){return Lt(this,null,(function*(){let{message_id:i,timestamp:s}=yield this.sdk.sendBroadcastMessage(e,t);this.updateMessageInStore({message:e,type:t,id:i,time:s})}))}sendGroupMessage(e,t,i){return Lt(this,null,(function*(){let s=this.store.getState(ur),n=t.map((e=>s[e])),{message_id:r,timestamp:a}=yield this.sdk.sendGroupMessage(e,n,i);this.updateMessageInStore({message:e,recipientRoles:t,type:i,id:r,time:a})}))}sendDirectMessage(e,t,i){return Lt(this,null,(function*(){let{message_id:s,timestamp:n}=yield this.sdk.sendDirectMessage(e,t,i);this.updateMessageInStore({message:e,recipientPeer:t,type:i,id:s,time:n})}))}updateMessageInStore(e){var t;if(!e.message)throw Lr.w("sendMessage","Failed to send message",e),Error(`sendMessage Failed - ${JSON.stringify(e)}`);if(e.type&&this.ignoredMessageTypes.includes(e.type))return;let i=this.sdk.getLocalPeer(),s={read:!0,id:e.id,time:new Date(e.time),message:e.message,type:e.type||"chat",recipientPeer:e.recipientPeer,recipientRoles:e.recipientRoles,senderName:null==i?void 0:i.name,sender:null==i?void 0:i.peerId,senderRole:null==(t=null==i?void 0:i.role)?void 0:t.name,ignored:!1};this.setState((e=>{e.messages.byID[s.id]=s,e.messages.allIDs.push(s.id)}),"newMessage")}setMessageRead(e,t){this.setState((i=>{t?i.messages.byID[t]?i.messages.byID[t].read=e:this.logPossibleInconsistency("no message with id is found"):i.messages.allIDs.forEach((t=>{i.messages.byID[t].read=e}))}),"setMessageRead")}attachVideo(e,t){return Lt(this,null,(function*(){if(this.localAndVideoUnmuting(e))return new Promise((i=>{let s=this.store.subscribe((n=>Lt(this,null,(function*(){n&&(yield this.attachVideoInternal(e,t),s(),i())}))),ir)}));yield this.attachVideoInternal(e,t)}))}detachVideo(e,t){return Lt(this,null,(function*(){let i=this.getTrackById(e);"video"===(null==i?void 0:i.type)?yield this.sdk.detachVideo(i,t):(t&&(t.srcObject=null),Lr.d("possible inconsistency detected - no video track found to remove sink"))}))}addPluginToVideoTrack(e,t){return Lt(this,null,(function*(){return this.addRemoveVideoPlugin(e,"add",t)}))}addPluginsToVideoStream(e){return Lt(this,null,(function*(){return this.addRemoveMediaStreamVideoPlugins(e,"add")}))}removePluginsFromVideoStream(e){return Lt(this,null,(function*(){return this.addRemoveMediaStreamVideoPlugins(e,"remove")}))}addPluginToAudioTrack(e){return Lt(this,null,(function*(){return this.addRemoveAudioPlugin(e,"add")}))}validateVideoPluginSupport(e){let t={isSupported:!1};if(!e)return Lr.w("no plugin passed in for checking support"),t.errMsg="no plugin passed in for checking support",t;let i=this.store.getState(Yn);if(!i)return Lr.w("video Track not added to local peer yet"),t.errMsg="call this function only after local peer has video track",t;let s=this.getTrackById(i);return s?t=s.validatePlugin(e):(Lr.w(`track ${i} not present, unable to validate plugin`),t.errMsg=`track ${i} not present, unable to validate plugin`),t}validateAudioPluginSupport(e){let t={isSupported:!1};if(!e)return Lr.w('no plugin passed in for checking support"'),t.errMsg='no plugin passed in for checking support"',t;let i=this.store.getState(Qn);if(!i)return Lr.w("audio track not added to local peer yet"),t.errMsg="call this function only after local peer has audio track",t;let s=this.getTrackById(i);return s?t=s.validatePlugin(e):(Lr.w(`track ${i} not present, unable to validate plugin`),t.errMsg=`track ${i} not present, unable to validate plugin`),t}removePluginFromVideoTrack(e){return Lt(this,null,(function*(){return this.addRemoveVideoPlugin(e,"remove")}))}removePluginFromAudioTrack(e){return Lt(this,null,(function*(){return this.addRemoveAudioPlugin(e,"remove")}))}changeRole(e,t,i=!1){return Lt(this,null,(function*(){yield this.sdk.changeRoleOfPeer(e,t,i)}))}changeRoleOfPeer(e,t,i=!1){return Lt(this,null,(function*(){yield this.sdk.changeRoleOfPeer(e,t,i)}))}changeRoleOfPeersWithRoles(e,t){return Lt(this,null,(function*(){let i=this.sdk.getRoles().filter((t=>e.includes(t.name)));yield this.sdk.changeRoleOfPeersWithRoles(i,t)}))}acceptChangeRole(e){return Lt(this,null,(function*(){let t=e.requestedBy?this.getSDKHMSPeer(e.requestedBy.id):void 0;t||Lr.w(`peer for which role change is requested no longer available - ${e.requestedBy}`);let i={requestedBy:t,role:e.role,token:e.token};yield this.sdk.acceptChangeRole(i),this.removeRoleChangeRequest(e)}))}raiseLocalPeerHand(){return Lt(this,null,(function*(){yield this.sdk.raiseLocalPeerHand()}))}lowerLocalPeerHand(){return Lt(this,null,(function*(){yield this.sdk.lowerLocalPeerHand()}))}raiseRemotePeerHand(e){return Lt(this,null,(function*(){yield this.sdk.raiseRemotePeerHand(e)}))}lowerRemotePeerHand(e){return Lt(this,null,(function*(){yield this.sdk.lowerRemotePeerHand(e)}))}getPeer(e){return Lt(this,null,(function*(){let t=yield this.sdk.getPeer(e);if(t)return La.convertPeer(t)}))}findPeerByName(e){return Lt(this,null,(function*(){let{offset:t,peers:i,eof:s}=yield this.sdk.findPeerByName(e);return{offset:t,eof:s,peers:i.map((e=>La.convertPeer(e)))}}))}getPeerListIterator(e){let t=this.sdk.getPeerListIterator(e);return{hasNext:()=>t.hasNext(),next:()=>Lt(this,null,(function*(){return(yield t.next()).map((e=>La.convertPeer(e)))})),findPeers:()=>Lt(this,null,(function*(){return(yield t.findPeers()).map((e=>La.convertPeer(e)))})),getTotal:()=>t.getTotal()}}initAppData(e){this.setState((t=>{t.appData=e}),"initAppData")}setAppData(e,t,i){let s="Object"===(null==t?void 0:t.constructor.name);this.setState((n=>{if(n.appData)i&&s?Object.assign(n.appData[e],t):n.appData[e]=t;else{let i={[e]:t};n.appData=i}}),`setAppData-${e}`)}rejectChangeRole(e){this.removeRoleChangeRequest(e)}endRoom(e,t){return Lt(this,null,(function*(){let i=this.store.getState(vr);if(null==i||!i.endRoom)return void Lr.w("You are not allowed to perform this action - endRoom");let s=this.store.getState(dr);this.setState((e=>{e.room.roomState="Disconnecting"}),"endingRoom");try{yield this.sdk.endRoom(e,t),this.resetState("endRoom")}catch(we){Lr.e("error in ending room - ",we),this.setState((e=>{e.room.roomState=s}),"revertEndRoom")}}))}removePeer(e,t){return Lt(this,null,(function*(){var i;let s=null==(i=this.sdk.getLocalPeer())?void 0:i.peerId;e!==s&&(yield this.sdk.removePeer(e,t))}))}startRTMPOrRecording(e){return Lt(this,null,(function*(){yield this.sdk.startRTMPOrRecording(e)}))}stopRTMPAndRecording(){return Lt(this,null,(function*(){yield this.sdk.stopRTMPAndRecording()}))}startHLSStreaming(e){return Lt(this,null,(function*(){yield this.sdk.startHLSStreaming(e)}))}stopHLSStreaming(e){return Lt(this,null,(function*(){yield this.sdk.stopHLSStreaming(e)}))}startTranscription(e){return Lt(this,null,(function*(){yield this.sdk.startTranscription(e)}))}stopTranscription(e){return Lt(this,null,(function*(){yield this.sdk.stopTranscription(e)}))}sendHLSTimedMetadata(e){return Lt(this,null,(function*(){yield this.sdk.sendHLSTimedMetadata(e)}))}changeName(e){return Lt(this,null,(function*(){yield this.sdk.changeName(e)}))}changeMetadata(e){return Lt(this,null,(function*(){"string"!=typeof e&&(e=JSON.stringify(e)),yield this.sdk.changeMetadata(e)}))}setSessionMetadata(e){return Lt(this,null,(function*(){yield this.sdk.setSessionMetadata(e),this.setState((t=>{t.sessionMetadata=e}),"setSessionMetadata"),this.setSessionStoreValueLocally({key:"default",value:e},"setSessionMetadata")}))}populateSessionMetadata(){return Lt(this,null,(function*(){let e=yield this.sdk.getSessionMetadata();this.setState((t=>{t.sessionMetadata=e}),"populateSessionMetadata"),this.setSessionStoreValueLocally({key:"default",value:e},"populateSessionmetadata")}))}setRemoteTrackEnabled(e,t){return Lt(this,null,(function*(){if("string"==typeof e){let i=this.getTrackById(e);i&&function(e){return e instanceof ys||e instanceof cn}(i)?yield this.sdk.changeTrackState(i,t):this.logPossibleInconsistency(`No remote track with ID ${e} found for change track state`)}else Array.isArray(e)&&e.forEach((e=>this.setRemoteTrackEnabled(e,t)))}))}setRemoteTracksEnabled(e){return Lt(this,null,(function*(){let t={enabled:e.enabled,type:e.type,source:e.source};if(e.roles){let i=this.store.getState(ur);t.roles=e.roles.map((e=>i[e]))}yield this.sdk.changeMultiTrackState(t)}))}setLogLevel(e){Lr.level=e,this.sdk.setLogLevel(e)}setFrameworkInfo(e){this.sdk.setFrameworkInfo(e)}ignoreMessageTypes(e,t=!1){if(t)this.ignoredMessageTypes=e;else for(let i of e)this.ignoredMessageTypes.includes(i)||this.ignoredMessageTypes.push(i)}enableBeamSpeakerLabelsLogging(){return Lt(this,null,(function*(){this.beamSpeakerLabelsLogger||(Lr.i("enabling beam speaker labels logging"),this.beamSpeakerLabelsLogger=new Na(this.store,this),yield this.beamSpeakerLabelsLogger.start())}))}initDiagnostics(){let e=new Wa(this.sdk,{onJoin:this.onJoin.bind(this),onPreview:this.onPreview.bind(this),onRoomUpdate:this.onRoomUpdate.bind(this),onPeerUpdate:this.onPeerUpdate.bind(this),onTrackUpdate:this.onTrackUpdate.bind(this),onMessageReceived:this.onMessageReceived.bind(this),onError:this.onError.bind(this),onReconnected:this.onReconnected.bind(this),onReconnecting:this.onReconnecting.bind(this),onRoleChangeRequest:this.onRoleChangeRequest.bind(this),onRoleUpdate:this.onRoleUpdate.bind(this),onDeviceChange:this.onDeviceChange.bind(this),onChangeTrackStateRequest:this.onChangeTrackStateRequest.bind(this),onChangeMultiTrackStateRequest:this.onChangeMultiTrackStateRequest.bind(this),onRemovedFromRoom:this.onRemovedFromRoom.bind(this),onNetworkQuality:this.onNetworkQuality.bind(this),onSessionStoreUpdate:this.onSessionStoreUpdate.bind(this),onPollsUpdate:this.onPollsUpdate.bind(this),onWhiteboardUpdate:this.onWhiteboardUpdate.bind(this)});return this.sdk.addAudioListener({onAudioLevelUpdate:this.onAudioLevelUpdate.bind(this)}),this.sdk.addConnectionQualityListener({onConnectionQualityUpdate:this.onConnectionQualityUpdate.bind(this)}),e}resetState(e="resetState"){this.isRoomJoinCalled=!1,Lr.cleanup(),this.setState((e=>{Object.assign(e,{room:{id:"",isConnected:!1,name:"",peers:[],localPeer:"",roomState:"Disconnected",recording:{browser:{running:!1},server:{running:!1},hls:{running:!1}},rtmp:{running:!1},hls:{running:!1,variants:[]},sessionId:""},peers:{},tracks:{},playlist:{audio:{list:{},selection:{id:"",hasPrevious:!1,hasNext:!1},progress:0,volume:0,currentTime:0,playbackRate:1},video:{list:{},selection:{id:"",hasPrevious:!1,hasNext:!1},progress:0,volume:0,currentTime:0,playbackRate:1}},messages:{byID:{},allIDs:[]},speakers:{},connectionQualities:{},settings:{audioInputDeviceId:"",audioOutputDeviceId:"",videoInputDeviceId:""},devices:{audioInput:[],audioOutput:[],videoInput:[]},roles:{},roleChangeRequests:[],errors:[],sessionStore:{},templateAppData:{},polls:{},whiteboards:{},hideLocalPeer:!1})}),e)}sdkJoinWithListeners(e){return Lt(this,null,(function*(){yield this.sdk.join(e,{onJoin:this.onJoin.bind(this),onPreview:this.onPreview.bind(this),onRoomUpdate:this.onRoomUpdate.bind(this),onPeerUpdate:this.onPeerUpdate.bind(this),onTrackUpdate:this.onTrackUpdate.bind(this),onMessageReceived:this.onMessageReceived.bind(this),onError:this.onError.bind(this),onReconnected:this.onReconnected.bind(this),onReconnecting:this.onReconnecting.bind(this),onRoleChangeRequest:this.onRoleChangeRequest.bind(this),onRoleUpdate:this.onRoleUpdate.bind(this),onDeviceChange:this.onDeviceChange.bind(this),onChangeTrackStateRequest:this.onChangeTrackStateRequest.bind(this),onChangeMultiTrackStateRequest:this.onChangeMultiTrackStateRequest.bind(this),onRemovedFromRoom:this.onRemovedFromRoom.bind(this),onNetworkQuality:this.onNetworkQuality.bind(this),onSessionStoreUpdate:this.onSessionStoreUpdate.bind(this),onPollsUpdate:this.onPollsUpdate.bind(this),onWhiteboardUpdate:this.onWhiteboardUpdate.bind(this),onSFUMigration:this.onSFUMigration.bind(this)}),this.sdk.addAudioListener({onAudioLevelUpdate:this.onAudioLevelUpdate.bind(this)}),this.sdk.addConnectionQualityListener({onConnectionQualityUpdate:this.onConnectionQualityUpdate.bind(this)})}))}onSFUMigration(){this.syncRoomState("SFUMigration")}onRemovedFromRoom(e){var t;let i=this.store.getState(jr(null==(t=e.requestedBy)?void 0:t.peerId));this.hmsNotifications.sendLeaveRoom(At(It({},e),{requestedBy:i||void 0}));let s=e.roomEnded||!i?"roomEnded":"removedFromRoom";Lr.i(`resetting state after peer removed ${s}`,e),this.resetState(s)}onDeviceChange(e){let t=e.devices;if(!t)return;let i=this.store.getState(Jn);if(this.setState((e=>{Ra(e.devices.audioInput,t.audioInput)||(e.devices.audioInput=t.audioInput),Ra(e.devices.videoInput,t.videoInput)||(e.devices.videoInput=t.videoInput),Ra(e.devices.audioOutput,t.audioOutput)||(e.devices.audioOutput=t.audioOutput);let s=this.sdk.getLocalPeer();null!=i&&i.id&&s&&Object.assign(e.settings,this.getMediaSettings(s))}),"deviceChange"),e.selection){let t=La.convertDeviceChangeUpdate(e);this.hmsNotifications.sendDeviceChange(t)}}sdkPreviewWithListeners(e){return Lt(this,null,(function*(){yield this.sdk.preview(e,{onPreview:this.onPreview.bind(this),onError:this.onError.bind(this),onReconnected:this.onReconnected.bind(this),onReconnecting:this.onReconnecting.bind(this),onDeviceChange:this.onDeviceChange.bind(this),onRoomUpdate:this.onRoomUpdate.bind(this),onPeerUpdate:this.onPeerUpdate.bind(this),onNetworkQuality:this.onNetworkQuality.bind(this)}),this.sdk.addAudioListener({onAudioLevelUpdate:this.onAudioLevelUpdate.bind(this)})}))}onNetworkQuality(e){this.setState((t=>{var i;let s=t.room.localPeer||(null==(i=this.sdk.getLocalPeer())?void 0:i.peerId);s&&(t.connectionQualities[s]={peerID:s,downlinkQuality:e})}),"ConnectionQuality")}onSessionStoreUpdate(e){this.setSessionStoreValueLocally(e,"sessionStoreUpdate")}onPollsUpdate(e,t){let i=fa[e];this.setState((e=>{let i=t.reduce(((e,t)=>{var i;return e[t.id]=At(It({},t),{questions:null==(i=t.questions)?void 0:i.map((e=>{var t,i;return At(It({},e),{answer:e.answer?It({},e.answer):void 0,options:null==(t=e.options)?void 0:t.map((e=>It({},e))),responses:null==(i=e.responses)?void 0:i.map((e=>It({},e)))})}))}),e}),{});((e,t)=>{let i=_a(Object.keys(e),Object.keys(t));for(let s of i){let i=e[s],n=t[s];wa(i,n)?(i.questions&&Ra(i.questions,n.questions)&&(n.questions=i.questions),Object.assign(i,n)):Aa(i,n)&&(e[s]=n)}})(e.polls,i)}),i),t.forEach((t=>this.hmsNotifications.sendPollUpdate(e,t.id)))}onWhiteboardUpdate(e){this.setState((t=>{t.whiteboards[e.id]=e}),"whiteboardUpdate")}startScreenShare(e){return Lt(this,null,(function*(){this.store.getState(nr)?this.logPossibleInconsistency("start screenshare is called while it's on"):(yield this.sdk.startScreenShare((()=>this.syncRoomState("screenshareStopped")),e),this.syncRoomState("startScreenShare"))}))}stopScreenShare(){return Lt(this,null,(function*(){this.store.getState(nr)?(yield this.sdk.stopScreenShare(),this.syncRoomState("stopScreenShare")):this.logPossibleInconsistency("stop screenshare is called while it's not on")}))}attachVideoInternal(e,t){return Lt(this,null,(function*(){let i=this.getTrackById(e);i||(i=this.getLocalTrack(e)),i&&"video"===i.type?yield this.sdk.attachVideo(i,t):this.logPossibleInconsistency("no video track found to add sink")}))}syncRoomState(e){e=`${e}_fullSync`,Lr.time(`store-sync-${e}`);let t,i={},s=[],n={},r={},a={},o=this.sdk.getPeers();for(let h of o){let e=La.convertPeer(h);i[e.id]=e,s.push(e.id),a[e.id]={peerID:e.id,downlinkQuality:h.networkQuality||-1};let o=[h.audioTrack,h.videoTrack,...h.auxiliaryTracks];for(let t of o){if(!t)continue;let e=La.convertTrack(t);n[e.id]=e}if(h.isLocal){let e=h;t=this.getPreviewFields(e),Object.assign(r,this.getMediaSettings(e))}}let l=this.sdk.getRecordingState(),d=this.sdk.getRTMPState(),c=this.sdk.getHLSState(),u=this.sdk.getTranscriptionState();this.setState((e=>{var o;e.room.peers=s;let h=e.peers,p=e.tracks;((e,t)=>{let i=_a(Object.keys(e),Object.keys(t));for(let s of i){let i=e[s],n=t[s];wa(i,n)?(Ra(i.auxiliaryTracks,n.auxiliaryTracks)&&(n.auxiliaryTracks=i.auxiliaryTracks),i.groups&&Ra(i.groups,n.groups)&&(n.groups=i.groups),Object.assign(i,n)):Ia(i,n)?delete e[s]:Aa(i,n)&&(e[s]=n)}})(h,i),((e,t)=>{let i=_a(Object.keys(e),Object.keys(t));for(let s of i){let i=e[s],n=t[s];wa(i,n)?(Ca(i,n),Object.assign(i,n)):Ia(i,n)?delete e[s]:Aa(i,n)&&(e[s]=n)}})(p,n),Object.assign(e.settings,r),e.room.isConnected&&Object.assign(e.connectionQualities,a),null!=(o=e.preview)&&o.localPeer&&null!=t&&t.localPeer?Object.assign(e.preview,t):e.preview=t,Object.assign(e.roles,La.convertRoles(this.sdk.getRoles())),Object.assign(e.playlist,La.convertPlaylist(this.sdk.getPlaylistManager())),Object.assign(e.room,La.convertRecordingStreamingState(l,d,c,u)),Object.assign(e.templateAppData,this.sdk.getTemplateAppData())}),e),Lr.timeEnd(`store-sync-${e}`)}onPreview(e){this.setState((t=>{var i;Object.assign(t.room,La.convertRoom(e,null==(i=this.sdk.getLocalPeer())?void 0:i.peerId)),t.room.roomState="Preview"}),"previewStart"),this.syncRoomState("previewSync")}onJoin(e){let t=this.sdk.getPlaylistManager();this.audioPlaylist=new Da(t,"audio",this.syncPlaylistState.bind(this),this.store),this.videoPlaylist=new Da(t,"video",this.syncRoomState.bind(this),this.store),this.syncRoomState("joinSync"),this.setState((t=>{var i;Object.assign(t.room,La.convertRoom(e,null==(i=this.sdk.getLocalPeer())?void 0:i.peerId)),t.room.isConnected=!0,t.room.roomState="Connected"}),"joined"),t.onProgress(this.setProgress),t.onNewTrackStart((e=>{this.syncPlaylistState(`${e.type}PlaylistUpdate`)})),t.onPlaylistEnded((e=>{this.syncPlaylistState(`${e}PlaylistEnded`)})),t.onCurrentTrackEnded((e=>{this.hmsNotifications.sendPlaylistTrackEnded(La.convertPlaylistItem(t,e)),this.syncPlaylistState(`${e.type}PlaylistItemEnded`)}))}onRoomUpdate(e,t){this.setState((e=>{var i;Object.assign(e.room,La.convertRoom(t,null==(i=this.sdk.getLocalPeer())?void 0:i.peerId))}),e),"TRANSCRIPTION_STATE_UPDATED"===e&&this.hmsNotifications.sendTranscriptionUpdate(t.transcriptions)}onPeerUpdate(e,t){if(![4,5].includes(e)){if(Array.isArray(t)){let e=this.store.getState(Bn),i=t.filter((t=>!e[t.peerId]));if(this.syncRoomState("peersJoined"),this.store.getState(Hn)){let e=[];for(let i of t){let t=this.store.getState(jr(i.peerId));t&&e.push(t)}this.hmsNotifications.sendPeerList(e)}else i.forEach((e=>{let t=this.store.getState(jr(e.peerId));t&&this.hmsNotifications.sendPeerUpdate(0,t)}));return}this.sendPeerUpdateNotification(e,t)}}onTrackUpdate(e,t,i){if(1===e)this.hmsNotifications.sendTrackUpdate(e,t.trackId),this.handleTrackRemove(t,i);else if([0,1].includes(e)){let i=ma[e];this.syncRoomState(i),this.hmsNotifications.sendTrackUpdate(e,t.trackId)}else{let i=ma[e]||"trackUpdate",s=La.convertTrack(t);this.setState((e=>{let t=e.tracks[s.id];wa(t,s)&&(Ca(t,s),Object.assign(t,s))}),i),this.hmsNotifications.sendTrackUpdate(e,t.trackId)}}onMessageReceived(e){let t=La.convertMessage(e,this.store.getState(zn));t.read=!1,t.ignored=this.ignoredMessageTypes.includes(t.type),"hms_transcript"===t.type&&(t.ignored=!0),this.putMessageInStore(t),this.hmsNotifications.sendMessageReceived(t)}putMessageInStore(e){e.ignored||this.actionBatcher.setState((t=>{t.messages.byID[e.id]=e,t.messages.allIDs.push(e.id)}),"newMessage",150)}onAudioLevelUpdate(e){this.setState((t=>{let i={};e.forEach((e=>{if(!e.track||!e.peer)return;let s=e.track.trackId;i[s]=e.audioLevel,t.speakers[s]||(t.speakers[s]={audioLevel:e.audioLevel,peerID:e.peer.peerId,trackID:s})}));let s=Object.entries(t.speakers);for(let[e,n]of s)n.audioLevel=i[e]||0,0===n.audioLevel&&delete t.speakers[e]}),"audioLevel")}onConnectionQualityUpdate(e){this.setState((t=>{e.forEach((e=>{let i=e.peerID;i&&(t.connectionQualities[i]?Object.assign(t.connectionQualities[i],e):t.connectionQualities[i]=e)}))}),"connectionQuality")}onChangeTrackStateRequest(e){var t;let i=this.store.getState(jr(null==(t=e.requestedBy)?void 0:t.peerId)),s=this.getStoreLocalTrackIDfromSDKTrack(e.track),n=this.store.getState(Vr(s));if(!n)return this.logPossibleInconsistency(`Not found track for which track state change was requested, ${e.track}`);e.enabled||this.syncRoomState("changeTrackStateRequest"),this.hmsNotifications.sendChangeTrackStateRequest({requestedBy:i||void 0,track:n,enabled:e.enabled})}onChangeMultiTrackStateRequest(e){var t;let i=this.store.getState(jr(null==(t=e.requestedBy)?void 0:t.peerId));e.enabled||this.syncRoomState("changeMultiTrackStateRequest");let s=[],n=this.store.getState($n);for(let r of e.tracks){let e=this.getStoreLocalTrackIDfromSDKTrack(r);e&&n[e]&&s.push(n[e])}this.hmsNotifications.sendChangeMultiTrackStateRequest({requestedBy:i||void 0,tracks:s,enabled:e.enabled,type:e.type,source:e.source})}onReconnected(){this.syncRoomState("reconnectedSync"),this.hmsNotifications.sendReconnected(),this.setState((e=>{e.room.roomState=e.room.isConnected?"Connected":"Preview"}),"reconnected")}onReconnecting(e){let t=La.convertException(e);Lr.e("Reconnection: received error from sdk",t),this.hmsNotifications.sendReconnecting(t),this.setState((e=>{e.room.roomState="Reconnecting",e.errors.push(t)}),"reconnecting")}onError(e){let t=La.convertException(e);t.isTerminal?(this.leave().then((()=>Lr.e("error from SDK, left room."))),this.setState((e=>{e.room.roomState="Failed",e.errors.push(t)}),"errorTerminal")):this.store.getState().errors.length<50&&this.setState((e=>{e.errors.push(t)}),"error"),this.syncRoomState("errorSync"),this.hmsNotifications.sendError(t),Lr.e("received error from sdk",t instanceof pi?`${t}`:t)}handleTrackRemove(e,t){this.setState((i=>{let s=i.peers[t.peerId],n=i.tracks,r=e.trackId;if(s)if(r===s.audioTrack)delete s.audioTrack;else if(r===s.videoTrack)delete s.videoTrack;else{let e=s.auxiliaryTracks.indexOf(r);e>-1&&s.auxiliaryTracks.splice(e,1)}delete n[r]}),"trackRemoved")}setEnabledSDKTrack(e,t){return Lt(this,null,(function*(){let i=this.getLocalTrack(e);i?yield i.setEnabled(t):this.logPossibleInconsistency(`track ${e} not present, unable to enabled/disable`)}))}setSDKLocalVideoTrackSettings(e,t){return Lt(this,null,(function*(){let i=this.getLocalTrack(e);i?yield i.setSettings(t):this.logPossibleInconsistency(`local track ${e} not present, unable to set settings`)}))}setSDKLocalAudioTrackSettings(e,t){return Lt(this,null,(function*(){let i=this.getLocalTrack(e);i?yield i.setSettings(t):this.logPossibleInconsistency(`local track ${e} not present, unable to set settings`)}))}getMediaSettings(e){var t;let i=this.store.getState(jn),s=e.audioTrack,n=e.videoTrack;return{audioInputDeviceId:(null==s?void 0:s.settings.deviceId)||i.audioInputDeviceId,videoInputDeviceId:(null==n?void 0:n.settings.deviceId)||i.videoInputDeviceId,audioOutputDeviceId:null==(t=this.sdk.getAudioOutput().getDevice())?void 0:t.deviceId,audioMode:(null==s?void 0:s.settings.audioMode)||"voice"}}getPreviewFields(e){var t,i;if(!e.isInPreview())return;let s=La.convertPeer(e);return{localPeer:s.id,audioTrack:s.audioTrack,videoTrack:s.videoTrack,asRole:(null==(t=e.asRole)?void 0:t.name)||(null==(i=e.role)?void 0:i.name)}}setTrackVolume(e,t){return Lt(this,null,(function*(){let i=this.getTrackById(t);i?i instanceof Di?(yield i.setVolume(e),this.setState((i=>{let s=i.tracks[t];s&&"audio"===s.type&&(s.volume=e)}),"trackVolume")):Lr.w(`track ${t} is not an audio track`):this.logPossibleInconsistency(`track ${t} not present, unable to set volume`)}))}localAndVideoUnmuting(e){let t=this.store.getState(Jn);if((null==t?void 0:t.videoTrack)!==e)return!1;let i=this.store.getState(sr),s=this.store.getState(ir);return i&&!s}logPossibleInconsistency(e){Lr.w("possible inconsistency detected - ",e)}addRemoveVideoPlugin(e,t,i){return Lt(this,null,(function*(){if(!e)return void Lr.w("Invalid plugin received in store");let s=this.store.getState(Yn);if(s){let n=this.getLocalTrack(s);n?("add"===t?yield n.addPlugin(e,i):"remove"===t&&(yield n.removePlugin(e)),this.syncRoomState(`${t}VideoPlugin`)):this.logPossibleInconsistency(`track ${s} not present, unable to ${t} plugin`)}}))}addRemoveMediaStreamVideoPlugins(e,t){return Lt(this,null,(function*(){if(0===e.length)return void Lr.w("Invalid plugin received in store");let i=this.store.getState(Yn);if(i){let s=this.getLocalTrack(i);s?("add"===t?yield s.addStreamPlugins(e):"remove"===t&&(yield s.removeStreamPlugins(e)),this.syncRoomState(`${t}MediaStreamPlugin`)):this.logPossibleInconsistency(`track ${i} not present, unable to ${t} plugin`)}}))}addRemoveAudioPlugin(e,t){return Lt(this,null,(function*(){if(!e)return void Lr.w("Invalid plugin received in store");let i=this.store.getState(Qn);if(i){let s=this.getLocalTrack(i);s?("add"===t?yield s.addPlugin(e):"remove"===t&&(yield s.removePlugin(e)),this.syncRoomState(`${t}AudioPlugin`)):this.logPossibleInconsistency(`track ${i} not present, unable to ${t} plugin`)}}))}onRoleChangeRequest(e){this.setState((t=>{0===t.roleChangeRequests.length&&t.roleChangeRequests.push(La.convertRoleChangeRequest(e))}),"roleChangeRequest")}removeRoleChangeRequest(e){this.setState((t=>{let i=t.roleChangeRequests.findIndex((t=>t.token===e.token));-1!==i&&t.roleChangeRequests.splice(i,1)}),"removeRoleChangeRequest")}onRoleUpdate(){this.syncRoomState("roleUpdate")}getStoreLocalTrackIDfromSDKTrack(e){return this.store.getState(Xn).find((t=>{var i;return(null==(i=this.getTrackById(t))?void 0:i.trackId)===e.trackId}))}updateMidCallPreviewRoomState(e,t){t.isLocal&&8===e&&this.store.getState(cr)&&this.setState((e=>{e.room.roomState="Connected"}),"midCallPreviewCompleted")}setSessionStoreValueLocally(e,t="setSessionStore"){let i=Array.isArray(e)?e:[e];this.setState((e=>{i.forEach((t=>{e.sessionStore[t.key]=t.value}))}),t)}},qa=e=>ri?`${e} ${document.title}`:e,Ka=class{constructor(e,t){this.eventBus=e,this.listener=t,this.TAG="[NetworkTestManager]",this.controller=new AbortController,this.start=e=>Lt(this,null,(function*(){var t;if(!e)return;let{url:i,timeout:s,scoreMap:n}=e,r=this.controller.signal,a=Date.now(),o=0,l=zi(s).then((()=>{this.controller.abort()}));try{let e=null==(t=(yield fetch(`${i}?${Date.now()}`,{signal:r})).body)?void 0:t.getReader();if(!e)throw Error("unable to process request");let s=()=>Lt(this,null,(function*(){if(e)try{let t=!1;for(;!t;){let{value:i,done:s}=yield e.read();t=s,i&&(o+=i.byteLength,this.sendScore({scoreMap:n,downloadedSize:o,startTime:a}))}}catch(xe){"AbortError"!==xe.name&&Yt.d(this.TAG,xe)}}));return Promise.race([s(),l]).then((()=>{this.sendScore({scoreMap:n,downloadedSize:o,startTime:a,finished:!0})})).catch((e=>{Yt.d(this.TAG,e),this.updateScoreToListener(0),this.eventBus.analytics.publish(Ri.previewNetworkQuality({error:e.message}))}))}catch(Ae){"AbortError"!==Ae.name?(Yt.d(this.TAG,Ae),this.updateScoreToListener(0),this.eventBus.analytics.publish(Ri.previewNetworkQuality({error:Ae.message}))):Yt.d(this.TAG,Ae)}})),this.stop=()=>{this.controller.signal.aborted||this.controller.abort()},this.sendScore=({scoreMap:e,downloadedSize:t,startTime:i,finished:s=!1})=>{let n=t/1024/((Date.now()-i)/1e3)*8,r=-1;for(let a in e){let t=e[a];n>=t.low&&(!t.high||n<=t.high)&&(r=Number(a))}this.updateScoreToListener(r),s&&this.eventBus.analytics.publish(Ri.previewNetworkQuality({score:r,downLink:n.toFixed(2)}))}}updateScoreToListener(e){var t,i;e!==this.score&&(this.score=e,null==(i=null==(t=this.listener)?void 0:t.onNetworkQuality)||i.call(t,e))}},Ja=class{constructor(e,t,i,s,n,r){this.store=e,this.transport=t,this.deviceManager=i,this.publish=s,this.removeAuxiliaryTrack=n,this.listener=r,this.handleLocalPeerRoleUpdate=e=>Lt(this,[e],(function*({oldRole:e,newRole:t}){var i;let s=this.store.getLocalPeer();s&&(yield this.diffRolesAndPublishTracks({oldRole:e,newRole:t}),null==(i=this.listener)||i.onPeerUpdate(8,s))})),this.diffRolesAndPublishTracks=e=>Lt(this,[e],(function*({oldRole:e,newRole:t}){var i,s,n,r,a,o;let l=new Set(e.publishParams.allowed),d=new Set(t.publishParams.allowed),c=this.removeTrack(l,d,"video"),u=this.removeTrack(l,d,"audio"),h=this.removeTrack(l,d,"screen"),p=this.hasSimulcastDifference(null==(i=e.publishParams.simulcast)?void 0:i.video,null==(s=t.publishParams.simulcast)?void 0:s.video),v=this.hasSimulcastDifference(null==(n=e.publishParams.simulcast)?void 0:n.screen,null==(r=t.publishParams.simulcast)?void 0:r.screen),g=null==(o=null==(a=this.store.getLocalPeer())?void 0:a.videoTrack)?void 0:o.enabled;yield this.removeAudioTrack(u),yield this.removeVideoTracks(c||p),yield this.removeScreenTracks(h||v);let m=this.getSettings();p&&(m.isVideoMuted=!g),yield this.publish(m),yield this.syncDevices(m,t)}))}syncDevices(e,t){return Lt(this,null,(function*(){(!e.isAudioMuted||!e.isVideoMuted)&&t.publishParams.allowed.length>0&&(yield this.deviceManager.init(!0))}))}removeVideoTracks(e){return Lt(this,null,(function*(){var t;if(!e)return;let i=this.store.getLocalPeer();null!=i&&i.videoTrack&&(i.videoTrack.isPublished?yield this.transport.unpublish([i.videoTrack]):yield i.videoTrack.cleanup(),null==(t=this.listener)||t.onTrackUpdate(1,i.videoTrack,i),i.videoTrack=void 0),yield this.removeAuxTracks((e=>"screen"!==e.source&&"video"===e.type))}))}removeAudioTrack(e){return Lt(this,null,(function*(){var t;if(!e)return;let i=this.store.getLocalPeer();null!=i&&i.audioTrack&&(i.audioTrack.isPublished?yield this.transport.unpublish([i.audioTrack]):yield i.audioTrack.cleanup(),null==(t=this.listener)||t.onTrackUpdate(1,i.audioTrack,i),i.audioTrack=void 0),yield this.removeAuxTracks((e=>"screen"!==e.source&&"audio"===e.type))}))}removeScreenTracks(e){return Lt(this,null,(function*(){e&&(yield this.removeAuxTracks((e=>"screen"===e.source)))}))}removeAuxTracks(e){return Lt(this,null,(function*(){let t=this.store.getLocalPeer();if(null!=t&&t.auxiliaryTracks){let i=[...t.auxiliaryTracks];for(let t of i)e(t)&&(yield this.removeAuxiliaryTrack(t.trackId))}}))}removeTrack(e,t,i){return e.has(i)&&!t.has(i)}hasSimulcastDifference(e,t){var i,s,n;return!(!e&&!t)&&((null==(i=null==e?void 0:e.layers)?void 0:i.length)!==(null==(s=null==t?void 0:t.layers)?void 0:s.length)||!(null==(n=null==e?void 0:e.layers)||!n.some((e=>{var i;let s=null==(i=null==t?void 0:t.layers)?void 0:i.find((t=>t.rid===e.rid));return(null==s?void 0:s.maxBitrate)!==e.maxBitrate||(null==s?void 0:s.maxFramerate)!==e.maxFramerate}))))}getSettings(){var e,t,i;let s=null==(e=this.store.getConfig())?void 0:e.settings;return{isAudioMuted:null==(t=null==s?void 0:s.isAudioMuted)||t,isVideoMuted:null==(i=null==s?void 0:s.isVideoMuted)||i,audioInputDeviceId:(null==s?void 0:s.audioInputDeviceId)||"default",audioOutputDeviceId:(null==s?void 0:s.audioOutputDeviceId)||"default",videoDeviceId:(null==s?void 0:s.videoDeviceId)||"default"}}},za=new class{constructor(){this.TAG="[HTTPAnalyticsTransport]",this.failedEvents=new yi("client-events"),this.isConnected=!0,this.env=null,this.websocketURL=""}setEnv(e){this.env=e,this.flushFailedEvents()}setWebsocketEndpoint(e){this.websocketURL=e}sendEvent(e){if(!this.env)return void this.addEventToStorage(e);let t={event:e.name,payload:e.properties,event_id:String(e.timestamp),peer:e.metadata.peer,timestamp:e.timestamp,device_id:e.device_id,cluster:{websocket_url:this.websocketURL}},i="prod"===this.env?"https://event.100ms.live/v2/client/report":"https://event-nonprod.100ms.live/v2/client/report";fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.metadata.token}`,user_agent_v2:e.metadata.userAgent},body:JSON.stringify(t)}).then((t=>{if(401!==t.status){if(200!==t.status)throw Error(t.statusText);this.removeFromStorage(e)}else this.removeFromStorage(e)})).catch((t=>{Yt.v(this.TAG,"Failed to send event",t,e),this.addEventToStorage(e)}))}flushFailedEvents(){let e=this.failedEvents.get();null==e||e.forEach((e=>this.sendEvent(e)))}addEventToStorage(e){let t=this.failedEvents.get()||[];t.find((t=>t.timestamp===e.timestamp))||(100===t.length&&t.shift(),t.push(e),this.failedEvents.set(t))}removeFromStorage(e){let t=this.failedEvents.get()||[],i=t.findIndex((t=>t.timestamp===e.timestamp));i>-1&&(t.splice(i,1),this.failedEvents.set(t))}},Qa=class{constructor(e){this.type=e.type,this.source=e.source||"regular",this.description="",e instanceof Li?(this.mute=!e.enabled,this.track_id=e.publishedTrackId,this.stream_id=e.stream.id):(this.mute=e.mute,this.track_id=e.track_id,this.stream_id=e.stream_id)}},Ya=class{constructor(){this.TAG="[Store]:",this.knownRoles={},this.peers={},this.tracks=new Map,this.peerTrackStates={},this.speakers=[],this.roleDetailsArrived=!1,this.env="prod",this.simulcastEnabled=!1,this.userAgent=Ci(this.env),this.polls=new Map,this.whiteboards=new Map,this.addPermissionToRole=(e,t,i,s)=>{var n;if(!this.knownRoles[e])return void Yt.d(this.TAG,`role ${e} is not present in given roles`,this.knownRoles);let r=this.knownRoles[e].permissions;"transcriptions"===t&&s?r[t]=At(It({},r[t]),{[s]:[i]}):"whiteboard"===t&&(r[t]||(r[t]=[]),null==(n=r[t])||n.push(i))},this.addWhiteboardPluginToRole=e=>{var t,i,s;let n=null==e?void 0:e.permissions;null==(t=null==n?void 0:n.admin)||t.forEach((e=>this.addPermissionToRole(e,"whiteboard","admin"))),null==(i=null==n?void 0:n.reader)||i.forEach((e=>this.addPermissionToRole(e,"whiteboard","read"))),null==(s=null==n?void 0:n.writer)||s.forEach((e=>this.addPermissionToRole(e,"whiteboard","write")))},this.addTranscriptionsPluginToRole=(e=[])=>{var t,i;for(let s of e)null==(i=null==(t=s.permissions)?void 0:t.admin)||i.forEach((e=>this.addPermissionToRole(e,"transcriptions","admin",s.mode)))},this.handleNoiseCancellationPlugin=e=>{this.room&&(this.room.isNoiseCancellationEnabled=!(null==e||!e.enabled)&&!!this.room.isNoiseCancellationEnabled)}}getConfig(){return this.config}setSimulcastEnabled(e){this.simulcastEnabled=e}removeRemoteTracks(){this.tracks.forEach((e=>{(e instanceof ys||e instanceof cn)&&(this.removeTrack(e),delete this.peerTrackStates[e.trackId])}))}getEnv(){return this.env}getPublishParams(){let e=this.getLocalPeer(),t=(null==e?void 0:e.asRole)||(null==e?void 0:e.role);return null==t?void 0:t.publishParams}getRoom(){return this.room}getPolicyForRole(e){return this.knownRoles[e]}getKnownRoles(){return this.knownRoles}getTemplateAppData(){return this.templateAppData}getLocalPeer(){if(this.localPeerId&&this.peers[this.localPeerId])return this.peers[this.localPeerId]}getRemotePeers(){return Object.values(this.peers).filter((e=>!e.isLocal))}getPeers(){return Object.values(this.peers)}getPeerMap(){return this.peers}getPeerById(e){if(this.peers[e])return this.peers[e]}getTracksMap(){return this.tracks}getTracks(){return Array.from(this.tracks.values())}getVideoTracks(){return this.getTracks().filter((e=>"video"===e.type))}getRemoteVideoTracks(){return this.getTracks().filter((e=>e instanceof cn))}getAudioTracks(){return this.getTracks().filter((e=>"audio"===e.type))}getPeerTracks(e){let t=e?this.peers[e]:void 0,i=[];return null!=t&&t.videoTrack&&i.push(t.videoTrack),null!=t&&t.audioTrack&&i.push(t.audioTrack),i.concat((null==t?void 0:t.auxiliaryTracks)||[])}getLocalPeerTracks(){return this.getPeerTracks(this.localPeerId)}hasTrack(e){return this.tracks.has(e)}getTrackById(e){var t,i;let s=Array.from(this.tracks.values()).find((t=>t.trackId===e));if(s)return s;let n=this.getLocalPeer();if(n){if(null!=(t=n.audioTrack)&&t.isPublishedTrackId(e))return n.audioTrack;if(null!=(i=n.videoTrack)&&i.isPublishedTrackId(e))return n.videoTrack}}getPeerByTrackId(e){let t=Array.from(this.tracks.values()).find((t=>t.trackId===e));return null!=t&&t.peerId?this.peers[t.peerId]:void 0}getSpeakers(){return this.speakers}getSpeakerPeers(){return this.speakers.map((e=>e.peer))}getUserAgent(){return this.userAgent}createAndSetUserAgent(e){this.userAgent=Ci(this.env,e)}setRoom(e){this.room=e}setKnownRoles(e){var t,i;if(this.knownRoles=e.known_roles,this.addPluginsToRoles(e.plugins),this.roleDetailsArrived=!0,this.templateAppData=e.app_data,!this.simulcastEnabled)return;let s=null==(t=this.knownRoles[e.name])?void 0:t.publishParams;this.videoLayers=this.convertSimulcastLayers(null==(i=s.simulcast)?void 0:i.video),this.updatePeersPolicy()}hasRoleDetailsArrived(){return this.roleDetailsArrived}setConfig(e){var t,i,s;if(Mi.rememberDevices(!!e.rememberDeviceSelection),e.rememberDeviceSelection){let n=Mi.getSelection();n&&(e.settings||(e.settings={}),null!=(t=n.audioInput)&&t.deviceId&&(e.settings.audioInputDeviceId=e.settings.audioInputDeviceId||n.audioInput.deviceId),null!=(i=n.audioOutput)&&i.deviceId&&(e.settings.audioOutputDeviceId=e.settings.audioOutputDeviceId||n.audioOutput.deviceId),null!=(s=n.videoInput)&&s.deviceId&&(e.settings.videoDeviceId=e.settings.videoDeviceId||n.videoInput.deviceId))}e.autoManageVideo=!1!==e.autoManageVideo,e.autoManageWakeLock=!1!==e.autoManageWakeLock,this.config=e,this.setEnv()}addPeer(e){this.peers[e.peerId]=e,e.isLocal&&(this.localPeerId=e.peerId)}addTrack(e){this.tracks.set(e,e)}getTrackState(e){return this.peerTrackStates[e]}setTrackState(e){this.peerTrackStates[e.trackInfo.track_id]=e}removeTrackState(e){delete this.peerTrackStates[e]}removePeer(e){this.localPeerId===e&&(this.localPeerId=void 0),delete this.peers[e]}removeTrack(e){this.tracks.delete(e)}updateSpeakers(e){this.speakers=e}updateAudioOutputVolume(e){return Lt(this,null,(function*(){for(let t of this.getAudioTracks())yield t.setVolume(e)}))}updateAudioOutputDevice(e){return Lt(this,null,(function*(){let t=[];this.getAudioTracks().forEach((i=>{i instanceof ys&&t.push(i.setOutputDevice(e))})),yield Promise.all(t)}))}getSimulcastLayers(e){var t;return this.simulcastEnabled&&["screen","regular"].includes(e)?"screen"===e?[]:(null==(t=this.videoLayers)?void 0:t.layers)||[]:[]}convertSimulcastLayers(e){if(e)return At(It({},e),{layers:(e.layers||[]).map((e=>At(It({},e),{maxBitrate:1e3*e.maxBitrate})))})}getSimulcastDefinitionsForPeer(e,t){var i,s,n;if([!e||!e.role,"screen"===t,!this.simulcastEnabled].some((e=>!!e)))return[];let r,a,o,l=this.getPolicyForRole(e.role.name).publishParams;return"regular"===t?(r=null==(i=l.simulcast)?void 0:i.video,a=l.video.width,o=l.video.height):"screen"===t&&(r=null==(s=l.simulcast)?void 0:s.screen,a=l.screen.width,o=l.screen.height),(null==(n=null==r?void 0:r.layers)?void 0:n.map((e=>({layer:rs[e.rid],resolution:{width:Math.floor(a/e.scaleResolutionDownBy),height:Math.floor(o/e.scaleResolutionDownBy)}}))))||[]}setPoll(e){this.polls.set(e.id,e)}getPoll(e){return this.polls.get(e)}setWhiteboard(e){this.whiteboards.set(e.id,e)}getWhiteboards(){return this.whiteboards}getWhiteboard(e){return e?this.whiteboards.get(e):this.whiteboards.values().next().value}getErrorListener(){return this.errorListener}cleanup(){let e=this.getTracks();for(let t of e)t.cleanup();this.room=void 0,this.config=void 0,this.localPeerId=void 0,this.roleDetailsArrived=!1}setErrorListener(e){this.errorListener=e}updatePeersPolicy(){this.getPeers().forEach((e=>{var t;e.role?e.role=this.getPolicyForRole(e.role.name):null==(t=this.errorListener)||t.onError(mi.GenericErrors.InvalidRole("VALIDATION",""))}))}addPluginsToRoles(e){e&&Object.keys(e).forEach((t=>{let i=t;switch(i){case"whiteboard":this.addWhiteboardPluginToRole(e[i]);break;case"transcriptions":this.addTranscriptionsPluginToRole(e[i]);break;case"noiseCancellation":this.handleNoiseCancellationPlugin(e[i])}}))}setEnv(){var e;let t=(null==(e=this.config)?void 0:e.initEndpoint).split("https://")[1],i="prod";t.startsWith("prod")?i="prod":t.startsWith("qa")?i="qa":t.startsWith("dev")&&(i="dev"),this.env=i,za.setEnv(i)}},Za=class{constructor(){this.TAG="[WakeLockManager]",this.wakeLock=null,this.acquireLock=()=>Lt(this,null,(function*(){yield this.requestWakeLock(),null==document||document.addEventListener("visibilitychange",this.visibilityHandler)})),this.cleanup=()=>Lt(this,null,(function*(){if(this.wakeLock&&!this.wakeLock.released)try{yield this.wakeLock.release(),Yt.d(this.TAG,"Wake lock released")}catch(e){let t=e;Yt.w(this.TAG,"Error while releasing wake lock",`name=${t.name}, message=${t.message}`)}null==document||document.removeEventListener("visibilitychange",this.visibilityHandler),this.wakeLock=null})),this.visibilityHandler=()=>Lt(this,null,(function*(){"visible"===(null==document?void 0:document.visibilityState)&&(!this.wakeLock||this.wakeLock.released)&&(Yt.d(this.TAG,"Re-acquiring wake lock due to visibility change"),yield this.requestWakeLock())})),this.requestWakeLock=()=>Lt(this,null,(function*(){try{if(!("wakeLock"in navigator))return void Yt.d(this.TAG,"Wake lock feature not supported");this.wakeLock=yield navigator.wakeLock.request("screen"),Yt.d(this.TAG,"Wake lock acquired")}catch(e){let t=e;Yt.w(this.TAG,"Error acquiring wake lock",`name=${t.name}, message=${t.message}`)}}))}},Xa=class{constructor(e){this.store=e,this.bufferSize=100,this.TAG="[AnalyticsEventsService]",this.transport=null,this.pendingEvents=[],this.level=1}setTransport(e){this.transport=e}reset(){this.transport=null,this.pendingEvents=[]}queue(e){if(e.level>=this.level&&(this.pendingEvents.push(e),this.pendingEvents.length>this.bufferSize)){let e=this.pendingEvents.shift();Yt.d(this.TAG,"Max buffer size reached","Removed event to accommodate new events",e)}return this}flushFailedClientEvents(){za.flushFailedEvents()}flush(){var e;try{for(;this.pendingEvents.length>0;){let t=this.pendingEvents.shift();t&&(t.metadata.peer.peer_id=null==(e=this.store.getLocalPeer())?void 0:e.peerId,t.metadata.userAgent=this.store.getUserAgent(),this.transport&&this.transport.transportProvider.isConnected?this.transport.sendEvent(t):this.sendClientEventOnHTTP(t))}}catch(ke){Yt.w(this.TAG,"Flush Failed",ke)}}sendClientEventOnHTTP(e){var t,i,s,n;let r=this.store.getRoom(),a=this.store.getLocalPeer();e.metadata.token=null==(t=this.store.getConfig())?void 0:t.authToken,e.metadata.peer={session_id:null==r?void 0:r.sessionId,room_id:null==r?void 0:r.id,room_name:null==r?void 0:r.name,template_id:null==r?void 0:r.templateId,joined_at:null==(i=null==r?void 0:r.joinedAt)?void 0:i.getTime(),session_started_at:null==(s=null==r?void 0:r.startedAt)?void 0:s.getTime(),role:null==(n=null==a?void 0:a.role)?void 0:n.name,user_name:null==a?void 0:a.name,user_data:null==a?void 0:a.metadata,peer_id:null==a?void 0:a.peerId},za.sendEvent(e)}},eo={autoplayFailed:void 0,initialized:!1,autoplayCheckPromise:void 0},to=class{constructor(e,t,i){this.store=e,this.deviceManager=t,this.eventBus=i,this.autoPausedTracks=new Set,this.TAG="[AudioSinkManager]:",this.volume=100,this.state=It({},eo),this.handleAudioPaused=e=>Lt(this,null,(function*(){Yt.d(this.TAG,"Audio Paused",e.target.id);let t=this.store.getTrackById(e.target.id);t&&this.autoPausedTracks.add(t)})),this.handleTrackUpdate=({track:e})=>{Yt.d(this.TAG,"Track updated",`${e}`)},this.handleTrackAdd=e=>Lt(this,[e],(function*({track:e,peer:t,callListener:i=!0}){var s,n;let r=document.createElement("audio");r.style.display="none",r.id=e.trackId,r.addEventListener("pause",this.handleAudioPaused),r.onerror=()=>Lt(this,null,(function*(){var i,s;Yt.e(this.TAG,"error on audio element",r.error);let n=mi.TracksErrors.AudioPlaybackError(`Audio playback error for track - ${e.trackId} code - ${null==(i=null==r?void 0:r.error)?void 0:i.code}`);this.eventBus.analytics.publish(Ri.audioPlaybackError(n)),(null==(s=null==r?void 0:r.error)?void 0:s.code)===MediaError.MEDIA_ERR_DECODE&&(this.removeAudioElement(r,e),yield zi(500),yield this.handleTrackAdd({track:e,peer:t,callListener:!1}),this.state.autoplayFailed||this.eventBus.analytics.publish(Ri.audioRecovered("Audio recovered after media decode error")))})),e.setAudioElement(r),yield e.setVolume(this.volume),Yt.d(this.TAG,"Audio track added",`${e}`),this.init(),null==(s=this.audioSink)||s.append(r),this.outputDevice&&(yield e.setOutputDevice(this.outputDevice)),r.srcObject=new MediaStream([e.nativeTrack]),i&&(null==(n=this.listener)||n.onTrackUpdate(0,e,t)),yield this.handleAutoplayError(e)})),this.handleAutoplayError=e=>Lt(this,null,(function*(){void 0===this.state.autoplayFailed&&(this.state.autoplayCheckPromise||(this.state.autoplayCheckPromise=new Promise((t=>{this.playAudioFor(e).then(t)}))),yield this.state.autoplayCheckPromise),this.state.autoplayFailed?this.autoPausedTracks.add(e):yield this.playAudioFor(e)})),this.handleAudioDeviceChange=e=>{e.isUserSelection||e.error||!e.selection||"video"===e.type||this.unpauseAudioTracks()},this.handleTrackRemove=e=>{this.autoPausedTracks.delete(e);let t=document.getElementById(e.trackId);t&&this.removeAudioElement(t,e),this.audioSink&&0===this.audioSink.childElementCount&&(this.state.autoplayCheckPromise=void 0,this.state.autoplayFailed=void 0),Yt.d(this.TAG,"Audio track removed",`${e}`)},this.unpauseAudioTracks=()=>Lt(this,null,(function*(){let e=[];this.autoPausedTracks.forEach((t=>{e.push(this.playAudioFor(t))})),yield Promise.all(e)})),this.removeAudioElement=(e,t)=>{e&&(Yt.d(this.TAG,"removing audio element",`${t}`),e.removeEventListener("pause",this.handleAudioPaused),e.srcObject=null,e.remove(),t.setAudioElement(null))},this.eventBus.audioTrackAdded.subscribe(this.handleTrackAdd),this.eventBus.audioTrackRemoved.subscribe(this.handleTrackRemove),this.eventBus.audioTrackUpdate.subscribe(this.handleTrackUpdate),this.eventBus.deviceChange.subscribe(this.handleAudioDeviceChange),this.eventBus.localVideoUnmutedNatively.subscribe(this.unpauseAudioTracks),this.eventBus.localAudioUnmutedNatively.subscribe(this.unpauseAudioTracks)}setListener(e){this.listener=e}get outputDevice(){return this.deviceManager.outputDevice}getVolume(){return this.volume}setVolume(e){return Lt(this,null,(function*(){yield this.store.updateAudioOutputVolume(e),this.volume=e}))}unblockAutoplay(){return Lt(this,null,(function*(){this.autoPausedTracks.size>0&&this.unpauseAudioTracks()}))}init(e){if(this.state.initialized||this.audioSink)return;this.state.initialized=!0;let t=document.createElement("div");t.id=`HMS-SDK-audio-sink-${(0,d.Z)()}`,(e&&document.getElementById(e)||document.body).append(t),this.audioSink=t,Yt.d(this.TAG,"audio sink created",this.audioSink)}cleanup(){var e;null==(e=this.audioSink)||e.remove(),this.audioSink=void 0,this.eventBus.audioTrackAdded.unsubscribe(this.handleTrackAdd),this.eventBus.audioTrackRemoved.unsubscribe(this.handleTrackRemove),this.eventBus.audioTrackUpdate.unsubscribe(this.handleTrackUpdate),this.eventBus.deviceChange.unsubscribe(this.handleAudioDeviceChange),this.eventBus.localVideoUnmutedNatively.unsubscribe(this.unpauseAudioTracks),this.eventBus.localAudioUnmutedNatively.unsubscribe(this.unpauseAudioTracks),this.autoPausedTracks=new Set,this.state=It({},eo)}playAudioFor(e){return Lt(this,null,(function*(){let t=e.getAudioElement();if(t)try{yield t.play(),this.state.autoplayFailed=!1,this.autoPausedTracks.delete(e),Yt.d(this.TAG,"Played track",`${e}`)}catch(Te){this.autoPausedTracks.add(e),Yt.w(this.TAG,"Failed to play track",`${e}`,Te);let i=Te;if(!this.state.autoplayFailed&&"NotAllowedError"===i.name){this.state.autoplayFailed=!0;let e=mi.TracksErrors.AutoplayBlocked("AUTOPLAY","");e.addNativeError(i),this.eventBus.analytics.publish(Ri.autoplayError()),this.eventBus.autoplayError.publish(e)}}else Yt.w(this.TAG,"No audio element found on track",e.trackId)}))}},io=class{constructor(e){this.eventBus=e,this.pluginUsage=new Map,this.pluginLastAddedAt=new Map,this.getPluginUsage=e=>{if(this.pluginUsage.has(e)||this.pluginUsage.set(e,0),this.pluginLastAddedAt.has(e)){let t=this.pluginLastAddedAt.get(e)||0,i=t?Date.now()-t:0;this.pluginUsage.set(e,(this.pluginUsage.get(e)||0)+i),this.pluginLastAddedAt.delete(e)}return this.pluginUsage.get(e)},this.updatePluginUsageData=e=>{var t;let i=(null==(t=e.properties)?void 0:t.plugin_name)||"";switch(e.name){case"mediaPlugin.toggled.on":case"mediaPlugin.added":{let t=e.properties.added_at||Date.now();this.pluginLastAddedAt.set(i,t);break}case"mediaPlugin.toggled.off":case"mediaPlugin.stats":if(this.pluginLastAddedAt.has(i)){let t=e.properties.duration||(Date.now()-(this.pluginLastAddedAt.get(i)||0))/1e3;this.pluginUsage.set(i,(this.pluginUsage.get(i)||0)+1e3*Math.max(t,0)),this.pluginLastAddedAt.delete(i)}}},this.cleanup=()=>{this.pluginLastAddedAt.clear(),this.pluginUsage.clear()},this.eventBus.analytics.subscribe((e=>this.updatePluginUsageData(e)))}},so=class{constructor(e,t){this.store=e,this.eventBus=t,this.audioInput=[],this.audioOutput=[],this.videoInput=[],this.hasWebcamPermission=!1,this.hasMicrophonePermission=!1,this.TAG="[Device Manager]:",this.initialized=!1,this.videoInputChanged=!1,this.audioInputChanged=!1,this.earpieceSelected=!1,this.timer=null,this.updateOutputDevice=(e,t)=>Lt(this,null,(function*(){let i=this.audioOutput.find((t=>t.deviceId===e));return i&&(this.outputDevice=i,yield this.store.updateAudioOutputDevice(i),this.eventBus.analytics.publish(Ri.deviceChange({isUserSelection:t,selection:{audioOutput:i},devices:this.getDevices(),type:"audioOutput"})),Mi.updateSelection("audioOutput",{deviceId:i.deviceId,groupId:i.groupId})),i})),this.getCurrentSelection=()=>{var e,t;let i=this.store.getLocalPeer(),s=this.createIdentifier(null==(e=null==i?void 0:i.audioTrack)?void 0:e.getMediaTrackSettings()),n=this.createIdentifier(null==(t=null==i?void 0:i.videoTrack)?void 0:t.getMediaTrackSettings()),r=this.audioInput.find((e=>this.createIdentifier(e)===s)),a=this.videoInput.find((e=>this.createIdentifier(e)===n));return{audioInput:r,videoInput:a,audioOutput:this.outputDevice}},this.computeChange=(e,t)=>e.length!==t.length||t.some((t=>!e.includes(this.createIdentifier(t)))),this.enumerateDevices=()=>Lt(this,null,(function*(){try{let e=yield navigator.mediaDevices.enumerateDevices(),t=this.videoInput.map(this.createIdentifier),i=this.audioInput.map(this.createIdentifier);this.audioInput=[],this.audioOutput=[],this.videoInput=[],e.forEach((e=>{"audioinput"===e.kind&&e.label?(this.hasMicrophonePermission=!0,this.audioInput.push(e)):"audiooutput"===e.kind?this.audioOutput.push(e):"videoinput"===e.kind&&e.label&&(this.hasWebcamPermission=!0,this.videoInput.push(e))})),this.videoInputChanged=this.computeChange(t,this.videoInput),this.audioInputChanged=this.computeChange(i,this.audioInput),Mi.setDevices({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput]}),this.logDevices("Enumerate Devices")}catch(e){Yt.e(this.TAG,"Failed enumerating devices",e)}})),this.updateToActualDefaultDevice=()=>Lt(this,null,(function*(){var e,t,i,s,n;let r=this.store.getLocalPeer();if(!(null==(t=null==(e=this.store.getConfig())?void 0:e.settings)?void 0:t.videoDeviceId)&&null!=r&&r.videoTrack&&(yield r.videoTrack.setSettings({deviceId:null==(i=this.videoInput[0])?void 0:i.deviceId},!0)),!(null==(n=null==(s=this.store.getConfig())?void 0:s.settings)?void 0:n.audioInputDeviceId)&&null!=r&&r.audioTrack){let e=()=>{var e;let t=this.audioInput.find((e=>!e.label.toLowerCase().includes("iphone")));return(()=>{var e;return"ios"===(null==(e=ni.getOS().name)?void 0:e.toLowerCase())})()&&t?null==t?void 0:t.deviceId:null==(e=this.getNewAudioInputDevice())?void 0:e.deviceId};e()&&(yield r.audioTrack.setSettings({deviceId:e()},!0))}})),this.handleDeviceChange=Yi((()=>Lt(this,null,(function*(){yield this.enumerateDevices(),this.logDevices("After Device Change");let e=this.store.getLocalPeer();yield this.setOutputDevice(!0),yield this.handleAudioInputDeviceChange(null==e?void 0:e.audioTrack),yield this.handleVideoInputDeviceChange(null==e?void 0:e.videoTrack),this.eventBus.analytics.publish(Ri.deviceChange({selection:this.getCurrentSelection(),type:"change",devices:this.getDevices()}))}))),500).bind(this),this.handleAudioInputDeviceChange=e=>Lt(this,null,(function*(){if(!e)return void Yt.d(this.TAG,"No Audio track on local peer");if(!this.audioInputChanged)return void Yt.d(this.TAG,"No Change in AudioInput Device");let t=this.getNewAudioInputDevice();if(!t||!t.deviceId)return this.eventBus.analytics.publish(Ri.deviceChange({selection:{audioInput:t},error:mi.TracksErrors.SelectedDeviceMissing("audio"),devices:this.getDevices(),type:"audioInput"})),void Yt.e(this.TAG,"Audio device not found");let{settings:i}=e,s=(new ls).codec(i.codec).maxBitrate(i.maxBitrate).deviceId(t.deviceId).audioMode(i.audioMode).build();try{yield e.setSettings(s,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:t,type:"audioInput"}),this.logDevices("Audio Device Change Success")}catch(we){Yt.e(this.TAG,"[Audio Device Change]",we),this.eventBus.analytics.publish(Ri.deviceChange({selection:{audioInput:t},devices:this.getDevices(),type:"audioInput",error:we})),this.eventBus.deviceChange.publish({error:we,selection:t,type:"audioInput",devices:this.getDevices()})}})),this.handleVideoInputDeviceChange=e=>Lt(this,null,(function*(){if(!e)return void Yt.d(this.TAG,"No video track on local peer");if(!this.videoInputChanged)return void Yt.d(this.TAG,"No Change in VideoInput Device");let t=this.videoInput[0];if(!t||!t.deviceId)return this.eventBus.analytics.publish(Ri.deviceChange({selection:{videoInput:t},error:mi.TracksErrors.SelectedDeviceMissing("video"),devices:this.getDevices(),type:"video"})),void Yt.e(this.TAG,"Video device not found");let{settings:i}=e,s=(new cs).codec(i.codec).maxBitrate(i.maxBitrate).maxFramerate(i.maxFramerate).setWidth(i.width).setHeight(i.height).deviceId(t.deviceId).build();try{yield e.setSettings(s,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:t,type:"video"}),this.logDevices("Video Device Change Success")}catch(we){Yt.e(this.TAG,"[Video Device Change]",we),this.eventBus.analytics.publish(Ri.deviceChange({selection:{videoInput:t},devices:this.getDevices(),type:"video",error:we})),this.eventBus.deviceChange.publish({error:we,type:"video",selection:t,devices:this.getDevices()})}})),this.startPollingForDevices=()=>{"ondevicechange"in navigator.mediaDevices||(this.timer=setTimeout((()=>{Lt(this,null,(function*(){yield this.enumerateDevices(),yield this.autoSelectAudioOutput(),this.startPollingForDevices()}))}),5e3))},this.autoSelectAudioOutput=()=>Lt(this,null,(function*(){var e;if("ondevicechange"in navigator.mediaDevices)return;let{bluetoothDevice:t,earpiece:i,speakerPhone:s,wired:n}=this.categorizeAudioInputDevices(),r=null==(e=this.store.getLocalPeer())?void 0:e.audioTrack;if(!r||!i)return;let a=this.getManuallySelectedAudioDevice(),o=(null==a?void 0:a.deviceId)||(null==t?void 0:t.deviceId)||(null==n?void 0:n.deviceId)||(null==s?void 0:s.deviceId);if(Yt.d(this.TAG,"externalDeviceID",o),r.settings.deviceId!==o||!this.earpieceSelected){if(!this.earpieceSelected){if((null==t?void 0:t.deviceId)===o)return void(this.earpieceSelected=!0);yield r.setSettings({deviceId:null==i?void 0:i.deviceId},!0),this.earpieceSelected=!0}yield r.setSettings({deviceId:o},!0)}}));let i=({enabled:e,track:t})=>e&&"regular"===t.source;this.eventBus.localVideoEnabled.waitFor(i).then((()=>Lt(this,null,(function*(){yield this.enumerateDevices(),this.videoInputChanged&&this.eventBus.deviceChange.publish({devices:this.getDevices()})})))),this.eventBus.localAudioEnabled.waitFor(i).then((()=>Lt(this,null,(function*(){yield this.enumerateDevices(),this.audioInputChanged&&this.eventBus.deviceChange.publish({devices:this.getDevices()})})))),this.eventBus.deviceChange.subscribe((({type:e,isUserSelection:t,selection:i})=>{if(t){let s="video"===e?"videoInput":e,n=this[s].find((e=>this.createIdentifier(e)===this.createIdentifier(i)));this.eventBus.analytics.publish(Ri.deviceChange({selection:{[s]:n},devices:this.getDevices(),type:e,isUserSelection:t}))}}))}init(e=!1,t=!0){return Lt(this,null,(function*(){this.initialized&&!e||(!this.initialized&&navigator.mediaDevices.addEventListener("devicechange",this.handleDeviceChange),this.initialized=!0,yield this.enumerateDevices(),e||(yield this.updateToActualDefaultDevice(),yield this.autoSelectAudioOutput(),this.startPollingForDevices()),this.logDevices("Init"),yield this.setOutputDevice(),this.eventBus.deviceChange.publish({devices:this.getDevices()}),t&&this.eventBus.analytics.publish(Ri.deviceChange({selection:this.getCurrentSelection(),type:"list",devices:this.getDevices()})))}))}getDevices(){return{audioInput:this.audioInput,audioOutput:this.audioOutput,videoInput:this.videoInput}}cleanup(){this.initialized=!1,this.earpieceSelected=!1,this.timer&&(clearTimeout(this.timer),this.timer=null),this.audioInput=[],this.audioOutput=[],this.videoInput=[],this.outputDevice=void 0,navigator.mediaDevices.removeEventListener("devicechange",this.handleDeviceChange)}createIdentifier(e){return e?`${e.deviceId}${e.groupId}`:""}getNewAudioInputDevice(){var e,t;let i=this.getManuallySelectedAudioDevice();if(i)return i;null==(t=null==(e=this.store.getLocalPeer())?void 0:e.audioTrack)||t.resetManuallySelectedDeviceId();let s=this.audioInput.find((e=>"default"===e.deviceId));return s?this.audioInput.find((e=>"default"!==e.deviceId&&s.label.includes(e.label))):this.audioInput[0]}setOutputDevice(e=!1){return Lt(this,null,(function*(){let t=this.getNewAudioInputDevice(),i=this.createIdentifier(this.outputDevice);this.outputDevice=this.getAudioOutputDeviceMatchingInput(t),this.outputDevice||(this.outputDevice=this.audioOutput.find((e=>this.createIdentifier(e)===i)),this.outputDevice||(this.outputDevice=this.audioOutput.find((e=>"default"===e.deviceId))||this.audioOutput[0])),yield this.store.updateAudioOutputDevice(this.outputDevice),e&&i!==this.createIdentifier(this.outputDevice)&&(this.eventBus.analytics.publish(Ri.deviceChange({selection:{audioOutput:this.outputDevice},devices:this.getDevices(),type:"audioOutput"})),this.eventBus.deviceChange.publish({selection:this.outputDevice,type:"audioOutput",devices:this.getDevices()}))}))}getManuallySelectedAudioDevice(){let e=this.store.getLocalPeer(),t=null==e?void 0:e.audioTrack;return this.audioInput.find((e=>e.deviceId===(null==t?void 0:t.getManuallySelectedDeviceId())))}categorizeAudioInputDevices(){let e=null,t=null,i=null,s=null;for(let n of this.audioInput){let r=qi(n.label);"SPEAKERPHONE"===r?t=n:"WIRED"===r?i=n:"BLUETOOTH"===r?e=n:"EARPIECE"===r&&(s=n)}return{bluetoothDevice:e,speakerPhone:t,wired:i,earpiece:s}}getAudioOutputDeviceMatchingInput(e){var t,i;let s=(null==(i=null==(t=this.store.getConfig())?void 0:t.settings)?void 0:i.speakerAutoSelectionBlacklist)||[];if("all"===s||!e)return;let n=e.label.toLowerCase()||"";if(s.some((e=>n.includes(e.toLowerCase()))))return;let r=this.audioOutput.find((t=>"default"!==e.deviceId&&t.label===e.label));if(r)return r;let a=this.audioOutput.find((t=>t.groupId===e.groupId));return a&&"default"===this.audioOutput[0].deviceId&&a.groupId===this.audioOutput[0].groupId?a:void 0}logDevices(e=""){Yt.d(this.TAG,e,JSON.stringify({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput],selected:this.getCurrentSelection()},null,4))}},no=class{constructor(e,t){this.deviceManager=e,this.audioSinkManager=t}getVolume(){return this.audioSinkManager.getVolume()}setVolume(e){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");this.audioSinkManager.setVolume(e)}getDevice(){return this.deviceManager.outputDevice}setDevice(e){return this.deviceManager.updateOutputDevice(e,!0)}unblockAutoplay(){return Lt(this,null,(function*(){yield this.audioSinkManager.unblockAutoplay(),yield Wi.resumeContext()}))}},ro=class{static handleError(e){if(404===e.status)throw mi.APIErrors.EndpointUnreachable("FEEDBACK",e.statusText);if(e.status>=400)throw mi.APIErrors.ServerErrors(e.status,"FEEDBACK",null==e?void 0:e.statusText)}static sendFeedback(e){return Lt(this,arguments,(function*({token:e,eventEndpoint:t="https://event.100ms.live",info:i,feedback:s}){Yt.d(this.TAG,`sendFeedback: feedbackEndpoint=${t} peerId=${i.peer.peer_id} session=${i.peer.session_id} `);let n=new URL("v2/client/feedback",t),r=At(It({},i),{payload:s});try{let t=yield fetch(n,{headers:{Authorization:`Bearer ${e}`},body:JSON.stringify(r),method:"POST"});try{return void this.handleError(t)}catch(Se){throw Yt.e(this.TAG,"error",Se.message,t.status),Se instanceof pi?Se:mi.APIErrors.ServerErrors(t.status,"FEEDBACK",Se.message)}}catch(_e){let t=_e;throw["Failed to fetch","NetworkError","ECONNRESET"].some((e=>t.message.includes(e)))?mi.APIErrors.EndpointUnreachable("FEEDBACK",t.message):t}}))}};ro.TAG="[FeedbackService]";var ao=class{constructor(e,t){this.eventName=e,this.eventEmitter=t,this.publish=e=>{this.eventEmitter.emit(this.eventName,e)},this.subscribe=e=>{this.eventEmitter.on(this.eventName,e)},this.subscribeOnce=e=>{this.eventEmitter.once(this.eventName,e)},this.unsubscribe=e=>{this.eventEmitter.off(this.eventName,e)},this.waitFor=e=>this.eventEmitter.waitFor(this.eventName,{filter:e}),this.removeAllListeners=()=>{this.eventEmitter.removeAllListeners(this.eventName)}}},oo=class{constructor(){this.eventEmitter=new ge.EventEmitter2,this.analytics=new ao(Xs,this.eventEmitter),this.deviceChange=new ao(Vs,this.eventEmitter),this.localAudioEnabled=new ao(Ws,this.eventEmitter),this.localVideoEnabled=new ao(Hs,this.eventEmitter),this.localVideoUnmutedNatively=new ao(qs,this.eventEmitter),this.localAudioUnmutedNatively=new ao(Ks,this.eventEmitter),this.statsUpdate=new ao(Js,this.eventEmitter),this.trackDegraded=new ao(zs,this.eventEmitter),this.trackRestored=new ao(Qs,this.eventEmitter),this.trackAudioLevelUpdate=new ao(Ys,this.eventEmitter),this.audioPluginFailed=new ao(en,this.eventEmitter),this.localAudioSilence=new ao(Zs,this.eventEmitter),this.policyChange=new ao(tn,this.eventEmitter),this.localRoleUpdate=new ao(sn,this.eventEmitter),this.audioTrackUpdate=new ao(nn,this.eventEmitter),this.audioTrackAdded=new ao(rn,this.eventEmitter),this.audioTrackRemoved=new ao(an,this.eventEmitter),this.autoplayError=new ao(on,this.eventEmitter),this.leave=new ao(ln,this.eventEmitter)}},lo=class{constructor(e,t,i){this.store=e,this.listener=t,this.audioListener=i}handleActiveSpeakers(e){var t,i,s;let n=e["speaker-list"],r=n.map((e=>({audioLevel:e.level,peer:this.store.getPeerById(e.peer_id),track:this.store.getTrackById(e.track_id)})));null==(t=this.audioListener)||t.onAudioLevelUpdate(r),this.store.updateSpeakers(r);let a=n[0];if(a){let e=this.store.getPeerById(a.peer_id);null==(i=this.listener)||i.onPeerUpdate(4,e)}else null==(s=this.listener)||s.onPeerUpdate(5,null)}},co=class{constructor(e){this.listener=e,this.TAG="[BroadcastManager]"}handleNotification(e,t){"on-broadcast"===e&&this.handleBroadcast(t)}handleBroadcast(e){var t,i;Yt.d(this.TAG,`Received Message from sender=${null==(t=null==e?void 0:e.peer)?void 0:t.peer_id}: ${e}`),null==(i=this.listener)||i.onMessageReceived(e)}},uo=class{constructor(e,t){this.store=e,this.listener=t}handleQualityUpdate(e){var t;let i=e.peers.map((e=>{let t=this.store.getPeerById(e.peer_id);return t&&t.updateNetworkQuality(e.downlink_score),{peerID:e.peer_id,downlinkQuality:e.downlink_score}}));null==(t=this.listener)||t.onConnectionQualityUpdate(i)}},ho=class{constructor(e,t,i){this.store=e,this.eventBus=t,this.listener=i,this.TAG="[TrackManager]",this.tracksToProcess=new Map,this.handleTrackAdd=e=>{Yt.d(this.TAG,"ONTRACKADD",`${e}`),this.tracksToProcess.set(e.trackId,e),this.processPendingTracks()},this.handleTrackRemovedPermanently=e=>{Yt.d(this.TAG,"ONTRACKREMOVE permanently",e),Object.keys(e.tracks).forEach((e=>{var t;let i=this.store.getTrackState(e);if(!i)return;let s=this.store.getTrackById(e);if(!s)return void Yt.d(this.TAG,"Track not found in store");"audio"===s.type&&this.eventBus.audioTrackRemoved.publish(s),this.store.removeTrack(s);let n=this.store.getPeerById(i.peerId);n&&(this.removePeerTracks(n,s),null==(t=this.listener)||t.onTrackUpdate(1,s,n))}))},this.handleTrackLayerUpdate=e=>{for(let t in e.tracks){let i=e.tracks[t],s=this.store.getTrackById(t);!s||!this.store.getPeerByTrackId(t)||s instanceof cn&&this.setLayer(s,i)}},this.handleTrackUpdate=(e,t=!0)=>{var i,s;let n=this.store.getPeerById(e.peer.peer_id),r=e.peer;if(n||r){n||(n=An(r,this.store),this.store.addPeer(n));for(let r in e.tracks){let a=Object.assign({},null==(i=this.store.getTrackState(r))?void 0:i.trackInfo),o=e.tracks[r],l=this.store.getTrackById(r);if(this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:It(It({},a),o)}),!l||this.tracksToProcess.has(r))this.processTrackInfo(o,e.peer.peer_id,t),this.processPendingTracks();else{l.setEnabled(!o.mute);let e=this.processTrackUpdate(l,a,o);e&&(null==(s=this.listener)||s.onTrackUpdate(e,l,n))}}}else Yt.d(this.TAG,"Track Update ignored - Peer not added to store")},this.processTrackInfo=(e,t,i)=>{},this.processPendingTracks=()=>{new Map(this.tracksToProcess).forEach((e=>{var t;let i=this.store.getTrackState(e.trackId);if(!i)return void Yt.d(this.TAG,"TrackState not added to store",`peerId - ${e.peerId}`,`trackId -${e.trackId}`);let s=this.store.getPeerById(i.peerId);s?(e.source=i.trackInfo.source,e.peerId=s.peerId,e.logIdentifier=s.name,e.setEnabled(!i.trackInfo.mute),this.addAudioTrack(s,e),this.addVideoTrack(s,e),"audio"===e.type?this.eventBus.audioTrackAdded.publish({track:e,peer:s}):null==(t=this.listener)||t.onTrackUpdate(0,e,s),this.tracksToProcess.delete(e.trackId)):Yt.d(this.TAG,"Peer not added to store, peerId",i.peerId)}))}}handleTrackMetadataAdd(e){Yt.d(this.TAG,"TRACK_METADATA_ADD",JSON.stringify(e,null,2));for(let t in e.tracks){let i=e.tracks[t];this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:i})}this.processPendingTracks()}handleTrackRemove(e,t=!0){var i;Yt.d(this.TAG,"ONTRACKREMOVE",`${e}`);let s=this.store.getTrackState(e.trackId);if(s)if(this.store.hasTrack(e)){if(t){this.store.removeTrack(e);let t=this.store.getPeerById(s.peerId);if(!t)return;this.removePeerTracks(t,e),null==(i=this.listener)||i.onTrackUpdate(1,e,t),"audio"===e.type&&this.eventBus.audioTrackRemoved.publish(e)}}else Yt.d(this.TAG,"Track not found in store")}setLayer(e,t){var i,s;let n=this.store.getPeerByTrackId(e.trackId);n&&(e.setLayerFromServer(t)?null==(i=this.listener)||i.onTrackUpdate(5,e,n):null==(s=this.listener)||s.onTrackUpdate(6,e,n))}removePeerTracks(e,t){let i=e.auxiliaryTracks.indexOf(t);i>-1?(e.auxiliaryTracks.splice(i,1),Yt.d(this.TAG,"auxiliary track removed",`${t}`)):"audio"===t.type&&e.audioTrack===t?(e.audioTrack=void 0,Yt.d(this.TAG,"audio track removed",`${t}`)):"video"===t.type&&e.videoTrack===t&&(e.videoTrack=void 0,Yt.d(this.TAG,"video track removed",`${t}`))}addAudioTrack(e,t){var i;"audio"===t.type&&("regular"!==t.source||e.audioTrack&&(null==(i=e.audioTrack)?void 0:i.trackId)!==t.trackId?e.auxiliaryTracks.push(t):e.audioTrack=t,this.store.addTrack(t),Yt.d(this.TAG,"audio track added",`${t}`))}addVideoTrack(e,t){if("video"!==t.type)return;let i=t,s=this.store.getSimulcastDefinitionsForPeer(e,i.source);if(i.setSimulcastDefinitons(s),this.addAsPrimaryVideoTrack(e,i))e.videoTrack?e.videoTrack.replaceTrack(i):e.videoTrack=i,this.store.addTrack(e.videoTrack);else{let t=e.auxiliaryTracks.findIndex((e=>e.trackId===i.trackId));-1===t?(e.auxiliaryTracks.push(i),this.store.addTrack(i)):(e.auxiliaryTracks[t].replaceTrack(i),this.store.addTrack(e.auxiliaryTracks[t]))}Yt.d(this.TAG,"video track added",`${t}`)}addAsPrimaryVideoTrack(e,t){var i;return"regular"===t.source&&(!e.videoTrack||(null==(i=e.videoTrack)?void 0:i.trackId)===t.trackId)}processTrackUpdate(e,t,i){let s;return t.mute!==i.mute?(s=i.mute?2:3,"audio"===e.type&&this.eventBus.audioTrackUpdate.publish({track:e,enabled:!i.mute})):t.description!==i.description&&(s=4),s}},po=class extends ho{constructor(e,t,i,s){super(e,t,s),this.transport=i,this.TAG="[OnDemandTrackManager]",this.processTrackInfo=(e,t,i=!0)=>{var s,n;if("video"!==e.type)return;let r=this.store.getPeerById(t);if(!r||!this.isPeerRoleSubscribed(t))return void Yt.d(this.TAG,`no peer in store for peerId: ${t}`);let a=new pn(new MediaStream,this.transport.getSubscribeConnection()),o=xs.getEmptyVideoTrack();o.enabled=!e.mute;let l=new cn(a,o,e.source,null==(s=this.store.getRoom())?void 0:s.disableNoneLayerRequest);l.setTrackId(e.track_id),l.peerId=r.peerId,l.logIdentifier=r.name,this.addVideoTrack(r,l),i&&(null==(n=this.listener)||n.onTrackUpdate(0,r.videoTrack,r))}}handleTrackMetadataAdd(e){super.handleTrackMetadataAdd(e);for(let t in e.tracks)"video"===e.tracks[t].type&&this.processTrackInfo(e.tracks[t],e.peer.peer_id)}handleTrackRemove(e){let t="video"===e.type&&"regular"===e.source;super.handleTrackRemove(e,!t),t&&this.processTrackInfo({track_id:e.trackId,mute:!e.enabled,type:e.type,source:e.source,stream_id:e.stream.id},e.peerId,!1)}addAsPrimaryVideoTrack(e,t){return"regular"===t.source&&(!e.videoTrack||e.videoTrack.trackId===t.trackId||e.videoTrack.enabled&&Vi(e.videoTrack.nativeTrack))}isPeerRoleSubscribed(e){var t,i,s,n;if(!e)return!0;let r=this.store.getLocalPeer(),a=this.store.getPeerById(e);return a&&(null==(n=null==(i=null==(t=null==r?void 0:r.role)?void 0:t.subscribeParams)?void 0:i.subscribeToRoles)?void 0:n.includes(null==(s=a.role)?void 0:s.name))}},vo=class{constructor(e,t,i,s){this.store=e,this.peerManager=t,this.trackManager=i,this.listener=s,this.TAG="[PeerListManager]",this.handleInitialPeerList=e=>{let t=Object.values(e.peers);this.peerManager.handlePeerList(t)},this.handleReconnectPeerList=e=>{this.handleRepeatedPeerList(e.peers)},this.handlePreviewRoomState=e=>{if(!this.store.hasRoleDetailsArrived())return;let t=e.peers;null!=t?(Object.keys(t).forEach((e=>{t[e].tracks={},t[e].is_from_room_state=!0})),this.handleRepeatedPeerList(t)):0===e.peer_count&&this.handleRepeatedPeerList({})},this.handleRepeatedPeerList=e=>{let t=this.store.getRemotePeers(),i=Object.values(e),s=t.filter((t=>!e[t.peerId]));s.length>0&&Yt.d(this.TAG,`${s}`),s.forEach((e=>{var t;let i={peer_id:e.peerId,role:(null==(t=e.role)?void 0:t.name)||"",info:{name:e.name,data:e.metadata||"",user_id:e.customerUserId||"",type:e.type},tracks:{},groups:[],realtime:e.realtime};this.peerManager.handlePeerLeave(i)}));let n=[];i.forEach((e=>{let t=this.store.getPeerById(e.peer_id),i=Object.values(e.tracks);t&&(this.store.getPeerTracks(t.peerId).forEach((i=>{var s;e.tracks[i.trackId]||(this.removePeerTrack(t,i.trackId),null==(s=this.listener)||s.onTrackUpdate(1,i,t))})),i.forEach((e=>{this.store.getTrackById(e.track_id)||this.store.setTrackState({peerId:t.peerId,trackInfo:e})})),this.trackManager.handleTrackUpdate({peer:e,tracks:e.tracks},!1),this.peerManager.handlePeerUpdate(e)),n.push(e)})),n.length>0&&this.peerManager.handlePeerList(n)}}handleNotification(e,t,i){if("peer-list"===e){let e=t;i?(Yt.d(this.TAG,"RECONNECT_PEER_LIST event",JSON.stringify(e,null,2)),this.handleReconnectPeerList(e)):(Yt.d(this.TAG,"PEER_LIST event",JSON.stringify(e,null,2)),this.handleInitialPeerList(e))}else if("room-state"===e){let e=t;this.handlePreviewRoomState(e)}}removePeerTrack(e,t){var i,s;if(Yt.d(this.TAG,`removing track - ${t} from ${e}`),(null==(i=e.audioTrack)?void 0:i.trackId)===t)e.audioTrack=void 0;else if((null==(s=e.videoTrack)?void 0:s.trackId)===t)e.videoTrack=void 0;else{let i=e.auxiliaryTracks.findIndex((e=>e.trackId===t));i>=0&&e.auxiliaryTracks.splice(i,1)}}},go=e=>e?new Date(e):void 0,mo=class{constructor(e,t,i){this.store=e,this.trackManager=t,this.listener=i,this.TAG="[PeerManager]",this.handlePeerList=e=>{var t,i;if(0===e.length)return void(null==(t=this.listener)||t.onPeerUpdate(9,[]));let s=[],n=new Set(e.map((e=>e.peer_id)));this.store.getRemotePeers().forEach((({peerId:e,fromRoomState:t})=>{!n.has(e)&&t&&this.store.removePeer(e)}));for(let r of e)s.push(this.makePeer(r));null==(i=this.listener)||i.onPeerUpdate(9,s),this.trackManager.processPendingTracks()},this.handlePeerJoin=e=>{var t;let i=this.makePeer(e);null==(t=this.listener)||t.onPeerUpdate(0,i),this.trackManager.processPendingTracks()},this.handlePeerLeave=e=>{var t,i,s,n;let r=this.store.getPeerById(e.peer_id);this.store.removePeer(e.peer_id),Yt.d(this.TAG,"PEER_LEAVE",e.peer_id,`remainingPeers=${this.store.getPeers().length}`),r&&(r.audioTrack&&(null==(t=this.listener)||t.onTrackUpdate(1,r.audioTrack,r)),r.videoTrack&&(null==(i=this.listener)||i.onTrackUpdate(1,r.videoTrack,r)),null==(s=r.auxiliaryTracks)||s.forEach((e=>{var t;null==(t=this.listener)||t.onTrackUpdate(1,e,r)})),null==(n=this.listener)||n.onPeerUpdate(1,r))}}handleNotification(e,t){switch(e){case"on-peer-join":{let e=t;this.handlePeerJoin(e);break}case"on-peer-leave":{let e=t;this.handlePeerLeave(e);break}case"on-peer-update":this.handlePeerUpdate(t)}}handlePeerUpdate(e){var t,i,s,n,r;let a=this.store.getPeerById(e.peer_id);if(!a&&e.realtime)return a=this.makePeer(e),void(null==(t=this.listener)||t.onPeerUpdate(a.isHandRaised?12:14,a));if(a&&!a.isLocal&&!e.realtime)return this.store.removePeer(a.peerId),void(null==(i=this.listener)||i.onPeerUpdate(13,a));if(!a)return void Yt.d(this.TAG,`peer ${e.peer_id} not found`);if(a.role&&a.role.name!==e.role){let t=this.store.getPolicyForRole(e.role);a.updateRole(t),this.updateSimulcastLayersForPeer(a),null==(s=this.listener)||s.onPeerUpdate(8,a)}let o=a.isHandRaised;a.updateGroups(e.groups),o!==(null==(n=e.groups)?void 0:n.includes(dn))&&(null==(r=this.listener)||r.onPeerUpdate(12,a)),this.handlePeerInfoUpdate(It({peer:a},e.info))}handlePeerInfoUpdate({peer:e,name:t,data:i}){var s,n;e&&(t&&e.name!==t&&(e.updateName(t),null==(s=this.listener)||s.onPeerUpdate(10,e)),i&&e.metadata!==i&&(e.updateMetadata(i),null==(n=this.listener)||n.onPeerUpdate(11,e)))}makePeer(e){let t=this.store.getPeerById(e.peer_id);t||(t=An(e,this.store),t.realtime=e.realtime,t.joinedAt=go(e.joined_at),t.fromRoomState=!!e.is_from_room_state,this.store.addPeer(t),Yt.d(this.TAG,"adding to the peerList",`${t}`));for(let i in e.tracks){let t=e.tracks[i];this.store.setTrackState({peerId:e.peer_id,trackInfo:t}),"video"===t.type&&this.trackManager.processTrackInfo(t,e.peer_id,!1)}return t}updateSimulcastLayersForPeer(e){this.store.getPeerTracks(e.peerId).forEach((t=>{if("video"===t.type&&["regular","screen"].includes(t.source)){let i=t,s=this.store.getSimulcastDefinitionsForPeer(e,i.source);i.setSimulcastDefinitons(s)}}))}},fo=class{constructor(e,t){this.store=e,this.eventBus=t}handlePolicyChange(e){let t=this.store.getLocalPeer();if(t&&!t.role){let i=e.known_roles[e.name];t.updateRole(i)}this.store.setKnownRoles(e);let i=this.store.getRoom();i?i.templateId=e.template_id:Yt.w("[PolicyChangeManager]","on policy change - room not present"),this.updateLocalPeerRole(e),this.eventBus.policyChange.publish(e)}updateLocalPeerRole(e){var t;let i=this.store.getLocalPeer();if(null!=i&&i.role&&i.role.name!==e.name){let s=this.store.getPolicyForRole(e.name),n=i.role;i.updateRole(s),s.name===(null==(t=i.asRole)?void 0:t.name)&&delete i.asRole,this.eventBus.localRoleUpdate.publish({oldRole:n,newRole:s})}}},yo=(e,t,i)=>{let s=new URL("qa"===i?"https://whiteboard-qa.100ms.live":"https://whiteboard.100ms.live");return s.searchParams.set("endpoint",`https://${t}`),s.searchParams.set("token",e),s.toString()},ko=class{constructor(e,t,i){this.transport=e,this.store=t,this.listener=i,this.TAG="[HMSWhiteboardInteractivityCenter]"}get isEnabled(){return this.transport.isFlagEnabled("whiteboardEnabled")}open(e){return Lt(this,null,(function*(){var t;if(!this.isEnabled)return Yt.w(this.TAG,"Whiteboard is not enabled for customer");let i=this.store.getWhiteboard(null==e?void 0:e.id),s=null==i?void 0:i.id;if(i||(s=(yield this.transport.signal.createWhiteboard(this.getCreateOptionsWithDefaults(e))).id),!s)throw new Error(`Whiteboard ID: ${s} not found`);let n=yield this.transport.signal.getWhiteboard({id:s}),r=At(It({},i),{title:null==e?void 0:e.title,attributes:null==e?void 0:e.attributes,id:n.id,url:yo(n.token,n.addr,this.store.getEnv()),token:n.token,addr:n.addr,owner:n.owner,permissions:n.permissions||[],open:!0});this.store.setWhiteboard(r),null==(t=this.listener)||t.onWhiteboardUpdate(r)}))}close(e){return Lt(this,null,(function*(){var t;if(!this.isEnabled)return Yt.w(this.TAG,"Whiteboard is not enabled for customer");let i=this.store.getWhiteboard(e);if(!i)throw new Error(`Whiteboard ID: ${e} not found`);let s={id:i.id,title:i.title,open:!1};this.store.setWhiteboard(s),null==(t=this.listener)||t.onWhiteboardUpdate(s)}))}setListener(e){this.listener=e}handleLocalRoleUpdate(){return Lt(this,null,(function*(){var e,t,i;let s=this.store.getWhiteboards();for(let n of s.values())if(n.url){let s=yield this.transport.signal.getWhiteboard({id:n.id}),r=this.store.getLocalPeer(),a=(null==r?void 0:r.customerUserId)===s.owner?null==(t=null==(e=r.role)?void 0:e.permissions.whiteboard)?void 0:t.includes("admin"):s.permissions.length>0,o=At(It({},n),{id:s.id,url:yo(s.token,s.addr,this.store.getEnv()),token:s.token,addr:s.addr,owner:s.owner,permissions:s.permissions,open:a});this.store.setWhiteboard(o),null==(i=this.listener)||i.onWhiteboardUpdate(o)}}))}getCreateOptionsWithDefaults(e){var t;let i=Object.values(this.store.getKnownRoles()),s=[],n=[],r=[];return i.forEach((e=>{var t,i,a;null!=(t=e.permissions.whiteboard)&&t.includes("read")&&s.push(e.name),null!=(i=e.permissions.whiteboard)&&i.includes("write")&&n.push(e.name),null!=(a=e.permissions.whiteboard)&&a.includes("admin")&&r.push(e.name)})),{title:(null==e?void 0:e.title)||`${null==(t=this.store.getRoom())?void 0:t.id} Whiteboard`,reader:(null==e?void 0:e.reader)||s,writer:(null==e?void 0:e.writer)||n,admin:(null==e?void 0:e.admin)||r}}},To=class{constructor(e,t,i){this.transport=e,this.store=t,this.listener=i,this.whiteboard=new ko(e,t,i)}setListener(e){this.listener=e,this.whiteboard.setListener(e)}createPoll(e){return Lt(this,null,(function*(){var t,i;let{poll_id:s}=yield this.transport.signal.setPollInfo(At(It({},e),{mode:e.mode?{customerID:"userid",peerID:"peerid",userName:"username"}[e.mode]:void 0,poll_id:e.id,vote:e.rolesThatCanVote,responses:e.rolesThatCanViewResponses}));e.id||(e.id=s),Array.isArray(e.questions)&&(yield this.addQuestionsToPoll(e.id,e.questions));let n=yield this.transport.signal.getPollQuestions({poll_id:e.id,index:0,count:50}),r=bo(At(It({},e),{poll_id:e.id,state:"created",created_by:null==(t=this.store.getLocalPeer())?void 0:t.peerId}));r.questions=n.questions.map((({question:e,options:t,answer:i})=>At(It({},e),{options:t,answer:i}))),null==(i=this.listener)||i.onPollsUpdate(0,[r])}))}startPoll(e){return Lt(this,null,(function*(){"string"==typeof e?yield this.transport.signal.startPoll({poll_id:e}):(yield this.createPoll(e),yield this.transport.signal.startPoll({poll_id:e.id}))}))}addQuestionsToPoll(e,t){return Lt(this,null,(function*(){t.length>0&&(yield this.transport.signal.setPollQuestions({poll_id:e,questions:t.map(((e,t)=>this.createQuestionSetParams(e,t)))}))}))}stopPoll(e){return Lt(this,null,(function*(){yield this.transport.signal.stopPoll({poll_id:e})}))}addResponsesToPoll(e,t){return Lt(this,null,(function*(){let i=this.store.getPoll(e);if(!i)throw new Error("Invalid poll ID - Poll not found");let s=t.map((e=>{var t,s;let n=this.getQuestionInPoll(i,e.questionIndex);return"single-choice"===n.type?(e.option=e.option||(null==(t=e.options)?void 0:t[0])||-1,delete e.text,delete e.options):"multiple-choice"===n.type?(null==(s=e.options)||s.sort(),delete e.text,delete e.option):(delete e.option,delete e.options),e.skipped&&(delete e.option,delete e.options,delete e.text),It({duration:0,type:n.type,question:e.questionIndex},e)}));yield this.transport.signal.setPollResponses({poll_id:e,responses:s})}))}fetchLeaderboard(e,t,i){return Lt(this,null,(function*(){var s,n;let r=this.store.getPoll(e);if(!r)throw new Error("Invalid poll ID - Poll not found");let a=null==(n=null==(s=this.store.getLocalPeer())?void 0:s.role)?void 0:n.permissions,o=!!(null!=a&&a.pollRead||null!=a&&a.pollWrite);if(r.anonymous||"stopped"!==r.state||!o)return{entries:[],hasNext:!1};let l=yield this.transport.signal.fetchPollLeaderboard({poll_id:r.id,count:i,offset:t}),d={avgScore:l.avg_score,avgTime:l.avg_time,votedUsers:l.voted_users,totalUsers:l.total_users,correctUsers:l.correct_users};return{entries:l.questions.map((e=>({position:e.position,totalResponses:e.total_responses,correctResponses:e.correct_responses,duration:e.duration,peer:e.peer,score:e.score}))),hasNext:!l.last,summary:d}}))}getPollResponses(e,t){return Lt(this,null,(function*(){var i,s;let n=yield this.transport.signal.getPollResponses({poll_id:e.id,index:0,count:50,self:t}),r=JSON.parse(JSON.stringify(e));null==(i=n.responses)||i.forEach((({response:i,peer:s,final:n})=>{var a,o;let l=null==(a=null==e?void 0:e.questions)?void 0:a.find((e=>e.index===i.question));if(l){let e={id:i.response_id,questionIndex:i.question,option:i.option,options:i.options,text:i.text,responseFinal:n,peer:{peerid:s.peerid,userHash:s.hash,userid:s.userid,username:s.username},skipped:i.skipped,type:i.type,update:i.update},a=l.responses&&!t?[...l.responses]:[];null!=(o=r.questions)&&o[i.question-1]&&(r.questions[i.question-1].responses=[...a,e])}})),this.store.setPoll(r),null==(s=this.listener)||s.onPollsUpdate(4,[r])}))}getPolls(){return Lt(this,null,(function*(){var e,t,i;let s=yield this.transport.signal.getPollsList({count:50,state:"started"}),n=[],r=null==(t=null==(e=this.store.getLocalPeer())?void 0:e.role)?void 0:t.permissions.pollWrite,a=[...s.polls];if(r){let e=yield this.transport.signal.getPollsList({count:50,state:"created"}),t=yield this.transport.signal.getPollsList({count:50,state:"stopped"});a=[...e.polls,...a,...t.polls]}for(let o of a){let e=yield this.transport.signal.getPollQuestions({poll_id:o.poll_id,index:0,count:50}),t=bo(o),i=this.store.getPoll(o.poll_id);t.questions=e.questions.map((({question:e,options:t,answer:s},n)=>{var r,a;return At(It({},e),{options:t,answer:s,responses:null==(a=null==(r=null==i?void 0:i.questions)?void 0:r[n])?void 0:a.responses})})),n.push(t),this.store.setPoll(t)}return null==(i=this.listener)||i.onPollsUpdate(3,n),n}))}createQuestionSetParams(e,t){var i,s;if(e.index){let s=null==(i=e.options)?void 0:i.map(((e,t)=>At(It({},e),{index:t+1})));return{question:At(It({},e),{index:t+1}),options:s,answer:e.answer}}let n,r=At(It({},e),{index:t+1}),a=e.answer||{hidden:!1};return Array.isArray(e.options)&&["single-choice","multiple-choice"].includes(e.type)?(n=null==(s=e.options)?void 0:s.map(((e,t)=>({index:t+1,text:e.text,weight:e.weight}))),"single-choice"===e.type?a.option=e.options.findIndex((e=>e.isCorrectAnswer))+1||void 0:a.options=e.options.map(((e,t)=>e.isCorrectAnswer?t+1:void 0)).filter((e=>!!e))):(null==a||delete a.options,null==a||delete a.option),{question:r,options:n,answer:a}}getQuestionInPoll(e,t){var i;let s=null==(i=null==e?void 0:e.questions)?void 0:i.find((e=>e.index===t));if(!s)throw new Error("Invalid question index - Question not found in poll");return s}},bo=e=>({id:e.poll_id,title:e.title,startedBy:e.started_by,createdBy:e.created_by,anonymous:e.anonymous,type:e.type,duration:e.duration,locked:e.locked,mode:e.mode?{userid:"customerID",peerid:"peerID",username:"userName"}[e.mode]:void 0,visibility:e.visibility,rolesThatCanVote:e.vote||[],rolesThatCanViewResponses:e.responses||[],state:e.state,stoppedBy:e.stopped_by,startedAt:go(e.started_at),stoppedAt:go(e.stopped_at),createdAt:go(e.created_at)}),So=class{constructor(e,t,i){this.store=e,this.transport=t,this.listener=i}handleNotification(e,t){switch(e){case"on-poll-start":this.handlePollStart(t);break;case"on-poll-stop":this.handlePollStop(t);break;case"on-poll-stats":this.handlePollStats(t)}}handlePollStart(e){return Lt(this,null,(function*(){var t,i;let s=[];for(let n of e.polls){let e=this.store.getPoll(n.poll_id);if(e&&"started"===e.state)return void(null==(t=this.listener)||t.onPollsUpdate(1,[e]));let i=yield this.transport.signal.getPollQuestions({poll_id:n.poll_id,index:0,count:50}),r=bo(n);r.questions=i.questions.map((({question:e,options:t,answer:i})=>At(It({},e),{options:t,answer:i}))),yield this.updatePollResponses(r,!0),s.push(r),this.store.setPoll(r)}null==(i=this.listener)||i.onPollsUpdate(1,s)}))}handlePollStop(e){return Lt(this,null,(function*(){var t;let i=[];for(let s of e.polls){let e=this.store.getPoll(s.poll_id);if(e){e.state="stopped",e.stoppedAt=go(s.stopped_at),e.stoppedBy=s.stopped_by;let t=yield this.transport.signal.getPollResult({poll_id:s.poll_id});this.updatePollResult(e,t),i.push(e)}}i.length>0&&(null==(t=this.listener)||t.onPollsUpdate(2,i))}))}handlePollStats(e){return Lt(this,null,(function*(){var t;let i=[];for(let s of e.polls){let e=this.store.getPoll(s.poll_id);if(!e)return;this.updatePollResult(e,s),i.push(e)}i.length>0&&(null==(t=this.listener)||t.onPollsUpdate(4,i))}))}updatePollResult(e,t){var i;e.result=It({},e.result),e.result.totalUsers=t.user_count,e.result.maxUsers=t.max_user,e.result.totalResponses=t.total_response,null==(i=t.questions)||i.forEach((t=>{var i,s;let n=null==(i=e.questions)?void 0:i.find((e=>e.index===t.question));n&&(n.result=It({},n.result),n.result.correctResponses=t.correct,n.result.skippedCount=t.skipped,n.result.totalResponses=t.total,null==(s=t.options)||s.forEach(((e,t)=>{var i;let s=null==(i=n.options)?void 0:i[t];s&&s.voteCount!==e&&(s.voteCount=e)})))}))}updatePollResponses(e,t){return Lt(this,null,(function*(){var i;null==(i=(yield this.transport.signal.getPollResponses({poll_id:e.id,index:0,count:50,self:t})).responses)||i.forEach((({response:t,peer:i,final:s})=>{var n;let r=null==(n=null==e?void 0:e.questions)?void 0:n.find((e=>e.index===t.question));if(!r)return;let a={id:t.response_id,questionIndex:t.question,option:t.option,options:t.options,text:t.text,responseFinal:s,peer:{peerid:i.peerid,userHash:i.hash,userid:i.userid,username:i.username},skipped:t.skipped,type:t.type,update:t.update};Array.isArray(r.responses)&&r.responses.length>0?r.responses.find((({id:e})=>e===a.id))||r.responses.push(a):r.responses=[a]}))}))}},Po=class{constructor(e,t){this.store=e,this.listener=t}handleNotification(e,t){switch(e){case"on-role-change-request":this.handleRoleChangeRequest(t);break;case"on-track-update-request":this.handleTrackUpdateRequest(t);break;case"on-change-track-mute-state-request":this.handleChangeTrackStateRequest(t);break;default:return}}handleRoleChangeRequest(e){var t;let i={requestedBy:e.requested_by?this.store.getPeerById(e.requested_by):void 0,role:this.store.getPolicyForRole(e.role),token:e.token};null==(t=this.listener)||t.onRoleChangeRequest(i)}handleTrackUpdateRequest(e){let{requested_by:t,track_id:i,mute:s}=e,n=t?this.store.getPeerById(t):void 0,r=this.store.getLocalPeerTracks().find((e=>e.publishedTrackId===i));if(!r)return;let a=()=>{var e;null==(e=this.listener)||e.onChangeTrackStateRequest({requestedBy:n,track:r,enabled:!s})};if(s){if(r.enabled===!s)return;r.setEnabled(!s).then(a)}else a()}handleChangeTrackStateRequest(e){var t;let{type:i,source:s,value:n,requested_by:r}=e,a=r?this.store.getPeerById(r):void 0,o=!n,l=this.getTracksToBeUpdated({type:i,source:s,enabled:o});if(0!==l.length)if(o)null==(t=this.listener)||t.onChangeMultiTrackStateRequest({requestedBy:a,tracks:l,type:i,source:s,enabled:!0});else{let e=[];for(let t of l)e.push(t.setEnabled(!1));Promise.all(e).then((()=>{var e;null==(e=this.listener)||e.onChangeMultiTrackStateRequest({requestedBy:a,tracks:l,enabled:!1})}))}}getTracksToBeUpdated({type:e,source:t,enabled:i}){let s=this.store.getLocalPeerTracks();return e&&(s=s.filter((t=>t.type===e))),t&&(s=s.filter((e=>e.source===t))),s.filter((e=>e.enabled!==i))}},Eo=class{constructor(e,t){this.store=e,this.listener=t,this.TAG="[RoomUpdateManager]"}handleNotification(e,t){switch(e){case"peer-list":this.onRoomState(t.room);break;case"on-rtmp-update":this.updateRTMPStatus(t);break;case"on-record-update":this.updateRecordingStatus(t);break;case"room-state":this.handlePreviewRoomState(t);break;case"room-info":this.handleRoomInfo(t);break;case"session-info":this.handleSessionInfo(t);break;case"on-hls-update":this.updateHLSStatus(t);break;case"on-transcription-update":this.handleTranscriptionStatus([t])}}handleRoomInfo(e){let t=this.store.getRoom();t?(t.description=e.description,t.large_room_optimization=e.large_room_optimization,t.max_size=e.max_size,t.name=e.name):Yt.w(this.TAG,"on session info - room not present")}handleSessionInfo(e){var t;let i=this.store.getRoom();i?(i.sessionId=e.session_id,i.peerCount!==e.peer_count&&(i.peerCount=e.peer_count,null==(t=this.listener)||t.onRoomUpdate("ROOM_PEER_COUNT_UPDATED",i))):Yt.w(this.TAG,"on session info - room not present")}handlePreviewRoomState(e){let{room:t}=e;this.onRoomState(t)}onRoomState(e){var t,i,s,n;let{recording:r,streaming:a,transcriptions:o,session_id:l,started_at:d,name:c}=e,u=this.store.getRoom();u?(u.name=c,u.rtmp.running=this.isStreamingRunning(null==(t=null==a?void 0:a.rtmp)?void 0:t.state),u.rtmp.startedAt=go(null==(i=null==a?void 0:a.rtmp)?void 0:i.started_at),u.rtmp.state=null==(s=null==a?void 0:a.rtmp)?void 0:s.state,u.recording.server=this.getPeerListSFURecording(r),u.recording.browser=this.getPeerListBrowserRecording(r),u.recording.hls=this.getPeerListHLSRecording(r),u.hls=this.convertHls(null==a?void 0:a.hls),u.transcriptions=this.addTranscriptionDetail(o),u.sessionId=l,u.startedAt=go(d),null==(n=this.listener)||n.onRoomUpdate("RECORDING_STATE_UPDATED",u)):Yt.w(this.TAG,"on room state - room not present")}addTranscriptionDetail(e){return e?e.map((e=>({state:e.state,mode:e.mode,initialised_at:go(e.initialised_at),started_at:go(e.started_at),stopped_at:go(e.stopped_at),updated_at:go(e.updated_at),error:this.toSdkError(null==e?void 0:e.error)}))):[]}isRecordingRunning(e){return!!e&&!["none","paused","stopped","failed"].includes(e)}isStreamingRunning(e){return!!e&&!["none","stopped","failed"].includes(e)}initHLS(e){let t=this.store.getRoom(),i={running:!0,variants:[]};return t?(null!=e&&e.variants&&e.variants.forEach(((t,s)=>{var n,r,a;"initialised"!==t.state?i.variants.push({meetingURL:null==t?void 0:t.meetingURL,url:null==t?void 0:t.url,metadata:null==t?void 0:t.metadata,playlist_type:null==t?void 0:t.playlist_type,startedAt:go(null==(n=null==e?void 0:e.variants)?void 0:n[s].started_at),initialisedAt:go(null==(r=null==e?void 0:e.variants)?void 0:r[s].initialised_at),state:t.state,stream_type:null==t?void 0:t.stream_type}):i.variants.push({initialisedAt:go(null==(a=null==e?void 0:e.variants)?void 0:a[s].initialised_at),url:""})})),i):(Yt.w(this.TAG,"on hls - room not present"),i)}updateHLSStatus(e){var t;let i=this.store.getRoom(),s=!!(e.variants&&e.variants.length>0)&&e.variants.some((e=>this.isStreamingRunning(e.state)));i?(e.enabled=s,i.hls=this.convertHls(e),null==(t=this.listener)||t.onRoomUpdate("HLS_STREAMING_STATE_UPDATED",i)):Yt.w(this.TAG,"on hls - room not present")}handleTranscriptionStatus(e){var t;let i=this.store.getRoom();i?(i.transcriptions=this.addTranscriptionDetail(e)||[],null==(t=this.listener)||t.onRoomUpdate("TRANSCRIPTION_STATE_UPDATED",i)):Yt.w(this.TAG,"on transcription - room not present")}convertHls(e){var t;if(null!=e&&e.variants&&e.variants.length>0&&e.variants.some((e=>"initialised"===e.state)))return this.initHLS(e);let i={running:!(null==e||!e.enabled),variants:[],error:this.toSdkError(null==e?void 0:e.error)};return null==(t=null==e?void 0:e.variants)||t.forEach((e=>{i.variants.push({meetingURL:null==e?void 0:e.meeting_url,url:null==e?void 0:e.url,metadata:null==e?void 0:e.metadata,playlist_type:null==e?void 0:e.playlist_type,startedAt:go(null==e?void 0:e.started_at),initialisedAt:go(null==e?void 0:e.initialised_at),state:e.state,stream_type:null==e?void 0:e.stream_type})})),i}getHLSRecording(e){var t,i;let s={running:!1},n=this.isRecordingRunning(null==e?void 0:e.state);return(n||"paused"===(null==e?void 0:e.state))&&(s={running:n,singleFilePerLayer:!(null==(t=null==e?void 0:e.hls_recording)||!t.single_file_per_layer),hlsVod:!(null==(i=null==e?void 0:e.hls_recording)||!i.hls_vod),startedAt:go(null==e?void 0:e.started_at),initialisedAt:go(null==e?void 0:e.initialised_at),state:null==e?void 0:e.state,error:this.toSdkError(null==e?void 0:e.error)}),s}getPeerListHLSRecording(e){var t,i;let s=null==e?void 0:e.hls;return{running:this.isRecordingRunning(null==s?void 0:s.state),startedAt:go(null==s?void 0:s.started_at),initialisedAt:go(null==s?void 0:s.initialised_at),state:null==s?void 0:s.state,singleFilePerLayer:null==(t=null==s?void 0:s.config)?void 0:t.single_file_per_layer,hlsVod:null==(i=null==s?void 0:s.config)?void 0:i.hls_vod}}getPeerListBrowserRecording(e){let t=null==e?void 0:e.browser;return{running:this.isRecordingRunning(null==t?void 0:t.state),startedAt:go(null==t?void 0:t.started_at),state:null==t?void 0:t.state}}getPeerListSFURecording(e){let t=null==e?void 0:e.sfu;return{running:this.isRecordingRunning(null==t?void 0:t.state),startedAt:go(null==t?void 0:t.started_at),state:null==t?void 0:t.state}}updateRecordingStatus(e){var t;let i,s=this.store.getRoom(),n=this.isRecordingRunning(e.state);s?("sfu"===e.type?(s.recording.server={running:n,startedAt:n?go(e.started_at):void 0,error:this.toSdkError(e.error),state:e.state},i="SERVER_RECORDING_STATE_UPDATED"):"HLS"===e.type?(s.recording.hls=this.getHLSRecording(e),i="RECORDING_STATE_UPDATED"):(s.recording.browser={running:n,startedAt:n?go(e.started_at):void 0,error:this.toSdkError(e.error),state:null==e?void 0:e.state},i="BROWSER_RECORDING_STATE_UPDATED"),null==(t=this.listener)||t.onRoomUpdate(i,s)):Yt.w(this.TAG,`set recording status running=${n} - room not present`)}updateRTMPStatus(e){var t,i;let s=this.store.getRoom(),n=this.isStreamingRunning(e.state);if(s)return n?(s.rtmp={running:n,startedAt:n?go(e.started_at):void 0,state:e.state,error:this.toSdkError(e.error)},void(null==(i=this.listener)||i.onRoomUpdate("RTMP_STREAMING_STATE_UPDATED",s))):(s.rtmp={running:n,state:e.state,error:this.toSdkError(e.error)},void(null==(t=this.listener)||t.onRoomUpdate("RTMP_STREAMING_STATE_UPDATED",s)));Yt.w(this.TAG,"on policy change - room not present")}toSdkError(e){if(null==e||!e.code)return;let t=e.message||"error in streaming/recording",i=new pi(e.code,"ServerErrors","NONE",t,t);return Yt.e(this.TAG,"error in streaming/recording",i),i}},Co=class{constructor(e,t){this.store=e,this.listener=t}handleNotification(e,t){"on-metadata-change"===e&&this.handleMetadataChange(t)}handleMetadataChange(e){var t;let i=e.values.map((e=>({key:e.key,value:e.data,updatedAt:go(e.updated_at),updatedBy:e.updated_by?this.store.getPeerById(e.updated_by):void 0})));null==(t=this.listener)||t.onSessionStoreUpdate(i)}},wo=class{constructor(e,t,i){this.store=e,this.transport=t,this.listener=i}handleNotification(e,t){if("on-whiteboard-update"===e)this.handleWhiteboardUpdate(t)}handleWhiteboardUpdate(e){return Lt(this,null,(function*(){var t;let i=this.store.getLocalPeer(),s=this.store.getWhiteboard(e.id),n=e.owner===(null==i?void 0:i.peerId)||e.owner===(null==i?void 0:i.customerUserId),r="open"===e.state,a={id:e.id,title:e.title,attributes:e.attributes};if(a.open=n?null==s?void 0:s.open:r,a.owner=a.open?e.owner:void 0,a.open)if(n)a.url=null==s?void 0:s.url,a.token=null==s?void 0:s.token,a.addr=null==s?void 0:s.addr,a.permissions=null==s?void 0:s.permissions;else{let t=yield this.transport.signal.getWhiteboard({id:e.id});a.url=yo(t.token,t.addr,this.store.getEnv()),a.token=t.token,a.addr=t.addr,a.permissions=t.permissions,a.open=t.permissions.length>0}this.store.setWhiteboard(a),null==(t=this.listener)||t.onWhiteboardUpdate(a)}))}},Io=class{constructor(e,t,i,s,n,r){this.store=e,this.transport=i,this.listener=s,this.audioListener=n,this.connectionQualityListener=r,this.TAG="[HMSNotificationManager]",this.hasConsistentRoomStateArrived=!1,this.ignoreNotification=e=>{if("peer-list"===e)this.hasConsistentRoomStateArrived=!0;else if("room-state"===e)return this.hasConsistentRoomStateArrived;return!1},this.handleTrackAdd=e=>{this.trackManager.handleTrackAdd(e)},this.handleTrackRemove=e=>{this.trackManager.handleTrackRemove(e)},this.updateLocalPeer=({name:e,metadata:t})=>{let i=this.store.getLocalPeer();this.peerManager.handlePeerInfoUpdate({peer:i,name:e,data:t})};let a=this.transport.isFlagEnabled("onDemandTracks");this.trackManager=a?new po(this.store,t,this.transport,this.listener):new ho(this.store,t,this.listener),this.peerManager=new mo(this.store,this.trackManager,this.listener),this.peerListManager=new vo(this.store,this.peerManager,this.trackManager,this.listener),this.broadcastManager=new co(this.listener),this.policyChangeManager=new fo(this.store,t),this.requestManager=new Po(this.store,this.listener),this.activeSpeakerManager=new lo(this.store,this.listener,this.audioListener),this.connectionQualityManager=new uo(this.store,this.connectionQualityListener),this.roomUpdateManager=new Eo(this.store,this.listener),this.sessionMetadataManager=new Co(this.store,this.listener),this.pollsManager=new So(this.store,this.transport,this.listener),this.whiteboardManager=new wo(this.store,this.transport,this.listener)}setListener(e){this.listener=e,this.trackManager.listener=e,this.peerManager.listener=e,this.peerListManager.listener=e,this.broadcastManager.listener=e,this.requestManager.listener=e,this.activeSpeakerManager.listener=e,this.roomUpdateManager.listener=e,this.sessionMetadataManager.listener=e,this.pollsManager.listener=e,this.whiteboardManager.listener=e}setAudioListener(e){this.audioListener=e,this.activeSpeakerManager.audioListener=e}setConnectionQualityListener(e){this.connectionQualityListener=e,this.connectionQualityManager.listener=e}handleNotification(e,t=!1){var i,s;let n=e.method,r=e.params;["active-speakers","sfu-stats","on-connection-quality-update",void 0].includes(n)||Yt.d(this.TAG,`Received notification - ${n}`,{notification:r}),"sfu-stats"===n&&null!=(i=window.HMS)&&i.ON_SFU_STATS&&"function"==typeof(null==(s=window.HMS)?void 0:s.ON_SFU_STATS)&&window.HMS.ON_SFU_STATS(e.params),!this.ignoreNotification(n)&&(this.roomUpdateManager.handleNotification(n,r),this.peerManager.handleNotification(n,r),this.requestManager.handleNotification(n,r),this.peerListManager.handleNotification(n,r,t),this.broadcastManager.handleNotification(n,r),this.sessionMetadataManager.handleNotification(n,r),this.pollsManager.handleNotification(n,r),this.whiteboardManager.handleNotification(n,r),this.handleIsolatedMethods(n,r))}handleIsolatedMethods(e,t){switch(e){case"on-track-add":this.trackManager.handleTrackMetadataAdd(t);break;case"on-track-update":this.trackManager.handleTrackUpdate(t);break;case"on-track-remove":if(!t.peer)return void Yt.d(this.TAG,`Ignoring sfu notification - ${e}`,{notification:t});this.trackManager.handleTrackRemovedPermanently(t);break;case"on-track-layer-update":this.trackManager.handleTrackLayerUpdate(t);break;case"active-speakers":this.activeSpeakerManager.handleActiveSpeakers(t);break;case"on-connection-quality-update":this.connectionQualityManager.handleQualityUpdate(t);break;case"on-policy-change":this.policyChangeManager.handlePolicyChange(t);break;case"node-info":this.transport.setSFUNodeId(t.sfu_node_id)}}},Ao=class{constructor(e){this.transport=e,this.observedKeys=new Set}get(e){return Lt(this,null,(function*(){let{data:t,updated_at:i}=yield this.transport.signal.getSessionMetadata(e);return{value:t,updatedAt:go(i)}}))}set(e,t){return Lt(this,null,(function*(){let{data:i,updated_at:s}=yield this.transport.signal.setSessionMetadata({key:e,data:t});return{value:i,updatedAt:go(s)}}))}observe(e){return Lt(this,null,(function*(){let t=new Set(this.observedKeys);if(e.forEach((e=>this.observedKeys.add(e))),this.observedKeys.size!==t.size)try{yield this.transport.signal.listenMetadataChange(Array.from(this.observedKeys))}catch(Te){throw this.observedKeys=t,Te}}))}unobserve(e){return Lt(this,null,(function*(){let t=new Set(this.observedKeys);if(this.observedKeys=new Set([...this.observedKeys].filter((t=>!e.includes(t)))),this.observedKeys.size!==t.size)try{yield this.transport.signal.listenMetadataChange(Array.from(this.observedKeys))}catch(Te){throw this.observedKeys=t,Te}}))}},Ro=class{constructor(e,t,i="",s="",n="https://prod-init.100ms.live/init",r=!1,a){this.authToken=e,this.peerId=t,this.peerName=i,this.data=s,this.endpoint=n,this.autoSubscribeVideo=r,this.iceServers=a}},_o=(e=>(e[e.ConnectFailed=0]="ConnectFailed",e[e.SignalDisconnect=1]="SignalDisconnect",e[e.JoinWSMessageFailed=2]="JoinWSMessageFailed",e[e.PublishIceConnectionFailed=3]="PublishIceConnectionFailed",e[e.SubscribeIceConnectionFailed=4]="SubscribeIceConnectionFailed",e))(_o||{}),Lo={0:[],1:[],2:[1],3:[1],4:[1]},Do=(e=>(e.Disconnected="Disconnected",e.Connecting="Connecting",e.Joined="Joined",e.Preview="Preview",e.Failed="Failed",e.Reconnecting="Reconnecting",e.Leaving="Leaving",e))(Do||{}),Mo=class{constructor(e){this.promise=new Promise(((t,i)=>{this.resolve=t,this.reject=i,e(t,i)}))}},No=class{constructor(e,t){this.onStateChange=e,this.sendEvent=t,this.TAG="[RetryScheduler]",this.inProgress=new Map,this.retryTaskIds=[]}schedule(e){return Lt(this,arguments,(function*({category:e,error:t,task:i,originalState:s,maxRetryTime:n=6e4,changeState:r=!0}){yield this.scheduleTask({category:e,error:t,changeState:r,task:i,originalState:s,maxRetryTime:n,failedAt:Date.now()})}))}reset(){this.retryTaskIds.forEach((e=>clearTimeout(e))),this.retryTaskIds=[],this.inProgress.clear()}isTaskInProgress(e){return!!this.inProgress.get(e)}scheduleTask(e){return Lt(this,arguments,(function*({category:e,error:t,changeState:i,task:s,originalState:n,failedAt:r,maxRetryTime:a=6e4,failedRetryCount:o=0}){if(Yt.d(this.TAG,"schedule: ",{category:_o[e],error:t}),0===o){let i=this.inProgress.get(e);if(i)return Yt.d(this.TAG,`schedule: Already a task for ${_o[e]} scheduled, waiting for its completion`),void(yield i.promise);let s=new Mo(((e,t)=>{}));this.inProgress.set(e,s),this.sendEvent(t,e)}let l=!1,d=Lo[e];for(let p in d){let t=d[parseInt(p)];try{let i=this.inProgress.get(t);i&&(Yt.d(this.TAG,`schedule: Suspending retry task of ${_o[e]}, waiting for ${_o[t]} to recover`),yield i.promise,Yt.d(this.TAG,`schedule: Resuming retry task ${_o[e]} as it's dependency ${_o[t]} is recovered`))}catch(st){Yt.d(this.TAG,`schedule: Stopping retry task of ${_o[e]} as it's dependency ${_o[t]} failed to recover`),l=!0;break}}let c=Date.now()-r;if(c>=a||l){if(t.description+=`. [${_o[e]}] Could not recover after ${c} milliseconds`,l&&(t.description+=` Could not recover all of it's required dependencies - [${d.map((e=>_o[e])).toString()}]`),t.isTerminal=!0,this.inProgress.delete(e),this.sendEvent(t,e),this.reset(),!i)throw t;return void this.onStateChange("Failed",t)}i&&this.onStateChange("Reconnecting",t);let u,h=this.getDelayForRetryCount(e);Yt.d(this.TAG,`schedule: [${_o[e]}] [failedRetryCount=${o}] Scheduling retry task in ${h}ms`);try{u=yield this.setTimeoutPromise(s,h)}catch($e){u=!1,Yt.w(this.TAG,`[${_o[e]}] Un-caught exception ${$e.name} in retry-task, initiating retry`,$e)}if(u){let t=this.inProgress.get(e);this.inProgress.delete(e),null==t||t.resolve(o),i&&0===this.inProgress.size&&this.onStateChange(n),Yt.d(this.TAG,`schedule: [${_o[e]}] [failedRetryCount=${o}] Recovered \u267b\ufe0f after ${c}ms`)}else yield this.scheduleTask({category:e,error:t,changeState:i,task:s,originalState:n,maxRetryTime:a,failedAt:r,failedRetryCount:o+1})}))}getDelayForRetryCount(e){let t=2===e?2*Math.random():Math.random(),i=0;return 2===e?i=2+t:1===e&&(i=1),1e3*i}setTimeoutPromise(e,t){return Lt(this,null,(function*(){return new Promise(((i,s)=>{let n=window.setTimeout((()=>Lt(this,null,(function*(){try{let t=yield e();t&&this.retryTaskIds.splice(this.retryTaskIds.indexOf(n),1),i(t)}catch(be){s(be)}}))),t);this.retryTaskIds.push(n)}))}))}},Oo=class extends Ki{constructor(){super(100),this.localStorage=new yi("hms-analytics"),this.localStorage.clear(),this.initLocalStorageQueue()}enqueue(e){super.enqueue(e),this.localStorage.set(this.storage)}dequeue(){let e=super.dequeue();return this.localStorage.set(this.storage),e}initLocalStorageQueue(){var e;null==(e=this.localStorage.get())||e.forEach((e=>{let t=new Ai(e);super.enqueue(t)}))}},xo=class{constructor(){this.TAG="[AnalyticsTransport]",this.eventCount=0,this.lastResetTime=Date.now(),this.MAX_EVENTS_PER_MINUTE=200,this.RESET_INTERVAL_MS=6e4}checkRateLimit(){let e=Date.now();if(e-this.lastResetTime>=this.RESET_INTERVAL_MS&&(this.eventCount=0,this.lastResetTime=e),this.eventCount>=this.MAX_EVENTS_PER_MINUTE)throw new Error("Too many events being sent, please check the implementation.");this.eventCount++}sendEvent(e){try{this.checkRateLimit()}catch(ke){throw Yt.w(this.TAG,"Rate limit exceeded",ke),ke}try{this.sendSingleEvent(e),this.flushFailedEvents()}catch(ke){Yt.w(this.TAG,"sendEvent failed",ke)}}flushFailedEvents(e){var t;try{for(Yt.d(this.TAG,"Flushing failed events",this.failedEvents);this.failedEvents.size()>0;){let i=this.failedEvents.dequeue();i&&((null==(t=i.metadata)?void 0:t.peer.peer_id)!==e&&i.metadata.peer.peer_id?za.sendEvent(i):this.sendSingleEvent(i))}}catch(Te){Yt.w(this.TAG,"flushFailedEvents failed",Te)}}sendSingleEvent(e){try{this.transportProvider.sendEvent(e),Yt.d(this.TAG,"Sent event",e.name,e)}catch(ke){throw Yt.w(this.TAG,`${this.transportProvider.TAG}.sendEvent failed, adding to local storage events`,{event:e,error:ke}),this.failedEvents.enqueue(e),ke}}},Uo=class extends xo{constructor(e){super(),this.transportProvider=e,this.failedEvents=new Oo}},Bo=class{constructor(e,t,i,s){this.store=e,this.eventBus=t,this.sampleWindowSize=i,this.pushInterval=s,this.shouldSendEvent=!1,this.sequenceNum=1,this.stop=()=>{this.shouldSendEvent&&this.sendEvent(),this.eventBus.statsUpdate.unsubscribe(this.handleStatsUpdate.bind(this)),this.shouldSendEvent=!1},this.start()}start(){this.shouldSendEvent||(this.stop(),this.shouldSendEvent=!0,this.eventBus.statsUpdate.subscribe(this.handleStatsUpdate.bind(this)),this.startLoop().catch((e=>Yt.e("[StatsAnalytics]",e.message))))}startLoop(){return Lt(this,null,(function*(){for(;this.shouldSendEvent;)yield zi(1e3*this.pushInterval),this.sendEvent()}))}sendEvent(){this.trackAnalytics.forEach((e=>{e.clearSamples()}))}cleanTrackAnalyticsAndCreateSample(e){this.trackAnalytics.forEach((e=>{!this.store.hasTrack(e.track)&&!(e.samples.length>0)&&this.trackAnalytics.delete(e.track_id)})),e&&this.trackAnalytics.forEach((e=>{e.createSample()}))}},Fo=class{constructor({track:e,ssrc:t,rid:i,kind:s,sampleWindowSize:n}){this.samples=[],this.tempStats=[],this.track=e,this.ssrc=t,this.rid=i,this.kind=s,this.track_id=this.track.trackId,this.source=this.track.source,this.sampleWindowSize=n}pushTempStat(e){this.tempStats.push(e)}createSample(){0!==this.tempStats.length&&(this.samples.push(this.collateSample()),this.prevLatestStat=this.getLatestStat(),this.tempStats.length=0)}clearSamples(){this.samples.length=0}getLatestStat(){return this.tempStats[this.tempStats.length-1]}getFirstStat(){return this.tempStats[0]}calculateSum(e){if("number"==typeof this.getLatestStat()[e])return this.tempStats.reduce(((t,i)=>t+(i[e]||0)),0)}calculateAverage(e,t=!0){let i=this.calculateSum(e),s=void 0!==i?i/this.tempStats.length:void 0;return s?t?Math.round(s):s:void 0}calculateDifferenceForSample(e){var t;let i=Number(null==(t=this.prevLatestStat)?void 0:t[e])||0;return(Number(this.getLatestStat()[e])||0)-i}calculateDifferenceAverage(e,t=!0){let i=this.calculateDifferenceForSample(e)/this.tempStats.length;return t?Math.round(i):i}calculateInstancesOfHigh(e,t){if("number"==typeof this.getLatestStat()[e])return this.tempStats.reduce(((i,s)=>i+((s[e]||0)>t?1:0)),0)}},Go=(e,t)=>e&&t&&(e.frameWidth!==t.frameWidth||e.frameHeight!==t.frameHeight),$o=(e,t)=>e&&t&&e.enabled!==t.enabled,jo=e=>Object.entries(e).filter((([,e])=>void 0!==e)).reduce(((e,[t,i])=>(e[t]=i,e)),{}),Vo=class extends Bo{constructor(){super(...arguments),this.trackAnalytics=new Map}toAnalytics(){var e,t;let i=[],s=[];return this.trackAnalytics.forEach((e=>{"audio"===e.track.type?i.push(e.toAnalytics()):"video"===e.track.type&&s.push(e.toAnalytics())})),{audio:i,video:s,joined_at:null==(t=null==(e=this.store.getRoom())?void 0:e.joinedAt)?void 0:t.getTime(),sequence_num:this.sequenceNum++,max_window_sec:30}}sendEvent(){this.eventBus.analytics.publish(Ri.publishStats(this.toAnalytics())),super.sendEvent()}handleStatsUpdate(e){let t=!1,i=e.getLocalTrackStats();Object.keys(i).forEach((s=>{let n=i[s],r=this.store.getLocalPeerTracks().find((e=>e.getTrackIDBeingSent()===s));Object.keys(n).forEach((i=>{var s,a,o;let l=n[i];if(!r)return;let d=this.getTrackIdentifier(r.trackId,l),c=At(It({},l),{availableOutgoingBitrate:null==(a=null==(s=e.getLocalPeerStats())?void 0:s.publish)?void 0:a.availableOutgoingBitrate});if(d&&this.trackAnalytics.has(d))null==(o=this.trackAnalytics.get(d))||o.pushTempStat(c);else if(r){let e=new Wo({track:r,sampleWindowSize:this.sampleWindowSize,rid:l.rid,ssrc:l.ssrc.toString(),kind:l.kind});e.pushTempStat(c),this.trackAnalytics.set(this.getTrackIdentifier(r.trackId,l),e)}let u=this.trackAnalytics.get(d);null!=u&&u.shouldCreateSample()&&(t=!0)}))})),this.cleanTrackAnalyticsAndCreateSample(t)}getTrackIdentifier(e,t){return t.rid?`${e}:${t.rid}`:e}},Wo=class extends Fo{constructor(){super(...arguments),this.samples=[],this.collateSample=()=>{let e=this.getLatestStat(),t=e.qualityLimitationDurations,i=t&&{bandwidth_sec:t.bandwidth,cpu_sec:t.cpu,other_sec:t.other},s=e.frameHeight?{height_px:this.getLatestStat().frameHeight,width_px:this.getLatestStat().frameWidth}:void 0,n=this.calculateAverage("jitter",!1),r=n?Math.round(1e3*n):void 0,a=this.calculateAverage("roundTripTime",!1),o=a?Math.round(1e3*a):void 0;return jo({timestamp:Date.now(),avg_available_outgoing_bitrate_bps:this.calculateAverage("availableOutgoingBitrate"),avg_bitrate_bps:this.calculateAverage("bitrate"),avg_fps:this.calculateAverage("framesPerSecond"),total_packets_lost:this.getLatestStat().packetsLost,total_packets_sent:this.getLatestStat().packetsSent,total_packet_sent_delay_sec:parseFloat(this.calculateDifferenceForSample("totalPacketSendDelay").toFixed(4)),total_fir_count:this.calculateDifferenceForSample("firCount"),total_pli_count:this.calculateDifferenceForSample("pliCount"),total_nack_count:this.calculateDifferenceForSample("nackCount"),avg_jitter_ms:r,avg_round_trip_time_ms:o,total_quality_limitation:i,resolution:s})},this.shouldCreateSample=()=>{let e=this.tempStats.length,t=this.tempStats[e-1],i=this.tempStats[e-2];return 30===e||$o(t,i)||"video"===t.kind&&Go(t,i)},this.toAnalytics=()=>({track_id:this.track_id,ssrc:this.ssrc,source:this.source,rid:this.rid,samples:this.samples})}},Ho=class extends Bo{constructor(){super(...arguments),this.trackAnalytics=new Map}toAnalytics(){var e,t;let i=[],s=[];return this.trackAnalytics.forEach((e=>{"audio"===e.track.type?i.push(e.toAnalytics()):"video"===e.track.type&&s.push(e.toAnalytics())})),{audio:i,video:s,joined_at:null==(t=null==(e=this.store.getRoom())?void 0:e.joinedAt)?void 0:t.getTime(),sequence_num:this.sequenceNum++,max_window_sec:10}}sendEvent(){this.eventBus.analytics.publish(Ri.subscribeStats(this.toAnalytics())),super.sendEvent()}handleStatsUpdate(e){let t=e.getAllRemoteTracksStats(),i=!1;Object.keys(t).forEach((s=>{var n,r;let a=this.store.getTrackById(s),o=t[s],l=((e,t)=>{let i=(null==t?void 0:t.jitterBufferDelay)||0,s=(null==t?void 0:t.jitterBufferEmittedCount)||0,n=((null==e?void 0:e.jitterBufferDelay)||0)-i,r=((null==e?void 0:e.jitterBufferEmittedCount)||0)-s;return r>0?1e3*n/r:(null==t?void 0:t.calculatedJitterBufferDelay)||0})(o,null==(n=this.trackAnalytics.get(s))?void 0:n.getLatestStat()),d=this.calculateAvSyncForStat(o,e),c=At(It({},o),{calculatedJitterBufferDelay:l,avSync:d});if("video"===o.kind){let e=a.getPreferredLayerDefinition();c.expectedFrameHeight=null==e?void 0:e.resolution.height,c.expectedFrameWidth=null==e?void 0:e.resolution.width}if(this.trackAnalytics.has(s))null==(r=this.trackAnalytics.get(s))||r.pushTempStat(c);else if(a){let e=new qo({track:a,sampleWindowSize:this.sampleWindowSize,ssrc:o.ssrc.toString(),kind:o.kind});e.pushTempStat(c),this.trackAnalytics.set(s,e)}let u=this.trackAnalytics.get(s);null!=u&&u.shouldCreateSample()&&(i=!0)})),this.cleanTrackAnalyticsAndCreateSample(i)}calculateAvSyncForStat(e,t){if(!e.peerID||!e.estimatedPlayoutTimestamp||"video"!==e.kind)return;let i=this.store.getPeerById(e.peerID),s=null==i?void 0:i.audioTrack,n=null==i?void 0:i.videoTrack;if(!(s&&n&&s.enabled&&n.enabled))return js;let r=t.getRemoteTrackStats(s.trackId);return r?r.estimatedPlayoutTimestamp?r.estimatedPlayoutTimestamp-e.estimatedPlayoutTimestamp:void 0:js}},qo=class extends Fo{constructor(){super(...arguments),this.samples=[],this.collateSample=()=>{let e=this.getLatestStat(),t=this.getFirstStat(),i={timestamp:Date.now(),total_pli_count:this.calculateDifferenceForSample("pliCount"),total_nack_count:this.calculateDifferenceForSample("nackCount"),avg_jitter_buffer_delay:this.calculateAverage("calculatedJitterBufferDelay",!1)};if("video"===e.kind)return jo(At(It({},i),{avg_av_sync_ms:this.calculateAvgAvSyncForSample(),avg_frames_received_per_sec:this.calculateDifferenceAverage("framesReceived"),avg_frames_dropped_per_sec:this.calculateDifferenceAverage("framesDropped"),avg_frames_decoded_per_sec:this.calculateDifferenceAverage("framesDecoded"),frame_width:this.calculateAverage("frameWidth"),frame_height:this.calculateAverage("frameHeight"),expected_frame_width:this.calculateAverage("expectedFrameWidth"),expected_frame_height:this.calculateAverage("expectedFrameHeight"),pause_count:this.calculateDifferenceForSample("pauseCount"),pause_duration_seconds:this.calculateDifferenceForSample("totalPausesDuration"),freeze_count:this.calculateDifferenceForSample("freezeCount"),freeze_duration_seconds:this.calculateDifferenceForSample("totalFreezesDuration")}));{let s=(e.concealedSamples||0)-(e.silentConcealedSamples||0)-((t.concealedSamples||0)-(t.silentConcealedSamples||0));return jo(At(It({},i),{audio_level:this.calculateInstancesOfHigh("audioLevel",.05),audio_concealed_samples:s,audio_total_samples_received:this.calculateDifferenceForSample("totalSamplesReceived"),audio_concealment_events:this.calculateDifferenceForSample("concealmentEvents"),fec_packets_discarded:this.calculateDifferenceForSample("fecPacketsDiscarded"),fec_packets_received:this.calculateDifferenceForSample("fecPacketsReceived"),total_samples_duration:this.calculateDifferenceForSample("totalSamplesDuration"),total_packets_received:this.calculateDifferenceForSample("packetsReceived"),total_packets_lost:this.calculateDifferenceForSample("packetsLost")}))}},this.shouldCreateSample=()=>{let e=this.tempStats.length,t=this.tempStats[e-1],i=this.tempStats[e-2];return 10===e||$o(t,i)||"video"===t.kind&&Go(t,i)},this.toAnalytics=()=>({track_id:this.track_id,ssrc:this.ssrc,source:this.source,rid:this.rid,samples:this.samples})}calculateAvgAvSyncForSample(){let e=this.tempStats.map((e=>e.avSync)).filter((e=>void 0!==e&&e!==js));return 0===e.length?js:e.reduce(((e,t)=>e+t),0)/e.length}},Ko=(e=>(e[e.Publish=0]="Publish",e[e.Subscribe=1]="Subscribe",e))(Ko||{});var Jo="[HMSConnection]",zo=class{constructor(e,t){this.candidates=new Array,this.role=e,this.signal=t}get iceConnectionState(){return this.nativeConnection.iceConnectionState}get connectionState(){return this.nativeConnection.connectionState}get action(){return 0===this.role?"PUBLISH":"SUBSCRIBE"}setSfuNodeId(e){this.sfuNodeId=e}addTransceiver(e,t){return this.nativeConnection.addTransceiver(e,t)}createOffer(e,t){return Lt(this,null,(function*(){try{let i=yield this.nativeConnection.createOffer(t);return Yt.d(Jo,`[role=${this.role}] createOffer offer=${JSON.stringify(i,null,1)}`),function(e){return e.sdp.includes("usedtx=1")?e:{type:e.type,sdp:e.sdp.replace("useinbandfec=1","useinbandfec=1;usedtx=1")}}(function(e,t){var i;let s=ft.Qc(e.sdp);if(null==(i=s.origin)||!i.username.startsWith("mozilla"))return e;let n=t?Array.from(t.values()):[];return s.media.forEach((e=>{var t,i,s;let r=null==(t=e.msid)?void 0:t.split(" ")[0],a=null==(i=n.find((t=>t.type===e.type&&t.stream_id===r)))?void 0:i.track_id;a&&(e.msid=null==(s=e.msid)?void 0:s.replace(/\s(.+)/,` ${a}`))})),{type:e.type,sdp:ft.cW(s)}}(i,e))}catch(Te){throw mi.WebrtcErrors.CreateOfferFailed(this.action,Te.message)}}))}createAnswer(e=void 0){return Lt(this,null,(function*(){try{let t=yield this.nativeConnection.createAnswer(e);return Yt.d(Jo,`[role=${this.role}] createAnswer answer=${JSON.stringify(t,null,1)}`),t}catch(ke){throw mi.WebrtcErrors.CreateAnswerFailed(this.action,ke.message)}}))}setLocalDescription(e){return Lt(this,null,(function*(){try{Yt.d(Jo,`[role=${this.role}] setLocalDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setLocalDescription(e)}catch(ke){throw mi.WebrtcErrors.SetLocalDescriptionFailed(this.action,ke.message)}}))}setRemoteDescription(e){return Lt(this,null,(function*(){try{Yt.d(Jo,`[role=${this.role}] setRemoteDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setRemoteDescription(e)}catch(ke){throw mi.WebrtcErrors.SetRemoteDescriptionFailed(this.action,ke.message)}}))}addIceCandidate(e){return Lt(this,null,(function*(){"closed"!==this.nativeConnection.signalingState?(Yt.d(Jo,`[role=${this.role}] addIceCandidate candidate=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.addIceCandidate(e)):Yt.d(Jo,`[role=${this.role}] addIceCandidate signalling state closed`)}))}get remoteDescription(){return this.nativeConnection.remoteDescription}getSenders(){return this.nativeConnection.getSenders()}handleSelectedIceCandidatePairs(){try{(0===this.role?this.getSenders():this.getReceivers()).forEach((e=>{var t;let i=null==(t=e.track)?void 0:t.kind;if(e.transport){let t=e.transport.iceTransport,s=()=>{"function"==typeof t.getSelectedCandidatePair&&(this.selectedCandidatePair=t.getSelectedCandidatePair(),this.selectedCandidatePair&&(this.observer.onSelectedCandidatePairChange(this.selectedCandidatePair),Yt.d(Jo,`${Ko[this.role]} connection`,`selected ${i||"unknown"} candidate pair`,JSON.stringify(this.selectedCandidatePair,null,2))))};"function"==typeof t.onselectedcandidatepairchange&&(t.onselectedcandidatepairchange=s),s()}}))}catch(e){Yt.w(Jo,`Error in logging selected ice candidate pair for ${Ko[this.role]} connection`,e)}}removeTrack(e){"closed"!==this.nativeConnection.signalingState&&this.nativeConnection.removeTrack(e)}setMaxBitrateAndFramerate(e,t){return Lt(this,null,(function*(){let i=(null==t?void 0:t.maxBitrate)||e.settings.maxBitrate,s=e instanceof Bs&&e.settings.maxFramerate,n=this.getSenders().find((t=>{var i;return(null==(i=null==t?void 0:t.track)?void 0:i.id)===e.getTrackIDBeingSent()}));if(n){let e=n.getParameters();1===e.encodings.length&&(i&&(e.encodings[0].maxBitrate=1e3*i),s&&(e.encodings[0].maxFramerate=s)),yield n.setParameters(e)}else Yt.w(Jo,`no sender found to setMaxBitrate for track - ${e.trackId}, sentTrackId - ${e.getTrackIDBeingSent()}`)}))}getStats(){return Lt(this,null,(function*(){return yield this.nativeConnection.getStats()}))}close(){this.nativeConnection.close()}getReceivers(){return this.nativeConnection.getReceivers()}},Qo=class extends zo{constructor(e,t,i){super(0,e),this.TAG="[HMSPublishConnection]",this.observer=i,this.nativeConnection=new RTCPeerConnection(t),this.channel=this.nativeConnection.createDataChannel(Gs,{protocol:"SCTP"}),this.channel.onerror=e=>Yt.e(this.TAG,`publish data channel onerror ${e}`,e),this.nativeConnection.onicecandidate=({candidate:t})=>{t&&(this.observer.onIceCandidate(t),e.trickle(this.role,t))},this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState),this.nativeConnection.sctp&&(this.nativeConnection.sctp.transport.onstatechange=()=>{var e;this.observer.onDTLSTransportStateChange(null==(e=this.nativeConnection.sctp)?void 0:e.transport.state)},this.nativeConnection.sctp.transport.onerror=e=>{var t;this.observer.onDTLSTransportError(new Error(null==(t=null==e?void 0:e.error)?void 0:t.errorDetail)||"DTLS Transport failed")})}}close(){super.close(),this.channel.close()}initAfterJoin(){this.nativeConnection.onnegotiationneeded=()=>Lt(this,null,(function*(){Yt.d(this.TAG,"onnegotiationneeded"),yield this.observer.onRenegotiationNeeded()}))}},Yo=class{constructor(e,t,i=""){this.TAG="[HMSDataChannel]",this.nativeChannel=e,this.observer=t,this.metadata=i,e.onmessage=e=>{this.observer.onMessage(e.data)}}get id(){return this.nativeChannel.id}get label(){return this.nativeChannel.label}get readyState(){return this.nativeChannel.readyState}send(e){Yt.d(this.TAG,`[${this.metadata}] Sending [size=${e.length}] message=${e}`),this.nativeChannel.send(e)}close(){this.nativeChannel.close()}},Zo=class extends zo{constructor(e,t,i,s){super(1,e),this.isFlagEnabled=i,this.TAG="[HMSSubscribeConnection]",this.remoteStreams=new Map,this.MAX_RETRIES=3,this.pendingMessageQueue=[],this.eventEmitter=new(me())({maxListeners:60}),this.handlePendingApiMessages=()=>{this.eventEmitter.emit("open",!0),this.pendingMessageQueue.length>0&&(Yt.d(this.TAG,"Found pending message queue, sending messages"),this.pendingMessageQueue.forEach((e=>this.sendOverApiDataChannel(e))),this.pendingMessageQueue.length=0)},this.sendMessage=(e,t)=>Lt(this,null,(function*(){var i;let s;"open"!==(null==(i=this.apiChannel)?void 0:i.readyState)&&(yield this.eventEmitter.waitFor("open"));for(let n=0;n<this.MAX_RETRIES;n++){this.apiChannel.send(e),s=yield this.waitForResponse(t);let i=s.error;if(!i)break;{if(404===i.code){Yt.d(this.TAG,`Track not found ${t}`,{request:e,try:n+1,error:i});break}if(Yt.d(this.TAG,`Failed sending ${t}`,{request:e,try:n+1,error:i}),i.code/100!==5&&429!==i.code)throw Error(`code=${i.code}, message=${i.message}`);let s=1e3*(2+2*Math.random());yield Qi(s)}}return s})),this.waitForResponse=e=>Lt(this,null,(function*(){let t=yield this.eventEmitter.waitFor("message",(function(t){return t.includes(e)})),i=JSON.parse(t[0]);return Yt.d(this.TAG,`response for ${e} -`,JSON.stringify(i,null,2)),i})),this.observer=s,this.nativeConnection=new RTCPeerConnection(t),this.initNativeConnectionCallbacks()}initNativeConnectionCallbacks(){this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState)},this.nativeConnection.ondatachannel=e=>{e.channel.label===Gs&&(this.apiChannel=new Yo(e.channel,{onMessage:e=>{this.eventEmitter.emit("message",e),this.observer.onApiChannelMessage(e)}},`role=${this.role}`),e.channel.onopen=this.handlePendingApiMessages)},this.nativeConnection.onicecandidate=e=>{null!==e.candidate&&(this.observer.onIceCandidate(e.candidate),this.signal.trickle(this.role,e.candidate))},this.nativeConnection.ontrack=e=>{var t;let i=e.streams[0],s=i.id;if(!this.remoteStreams.has(s)){let e=new pn(i,this);this.remoteStreams.set(s,e)}i.addEventListener("removetrack",(t=>{if(t.track.id!==e.track.id)return;let i=n.tracks.findIndex((i=>{var s;return i.nativeTrack.id===t.track.id&&e.transceiver.mid===(null==(s=i.transceiver)?void 0:s.mid)}));if(i>=0){let e=n.tracks[i];this.observer.onTrackRemove(e),n.tracks.splice(i,1),0===n.tracks.length&&this.remoteStreams.delete(s)}}));let n=this.remoteStreams.get(s),r="audio"===e.track.kind,a=r?ys:cn,o=r?new a(n,e.track):new a(n,e.track,void 0,this.isFlagEnabled("disableNoneLayerRequest"));"video"===e.track.kind&&n.setVideoLayerLocally("none","addTrack","subscribeConnection"),o.transceiver=e.transceiver;let l=function(e,t){var i;if(null==e||!e.sdp||!t)return;let s=ft.Qc(e.sdp).media.find((e=>bi(e.mid)&&parseInt(e.mid)===parseInt(t)));return null==(i=null==s?void 0:s.msid)?void 0:i.split(" ")[1]}(this.remoteDescription,null==(t=e.transceiver)?void 0:t.mid);l&&o.setSdpTrackId(l),n.tracks.push(o),this.observer.onTrackAdd(o)}}sendOverApiDataChannel(e){this.apiChannel&&"open"===this.apiChannel.readyState?this.apiChannel.send(e):(Yt.w(this.TAG,`API Data channel not ${this.apiChannel?"open":"present"}, queueing`,e),this.pendingMessageQueue.push(e))}sendOverApiDataChannelWithResponse(e,t){return Lt(this,null,(function*(){let i=(0,d.Z)();if("prefer-video-track-state"===e.method&&this.isFlagEnabled("disableVideoTrackAutoUnsubscribe")&&"none"===e.params.max_spatial_layer)return Yt.d(this.TAG,"video auto unsubscribe is disabled, request is ignored"),{id:i};let s=JSON.stringify(It({id:t||i,jsonrpc:"2.0"},e));return this.sendMessage(s,i)}))}close(){var e;super.close(),null==(e=this.apiChannel)||e.close()}},Xo=(e,t)=>t&&0!==t.length?t.map((e=>({urls:e.urls,credentialType:"password",credential:e.password,username:e.userName}))):e,el="[InitService]",tl=class{static handleError(e,t){switch(e.status){case 404:throw mi.APIErrors.EndpointUnreachable("INIT",t.message||e.statusText);case 200:break;default:throw mi.APIErrors.ServerErrors(t.code||e.status,"INIT",t.message||(null==e?void 0:e.statusText))}}static fetchInitConfig(e){return Lt(this,arguments,(function*({token:e,peerId:t,userAgent:i,initEndpoint:s="https://prod-init.100ms.live",region:n="",iceServers:r}){Yt.d(el,`fetchInitConfig: initEndpoint=${s} token=${e} peerId=${t} region=${n} `);let a=function(e,t,i,n){try{let s=new URL("/init",e);return n&&n.trim().length>0&&s.searchParams.set("region",n.trim()),s.searchParams.set("peer_id",t),s.searchParams.set("user_agent_v2",i),s.toString()}catch(s){let t=s;throw Yt.e(el,t.name,t.message),t}}(s,t,i,n);try{let t=yield fetch(a,{headers:{Authorization:`Bearer ${e}`}});try{let e=yield t.clone().json();return this.handleError(t,e),Yt.d(el,`config is ${JSON.stringify(e,null,2)}`),function(e,t){var i;return At(It({},e),{rtcConfiguration:At(It({},e.rtcConfiguration),{iceServers:Xo(null==(i=e.rtcConfiguration)?void 0:i.ice_servers,t)})})}(e,r)}catch(Ae){let i=yield t.text();throw Yt.e(el,"json error",Ae.message,i),Ae instanceof pi?Ae:mi.APIErrors.ServerErrors(t.status,"INIT",Ae.message)}}catch(Se){let t=Se;throw["Failed to fetch","NetworkError","ECONNRESET"].some((e=>t.message.includes(e)))?mi.APIErrors.EndpointUnreachable("INIT",t.message):t}}))}};var il=class{constructor(e){this.TAG="[SIGNAL]: ",this.pongResponseTimes=new Ki(5),this.isJoinCompleted=!1,this.pendingTrickle=[],this.socket=null,this.callbacks=new Map,this._isConnected=!1,this.id=0,this.onCloseHandler=()=>{},this.resolvePingOnAnyResponse=()=>{this.callbacks.forEach(((e,t)=>{var i;"ping"===(null==(i=e.metadata)?void 0:i.method)&&(e.resolve({timestamp:Date.now()}),this.callbacks.delete(t))}))},this.offlineListener=()=>{Yt.d(this.TAG,"Window network offline"),this.setIsConnected(!1,"Window network offline")},this.onlineListener=()=>{Yt.d(this.TAG,"Window network online"),this.observer.onNetworkOnline()},this.observer=e,window.addEventListener("offline",this.offlineListener),window.addEventListener("online",this.onlineListener),this.onMessageHandler=this.onMessageHandler.bind(this)}get isConnected(){return this._isConnected}setSfuNodeId(e){this.sfuNodeId=e}setIsConnected(e,t=""){Yt.d(this.TAG,`isConnected set id: ${this.id}, oldValue: ${this._isConnected}, newValue: ${e}`),this._isConnected!==e&&(this._isConnected&&!e?(this._isConnected=e,this.rejectPendingCalls(t),this.observer.onOffline(t)):!this._isConnected&&e&&(this._isConnected=e,this.observer.onOnline()))}getPongResponseTimes(){return this.pongResponseTimes.toList()}internalCall(e,t){return Lt(this,null,(function*(){var i;let s=(0,d.Z)(),n={method:e,params:t,id:s,jsonrpc:"2.0"};null==(i=this.socket)||i.send(JSON.stringify(n));try{return yield new Promise(((t,i)=>{this.callbacks.set(s,{resolve:t,reject:i,metadata:{method:e}})}))}catch(be){if(be instanceof pi)throw be;let i=be;throw mi.WebsocketMethodErrors.ServerErrors(Number(i.code),vi(e),i.message)}}))}notify(e,t){var i,s;let n={method:e,params:t};(null==(i=this.socket)?void 0:i.readyState)===WebSocket.OPEN&&(null==(s=this.socket)||s.send(JSON.stringify(n)))}open(e){return new Promise(((t,i)=>{let s=!1;this.socket&&(this.socket.close(),this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler)),this.socket=new WebSocket(e);let n=()=>{Yt.e(this.TAG,"Error from websocket"),s=!0,i(mi.WebSocketConnectionErrors.FailedToConnect("JOIN","Error opening websocket connection"))};this.onCloseHandler=e=>{Yt.w(`Websocket closed code=${e.code}`),s?this.setIsConnected(!1,`code: ${e.code}${1e3!==e.code?", unexpected websocket close":""}`):(s=!0,i(mi.WebSocketConnectionErrors.AbnormalClose("JOIN",`Error opening websocket connection - websocket closed unexpectedly with code=${e.code}`)))},this.socket.addEventListener("error",n);let r=()=>{var e,i;s=!0,t(),this.setIsConnected(!0),this.id++,null==(e=this.socket)||e.removeEventListener("open",r),null==(i=this.socket)||i.removeEventListener("error",n),this.pingPongLoop(this.id)};this.socket.addEventListener("open",r),this.socket.addEventListener("close",this.onCloseHandler),this.socket.addEventListener("message",this.onMessageHandler)}))}close(){return Lt(this,null,(function*(){window.removeEventListener("offline",this.offlineListener),window.removeEventListener("online",this.onlineListener),this.socket?(this.socket.close(1e3,"Normal Close"),this.setIsConnected(!1,"code: 1000, normal websocket close"),this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler)):this.setIsConnected(!1,"websocket not connected yet")}))}join(e,t,i,s,n,r,a){return Lt(this,null,(function*(){if(!this.isConnected)throw mi.WebSocketConnectionErrors.WebSocketConnectionLost("JOIN","Failed to send join over WS connection");let o={name:e,disableVidAutoSub:i,data:t,offer:a,server_sub_degrade:s,simulcast:n,onDemandTracks:r},l=yield this.internalCall("join",o);return this.isJoinCompleted=!0,this.pendingTrickle.forEach((({target:e,candidate:t})=>this.trickle(e,t))),this.pendingTrickle.length=0,Yt.d(this.TAG,`join: response=${JSON.stringify(l,null,1)}`),l}))}trickle(e,t){this.isJoinCompleted?this.notify("trickle",{target:e,candidate:t,sfu_node_id:this.sfuNodeId}):this.pendingTrickle.push({target:e,candidate:t})}offer(e,t){return Lt(this,null,(function*(){return yield this.call("offer",{desc:e,tracks:Object.fromEntries(t),sfu_node_id:this.sfuNodeId})}))}answer(e){this.notify("answer",{desc:e,sfu_node_id:this.sfuNodeId})}trackUpdate(e){this.notify("track-update",{tracks:Object.fromEntries(e)})}broadcast(e){return Lt(this,null,(function*(){return yield this.call("broadcast",e)}))}leave(){this.notify("leave",{})}endRoom(e,t){return Lt(this,null,(function*(){yield this.call("end-room",{lock:e,reason:t})}))}sendEvent(e){if(!this.isConnected)throw Error(`${this.TAG} not connected. Could not send event ${e}`);this.notify("analytics",e.toSignalParams())}ping(e){let t=Date.now(),i=new Promise((i=>{setTimeout((()=>{i(Date.now()-t)}),e+1)})),s=this.internalCall("ping",{timestamp:t}).then((()=>Date.now()-t)).catch((()=>Date.now()-t));return Promise.race([i,s])}requestRoleChange(e){return Lt(this,null,(function*(){yield this.call("role-change-request",e)}))}requestBulkRoleChange(e){return Lt(this,null,(function*(){yield this.call("role-change-request",e)}))}acceptRoleChangeRequest(e){return Lt(this,null,(function*(){yield this.call("role-change",e)}))}requestTrackStateChange(e){return Lt(this,null,(function*(){yield this.call("track-update-request",e)}))}requestMultiTrackStateChange(e){return Lt(this,null,(function*(){yield this.call("change-track-mute-state-request",e)}))}removePeer(e){return Lt(this,null,(function*(){yield this.call("peer-leave-request",e)}))}startRTMPOrRecording(e){return Lt(this,null,(function*(){yield this.call("rtmp-start",It({},e))}))}stopRTMPAndRecording(){return Lt(this,null,(function*(){yield this.call("rtmp-stop",{})}))}startHLSStreaming(e){return Lt(this,null,(function*(){yield this.call("hls-start",It({},e))}))}stopHLSStreaming(e){return Lt(this,null,(function*(){yield this.call("hls-stop",It({},e))}))}startTranscription(e){return Lt(this,null,(function*(){yield this.call("transcription-start",It({},e))}))}stopTranscription(e){return Lt(this,null,(function*(){yield this.call("transcription-stop",It({},e))}))}sendHLSTimedMetadata(e){return Lt(this,null,(function*(){yield this.call("hls-timed-metadata",It({},e))}))}updatePeer(e){return Lt(this,null,(function*(){yield this.call("peer-update",It({},e))}))}getPeer(e){return Lt(this,null,(function*(){return yield this.call("get-peer",It({},e))}))}joinGroup(e){return Lt(this,null,(function*(){return yield this.call("group-join",{name:e})}))}leaveGroup(e){return Lt(this,null,(function*(){return yield this.call("group-leave",{name:e})}))}addToGroup(e,t){return Lt(this,null,(function*(){yield this.call("group-add",{name:t,peer_id:e})}))}removeFromGroup(e,t){return Lt(this,null,(function*(){yield this.call("group-remove",{name:t,peer_id:e})}))}peerIterNext(e){return Lt(this,null,(function*(){return yield this.call("peer-iter-next",e)}))}findPeers(e){return Lt(this,null,(function*(){return yield this.call("find-peer",e)}))}findPeerByName(e){return Lt(this,null,(function*(){return yield this.call("peer-name-search",e)}))}setSessionMetadata(e){if(!this.isConnected)throw mi.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL","Failed to set session store value due to network disconnection");return this.call("set-metadata",It({},e))}listenMetadataChange(e){if(!this.isConnected)throw mi.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL","Failed to observe session store key due to network disconnection");return this.call("listen-metadata-change",{keys:e})}getSessionMetadata(e){if(!this.isConnected)throw mi.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL","Failed to set session store value due to network disconnection");return this.call("get-metadata",{key:e})}setPollInfo(e){return this.call("poll-info-set",It({},e))}getPollInfo(e){return this.call("poll-info-get",It({},e))}setPollQuestions(e){return this.call("poll-questions-set",It({},e))}startPoll(e){return this.call("poll-start",It({},e))}stopPoll(e){return this.call("poll-stop",It({},e))}getPollQuestions(e){return this.call("poll-questions-get",It({},e))}setPollResponses(e){return this.call("poll-response",It({},e))}getPollResponses(e){return this.call("poll-responses",It({},e))}getPollsList(e){return this.call("poll-list",It({},e))}getPollResult(e){return this.call("poll-result",It({},e))}createWhiteboard(e){return this.validateConnection(),this.call("whiteboard-create",It({},e))}getWhiteboard(e){return this.validateConnection(),this.call("whiteboard-get",It({},e))}fetchPollLeaderboard(e){return this.call("poll-leaderboard",It({},e))}validateConnection(){if(!this.isConnected)throw mi.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL","Failed to send message due to network disconnection")}onMessageHandler(e){let t=e.data,i=JSON.parse(t);if(this.resolvePingOnAnyResponse(),i.id)this.handleResponseWithId(i);else{if(!i.method)throw Error(`WebSocket message has no 'method' or 'id' field, message=${i}`);this.handleResponseWithMethod(i)}}handleResponseWithId(e){let t=e,i=t.id;if(this.callbacks.has(i)){let e=this.callbacks.get(i);this.callbacks.delete(i),t.result?e.resolve(t.result):e.reject(t.error)}else this.observer.onNotification(t)}handleResponseWithMethod(e){switch(e.method){case"offer":this.observer.onOffer(e.params);break;case"trickle":this.observer.onTrickle(e.params);break;case"on-error":this.observer.onServerError(mi.WebsocketMethodErrors.ServerErrors(Number(e.params.code),"on-error",e.params.message));break;case"on-warning":Yt.w(this.TAG,e.params);break;default:this.observer.onNotification(e)}}rejectPendingCalls(e=""){this.callbacks.forEach(((t,i)=>{var s,n,r,a;"ping"!==(null==(s=t.metadata)?void 0:s.method)&&(Yt.e(this.TAG,`rejecting pending callback ${null==(n=t.metadata)?void 0:n.method}, id=${i}`),t.reject(mi.WebSocketConnectionErrors.WebSocketConnectionLost(null!=(r=t.metadata)&&r.method?vi(null==(a=t.metadata)?void 0:a.method):"RECONNECT_SIGNAL",e)),this.callbacks.delete(i))}))}pingPongLoop(e){return Lt(this,null,(function*(){var t,i;let s=(null==(t=window.HMS)?void 0:t.PING_TIMEOUT)||12e3;if(this.isConnected){let t=yield this.ping(s);this.pongResponseTimes.enqueue(t),t>s?(Yt.d(this.TAG,`Pong timeout ${e}, pageHidden=${"undefined"!=typeof document&&document.hidden}`),this.id===e&&this.setIsConnected(!1,"ping pong failure")):setTimeout((()=>this.pingPongLoop(e)),(null==(i=window.HMS)?void 0:i.PING_INTERVAL)||3e3)}}))}call(e,t){return Lt(this,null,(function*(){let i,s=mi.WebsocketMethodErrors.ServerErrors(500,e,`Default ${e} error`);for(i=1;i<=3;i++)try{return this.validateConnection(),Yt.d(this.TAG,`Try number ${i} sending ${e}`,t),yield this.internalCall(e,t)}catch(be){if(s=be,Yt.e(this.TAG,`Failed sending ${e} try: ${i}`,{method:e,params:t,error:s}),5!==parseInt(""+s.code/100)&&429!==s.code&&1003!==s.code)break;let r=1e3*(2+2*Math.random());yield Qi(r)}throw Yt.e(`Sending ${e} over WS failed after ${Math.min(i,3)} retries`,{method:e,params:t,error:s}),s}))}},sl="[HMSTransport]:",nl=class{constructor(e,t,i,s,n,r,a){this.observer=e,this.deviceManager=t,this.store=i,this.eventBus=s,this.analyticsEventsService=n,this.analyticsTimer=r,this.pluginUsageTracker=a,this.state="Disconnected",this.trackStates=new Map,this.publishConnection=null,this.subscribeConnection=null,this.maxSubscribeBitrate=0,this.joinRetryCount=0,this.publishDisconnectTimer=0,this.onScreenshareStop=()=>{},this.screenStream=new Set,this.callbacks=new Map,this.setListener=e=>{this.listener=e},this.setOnScreenshareStop=e=>{this.onScreenshareStop=e},this.signalObserver={onOffer:e=>Lt(this,null,(function*(){try{if(!this.subscribeConnection)return;if(e.sfu_node_id&&this.subscribeConnection.sfuNodeId&&this.subscribeConnection.sfuNodeId!==e.sfu_node_id)return void Yt.d(sl,"ignoring old offer");yield this.subscribeConnection.setRemoteDescription(e),Yt.d(sl,`[SUBSCRIBE] Adding ${this.subscribeConnection.candidates.length} ice-candidates`,this.subscribeConnection.candidates);for(let e of this.subscribeConnection.candidates)yield this.subscribeConnection.addIceCandidate(e);this.subscribeConnection.candidates.length=0;let t=yield this.subscribeConnection.createAnswer();yield this.subscribeConnection.setLocalDescription(t),this.signal.answer(t),Yt.d(sl,"[role=SUBSCRIBE] onOffer renegotiation DONE \u2705")}catch(t){let i;Yt.d(sl,"[role=SUBSCRIBE] onOffer renegotiation FAILED \u274c",t),this.state="Failed",i=t instanceof pi?t:mi.GenericErrors.Unknown("SUBSCRIBE",t.message),this.observer.onFailure(i),this.eventBus.analytics.publish(Ri.subscribeFail(i))}})),onTrickle:e=>Lt(this,null,(function*(){let t=0===e.target?this.publishConnection:this.subscribeConnection;null!=t&&t.remoteDescription?yield t.addIceCandidate(e.candidate):null==t||t.candidates.push(e.candidate)})),onNotification:e=>this.observer.onNotification(e),onServerError:e=>Lt(this,null,(function*(){yield this.observer.onStateChange("Failed",e)})),onFailure:e=>{this.joinParameters&&this.retryScheduler.schedule({category:1,error:e,task:this.retrySignalDisconnectTask,originalState:this.state})},onOffline:e=>Lt(this,null,(function*(){Yt.d(sl,"socket offline",Do[this.state]);try{"Leaving"!==this.state&&this.joinParameters&&this.retryScheduler.schedule({category:1,error:mi.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL",e),task:this.retrySignalDisconnectTask,originalState:this.state})}catch(t){console.error(t)}})),onOnline:()=>{var e;Yt.d(sl,"socket online",Do[this.state]),this.analyticsSignalTransport.flushFailedEvents(null==(e=this.store.getLocalPeer())?void 0:e.peerId)},onNetworkOnline:()=>{this.analyticsEventsService.flushFailedClientEvents()}},this.signal=new il(this.signalObserver),this.analyticsSignalTransport=new Uo(this.signal),this.publishDtlsStateTimer=0,this.lastPublishDtlsState="new",this.handleLocalRoleUpdate=e=>Lt(this,[e],(function*({oldRole:e,newRole:t}){!this.doesRoleNeedWebRTC(e)&&this.doesRoleNeedWebRTC(t)&&(Yt.d(sl,"Local peer role updated to webrtc role, creating PeerConnections and performing inital publish negotiation \u23f3"),this.createPeerConnections(),yield this.negotiateOnFirstPublish())})),this.retryPublishIceFailedTask=()=>Lt(this,null,(function*(){if(this.publishConnection){let e=new Promise(((e,t)=>{this.callbacks.set(Fs,{promise:{resolve:e,reject:t},action:"RESTART_ICE",extra:{}})}));yield this.performPublishRenegotiation({iceRestart:"connected"!==this.publishConnection.connectionState}),yield e}return!0})),this.retrySubscribeIceFailedTask=()=>Lt(this,null,(function*(){if(this.subscribeConnection&&"connected"!==this.subscribeConnection.connectionState){let e=new Promise(((e,t)=>{this.callbacks.set($s,{promise:{resolve:e,reject:t},action:"RESTART_ICE",extra:{}})})),t=new Promise((e=>{setTimeout(e,6e4,!1)}));return Promise.race([e,t])}return!0})),this.retrySignalDisconnectTask=()=>Lt(this,null,(function*(){var e;Yt.d(sl,"retrySignalDisconnectTask",{signalConnected:this.signal.isConnected}),this.signal.isConnected||(yield this.internalConnect(this.joinParameters.authToken,this.joinParameters.endpoint,this.joinParameters.peerId,this.joinParameters.iceServers));let t=null!=(e=this.store.getRoom())&&e.joinedAt?this.signal.isConnected&&(yield this.retryPublishIceFailedTask()):this.signal.isConnected;return this.signal.trackUpdate(this.trackStates),t})),this.webrtcInternals=new Pn(this.store,this.eventBus);this.retryScheduler=new No(((e,t)=>Lt(this,null,(function*(){e!==this.state&&(this.state=e,yield this.observer.onStateChange(this.state,t))}))),this.sendErrorAnalyticsEvent.bind(this)),this.eventBus.statsUpdate.subscribe((e=>{var t,i;let s=(null==(i=null==(t=e.getLocalPeerStats())?void 0:t.subscribe)?void 0:i.bitrate)||0;this.maxSubscribeBitrate=Math.max(this.maxSubscribeBitrate,s)})),this.eventBus.localAudioEnabled.subscribe((({track:e,enabled:t})=>this.trackUpdate(e,t))),this.eventBus.localVideoEnabled.subscribe((({track:e,enabled:t})=>this.trackUpdate(e,t)))}getWebsocketEndpoint(){if(this.initConfig)return this.initConfig.endpoint}getWebrtcInternals(){return this.webrtcInternals}isFlagEnabled(e){var t;let i=null==(t=this.initConfig)?void 0:t.config;return((null==i?void 0:i.enabledFlags)||[]).includes(e)}setConnectivityListener(e){this.connectivityListener=e}preview(e,t,i,s,n=!1,r){return Lt(this,null,(function*(){let a=yield this.connect(e,t,i,s,n,r);return this.state="Preview",this.observer.onStateChange(this.state),a}))}join(e,t,i,s,n=!1,r){return Lt(this,null,(function*(){Yt.d(sl,"join: started \u23f0");try{(!this.signal.isConnected||!this.initConfig)&&(yield this.connect(e,s,t,i,n,r)),this.validateNotDisconnected("connect"),this.initConfig&&(yield this.waitForLocalRoleAvailability(),yield this.createConnectionsAndNegotiateJoin(i,n),this.initStatsAnalytics(),Yt.d(sl,"\u2705 join: Negotiated over PUBLISH connection"))}catch(fe){Yt.e(sl,`join: failed \u274c [token=${e}]`,fe),this.state="Failed";let i=fe;throw i.isTerminal=i.isTerminal||500===i.code,yield this.observer.onStateChange(this.state,i),i}Yt.d(sl,"\u2705 join: successful"),this.state="Joined",this.observer.onStateChange(this.state)}))}connect(e,t,i,s,n=!1,r){return Lt(this,null,(function*(){this.setTransportStateForConnect(),this.joinParameters=new Ro(e,i,s.name,s.metaData,t,n,r);try{return yield this.internalConnect(e,t,i,r)}catch(fe){if(!(fe instanceof pi&&([hi.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,hi.WebSocketConnectionErrors.FAILED_TO_CONNECT,hi.WebSocketConnectionErrors.ABNORMAL_CLOSE,hi.APIErrors.ENDPOINT_UNREACHABLE].includes(fe.code)||fe.code.toString().startsWith("5")||fe.code.toString().startsWith("429"))))throw fe;{let n=()=>Lt(this,null,(function*(){return yield this.internalConnect(e,t,i,r),!(!this.initConfig||!this.initConfig.endpoint)}));yield this.retryScheduler.schedule({category:0,error:fe,task:n,originalState:this.state,changeState:!1})}}}))}leave(e){return Lt(this,null,(function*(){var t,i,s;this.retryScheduler.reset(),this.joinParameters=void 0,Yt.d(sl,"leaving in transport");try{let n=this.pluginUsageTracker.getPluginUsage("HMSKrispPlugin");if(n&&this.eventBus.analytics.publish(Ri.getKrispUsage(n)),this.state="Leaving",null==(t=this.publishStatsAnalytics)||t.stop(),null==(i=this.subscribeStatsAnalytics)||i.stop(),null==(s=this.webrtcInternals)||s.cleanup(),this.clearPeerConnections(),e)try{this.signal.leave(),Yt.d(sl,"signal leave done")}catch(be){Yt.w(sl,"failed to send leave on websocket to server",be)}this.analyticsEventsService.flushFailedClientEvents(),this.analyticsEventsService.reset(),yield this.signal.close()}catch(we){this.eventBus.analytics.publish(Ri.disconnect(we)),Yt.e(sl,"leave: FAILED \u274c",we)}finally{this.state="Disconnected",this.observer.onStateChange(this.state)}}))}publish(e){return Lt(this,null,(function*(){var t;for(let i of e)try{yield this.publishTrack(i),null==(t=this.connectivityListener)||t.onMediaPublished(i)}catch(ye){this.eventBus.analytics.publish(Ri.publish({devices:this.deviceManager.getDevices(),error:ye}))}}))}unpublish(e){return Lt(this,null,(function*(){for(let t of e)yield this.unpublishTrack(t)}))}setSFUNodeId(e){var t,i;this.signal.setSfuNodeId(e),this.sfuNodeId?e&&this.sfuNodeId!==e&&(this.sfuNodeId=e,this.handleSFUMigration()):(this.sfuNodeId=e,null==(t=this.publishConnection)||t.setSfuNodeId(e),null==(i=this.subscribeConnection)||i.setSfuNodeId(e))}handleSFUMigration(){return Lt(this,null,(function*(){var e,t;Yt.time("sfu migration"),this.clearPeerConnections();let i=this.store.getPeerMap();this.store.removeRemoteTracks();for(let a in i){let e=i[a];e.isLocal||(e.audioTrack=void 0,e.videoTrack=void 0,e.auxiliaryTracks=[])}let s=this.store.getLocalPeer();if(!s)return;this.createPeerConnections(),this.trackStates.clear(),yield this.negotiateOnFirstPublish();let n=new Map;if(s.audioTrack){let e=s.audioTrack.stream;n.get(e.id)||n.set(e.id,new hn(new MediaStream));let t=s.audioTrack.clone(n.get(e.id));this.store.removeTrack(s.audioTrack),s.audioTrack.cleanup(),yield this.publishTrack(t),s.audioTrack=t}if(s.videoTrack){let e=s.videoTrack.stream;n.get(e.id)||n.set(e.id,new hn(new MediaStream)),this.store.removeTrack(s.videoTrack);let t=s.videoTrack.clone(n.get(e.id));s.videoTrack.cleanup(),yield this.publishTrack(t),s.videoTrack=t}let r=[];for(;s.auxiliaryTracks.length>0;){let e=s.auxiliaryTracks.shift();if(e){let t=e.stream;n.get(t.id)||n.set(t.id,new hn("screen"===e.source?t.nativeStream.clone():new MediaStream)),this.store.removeTrack(e);let i=e.clone(n.get(t.id));"video"===i.type&&"screen"===i.source&&(this.screenStream.add(t.nativeStream),this.screenStream.add(i.stream.nativeStream),i.nativeTrack.addEventListener("ended",this.onScreenshareStop)),e.cleanup(),yield this.publishTrack(i),r.push(i)}}s.auxiliaryTracks=r,n.clear(),null==(t=null==(e=this.listener)?void 0:e.onSFUMigration)||t.call(e),Yt.timeEnd("sfu migration")}))}trackUpdate(e,t){var i;let s=Array.from(this.trackStates.values()).find((t=>e.type===t.type&&e.source===t.source));if(s){let n=new Qa(At(It({},s),{mute:!t}));this.trackStates.set(s.track_id,n),Yt.d(sl,"Track Update",this.trackStates,e),this.signal.trackUpdate(new Map([[s.track_id,n]]));let r=this.store.getLocalPeer();r&&t===e.enabled&&(null==(i=this.listener)||i.onTrackUpdate(t?3:2,e,r))}}publishTrack(e){return Lt(this,null,(function*(){e.publishedTrackId=e.getTrackIDBeingSent(),Yt.d(sl,`\u23f3 publishTrack: trackId=${e.trackId}, toPublishTrackId=${e.publishedTrackId}`,`${e}`),this.trackStates.set(e.publishedTrackId,new Qa(e));let t=new Promise(((e,t)=>{this.callbacks.set(Fs,{promise:{resolve:e,reject:t},action:"PUBLISH",extra:{}})})),i=e.stream;i.setConnection(this.publishConnection);let s=this.store.getSimulcastLayers(e.source);i.addTransceiver(e,s),Yt.time(`publish-${e.trackId}-${e.type}`),yield t,Yt.timeEnd(`publish-${e.trackId}-${e.type}`),this.store.addTrack(e),yield i.setMaxBitrateAndFramerate(e).then((()=>{Yt.d(sl,`Setting maxBitrate=${e.settings.maxBitrate} kpbs${e instanceof Bs?` and maxFramerate=${e.settings.maxFramerate}`:""} for ${e.source} ${e.type} ${e.trackId}`)})).catch((e=>Yt.w(sl,"Failed setting maxBitrate and maxFramerate",e))),e.isPublished=!0,Yt.d(sl,`\u2705 publishTrack: trackId=${e.trackId}`,`${e}`,this.callbacks)}))}unpublishTrack(e){return Lt(this,null,(function*(){if(Yt.d(sl,`\u23f3 unpublishTrack: trackId=${e.trackId}`,`${e}`),e.publishedTrackId&&this.trackStates.has(e.publishedTrackId))this.trackStates.delete(e.publishedTrackId);else{let t=Array.from(this.trackStates.values()).find((t=>e.type===t.type&&e.source===t.source));t&&this.trackStates.delete(t.track_id)}let t=new Promise(((e,t)=>{this.callbacks.set(Fs,{promise:{resolve:e,reject:t},action:"UNPUBLISH",extra:{}})}));e.stream.removeSender(e),yield t,yield e.cleanup(),"screen"===e.source&&this.screenStream&&this.screenStream.forEach((e=>{e.getTracks().forEach((e=>{e.stop()})),this.screenStream.delete(e)})),this.store.removeTrack(e),Yt.d(sl,`\u2705 unpublishTrack: trackId=${e.trackId}`,this.callbacks)}))}clearPeerConnections(){return Lt(this,null,(function*(){var e,t;clearTimeout(this.publishDtlsStateTimer),this.publishDtlsStateTimer=0,clearTimeout(this.publishDisconnectTimer),this.publishDisconnectTimer=0,this.lastPublishDtlsState="new",null==(e=this.publishConnection)||e.close(),null==(t=this.subscribeConnection)||t.close(),this.publishConnection=null,this.subscribeConnection=null}))}waitForLocalRoleAvailability(){if(!this.store.hasRoleDetailsArrived())return new Promise((e=>{this.eventBus.policyChange.subscribeOnce((()=>e()))}))}createConnectionsAndNegotiateJoin(e,t=!1){return Lt(this,null,(function*(){let i=this.doesLocalPeerNeedWebRTC();i&&this.createPeerConnections(),this.analyticsTimer.start("join_response_time"),yield this.negotiateJoinWithRetry({name:e.name,data:e.metaData,autoSubscribeVideo:t,isWebRTC:i}),this.analyticsTimer.end("join_response_time")}))}createPeerConnections(){var e,t,i;let s=(e,t,i=!1)=>{(["disconnected","failed"].includes(t)?Yt.w.bind(Yt):Yt.d.bind(Yt))(sl,`${Ko[e]} ${i?"ice":""} connection state change: ${t}`)};if(this.initConfig){let e={onRenegotiationNeeded:()=>Lt(this,null,(function*(){yield this.performPublishRenegotiation()})),onDTLSTransportStateChange:e=>{var t,i,s;if(("failed"===e?Yt.w.bind(Yt):Yt.d.bind(Yt))(sl,`Publisher on dtls transport state change: ${e}`),!e||this.lastPublishDtlsState===e||(this.lastPublishDtlsState=e,0!==this.publishDtlsStateTimer&&(clearTimeout(this.publishDtlsStateTimer),this.publishDtlsStateTimer=0),"connecting"!==e&&"failed"!==e))return;let n=null==(s=null==(i=null==(t=this.initConfig)?void 0:t.config)?void 0:i.dtlsStateTimeouts)?void 0:s[e];!n||n<=0||(this.publishDtlsStateTimer=window.setTimeout((()=>{var t;let i=null==(t=this.publishConnection)?void 0:t.nativeConnection.connectionState;if(i&&e&&i===e){let t=mi.WebrtcErrors.ICEFailure("PUBLISH",`DTLS transport state ${e} timeout:${n}ms`,!0);this.eventBus.analytics.publish(Ri.disconnect(t)),this.observer.onFailure(t)}}),n))},onDTLSTransportError:e=>{Yt.e(sl,`onDTLSTransportError ${e.name} ${e.message}`,e),this.eventBus.analytics.publish(Ri.disconnect(e))},onIceConnectionChange:e=>Lt(this,null,(function*(){s(0,e,!0)})),onConnectionStateChange:e=>Lt(this,null,(function*(){var t,i,n,r,a,o,l,d;s(0,e,!1),"new"!==e&&("connected"===e?(null==(t=this.connectivityListener)||t.onICESuccess(!0),null==(i=this.publishConnection)||i.handleSelectedIceCandidatePairs()):"failed"===e?yield this.handleIceConnectionFailure(0,mi.WebrtcErrors.ICEFailure("PUBLISH",`local candidate - ${null==(a=null==(r=null==(n=this.publishConnection)?void 0:n.selectedCandidatePair)?void 0:r.local)?void 0:a.candidate}; remote candidate - ${null==(d=null==(l=null==(o=this.publishConnection)?void 0:o.selectedCandidatePair)?void 0:l.remote)?void 0:d.candidate}`)):this.publishDisconnectTimer=window.setTimeout((()=>{var e,t,i,s,n,r,a;"connected"!==(null==(e=this.publishConnection)?void 0:e.connectionState)&&this.handleIceConnectionFailure(0,mi.WebrtcErrors.ICEDisconnected("PUBLISH",`local candidate - ${null==(s=null==(i=null==(t=this.publishConnection)?void 0:t.selectedCandidatePair)?void 0:i.local)?void 0:s.candidate}; remote candidate - ${null==(a=null==(r=null==(n=this.publishConnection)?void 0:n.selectedCandidatePair)?void 0:r.remote)?void 0:a.candidate}`))}),5e3))})),onIceCandidate:e=>{var t;null==(t=this.connectivityListener)||t.onICECandidate(e,!0)},onSelectedCandidatePairChange:e=>{var t;null==(t=this.connectivityListener)||t.onSelectedICECandidatePairChange(e,!0)}},t={onApiChannelMessage:e=>{this.observer.onNotification(JSON.parse(e))},onTrackAdd:e=>{Yt.d(sl,"[Subscribe] onTrackAdd",`${e}`),this.observer.onTrackAdd(e)},onTrackRemove:e=>{Yt.d(sl,"[Subscribe] onTrackRemove",`${e}`),this.observer.onTrackRemove(e)},onIceConnectionChange:e=>Lt(this,null,(function*(){var t;if(s(1,e,!0),"connected"===e){let e=this.callbacks.get($s);this.callbacks.delete($s),null==(t=this.connectivityListener)||t.onICESuccess(!1),e&&e.promise.resolve(!0)}})),onConnectionStateChange:e=>Lt(this,null,(function*(){var t,i,n,r,a,o,l;if(s(1,e,!1),"failed"===e)yield this.handleIceConnectionFailure(1,mi.WebrtcErrors.ICEFailure("SUBSCRIBE",`local candidate - ${null==(n=null==(i=null==(t=this.subscribeConnection)?void 0:t.selectedCandidatePair)?void 0:i.local)?void 0:n.candidate}; remote candidate - ${null==(o=null==(a=null==(r=this.subscribeConnection)?void 0:r.selectedCandidatePair)?void 0:a.remote)?void 0:o.candidate}`));else if("disconnected"===e)setTimeout((()=>{var e,t,i,s,n,r,a;"disconnected"===(null==(e=this.subscribeConnection)?void 0:e.connectionState)&&this.handleIceConnectionFailure(1,mi.WebrtcErrors.ICEDisconnected("SUBSCRIBE",`local candidate - ${null==(s=null==(i=null==(t=this.subscribeConnection)?void 0:t.selectedCandidatePair)?void 0:i.local)?void 0:s.candidate}; remote candidate - ${null==(a=null==(r=null==(n=this.subscribeConnection)?void 0:n.selectedCandidatePair)?void 0:r.remote)?void 0:a.candidate}`))}),5e3);else if("connected"===e){null==(l=this.subscribeConnection)||l.handleSelectedIceCandidatePairs();let e=this.callbacks.get($s);this.callbacks.delete($s),e&&e.promise.resolve(!0)}})),onIceCandidate:e=>{var t;null==(t=this.connectivityListener)||t.onICECandidate(e,!1)},onSelectedCandidatePairChange:e=>{var t;null==(t=this.connectivityListener)||t.onSelectedICECandidatePairChange(e,!1)}};this.publishConnection||(this.publishConnection=new Qo(this.signal,this.initConfig.rtcConfiguration,e)),this.subscribeConnection||(this.subscribeConnection=new Zo(this.signal,this.initConfig.rtcConfiguration,this.isFlagEnabled.bind(this),t))}null==(i=this.webrtcInternals)||i.setPeerConnections({publish:null==(e=this.publishConnection)?void 0:e.nativeConnection,subscribe:null==(t=this.subscribeConnection)?void 0:t.nativeConnection})}negotiateJoinWithRetry(e){return Lt(this,arguments,(function*({name:e,data:t,autoSubscribeVideo:i,isWebRTC:s=!0}){try{yield this.negotiateJoin({name:e,data:t,autoSubscribeVideo:i,isWebRTC:s})}catch(be){Yt.e(sl,"Join negotiation failed \u274c",be);let r=be instanceof pi?be:mi.WebsocketMethodErrors.ServerErrors(500,"JOIN",`Websocket join error - ${be.message}`),a=5===parseInt(""+r.code/100)||[hi.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,429].includes(r.code);if(410===r.code&&(r.isTerminal=!0),!a)throw be;{this.joinRetryCount=0,r.isTerminal=!1;let n=()=>Lt(this,null,(function*(){return this.joinRetryCount++,yield this.negotiateJoin({name:e,data:t,autoSubscribeVideo:i,isWebRTC:s})}));yield this.retryScheduler.schedule({category:2,error:r,task:n,originalState:"Joined",changeState:!1})}}}))}negotiateJoin(e){return Lt(this,arguments,(function*({name:e,data:t,autoSubscribeVideo:i,isWebRTC:s=!0}){return s?yield this.negotiateJoinWebRTC({name:e,data:t,autoSubscribeVideo:i}):yield this.negotiateJoinNonWebRTC({name:e,data:t,autoSubscribeVideo:i})}))}negotiateJoinWebRTC(e){return Lt(this,arguments,(function*({name:e,data:t,autoSubscribeVideo:i}){if(Yt.d(sl,"\u23f3 join: Negotiating over PUBLISH connection"),!this.publishConnection)return Yt.e(sl,"Publish peer connection not found, cannot negotiate"),!1;let s=yield this.publishConnection.createOffer();yield this.publishConnection.setLocalDescription(s);let n=this.isFlagEnabled("subscribeDegradation"),r=this.isFlagEnabled("simulcast"),a=this.isFlagEnabled("onDemandTracks"),o=yield this.signal.join(e,t,!i,n,r,a,s);this.setSFUNodeId(null==o?void 0:o.sfu_node_id),yield this.publishConnection.setRemoteDescription(o);for(let l of this.publishConnection.candidates)yield this.publishConnection.addIceCandidate(l);return this.publishConnection.initAfterJoin(),!!o}))}negotiateJoinNonWebRTC(e){return Lt(this,arguments,(function*({name:e,data:t,autoSubscribeVideo:i}){Yt.d(sl,"\u23f3 join: Negotiating Non-WebRTC");let s=this.isFlagEnabled("subscribeDegradation"),n=this.isFlagEnabled("simulcast"),r=this.isFlagEnabled("onDemandTracks"),a=yield this.signal.join(e,t,!i,s,n,r);return this.setSFUNodeId(null==a?void 0:a.sfu_node_id),!!a}))}negotiateOnFirstPublish(){return Lt(this,null,(function*(){if(Yt.d(sl,"\u23f3 Negotiating offer over PUBLISH connection"),!this.publishConnection)return Yt.e(sl,"Publish peer connection not found, cannot negotiate"),!1;try{let e=yield this.publishConnection.createOffer(this.trackStates);yield this.publishConnection.setLocalDescription(e);let t=yield this.signal.offer(e,this.trackStates);yield this.publishConnection.setRemoteDescription(t);for(let i of this.publishConnection.candidates)yield this.publishConnection.addIceCandidate(i);return this.publishConnection.initAfterJoin(),!!t}catch(e){if(e instanceof pi&&421===e.code)return!0;throw e}}))}performPublishRenegotiation(e){return Lt(this,null,(function*(){Yt.d(sl,"\u23f3 [role=PUBLISH] onRenegotiationNeeded START",this.trackStates);let t=this.callbacks.get(Fs);if(t)if(this.publishConnection)try{let i=yield this.publishConnection.createOffer(this.trackStates,e);yield this.publishConnection.setLocalDescription(i),Yt.time("renegotiation-offer-exchange");let s=yield this.signal.offer(i,this.trackStates);this.callbacks.delete(Fs),Yt.timeEnd("renegotiation-offer-exchange"),yield this.publishConnection.setRemoteDescription(s),t.promise.resolve(!0),Yt.d(sl,"[role=PUBLISH] onRenegotiationNeeded DONE \u2705")}catch(Te){let i;i=Te instanceof pi?Te:mi.GenericErrors.Unknown("PUBLISH",Te.message),421===i.code?t.promise.resolve(!0):t.promise.reject(i),Yt.d(sl,"[role=PUBLISH] onRenegotiationNeeded FAILED \u274c")}else Yt.e(sl,"Publish peer connection not found, cannot renegotiate");else Yt.w(sl,"no callback found for renegotiation")}))}handleIceConnectionFailure(e,t){return Lt(this,null,(function*(){this.retryScheduler.isTaskInProgress(4)||(0===e?this.retryScheduler.schedule({category:3,error:t,task:this.retryPublishIceFailedTask,originalState:"Joined"}):this.retryScheduler.schedule({category:4,error:t,task:this.retrySubscribeIceFailedTask,originalState:"Joined"}))}))}internalConnect(e,t,i,s){return Lt(this,null,(function*(){var n,r,a;Yt.d(sl,"connect: started \u23f0");let o=new Date;try{this.analyticsTimer.start("init_response_time"),this.initConfig=yield tl.fetchInitConfig({token:e,peerId:i,userAgent:this.store.getUserAgent(),initEndpoint:t,iceServers:s}),null==(n=this.connectivityListener)||n.onInitSuccess(this.initConfig.endpoint);let o=this.store.getRoom();return o&&(o.effectsKey=null==(r=this.initConfig.config.vb)?void 0:r.effectsKey,o.isEffectsEnabled=this.isFlagEnabled("effectsSDKEnabled"),o.disableNoneLayerRequest=this.isFlagEnabled("disableNoneLayerRequest"),o.isVBEnabled=this.isFlagEnabled("vb"),o.isHipaaEnabled=this.isFlagEnabled("hipaa"),o.isNoiseCancellationEnabled=this.isFlagEnabled("noiseCancellation")),this.analyticsTimer.end("init_response_time"),za.setWebsocketEndpoint(this.initConfig.endpoint),this.validateNotDisconnected("post init"),yield this.openSignal(e,i),this.observer.onConnected(),null==(a=this.connectivityListener)||a.onSignallingSuccess(),this.store.setSimulcastEnabled(this.isFlagEnabled("simulcast")),Yt.d(sl,"Adding Analytics Transport: JsonRpcSignal"),this.analyticsEventsService.setTransport(this.analyticsSignalTransport),this.analyticsEventsService.flush(),this.initConfig}catch(Se){throw"Reconnecting"!==this.state&&this.eventBus.analytics.publish(Ri.connect(Se,this.getAdditionalAnalyticsProperties(),o,new Date,t)),Yt.e(sl,"\u274c internal connect: failed",Se),Se}}))}validateNotDisconnected(e){if("Disconnected"===this.state)throw Yt.w(sl,"aborting join as transport state is disconnected"),mi.GenericErrors.ValidationFailed(`leave called before join could complete - stage=${e}`)}openSignal(e,t){return Lt(this,null,(function*(){if(!this.initConfig)throw mi.APIErrors.InitConfigNotAvailable("INIT","Init Config not found");Yt.d(sl,"\u23f3 internal connect: connecting to ws endpoint",this.initConfig.endpoint);let i=new URL(this.initConfig.endpoint);i.searchParams.set("peer",t),i.searchParams.set("token",e),i.searchParams.set("user_agent_v2",this.store.getUserAgent()),i.searchParams.set("protocol_version","2.5"),i.searchParams.set("protocol_spec","20240720"),this.endpoint=i.toString(),this.analyticsTimer.start("ws_connect_time"),yield this.signal.open(this.endpoint),this.analyticsTimer.end("ws_connect_time"),this.analyticsTimer.start("on_policy_change_time"),this.analyticsTimer.start("room_state_time"),Yt.d(sl,"\u2705 internal connect: connected to ws endpoint")}))}initStatsAnalytics(){var e,t;this.isFlagEnabled("publishStats")&&(this.publishStatsAnalytics=new Vo(this.store,this.eventBus,this.getValueFromInitConfig("publishStats","maxSampleWindowSize",30),this.getValueFromInitConfig("publishStats","maxSamplePushInterval",300)),null==(e=this.getWebrtcInternals())||e.start()),this.isFlagEnabled("subscribeStats")&&(this.subscribeStatsAnalytics=new Ho(this.store,this.eventBus,this.getValueFromInitConfig("subscribeStats","maxSampleWindowSize",10),this.getValueFromInitConfig("subscribeStats","maxSamplePushInterval",60)),null==(t=this.getWebrtcInternals())||t.start())}getValueFromInitConfig(e,t,i){var s,n;return(null==(n=null==(s=this.initConfig)?void 0:s.config[e])?void 0:n[t])||i}doesRoleNeedWebRTC(e){var t,i;if(!this.isFlagEnabled("nonWebRTCDisableOffer"))return!0;let s=!!(e.publishParams.allowed&&(null==(t=e.publishParams.allowed)?void 0:t.length)>0),n=!!(e.subscribeParams.subscribeToRoles&&(null==(i=e.subscribeParams.subscribeToRoles)?void 0:i.length)>0);return s||n}doesLocalPeerNeedWebRTC(){var e;let t=null==(e=this.store.getLocalPeer())?void 0:e.role;return!t||this.doesRoleNeedWebRTC(t)}setTransportStateForConnect(){if("Failed"===this.state&&(this.state="Disconnected"),"Disconnected"!==this.state&&"Reconnecting"!==this.state)throw mi.WebsocketMethodErrors.AlreadyJoined("JOIN",`Cannot join a meeting in ${this.state} state`);"Disconnected"===this.state&&(this.state="Connecting",this.observer.onStateChange(this.state))}sendErrorAnalyticsEvent(e,t){let i,s=this.getAdditionalAnalyticsProperties();switch(t){case 0:i=Ri.connect(e,s);break;case 1:i=Ri.disconnect(e,s);break;case 2:i=Ri.join({error:e,time:this.analyticsTimer.getTimeTaken("join_time"),init_response_time:this.analyticsTimer.getTimeTaken("init_response_time"),ws_connect_time:this.analyticsTimer.getTimeTaken("ws_connect_time"),on_policy_change_time:this.analyticsTimer.getTimeTaken("on_policy_change_time"),local_audio_track_time:this.analyticsTimer.getTimeTaken("local_audio_track_time"),local_video_track_time:this.analyticsTimer.getTimeTaken("local_video_track_time"),retries_join:this.joinRetryCount});break;case 3:i=Ri.publish({error:e});break;case 4:i=Ri.subscribeFail(e)}this.eventBus.analytics.publish(i)}getSubscribeConnection(){return this.subscribeConnection}getAdditionalAnalyticsProperties(){var e,t,i,s,n,r,a,o;let l=(()=>{if(!ri||"undefined"==typeof navigator.connection)return;let e=navigator.connection;return{downlink:e.downlink,downlinkMax:e.downlinkMax,effectiveType:e.effectiveType,rtt:e.rtt,saveData:e.saveData,type:e.type}})(),d="undefined"!=typeof document&&document.hidden,c=this.store.getRemoteVideoTracks().filter((e=>e.degraded)).length;return{network_info:l,document_hidden:d,num_degraded_tracks:c,bitrate:{publish:null==(s=null==(i=null==(t=null==(e=this.getWebrtcInternals())?void 0:e.getCurrentStats())?void 0:t.getLocalPeerStats())?void 0:i.publish)?void 0:s.bitrate,subscribe:null==(o=null==(a=null==(r=null==(n=this.getWebrtcInternals())?void 0:n.getCurrentStats())?void 0:r.getLocalPeerStats())?void 0:a.subscribe)?void 0:o.bitrate},max_sub_bitrate:this.maxSubscribeBitrate,recent_pong_response_times:this.signal.getPongResponseTimes(),transport_state:this.state}}};function rl(e){if(!e||0===e.length)throw mi.APIErrors.InvalidTokenFormat("INIT","Token cannot be an empty string or undefined or null");let t=e.split(".");if(3!==t.length)throw mi.APIErrors.InvalidTokenFormat("INIT","Expected 3 '.' separate fields - header, payload and signature respectively");let i=atob(t[1]);try{let e=JSON.parse(i);return{roomId:e.room_id,userId:e.user_id,role:e.role}}catch(Te){throw mi.APIErrors.InvalidTokenFormat("INIT",`couldn't parse to json - ${Te.message}`)}}var al={published:!1,isInitialised:!1,isReconnecting:!1,isPreviewInProgress:!1,isPreviewCalled:!1,isJoinInProgress:!1,deviceManagersInitialised:!1},ol=class{constructor(){this.TAG="[HMSSdk]:",this.transportState="Disconnected",this.analyticsTimer=new Ns,this.sdkState=It({},al),this.isDiagnostics=!1,this.playlistSettings={video:{bitrate:1e3},audio:{bitrate:64}},this.handleAutoplayError=e=>{var t,i;null==(i=null==(t=this.errorListener)?void 0:t.onError)||i.call(t,e)},this.observer={onNotification:e=>{var t;if("on-peer-leave-request"!==e.method){switch(e.method){case"on-policy-change":this.analyticsTimer.end("on_policy_change_time");break;case"peer-list":this.analyticsTimer.end("peer_list_time"),this.sendJoinAnalyticsEvent(this.sdkState.isPreviewCalled);break;case"room-state":this.analyticsTimer.end("room_state_time")}null==(t=this.notificationManager)||t.handleNotification(e,this.sdkState.isReconnecting)}else this.handlePeerLeaveRequest(e.params)},onConnected:()=>{this.initNotificationManager()},onTrackAdd:e=>{var t;null==(t=this.notificationManager)||t.handleTrackAdd(e)},onTrackRemove:e=>{var t;null==(t=this.notificationManager)||t.handleTrackRemove(e)},onFailure:e=>{var t;null==(t=this.errorListener)||t.onError(e)},onStateChange:(e,t)=>Lt(this,null,(function*(){var i,s;let n=e=>Lt(this,null,(function*(){var t,i;yield this.internalLeave(!0,e),!this.sdkState.isPreviewInProgress&&!this.sdkState.isJoinInProgress&&(null==(i=null==(t=this.errorListener)?void 0:t.onError)||i.call(t,e)),this.sdkState.isReconnecting=!1}));switch(e){case"Preview":case"Joined":this.initNotificationManager(),"Reconnecting"===this.transportState&&(null==(i=this.listener)||i.onReconnected());break;case"Failed":yield n(t);break;case"Reconnecting":this.sdkState.isReconnecting=!0,null==(s=this.listener)||s.onReconnecting(t)}this.transportState=e,Yt.d(this.TAG,"Transport State Change",this.transportState)}))},this.handlePeerLeaveRequest=e=>{var t;let i=e.requested_by?this.store.getPeerById(e.requested_by):void 0,s={roomEnded:e.room_end,reason:e.reason,requestedBy:i};null==(t=this.listener)||t.onRemovedFromRoom(s),this.internalLeave(!1)},this.handlePreviewError=e=>{var t;this.analyticsTimer.end("preview_time"),e&&(null==(t=this.errorListener)||t.onError(e)),this.sendPreviewAnalyticsEvent(e),this.sdkState.isPreviewInProgress=!1},this.handleDeviceChange=e=>{var t,i;e.isUserSelection||(Yt.d(this.TAG,"Device Change event",e),null==(i=null==(t=this.deviceChangeListener)?void 0:t.onDeviceChange)||i.call(t,e),(()=>{var t,i,s,n;if(e.error&&e.type){let r=e.type.includes("audio")?null==(t=this.localPeer)?void 0:t.audioTrack:null==(i=this.localPeer)?void 0:i.videoTrack;null==(s=this.errorListener)||s.onError(e.error),[hi.TracksErrors.CANT_ACCESS_CAPTURE_DEVICE,hi.TracksErrors.DEVICE_IN_USE,hi.TracksErrors.DEVICE_NOT_AVAILABLE].includes(e.error.code)&&r&&(r.setEnabled(!1),null==(n=this.listener)||n.onTrackUpdate(2,r,this.localPeer))}})())},this.handleAudioPluginError=e=>{var t;Yt.e(this.TAG,"Audio Plugin Error event",e),null==(t=this.errorListener)||t.onError(e)},this.handleLocalRoleUpdate=e=>Lt(this,[e],(function*({oldRole:e,newRole:t}){var i;yield this.transport.handleLocalRoleUpdate({oldRole:e,newRole:t}),yield null==(i=this.roleChangeManager)?void 0:i.handleLocalPeerRoleUpdate({oldRole:e,newRole:t}),yield this.interactivityCenter.whiteboard.handleLocalRoleUpdate()})),this.unpauseRemoteVideoTracks=()=>{this.store.getRemoteVideoTracks().forEach((e=>e.handleTrackUnmute()))},this.sendAudioPresenceFailed=()=>{var e;let t=mi.TracksErrors.NoAudioDetected("PREVIEW");Yt.w(this.TAG,"Audio Presence Failure",this.transportState,t),this.isDiagnostics&&(null==(e=this.listener)||e.onError(t))},this.sendJoinAnalyticsEvent=(e=!1,t)=>{this.eventBus.analytics.publish(Ri.join(At(It({error:t},this.analyticsTimer.getTimes()),{time:this.analyticsTimer.getTimeTaken("join_time"),is_preview_called:e,retries_join:this.transport.joinRetryCount})))},this.sendPreviewAnalyticsEvent=e=>{this.eventBus.analytics.publish(Ri.preview(At(It({error:e},this.analyticsTimer.getTimes()),{time:this.analyticsTimer.getTimeTaken("preview_time")})))},this.sendAnalyticsEvent=e=>{this.isDiagnostics||this.analyticsEventsService.queue(e).flush()}}setSessionPeerInfo(e,t){var i,s,n,r;let a=this.store.getRoom();t&&a?this.sessionPeerInfo={peer:{peer_id:t.peerId,role:null==(i=t.role)?void 0:i.name,joined_at:(null==(s=t.joinedAt)?void 0:s.valueOf())||0,room_name:a.name,session_started_at:(null==(n=a.startedAt)?void 0:n.valueOf())||0,user_data:t.customerUserId,user_name:t.name,template_id:a.templateId,session_id:a.sessionId,token:null==(r=this.store.getConfig())?void 0:r.authToken},agent:this.store.getUserAgent(),device_id:ki(),cluster:{websocket_url:e},timestamp:Date.now()}:Yt.e(this.TAG,"setSessionPeerInfo> Local peer or room is undefined")}initNotificationManager(){this.notificationManager||(this.notificationManager=new Io(this.store,this.eventBus,this.transport,this.listener,this.audioListener))}initStoreAndManagers(e){var t,i;if(this.listener=e,this.errorListener=e,this.deviceChangeListener=e,null==(t=this.store)||t.setErrorListener(this.errorListener),this.sdkState.isInitialised)return null==(i=this.notificationManager)||i.setListener(this.listener),this.audioSinkManager.setListener(this.listener),this.interactivityCenter.setListener(this.listener),void this.transport.setListener(this.listener);this.sdkState.isInitialised=!0,this.store=new Ya,this.store.setErrorListener(this.errorListener),this.eventBus=new oo,this.pluginUsageTracker=new io(this.eventBus),this.wakeLockManager=new Za,this.networkTestManager=new Ka(this.eventBus,this.listener),this.playlistManager=new xn(this,this.eventBus),this.deviceManager=new so(this.store,this.eventBus),this.audioSinkManager=new to(this.store,this.deviceManager,this.eventBus),this.audioOutput=new no(this.deviceManager,this.audioSinkManager),this.audioSinkManager.setListener(this.listener),this.eventBus.autoplayError.subscribe(this.handleAutoplayError),this.localTrackManager=new xs(this.store,this.observer,this.deviceManager,this.eventBus,this.analyticsTimer),this.analyticsEventsService=new Xa(this.store),this.transport=new nl(this.observer,this.deviceManager,this.store,this.eventBus,this.analyticsEventsService,this.analyticsTimer,this.pluginUsageTracker),"onInitSuccess"in e&&this.transport.setConnectivityListener(e),this.sessionStore=new Ao(this.transport),this.interactivityCenter=new To(this.transport,this.store,this.listener),this.eventBus.analytics.subscribe(this.sendAnalyticsEvent),this.eventBus.deviceChange.subscribe(this.handleDeviceChange),this.eventBus.localVideoUnmutedNatively.subscribe(this.unpauseRemoteVideoTracks),this.eventBus.localAudioUnmutedNatively.subscribe(this.unpauseRemoteVideoTracks),this.eventBus.audioPluginFailed.subscribe(this.handleAudioPluginError)}validateJoined(e){if(!this.localPeer)throw mi.GenericErrors.NotConnected("VALIDATION",`Not connected - ${e}`)}sendHLSAnalytics(e){this.sendAnalyticsEvent(Ri.hlsPlayerError(e))}refreshDevices(){return Lt(this,null,(function*(){this.validateJoined("refreshDevices"),yield this.deviceManager.init(!0)}))}getWebrtcInternals(){var e;return null==(e=this.transport)?void 0:e.getWebrtcInternals()}getSessionStore(){return this.sessionStore}getPlaylistManager(){return this.playlistManager}getRecordingState(){var e;return null==(e=this.store.getRoom())?void 0:e.recording}getRTMPState(){var e;return null==(e=this.store.getRoom())?void 0:e.rtmp}getHLSState(){var e;return null==(e=this.store.getRoom())?void 0:e.hls}getTranscriptionState(){var e;return null==(e=this.store.getRoom())?void 0:e.transcriptions}getTemplateAppData(){return this.store.getTemplateAppData()}getInteractivityCenter(){return this.interactivityCenter}getPeerListIterator(e){return new Rn(this.transport,this.store,e)}updatePlaylistSettings(e){e.video&&Object.assign(this.playlistSettings.video,e.video),e.audio&&Object.assign(this.playlistSettings.audio,e.audio)}get localPeer(){var e;return null==(e=this.store)?void 0:e.getLocalPeer()}preview(e,t){return Lt(this,null,(function*(){if(Pi(),Si(),this.sdkState.isPreviewInProgress)return Promise.reject(mi.GenericErrors.PreviewAlreadyInProgress("PREVIEW","Preview already called"));if(["Joined","Reconnecting"].includes(this.transportState))return this.midCallPreview(e.asRole,e.settings);this.analyticsTimer.start("preview_time"),this.setUpPreview(e,t);let i=!1,s=!1,n=setTimeout((()=>{var e,t;(!i||!s)&&(null==(t=null==(e=this.listener)?void 0:e.onNetworkQuality)||t.call(e,-1))}),3e3);return new Promise(((r,a)=>{this.eventBus.policyChange.subscribeOnce((()=>Lt(this,null,(function*(){var i;if(this.localPeer){let t=e.asRole&&this.store.getPolicyForRole(e.asRole);this.localPeer.asRole=t||this.localPeer.role}let s=yield this.localTrackManager.getTracksToPublish(e.settings);s.forEach((e=>{var t;if(this.setLocalPeerTrack(e),e.isTrackNotPublishing()){let i=mi.TracksErrors.NoDataInTrack(`${e.type} track has no data. muted: ${e.nativeTrack.muted}, readyState: ${e.nativeTrack.readyState}`);Yt.e(this.TAG,i),this.sendAnalyticsEvent(Ri.publish({devices:this.deviceManager.getDevices(),error:i})),null==(t=this.listener)||t.onError(i)}})),null!=(i=this.localPeer)&&i.audioTrack&&this.initPreviewTrackAudioLevelMonitor(),yield this.initDeviceManagers(),this.sdkState.isPreviewInProgress=!1,this.analyticsTimer.end("preview_time");let n=this.store.getRoom();n&&t.onPreview(n,s),this.sendPreviewAnalyticsEvent(),r()})))),this.eventBus.leave.subscribeOnce(this.handlePreviewError),this.eventBus.leave.subscribeOnce((e=>a(e))),this.transport.preview(e.authToken,e.initEndpoint,this.localPeer.peerId,{name:e.userName,metaData:e.metaData||""},e.autoVideoSubscribe,e.iceServers).then((t=>{var r;i=!0,clearTimeout(n),t&&e.captureNetworkQualityInPreview&&this.networkTestManager.start(null==(r=t.config)?void 0:r.networkHealth).then((()=>{s=!0}))})).catch((e=>{this.handlePreviewError(e),a(e)}))}))}))}midCallPreview(e,t){return Lt(this,null,(function*(){var i,s;if(!this.localPeer||"Joined"!==this.transportState)throw mi.GenericErrors.NotConnected("VALIDATION","Not connected - midCallPreview");let n=e&&this.store.getPolicyForRole(e);if(!n)throw mi.GenericErrors.InvalidRole("PREVIEW",`role ${e} does not exist in policy`);this.localPeer.asRole=n;let r=yield this.localTrackManager.getTracksToPublish(t);r.forEach((e=>this.setLocalPeerTrack(e))),null!=(i=this.localPeer)&&i.audioTrack&&this.initPreviewTrackAudioLevelMonitor(),yield this.initDeviceManagers(),null==(s=this.listener)||s.onPreview(this.store.getRoom(),r)}))}cancelMidCallPreview(){return Lt(this,null,(function*(){var e,t,i;if((!this.localPeer||!this.localPeer.isInPreview())&&Yt.w(this.TAG,"Cannot cancel mid call preview as preview is not in progress"),null!=(e=this.localPeer)&&e.asRole&&this.localPeer.role){let e=this.localPeer.asRole,s=this.localPeer.role;delete this.localPeer.asRole,yield null==(t=this.roleChangeManager)?void 0:t.diffRolesAndPublishTracks({oldRole:e,newRole:s}),null==(i=this.listener)||i.onPeerUpdate(8,this.localPeer)}}))}join(e,t){return Lt(this,null,(function*(){var i,s,n,r,a,o,l,d;if(Pi(),Si(),this.sdkState.isPreviewInProgress)throw mi.GenericErrors.NotReady("JOIN","Preview is in progress, can't join");null==(s=null==(i=this.eventBus)?void 0:i.leave)||s.unsubscribe(this.handlePreviewError),this.analyticsTimer.start("join_time"),this.sdkState.isJoinInProgress=!0;let{roomId:c,userId:u,role:h}=rl(e.authToken),p=(null==(r=null==(n=this.localPeer)?void 0:n.asRole)?void 0:r.name)||(null==(o=null==(a=this.localPeer)?void 0:a.role)?void 0:o.name);null==(l=this.networkTestManager)||l.stop(),this.commonSetup(e,c,t),this.removeDevicesFromConfig(e),this.store.setConfig(e),this.store.createAndSetUserAgent(this.frameworkInfo),Wi.resumeContext();let v=this.store.getConfig();null!=v&&v.autoManageWakeLock&&this.wakeLockManager.acquireLock(),this.localPeer?(this.localPeer.name=e.userName,this.localPeer.role=this.store.getPolicyForRole(h),this.localPeer.customerUserId=u,this.localPeer.metadata=e.metaData,delete this.localPeer.asRole):this.createAndAddLocalPeerToStore(e,h,u),this.roleChangeManager=new Ja(this.store,this.transport,this.deviceManager,this.getAndPublishTracks.bind(this),this.removeTrack.bind(this),this.listener),this.eventBus.localRoleUpdate.subscribe(this.handleLocalRoleUpdate),Yt.d(this.TAG,`\u23f3 Joining room ${c}`),Yt.time(`join-room-${c}`);try{yield this.transport.join(e.authToken,this.localPeer.peerId,{name:e.userName,metaData:e.metaData},e.initEndpoint,e.autoVideoSubscribe,e.iceServers),Yt.d(this.TAG,`\u2705 Joined room ${c}`),this.analyticsTimer.start("peer_list_time"),yield this.notifyJoin(),this.sdkState.isJoinInProgress=!1,yield this.publish(e.settings,p)}catch(qe){throw this.analyticsTimer.end("join_time"),this.sdkState.isJoinInProgress=!1,null==(d=this.listener)||d.onError(qe),this.sendJoinAnalyticsEvent(this.sdkState.isPreviewCalled,qe),Yt.e(this.TAG,"Unable to join room",qe),qe}Yt.timeEnd(`join-room-${c}`)}))}stringifyMetadata(e){e.metaData&&"string"!=typeof e.metaData?e.metaData=JSON.stringify(e.metaData):e.metaData||(e.metaData="")}cleanup(){var e,t,i;this.cleanDeviceManagers(),this.eventBus.analytics.unsubscribe(this.sendAnalyticsEvent),this.eventBus.localVideoUnmutedNatively.unsubscribe(this.unpauseRemoteVideoTracks),this.eventBus.localAudioUnmutedNatively.unsubscribe(this.unpauseRemoteVideoTracks),this.analyticsTimer.cleanup(),Mi.cleanup(),this.playlistManager.cleanup(),null==(e=this.wakeLockManager)||e.cleanup(),xs.cleanup(),this.notificationManager=void 0,Yt.cleanup(),this.sdkState=It({},al),this.localPeer&&(null==(t=this.localPeer.audioTrack)||t.cleanup(),this.localPeer.audioTrack=void 0,null==(i=this.localPeer.videoTrack)||i.cleanup(),this.localPeer.videoTrack=void 0),this.store.cleanup(),this.listener=void 0,this.roleChangeManager&&this.eventBus.localRoleUpdate.unsubscribe(this.handleLocalRoleUpdate)}leave(e){return this.internalLeave(e)}internalLeave(e=!0,t){return Lt(this,null,(function*(){var i,s,n,r;let a=null==(i=this.store)?void 0:i.getRoom();if(a){for(;(this.sdkState.isPreviewInProgress||this.sdkState.isJoinInProgress)&&(null==t||!t.isTerminal);)yield Qi(100);let i=a.id;this.setSessionPeerInfo(this.transport.getWebsocketEndpoint()||"",this.localPeer),null==(s=this.networkTestManager)||s.stop(),this.eventBus.leave.publish(t);let o=null==(n=this.localPeer)?void 0:n.peerId;Yt.d(this.TAG,`\u23f3 Leaving room ${i}, peerId=${o}`),yield null==(r=this.transport)?void 0:r.leave(e),this.cleanup(),Yt.d(this.TAG,`\u2705 Left room ${i}, peerId=${o}`)}}))}getAuthTokenByRoomCode(e,t){return Lt(this,null,(function*(){let i=(t||{}).endpoint||"https://auth.100ms.live/v2/token";this.analyticsTimer.start("GET_TOKEN");let s=yield Va(i,{method:"POST",body:JSON.stringify({code:e.roomCode,user_id:e.userId})},[429,500,501,502,503,504,505,506,507,508,509,510,511]),n=yield s.json();if(this.analyticsTimer.end("GET_TOKEN"),!s.ok)throw mi.APIErrors.ServerErrors(n.code,"GET_TOKEN",n.message,!1);let{token:r}=n;if(!r)throw Error(n.message);return r}))}getLocalPeer(){return this.store.getLocalPeer()}getPeers(){return this.store.getPeers()}getPeerMap(){return this.store.getPeerMap()}getAudioOutput(){return this.audioOutput}sendMessage(e,t){this.sendMessageInternal({message:t,type:e})}sendBroadcastMessage(e,t){return Lt(this,null,(function*(){return yield this.sendMessageInternal({message:e,type:t})}))}sendGroupMessage(e,t,i){return Lt(this,null,(function*(){let s=this.store.getKnownRoles();if(0===(t.filter((e=>s[e.name]))||[]).length)throw mi.GenericErrors.ValidationFailed("No valid role is present",t);return yield this.sendMessageInternal({message:e,recipientRoles:t,type:i})}))}sendDirectMessage(e,t,i){return Lt(this,null,(function*(){var s,n;if((null==(s=this.localPeer)?void 0:s.peerId)===t)throw mi.GenericErrors.ValidationFailed("Cannot send message to self");let r=!(null==(n=this.store.getRoom())||!n.large_room_optimization),a=this.store.getPeerById(t);if(!a){if(!r)throw mi.GenericErrors.ValidationFailed("Invalid peer - peer not present in the room",t);{let e=yield this.transport.signal.getPeer({peer_id:t});if(!e)throw mi.GenericErrors.ValidationFailed("Invalid peer - peer not present in the room",t);a=An(e,this.store)}}return yield this.sendMessageInternal({message:e,recipientPeer:a,type:i})}))}submitSessionFeedback(e,t){return Lt(this,null,(function*(){if(!this.sessionPeerInfo)throw Yt.e(this.TAG,"submitSessionFeedback> session is undefined"),new Error("session is undefined");let i=this.sessionPeerInfo.peer.token;if(!i)throw Yt.e(this.TAG,"submitSessionFeedback> token is undefined"),new Error("Internal error, token is not present");try{yield ro.sendFeedback({token:i,info:this.sessionPeerInfo,feedback:e,eventEndpoint:t}),Yt.i(this.TAG,"submitSessionFeedback> submitted feedback"),this.sessionPeerInfo=void 0}catch(ye){throw Yt.e(this.TAG,"submitSessionFeedback> error occured ",ye),new Error("Unable to submit feedback")}}))}getPeer(e){return Lt(this,null,(function*(){let t=yield this.transport.signal.getPeer({peer_id:e});if(t)return An(t,this.store)}))}findPeerByName(e){return Lt(this,arguments,(function*({query:e,limit:t=10,offset:i}){let{peers:s,offset:n,eof:r}=yield this.transport.signal.findPeerByName({query:null==e?void 0:e.toLowerCase(),limit:t,offset:i});return s.length>0?{offset:n,eof:r,peers:s.map((e=>An({peer_id:e.peer_id,role:e.role,groups:[],info:{name:e.name,data:"",user_id:"",type:e.type}},this.store)))}:{offset:n,peers:[]}}))}sendMessageInternal(e){return Lt(this,arguments,(function*({recipientRoles:e,recipientPeer:t,type:i="chat",message:s}){if(""===s.replace(/\u200b/g," ").trim())throw Yt.w(this.TAG,"sendMessage","Ignoring empty message send"),mi.GenericErrors.ValidationFailed("Empty message not allowed");let n={info:{message:s,type:i}};return null!=e&&e.length&&(n.roles=e.map((e=>e.name))),null!=t&&t.peerId&&(n.peer_id=t.peerId),Yt.d(this.TAG,"Sending Message: ",n),yield this.transport.signal.broadcast(n)}))}startScreenShare(e,t){return Lt(this,null,(function*(){var i,s,n;let r=this.store.getPublishParams();if(!r)return;let{allowed:a}=r;if(!a||!a.includes("screen"))return void Yt.e(this.TAG,`Role ${null==(i=this.localPeer)?void 0:i.role} cannot share screen`);if(null!=(n=null==(s=this.localPeer)?void 0:s.auxiliaryTracks)&&n.find((e=>"screen"===e.source)))throw Error("Cannot share multiple screens");let o=yield this.getScreenshareTracks(e,t);if(!this.localPeer)return Yt.d(this.TAG,"Screenshared when not connected"),void o.forEach((e=>{e.cleanup()}));this.transport.setOnScreenshareStop((()=>{this.stopEndedScreenshare(e)})),yield this.transport.publish(o),o.forEach((e=>{var t,i,s;e.peerId=null==(t=this.localPeer)?void 0:t.peerId,null==(i=this.localPeer)||i.auxiliaryTracks.push(e),null==(s=this.listener)||s.onTrackUpdate(0,e,this.localPeer)}))}))}stopEndedScreenshare(e){return Lt(this,null,(function*(){Yt.d(this.TAG,"\u2705 Screenshare ended natively"),yield this.stopScreenShare(),e()}))}stopScreenShare(){return Lt(this,null,(function*(){var e;Yt.d(this.TAG,"\u2705 Screenshare ended from app");let t=null==(e=this.localPeer)?void 0:e.auxiliaryTracks.filter((e=>"screen"===e.source));if(t)for(let i of t)yield this.removeTrack(i.trackId)}))}addTrack(e,t="regular"){return Lt(this,null,(function*(){var i,s,n,r;if(!e)return void Yt.w(this.TAG,"Please pass a valid MediaStreamTrack");if(!this.localPeer)throw mi.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot addTrack");if(this.localPeer.auxiliaryTracks.find((t=>t.trackId===e.id)))return;let a=e.kind,o=new MediaStream([e]),l=new hn(o),d=new("audio"===a?fs:Bs)(l,e,t,this.eventBus);yield this.applySettings(d),yield this.setPlaylistSettings({track:e,hmsTrack:d,source:t}),yield null==(i=this.transport)?void 0:i.publish([d]),d.peerId=null==(s=this.localPeer)?void 0:s.peerId,null==(n=this.localPeer)||n.auxiliaryTracks.push(d),null==(r=this.listener)||r.onTrackUpdate(0,d,this.localPeer)}))}removeTrack(e,t=!1){return Lt(this,null,(function*(){var i;if(!this.localPeer)throw mi.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot removeTrack");let s=this.localPeer.auxiliaryTracks.findIndex((t=>t.trackId===e));if(s>-1){let e=this.localPeer.auxiliaryTracks[s];e.isPublished?yield this.transport.unpublish([e]):yield e.cleanup(),t||this.stopPlaylist(e),this.localPeer.auxiliaryTracks.splice(s,1),null==(i=this.listener)||i.onTrackUpdate(1,e,this.localPeer)}else Yt.w(this.TAG,`No track found for ${e}`)}))}setAnalyticsLevel(e){this.analyticsEventsService.level=e}setLogLevel(e){Yt.level=e}addAudioListener(e){var t;this.audioListener=e,null==(t=this.notificationManager)||t.setAudioListener(e)}addConnectionQualityListener(e){var t;null==(t=this.notificationManager)||t.setConnectionQualityListener(e)}setIsDiagnostics(e){this.isDiagnostics=e}changeRole(e,t,i=!1){return Lt(this,null,(function*(){var s;yield null==(s=this.transport)?void 0:s.signal.requestRoleChange({requested_for:e,role:t,force:i})}))}changeRoleOfPeer(e,t,i=!1){return Lt(this,null,(function*(){var s;yield null==(s=this.transport)?void 0:s.signal.requestRoleChange({requested_for:e,role:t,force:i})}))}changeRoleOfPeersWithRoles(e,t){return Lt(this,null,(function*(){var i;e.length<=0||!t||(yield null==(i=this.transport)?void 0:i.signal.requestBulkRoleChange({roles:e.map((e=>e.name)),role:t,force:!0}))}))}acceptChangeRole(e){return Lt(this,null,(function*(){var t,i;yield null==(i=this.transport)?void 0:i.signal.acceptRoleChangeRequest({requested_by:null==(t=e.requestedBy)?void 0:t.peerId,role:e.role.name,token:e.token})}))}endRoom(e,t){return Lt(this,null,(function*(){var i;if(!this.localPeer)throw mi.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot end room");yield null==(i=this.transport)?void 0:i.signal.endRoom(e,t),yield this.leave()}))}removePeer(e,t){return Lt(this,null,(function*(){var i;if(!this.localPeer)throw mi.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot remove peer");yield null==(i=this.transport)?void 0:i.signal.removePeer({requested_for:e,reason:t})}))}startRTMPOrRecording(e){return Lt(this,null,(function*(){var t,i;if(!this.localPeer)throw mi.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot start streaming or recording");let s={meeting_url:e.meetingURL,record:e.record};null!=(t=e.rtmpURLs)&&t.length&&(s.rtmp_urls=e.rtmpURLs),e.resolution&&(s.resolution=e.resolution),yield null==(i=this.transport)?void 0:i.signal.startRTMPOrRecording(s)}))}stopRTMPAndRecording(){return Lt(this,null,(function*(){var e;if(!this.localPeer)throw mi.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot stop streaming or recording");yield null==(e=this.transport)?void 0:e.signal.stopRTMPAndRecording()}))}startHLSStreaming(e){return Lt(this,null,(function*(){var t;if(!this.localPeer)throw mi.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot start HLS streaming");let i={};e&&e.variants&&e.variants.length>0&&(i.variants=e.variants.map((e=>{let t={meeting_url:e.meetingURL};return e.metadata&&(t.metadata=e.metadata),t}))),null!=e&&e.recording&&(i.hls_recording={single_file_per_layer:e.recording.singleFilePerLayer,hls_vod:e.recording.hlsVod}),yield null==(t=this.transport)?void 0:t.signal.startHLSStreaming(i)}))}stopHLSStreaming(e){return Lt(this,null,(function*(){var t,i,s;if(!this.localPeer)throw mi.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot stop HLS streaming");if(e){let s={variants:null==(t=null==e?void 0:e.variants)?void 0:t.map((e=>{let t={meeting_url:e.meetingURL};return e.metadata&&(t.metadata=e.metadata),t}))};yield null==(i=this.transport)?void 0:i.signal.stopHLSStreaming(s)}yield null==(s=this.transport)?void 0:s.signal.stopHLSStreaming()}))}startTranscription(e){return Lt(this,null,(function*(){var t;if(!this.localPeer)throw mi.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot start transcriptions");let i={mode:e.mode};yield null==(t=this.transport)?void 0:t.signal.startTranscription(i)}))}stopTranscription(e){return Lt(this,null,(function*(){var t;if(!this.localPeer)throw mi.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot stop transcriptions");if(!e)throw mi.GenericErrors.Signalling("VALIDATION","No mode is passed to stop the transcription");let i={mode:e.mode};yield null==(t=this.transport)?void 0:t.signal.stopTranscription(i)}))}sendHLSTimedMetadata(e){return Lt(this,null,(function*(){var t;if(this.validateJoined("sendHLSTimedMetadata"),e.length>0){let i={metadata_objs:e};yield null==(t=this.transport)?void 0:t.signal.sendHLSTimedMetadata(i)}}))}changeName(e){return Lt(this,null,(function*(){var t,i;this.validateJoined("changeName");let s=this.store.getLocalPeer();s&&s.name!==e&&(yield null==(t=this.transport)?void 0:t.signal.updatePeer({name:e}),null==(i=this.notificationManager)||i.updateLocalPeer({name:e}))}))}changeMetadata(e){return Lt(this,null,(function*(){var t,i;this.validateJoined("changeMetadata"),yield null==(t=this.transport)?void 0:t.signal.updatePeer({data:e}),null==(i=this.notificationManager)||i.updateLocalPeer({metadata:e})}))}setSessionMetadata(e){return Lt(this,null,(function*(){var t;yield null==(t=this.transport)?void 0:t.signal.setSessionMetadata({key:"default",data:e})}))}getSessionMetadata(){return Lt(this,null,(function*(){var e;return(yield null==(e=this.transport)?void 0:e.signal.getSessionMetadata("default")).data}))}getRoles(){return Object.values(this.store.getKnownRoles())}changeTrackState(e,t){return Lt(this,null,(function*(){var i;if("video"===e.type&&"regular"!==e.source)return void Yt.w(this.TAG,"Muting non-regular video tracks is currently not supported");if(e.enabled===t)return void Yt.w(this.TAG,`Aborting change track state, track already has enabled - ${t}`,e);if(!this.store.getTrackById(e.trackId))throw mi.GenericErrors.ValidationFailed("No track found for change track state",e);let s=this.store.getPeerByTrackId(e.trackId);if(!s)throw mi.GenericErrors.ValidationFailed("No peer found for change track state",e);yield null==(i=this.transport)?void 0:i.signal.requestTrackStateChange({requested_for:s.peerId,track_id:e.trackId,stream_id:e.stream.id,mute:!t})}))}changeMultiTrackState(e){return Lt(this,null,(function*(){var t;if("boolean"!=typeof e.enabled)throw mi.GenericErrors.ValidationFailed("Pass a boolean for enabled");let{enabled:i,roles:s,type:n,source:r}=e;yield null==(t=this.transport)?void 0:t.signal.requestMultiTrackStateChange({value:!i,type:n,source:r,roles:null==s?void 0:s.map((e=>null==e?void 0:e.name))})}))}raiseLocalPeerHand(){return Lt(this,null,(function*(){var e;this.validateJoined("raiseLocalPeerHand"),yield null==(e=this.transport)?void 0:e.signal.joinGroup(dn)}))}lowerLocalPeerHand(){return Lt(this,null,(function*(){var e;this.validateJoined("lowerLocalPeerHand"),yield null==(e=this.transport)?void 0:e.signal.leaveGroup(dn)}))}raiseRemotePeerHand(e){return Lt(this,null,(function*(){var t;yield null==(t=this.transport)?void 0:t.signal.addToGroup(e,dn)}))}lowerRemotePeerHand(e){return Lt(this,null,(function*(){var t;yield null==(t=this.transport)?void 0:t.signal.removeFromGroup(e,dn)}))}setFrameworkInfo(e){this.frameworkInfo=It(It({},this.frameworkInfo),e)}attachVideo(e,t){return Lt(this,null,(function*(){let i=this.store.getConfig();null!=i&&i.autoManageVideo?e.attach(t):yield e.addSink(t)}))}detachVideo(e,t){return Lt(this,null,(function*(){let i=this.store.getConfig();null!=i&&i.autoManageVideo?e.detach(t):yield e.removeSink(t)}))}publish(e,t){return Lt(this,null,(function*(){var i,s,n;if([this.store.getPublishParams(),!this.sdkState.published,!ai].every((e=>!!e))){let r=t&&t!==(null==(s=null==(i=this.localPeer)?void 0:i.role)?void 0:s.name)?()=>{var e;return null==(e=this.roleChangeManager)?void 0:e.diffRolesAndPublishTracks({oldRole:this.store.getPolicyForRole(t),newRole:this.localPeer.role})}:()=>this.getAndPublishTracks(e);yield null==(n=null==r?void 0:r())?void 0:n.catch((e=>{var t;Yt.e(this.TAG,"Error in publish",e),null==(t=this.listener)||t.onError(e)}))}}))}getAndPublishTracks(e){return Lt(this,null,(function*(){var t,i;let s=yield this.localTrackManager.getTracksToPublish(e);yield this.setAndPublishTracks(s),null==(i=null==(t=this.localPeer)?void 0:t.audioTrack)||i.initAudioLevelMonitor(),this.sdkState.published=!0}))}setAndPublishTracks(e){return Lt(this,null,(function*(){var t,i;for(let s of e){if(yield this.transport.publish([s]),s.isTrackNotPublishing()){let e=mi.TracksErrors.NoDataInTrack(`${s.type} track has no data. muted: ${s.nativeTrack.muted}, readyState: ${s.nativeTrack.readyState}`);Yt.e(this.TAG,e),this.sendAnalyticsEvent(Ri.publish({devices:this.deviceManager.getDevices(),error:e})),null==(t=this.listener)||t.onError(e)}this.setLocalPeerTrack(s),null==(i=this.listener)||i.onTrackUpdate(0,s,this.localPeer)}yield this.initDeviceManagers()}))}setLocalPeerTrack(e){var t;switch(e.peerId=null==(t=this.localPeer)?void 0:t.peerId,e.type){case"audio":this.localPeer.audioTrack=e;break;case"video":this.localPeer.videoTrack=e}}initDeviceManagers(){return Lt(this,null,(function*(){var e,t,i,s,n;this.sdkState.deviceManagersInitialised||(this.sdkState.deviceManagersInitialised=!0,yield this.deviceManager.init(),(yield this.deviceManager.updateOutputDevice(null==(t=null==(e=this.store.getConfig())?void 0:e.settings)?void 0:t.audioOutputDeviceId))||(yield this.deviceManager.updateOutputDevice(null==(s=null==(i=Mi.getSelection())?void 0:i.audioOutput)?void 0:s.deviceId)),this.audioSinkManager.init(null==(n=this.store.getConfig())?void 0:n.audioSinkElementId))}))}cleanDeviceManagers(){this.eventBus.deviceChange.unsubscribe(this.handleDeviceChange),this.eventBus.audioPluginFailed.unsubscribe(this.handleAudioPluginError),this.eventBus.autoplayError.unsubscribe(this.handleAutoplayError),this.deviceManager.cleanup(),this.audioSinkManager.cleanup()}initPreviewTrackAudioLevelMonitor(){var e;let t=null==(e=this.localPeer)?void 0:e.audioTrack;null==t||t.initAudioLevelMonitor(),this.eventBus.trackAudioLevelUpdate.subscribe((e=>{var i;let s=e&&e.track.trackId===(null==t?void 0:t.trackId)?[{audioLevel:e.audioLevel,peer:this.localPeer,track:t}]:[];this.store.updateSpeakers(s),null==(i=this.audioListener)||i.onAudioLevelUpdate(s)})),this.eventBus.localAudioSilence.subscribe(this.sendAudioPresenceFailed)}notifyJoin(){var e;let t=this.store.getLocalPeer(),i=this.store.getRoom();if(i)return i.joinedAt=new Date,t&&(t.joinedAt=i.joinedAt),null!=t&&t.role?(this.analyticsTimer.end("join_time"),void(null==(e=this.listener)||e.onJoin(i))):new Promise(((e,t)=>{this.eventBus.policyChange.subscribeOnce((()=>{var t;this.analyticsTimer.end("join_time"),null==(t=this.listener)||t.onJoin(i),e()})),this.eventBus.leave.subscribeOnce((e=>{t(e)}))}));Yt.w(this.TAG,"notify join - room not present")}setUpPreview(e,t){this.sdkState.isPreviewCalled=!0,this.sdkState.isPreviewInProgress=!0;let{roomId:i,userId:s,role:n}=rl(e.authToken);this.commonSetup(e,i,t),this.store.setConfig(e),this.store.createAndSetUserAgent(this.frameworkInfo),this.createAndAddLocalPeerToStore(e,n,s,e.asRole)}setPlaylistSettings(e){return Lt(this,arguments,(function*({track:e,hmsTrack:t,source:i}){var s,n;if("videoplaylist"===i){let i={};if("audio"===e.kind)i.maxBitrate=(null==(s=this.playlistSettings.audio)?void 0:s.bitrate)||64;else{i.maxBitrate=(null==(n=this.playlistSettings.video)?void 0:n.bitrate)||1e3;let{width:t,height:s}=e.getSettings();i.width=t,i.height=s}yield t.setSettings(i)}else"audioplaylist"===i&&(yield t.setSettings({maxBitrate:64}))}))}createAndAddLocalPeerToStore(e,t,i,s){let n=this.store.getPolicyForRole(t),r=s?this.store.getPolicyForRole(s):void 0,a=new wn({name:e.userName||"",customerUserId:i,metadata:e.metaData||"",role:n,asRole:r||n,type:"regular"});this.store.addPeer(a)}commonSetup(e,t,i){this.stringifyMetadata(e),e.initEndpoint||(e.initEndpoint="https://prod-init.100ms.live"),this.initStoreAndManagers(i),this.store.getRoom()||this.store.setRoom(new ja(t))}removeDevicesFromConfig(e){this.store.getConfig()&&e.settings&&(delete e.settings.audioOutputDeviceId,delete e.settings.videoDeviceId,delete e.settings.audioInputDeviceId)}getScreenshareTracks(e,t){return Lt(this,null,(function*(){let i=this.transport.isFlagEnabled("scaleScreenshareBasedOnPixels"),[s,n]=yield this.localTrackManager.getLocalScreen(t,i),r=()=>{this.stopEndedScreenshare(e)},a=[];if(null!=t&&t.audioOnly){if(s.nativeTrack.stop(),!n)throw mi.TracksErrors.NothingToReturn("TRACK","Select share audio when sharing screen","No audio found");a.push(n),n.nativeTrack.addEventListener("ended",r)}else a.push(s),s.nativeTrack.addEventListener("ended",r),n&&a.push(n);return a}))}stopPlaylist(e){"audioplaylist"===e.source?this.playlistManager.stop("audio"):"videoplaylist"===e.source&&this.playlistManager.stop("video")}applySettings(e){return Lt(this,null,(function*(){(e=>{if(!e.getPublishParams())throw mi.GenericErrors.NotConnected("VALIDATION","call addTrack after preview or join is successful")})(this.store);let t=this.store.getPublishParams();if(t)if(e instanceof Bs){let i="regular"===e.source?"video":"screen"===e.source?"screen":"";if(!i||!t.allowed.includes(i))return;let s=t[i];if(!s)return;let n=(new cs).codec(s.codec).maxBitrate(s.bitRate).maxFramerate(s.frameRate).setWidth(s.width).setHeight(s.height).build();yield e.setSettings(n)}else if(e instanceof fs){if(!t.allowed.includes("audio"))return;let i=(new ls).codec(t.audio.codec).maxBitrate(t.audio.bitRate).build();yield e.setSettings(i)}}))}},ll=class e{constructor(t,i,s){this.getStats=()=>(this.stats||(this.stats=new pl(this.store,this.sdk)),this.stats),this.getDiagnosticsSDK=()=>(this.diagnostics||(this.diagnostics=this.actions.initDiagnostics()),this.diagnostics),this.store=t||e.createNewHMSStore(qa("HMSStore"),Nt),this.notifications=s||new Ta(this.store),i?this.actions=i:(this.sdk=new ol,this.actions=new Ha(this.store,this.sdk,this.notifications)),this.actions.setFrameworkInfo({type:"js",sdkVersion:Dt().version}),this.initialTriggerOnSubscribe=!1,ri&&(window.__hms=this)}triggerOnSubscribe(){this.initialTriggerOnSubscribe||(e.makeStoreTriggerOnSubscribe(this.store),this.initialTriggerOnSubscribe=!0)}getStore(){return this.store}getHMSActions(){return this.actions}getActions(){return this.actions}getNotifications(){return{onNotification:this.notifications.onNotification}}static createNewHMSStore(t,i){let s=mt((()=>i())),n=s.setState;s.setState=e=>{let t="function"==typeof e?vt(e):e;n(t)};let r=s.getState;s.getState=e=>e?e(r()):r(),e.compareWithShallowCheckInSubscribe(s);let a=e.setUpDevtools(s,t);return At(It({},s),{namedSetState:a})}static makeStoreTriggerOnSubscribe(e){let t=e.subscribe;e.subscribe=(i,s,n)=>(i(e.getState(s),void 0),t(i,s,n))}static compareWithShallowCheckInSubscribe(e){let t=e.subscribe;e.subscribe=(e,i,s)=>(i||(i=e=>e),t(e,i,s=s||gt))}static setUpDevtools(t,i){let s;try{s=window.__REDUX_DEVTOOLS_EXTENSION__||window.top.__REDUX_DEVTOOLS_EXTENSION__}catch(be){}if(!s)return e=>{t.setState(e)};let n=s.connect(e.devtoolsOptions(i));n.prefix=i?`${i} > `:"";let r=t.setState;return t.setState=e=>{r(e),n.send(`${n.prefix}setState`,t.getState())},n.subscribe(e.devtoolsSubscribe(n,t,r)),n.send("setUpStore",t.getState()),(e,i)=>{r(e);let s=i||`${n.prefix}action`;n.send(s,t.getState())}}static devtoolsOptions(e){return{name:e,actionsBlacklist:["audioLevel","playlistProgress","connectionQuality"]}}static devtoolsSubscribe(e,t,i){return s=>{var n,r,a,o;if("DISPATCH"===s.type&&s.state)["JUMP_TO_ACTION","JUMP_TO_STATE"].includes(s.payload.type)?i(JSON.parse(s.state)):t.setState(JSON.parse(s.state));else if("DISPATCH"===s.type&&"COMMIT"===(null==(n=s.payload)?void 0:n.type))e.init(t.getState());else if("DISPATCH"===s.type&&"IMPORT_STATE"===(null==(r=s.payload)?void 0:r.type)){let n=null==(a=s.payload.nextLiftedState)?void 0:a.actionsById;((null==(o=s.payload.nextLiftedState)?void 0:o.computedStates)||[]).forEach((({state:s},r)=>{let a=n[r]||`${e.prefix}setState`;0===r?e.init(s):(i(s),e.send(a,t.getState()))}))}}}},dl=(e,t,i)=>{var s,n;let r=cl(i,t);null==(s=e.getWebrtcInternals())||s.start();let a=null==(n=e.getWebrtcInternals())?void 0:n.onStatsChange((s=>ul(t,s,i,e)));return()=>{r(),a&&a()}},cl=(e,t)=>{let i,s,n;return e.getState(zn)?t.namedSetState((t=>{t.localPeer.id=e.getState(zn)}),"localpeer-id"):i=e.subscribe((e=>{e&&t.namedSetState((t=>{t.localPeer.id=e}),"localpeer-id")}),zn),e.getState(Yn)?t.namedSetState((t=>{t.localPeer.videoTrack=e.getState(Yn)}),"localpeer-videotrack-id"):s=e.subscribe((e=>{e&&t.namedSetState((t=>{t.localPeer.videoTrack=e}),"localpeer-videotrack-id")}),Yn),e.getState(Qn)?t.namedSetState((t=>{t.localPeer.audioTrack=e.getState(Qn)}),"localpeer-audiotrack-id"):n=e.subscribe((e=>{e&&t.namedSetState((t=>{t.localPeer.audioTrack=e}),"localpeer-audiotrack-id")}),Qn),()=>{null==i||i(),null==s||s(),null==n||n()}},ul=(e,t,i,s)=>{let n=i.getState($n);e.namedSetState((e=>{let r=i.getState(zn),a={},o=Object.keys(n).filter((e=>n[e].peerId!==r));for(let i of o){let e=t.getRemoteTrackStats(i);e&&(a[i]=e)}Ea(e.remoteTrackStats,a);let l={[r]:t.getLocalPeerStats()};Ea(e.peerStats,l),((e,t,i)=>{let s=i.reduce(((e,i)=>(e[i.firstTrackId]=Object.values(t[i.getTrackIDBeingSent()]||{}).sort(((e,t)=>e.rid&&t.rid?e.rid<t.rid?-1:1:0)),e)),{}),n=_a(Object.keys(e),Object.keys(s));for(let r of n)s[r]?e[r]=s[r]:delete e[r]})(e.localTrackStats,t.getLocalTrackStats(),s.store.getLocalPeerTracks())}),"webrtc-stats")},hl=(e,t="resetState")=>{e.namedSetState((e=>{Object.assign(e,{peerStats:{},remoteTrackStats:{},localTrackStats:{},localPeer:{id:""}})}),t)},pl=class{constructor(e,t){this.hmsStore=e,this.sdk=t,this.store=ll.createNewHMSStore(qa("HMSStatsStore"),Ot),this.getState=this.store.getState,this.subscribe=this.store.subscribe,this.getPublishPeerConnection=()=>new Promise((e=>{var t,i;"Connected"===this.hmsStore.getState(dr)?e(null==(i=null==(t=this.sdk)?void 0:t.getWebrtcInternals())?void 0:i.getPublishPeerConnection()):this.hmsStore.subscribe((t=>{var i,s;"Connected"===t&&e(null==(s=null==(i=this.sdk)?void 0:i.getWebrtcInternals())?void 0:s.getPublishPeerConnection())}),dr)})),this.getSubscribePeerConnection=()=>new Promise((e=>{var t,i;"Connected"===this.hmsStore.getState(dr)?e(null==(i=null==(t=this.sdk)?void 0:t.getWebrtcInternals())?void 0:i.getSubscribePeerConnection()):this.hmsStore.subscribe((t=>{var i,s;"Connected"===t&&e(null==(s=null==(i=this.sdk)?void 0:i.getWebrtcInternals())?void 0:s.getSubscribePeerConnection())}),dr)})),this.sdk&&((e,t,i)=>{let s;"Connected"===i.getState(dr)&&(s=dl(e,t,i)),i.subscribe((n=>{["Connected","Reconnecting"].includes(n)?s||(s=dl(e,t,i)):["Disconnected","Failed"].includes(n)&&s&&(hl(t,n),s(),s=void 0)}),dr)})(this.sdk,this.store,this.hmsStore)}},vl=(e,t)=>t,gl=e=>e.peerStats,ml=e=>e.localTrackStats,fl=(0,o.P1)([gl,e=>e.localPeer.id],((e,t)=>e[t])),yl=((0,o.P1)(fl,(e=>{var t;return null==(t=null==e?void 0:e.subscribe)?void 0:t.packetsLost})),(0,o.P1)(fl,(e=>{var t;return null==(t=null==e?void 0:e.subscribe)?void 0:t.jitter})),(0,o.P1)(fl,(e=>{var t;return null==(t=null==e?void 0:e.publish)?void 0:t.bitrate})),(0,o.P1)(fl,(e=>{var t;return null==(t=null==e?void 0:e.subscribe)?void 0:t.bitrate})),(0,o.P1)(fl,(e=>{var t;return null==(t=null==e?void 0:e.publish)?void 0:t.availableOutgoingBitrate})),(0,o.P1)(fl,(e=>{var t;return null==(t=null==e?void 0:e.subscribe)?void 0:t.availableIncomingBitrate})),(0,o.P1)(fl,(e=>{var t;return null==(t=null==e?void 0:e.publish)?void 0:t.bytesSent})),(0,o.P1)(fl,(e=>{var t;return null==(t=null==e?void 0:e.subscribe)?void 0:t.bytesReceived})),(0,o.P1)([gl,(e,t)=>t],((e,t)=>t?e[t]:void 0))),kl=(0,o.P1)([e=>e.remoteTrackStats,vl],((e,t)=>t?e[t]:void 0)),Tl=(0,o.P1)([ml,vl],((e,t)=>t?e[t]:void 0));Rr(yl),Rr(kl),(0,o.P1)([ml,e=>e.localPeer.audioTrack],((e,t)=>{var i;return t?null==(i=e[t])?void 0:i[0]:void 0})),Rr((0,o.P1)(Tl,(e=>null==e?void 0:e[0]))),(0,o.P1)([ml,e=>e.localPeer.videoTrack],((e,t)=>{var i;return t?null==(i=e[t])?void 0:i[0]:void 0})),Rr((0,o.P1)(Tl,(e=>e)))},20531:function(e,t,i){var s;!function(n,r){"use strict";var a="function",o="undefined",l="object",d="string",c="major",u="model",h="name",p="type",v="vendor",g="version",m="architecture",f="console",y="mobile",k="tablet",T="smarttv",b="wearable",S="embedded",P="Amazon",E="Apple",C="ASUS",w="BlackBerry",I="Browser",A="Chrome",R="Firefox",_="Google",L="Huawei",D="LG",M="Microsoft",N="Motorola",O="Opera",x="Samsung",U="Sharp",B="Sony",F="Xiaomi",G="Zebra",$="Facebook",j="Chromium OS",V="Mac OS",W=function(e){for(var t={},i=0;i<e.length;i++)t[e[i].toUpperCase()]=e[i];return t},H=function(e,t){return typeof e===d&&-1!==q(t).indexOf(q(e))},q=function(e){return e.toLowerCase()},K=function(e,t){if(typeof e===d)return e=e.replace(/^\s\s*/,""),typeof t===o?e:e.substring(0,350)},J=function(e,t){for(var i,s,n,o,d,c,u=0;u<t.length&&!d;){var h=t[u],p=t[u+1];for(i=s=0;i<h.length&&!d&&h[i];)if(d=h[i++].exec(e))for(n=0;n<p.length;n++)c=d[++s],typeof(o=p[n])===l&&o.length>0?2===o.length?typeof o[1]==a?this[o[0]]=o[1].call(this,c):this[o[0]]=o[1]:3===o.length?typeof o[1]!==a||o[1].exec&&o[1].test?this[o[0]]=c?c.replace(o[1],o[2]):r:this[o[0]]=c?o[1].call(this,c,o[2]):r:4===o.length&&(this[o[0]]=c?o[3].call(this,c.replace(o[1],o[2])):r):this[o]=c||r;u+=2}},z=function(e,t){for(var i in t)if(typeof t[i]===l&&t[i].length>0){for(var s=0;s<t[i].length;s++)if(H(t[i][s],e))return"?"===i?r:i}else if(H(t[i],e))return"?"===i?r:i;return e},Q={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},Y={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[g,[h,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[g,[h,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[h,g],[/opios[\/ ]+([\w\.]+)/i],[g,[h,O+" Mini"]],[/\bopr\/([\w\.]+)/i],[g,[h,O]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(heytap|ovi)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[h,g],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[g,[h,"UC"+I]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[g,[h,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[g,[h,"WeChat"]],[/konqueror\/([\w\.]+)/i],[g,[h,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[g,[h,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[g,[h,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[h,/(.+)/,"$1 Secure "+I],g],[/\bfocus\/([\w\.]+)/i],[g,[h,R+" Focus"]],[/\bopt\/([\w\.]+)/i],[g,[h,O+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[g,[h,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[g,[h,"Dolphin"]],[/coast\/([\w\.]+)/i],[g,[h,O+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[g,[h,"MIUI "+I]],[/fxios\/([-\w\.]+)/i],[g,[h,R]],[/\bqihu|(qi?ho?o?|360)browser/i],[[h,"360 "+I]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[h,/(.+)/,"$1 "+I],g],[/(comodo_dragon)\/([\w\.]+)/i],[[h,/_/g," "],g],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[h,g],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[h],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[h,$],g],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[h,g],[/\bgsa\/([\w\.]+) .*safari\//i],[g,[h,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[g,[h,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[g,[h,A+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[h,A+" WebView"],g],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[g,[h,"Android "+I]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[h,g],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[g,[h,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[g,h],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[h,[g,z,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[h,g],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[h,"Netscape"],g],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[g,[h,R+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[h,g],[/(cobalt)\/([\w\.]+)/i],[h,[g,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[m,"amd64"]],[/(ia32(?=;))/i],[[m,q]],[/((?:i[346]|x)86)[;\)]/i],[[m,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[m,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[m,"armhf"]],[/windows (ce|mobile); ppc;/i],[[m,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[m,/ower/,"",q]],[/(sun4\w)[;\)]/i],[[m,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[m,q]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[u,[v,x],[p,k]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[u,[v,x],[p,y]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[u,[v,E],[p,y]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[u,[v,E],[p,k]],[/(macintosh);/i],[u,[v,E]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[u,[v,U],[p,y]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[u,[v,L],[p,k]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[u,[v,L],[p,y]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[u,/_/g," "],[v,F],[p,y]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[u,/_/g," "],[v,F],[p,k]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[u,[v,"OPPO"],[p,y]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[u,[v,"Vivo"],[p,y]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[u,[v,"Realme"],[p,y]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[u,[v,N],[p,y]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[u,[v,N],[p,k]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[u,[v,D],[p,k]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[u,[v,D],[p,y]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[u,[v,"Lenovo"],[p,k]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[u,/_/g," "],[v,"Nokia"],[p,y]],[/(pixel c)\b/i],[u,[v,_],[p,k]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[u,[v,_],[p,y]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[u,[v,B],[p,y]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[u,"Xperia Tablet"],[v,B],[p,k]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[u,[v,"OnePlus"],[p,y]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo[c-r]{2})( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[u,[v,P],[p,k]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[u,/(.+)/g,"Fire Phone $1"],[v,P],[p,y]],[/(playbook);[-\w\),; ]+(rim)/i],[u,v,[p,k]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[u,[v,w],[p,y]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[u,[v,C],[p,k]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[u,[v,C],[p,y]],[/(nexus 9)/i],[u,[v,"HTC"],[p,k]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[v,[u,/_/g," "],[p,y]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[u,[v,"Acer"],[p,k]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[u,[v,"Meizu"],[p,y]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[v,u,[p,y]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[v,u,[p,k]],[/(surface duo)/i],[u,[v,M],[p,k]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[u,[v,"Fairphone"],[p,y]],[/(u304aa)/i],[u,[v,"AT&T"],[p,y]],[/\bsie-(\w*)/i],[u,[v,"Siemens"],[p,y]],[/\b(rct\w+) b/i],[u,[v,"RCA"],[p,k]],[/\b(venue[\d ]{2,7}) b/i],[u,[v,"Dell"],[p,k]],[/\b(q(?:mv|ta)\w+) b/i],[u,[v,"Verizon"],[p,k]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[u,[v,"Barnes & Noble"],[p,k]],[/\b(tm\d{3}\w+) b/i],[u,[v,"NuVision"],[p,k]],[/\b(k88) b/i],[u,[v,"ZTE"],[p,k]],[/\b(nx\d{3}j) b/i],[u,[v,"ZTE"],[p,y]],[/\b(gen\d{3}) b.+49h/i],[u,[v,"Swiss"],[p,y]],[/\b(zur\d{3}) b/i],[u,[v,"Swiss"],[p,k]],[/\b((zeki)?tb.*\b) b/i],[u,[v,"Zeki"],[p,k]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[v,"Dragon Touch"],u,[p,k]],[/\b(ns-?\w{0,9}) b/i],[u,[v,"Insignia"],[p,k]],[/\b((nxa|next)-?\w{0,9}) b/i],[u,[v,"NextBook"],[p,k]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[v,"Voice"],u,[p,y]],[/\b(lvtel\-)?(v1[12]) b/i],[[v,"LvTel"],u,[p,y]],[/\b(ph-1) /i],[u,[v,"Essential"],[p,y]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[u,[v,"Envizen"],[p,k]],[/\b(trio[-\w\. ]+) b/i],[u,[v,"MachSpeed"],[p,k]],[/\btu_(1491) b/i],[u,[v,"Rotor"],[p,k]],[/(shield[\w ]+) b/i],[u,[v,"Nvidia"],[p,k]],[/(sprint) (\w+)/i],[v,u,[p,y]],[/(kin\.[onetw]{3})/i],[[u,/\./g," "],[v,M],[p,y]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[u,[v,G],[p,k]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[u,[v,G],[p,y]],[/smart-tv.+(samsung)/i],[v,[p,T]],[/hbbtv.+maple;(\d+)/i],[[u,/^/,"SmartTV"],[v,x],[p,T]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[v,D],[p,T]],[/(apple) ?tv/i],[v,[u,E+" TV"],[p,T]],[/crkey/i],[[u,A+"cast"],[v,_],[p,T]],[/droid.+aft(\w)( bui|\))/i],[u,[v,P],[p,T]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[u,[v,U],[p,T]],[/(bravia[\w ]+)( bui|\))/i],[u,[v,B],[p,T]],[/(mitv-\w{5}) bui/i],[u,[v,F],[p,T]],[/Hbbtv.*(technisat) (.*);/i],[v,u,[p,T]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[v,K],[u,K],[p,T]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[p,T]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[v,u,[p,f]],[/droid.+; (shield) bui/i],[u,[v,"Nvidia"],[p,f]],[/(playstation [345portablevi]+)/i],[u,[v,B],[p,f]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[u,[v,M],[p,f]],[/((pebble))app/i],[v,u,[p,b]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[u,[v,E],[p,b]],[/droid.+; (glass) \d/i],[u,[v,_],[p,b]],[/droid.+; (wt63?0{2,3})\)/i],[u,[v,G],[p,b]],[/(quest( 2| pro)?)/i],[u,[v,$],[p,b]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[v,[p,S]],[/(aeobc)\b/i],[u,[v,P],[p,S]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[u,[p,y]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[u,[p,k]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[p,k]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[p,y]],[/(android[-\w\. ]{0,9});.+buil/i],[u,[v,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[g,[h,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[g,[h,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[h,g],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[g,h]],os:[[/microsoft (windows) (vista|xp)/i],[h,g],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[h,[g,z,Q]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[h,"Windows"],[g,z,Q]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/ios;fbsv\/([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[g,/_/g,"."],[h,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[h,V],[g,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[g,h],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[h,g],[/\(bb(10);/i],[g,[h,w]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[g,[h,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[g,[h,R+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[g,[h,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[g,[h,"watchOS"]],[/crkey\/([\d\.]+)/i],[g,[h,A+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[h,j],g],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[h,g],[/(sunos) ?([\w\.\d]*)/i],[[h,"Solaris"],g],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[h,g]]},Z=function(e,t){if(typeof e===l&&(t=e,e=r),!(this instanceof Z))return new Z(e,t).getResult();var i=typeof n!==o&&n.navigator?n.navigator:r,s=e||(i&&i.userAgent?i.userAgent:""),f=i&&i.userAgentData?i.userAgentData:r,T=t?function(e,t){var i={};for(var s in e)t[s]&&t[s].length%2===0?i[s]=t[s].concat(e[s]):i[s]=e[s];return i}(Y,t):Y,b=i&&i.userAgent==s;return this.getBrowser=function(){var e,t={};return t[h]=r,t[g]=r,J.call(t,s,T.browser),t[c]=typeof(e=t[g])===d?e.replace(/[^\d\.]/g,"").split(".")[0]:r,b&&i&&i.brave&&typeof i.brave.isBrave==a&&(t[h]="Brave"),t},this.getCPU=function(){var e={};return e[m]=r,J.call(e,s,T.cpu),e},this.getDevice=function(){var e={};return e[v]=r,e[u]=r,e[p]=r,J.call(e,s,T.device),b&&!e[p]&&f&&f.mobile&&(e[p]=y),b&&"Macintosh"==e[u]&&i&&typeof i.standalone!==o&&i.maxTouchPoints&&i.maxTouchPoints>2&&(e[u]="iPad",e[p]=k),e},this.getEngine=function(){var e={};return e[h]=r,e[g]=r,J.call(e,s,T.engine),e},this.getOS=function(){var e={};return e[h]=r,e[g]=r,J.call(e,s,T.os),b&&!e[h]&&f&&"Unknown"!=f.platform&&(e[h]=f.platform.replace(/chrome os/i,j).replace(/macos/i,V)),e},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return s},this.setUA=function(e){return s=typeof e===d&&e.length>350?K(e,350):e,this},this.setUA(s),this};Z.VERSION="1.0.35",Z.BROWSER=W([h,g,c]),Z.CPU=W([m]),Z.DEVICE=W([u,v,p,f,y,T,k,b,S]),Z.ENGINE=Z.OS=W([h,g]),typeof t!==o?(e.exports&&(t=e.exports=Z),t.UAParser=Z):i.amdO?(s=function(){return Z}.call(t,i,t,e))===r||(e.exports=s):typeof n!==o&&(n.UAParser=Z);var X=typeof n!==o&&(n.jQuery||n.Zepto);if(X&&!X.ua){var ee=new Z;X.ua=ee.getResult(),X.ua.get=function(){return ee.getUA()},X.ua.set=function(e){ee.setUA(e);var t=ee.getResult();for(var i in t)X.ua[i]=t[i]}}}("object"===typeof window?window:this)},93914:(e,t,i)=>{"use strict";i.d(t,{j:()=>d});var s=i(59933),n=i(67294),r=i(84895),a=i(85783),o=i(13273);const l=(e,t)=>o.Z.e("react-sdk",t,e);["blink"].some((e=>{var t,i;return(null===(i=null===(t=r.eC.getEngine())||void 0===t?void 0:t.name)||void 0===i?void 0:i.toLowerCase())===e}));const d=({type:e,json:t=!0,onEvent:i,handleError:o=l})=>{const d=(0,a.cw)(),c=(0,a.mV)();return(0,n.useEffect)((()=>{d.ignoreMessageTypes([e])}),[d,e]),(0,n.useEffect)((()=>{if(c)return c.onNotification((s=>{const n=s.data;if(n&&n.type===e)try{const e=t?JSON.parse(n.message):n.message;null==i||i(e)}catch(s){o(s,"handleCustomEvent")}}),r.a5.NEW_MESSAGE)}),[c,e,t,i,o]),{sendEvent:(0,n.useCallback)(((n,r)=>(0,s.m)(void 0,void 0,void 0,(function*(){try{const s=((e,t)=>t?JSON.stringify(e||""):e)(n,t);r&&Array.isArray(null==r?void 0:r.roleNames)?yield d.sendGroupMessage(s,r.roleNames,e):"string"==typeof(null==r?void 0:r.peerId)?yield d.sendDirectMessage(s,r.peerId,e):yield d.sendBroadcastMessage(s,e),null==i||i(n)}catch(s){o(s,"sendCustomEvent")}}))),[d,o,i,e,t])}}},53939:(e,t,i)=>{"use strict";i.d(t,{Z:()=>a});var s=i(67294),n=i(85783);const r=e=>e.reduce(((e,t)=>(e[t.id]=t,e)),{}),a=e=>{const t=(0,n.cw)(),i=(0,s.useRef)(t.getPeerListIterator(e)),[a,o]=(0,s.useState)({}),[l,d]=(0,s.useState)(0);return{loadPeers:()=>i.current.findPeers().then((e=>{o(r(e)),d(i.current.getTotal())})),loadMorePeers:()=>i.current.next().then((e=>{o((t=>Object.assign(Object.assign({},t),r(e)))),d(i.current.getTotal())})),hasNext:()=>i.current.hasNext(),total:l,peers:Object.values(a)}}},87116:(e,t,i)=>{"use strict";i.d(t,{R:()=>l});var s=i(59933),n=i(67294),r=i(84895),a=i(85783),o=i(13273);const l=({trackId:e,attach:t})=>{const i=(0,a.cw)(),l=(0,n.useRef)(null),d=(0,a._U)((0,r.GP)(e)),c=(0,n.useRef)(),u=(0,n.useCallback)((e=>{e&&(l.current=e)}),[]);return(0,n.useEffect)((()=>{c.current?(null==d?void 0:d.id)&&c.current!==(null==d?void 0:d.id)&&(0,s.m)(void 0,void 0,void 0,(function*(){if(l.current)try{o.Z.d("detaching because different track is passed"),yield i.detachVideo(c.current,l.current)}catch(e){o.Z.w("detach video error for track",c.current,e)}c.current=null==d?void 0:d.id})):c.current=null==d?void 0:d.id}),[null==d?void 0:d.id,i]),(0,n.useEffect)((()=>{(0,s.m)(void 0,void 0,void 0,(function*(){(null==d?void 0:d.id)&&l.current&&(!1!==t?yield i.attachVideo(d.id,l.current):yield i.detachVideo(d.id,l.current))}))}),[d,t,i]),(0,n.useEffect)((()=>()=>{(0,s.m)(void 0,void 0,void 0,(function*(){if(l.current&&d)try{yield i.detachVideo(d.id,l.current)}catch(e){o.Z.w("detach video error for track",d.id,e)}}))}),[]),{videoRef:u}}},59933:(e,t,i)=>{"use strict";function s(e,t,i,s){return new(i||(i=Promise))((function(n,r){function a(e){try{l(s.next(e))}catch(e){r(e)}}function o(e){try{l(s.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}l((s=s.apply(e,t||[])).next())}))}i.d(t,{m:()=>s}),"function"==typeof SuppressedError&&SuppressedError},85783:(e,t,i)=>{"use strict";i.d(t,{dx:()=>p,cw:()=>m,C1:()=>f,_U:()=>v,mV:()=>g});var s=i(67294);function n(e){let t;const i=new Set,s=(e,s)=>{const n="function"===typeof e?e(t):e;if(n!==t){const e=t;t=s?n:Object.assign({},t,n),i.forEach((i=>i(t,e)))}},n=()=>t,r={setState:s,getState:n,subscribe:(e,s,r)=>s||r?((e,s=n,r=Object.is)=>{console.warn("[DEPRECATED] Please use `subscribeWithSelector` middleware");let a=s(t);function o(){const i=s(t);if(!r(a,i)){const t=a;e(a=i,t)}}return i.add(o),()=>i.delete(o)})(e,s,r):(i.add(e),()=>i.delete(e)),destroy:()=>i.clear()};return t=e(s,n,r),r}const r="undefined"===typeof window||!window.navigator||/ServerSideRendering|^Deno\//.test(window.navigator.userAgent)?s.useEffect:s.useLayoutEffect;function a(e){const t="function"===typeof e?n(e):e,i=(e=t.getState,i=Object.is)=>{const[,n]=(0,s.useReducer)((e=>e+1),0),a=t.getState(),o=(0,s.useRef)(a),l=(0,s.useRef)(e),d=(0,s.useRef)(i),c=(0,s.useRef)(!1),u=(0,s.useRef)();let h;void 0===u.current&&(u.current=e(a));let p=!1;(o.current!==a||l.current!==e||d.current!==i||c.current)&&(h=e(a),p=!i(u.current,h)),r((()=>{p&&(u.current=h),o.current=a,l.current=e,d.current=i,c.current=!1}));const v=(0,s.useRef)(a);r((()=>{const e=()=>{try{const e=t.getState(),i=l.current(e);d.current(u.current,i)||(o.current=e,u.current=i,n())}catch(e){c.current=!0,n()}},i=t.subscribe(e);return t.getState()!==v.current&&e(),i}),[]);const g=p?h:u.current;return(0,s.useDebugValue)(g),g};return Object.assign(i,t),i[Symbol.iterator]=function(){console.warn("[useStore, api] = create() is deprecated and will be removed in v4");const e=[i,t];return{next(){const t=e.length<=0;return{value:e.shift(),done:t}}}},i}var o=i(84895);function l(e,t){if(Object.is(e,t))return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;const i=Object.keys(e);if(i.length!==Object.keys(t).length)return!1;for(let s=0;s<i.length;s++)if(!Object.prototype.hasOwnProperty.call(t,i[s])||!Object.is(e[i[s]],t[i[s]]))return!1;return!0}var d=i(13273);const c="It seems like you forgot to add your component within a top level HMSRoomProvider, please refer to 100ms react docs(https://www.100ms.live/docs/javascript/v2/how-to-guides/install-the-sdk/integration#react-hooks) to check on the required steps for using this hook. If the provider is present\n  at the top level, check the yarn.lock/package-lock.json, if there are multiple versions of @100mslive/react-sdk. Please ensure the versions of @100mslive/react-sdk and @100mslive/roomkit-react are the same versions from the release notes(https://www.100ms.live/docs/javascript/v2/changelog/release-notes) that you are trying to update to.";const u="undefined"!=typeof window,h=(0,s.createContext)(null),p=({children:e,actions:t,store:i,notifications:n,stats:r,isHMSStatsOn:l=!1,leaveOnUnload:d=!0})=>{const c=(0,s.useMemo)((()=>{let e;const d=()=>{throw new Error("modifying store is not allowed")};if(t&&i)e={actions:t,store:a(Object.assign(Object.assign({},i),{setState:d,destroy:d}))},n&&(e.notifications=n),r&&(e.statsStore=a({getState:r.getState,subscribe:r.subscribe,setState:d,destroy:d}));else{const t=new o.pE;if(e={actions:t.getActions(),store:a(Object.assign(Object.assign({},t.getStore()),{setState:d,destroy:d})),notifications:t.getNotifications()},l){const i=t.getStats();e.statsStore=a({getState:i.getState,subscribe:i.subscribe,setState:d,destroy:d})}}return e.actions.setFrameworkInfo({type:"react-web",version:s.version,sdkVersion:"0.10.23"}),e}),[t,i,n,r,l]);return(0,s.useEffect)((()=>{if(u&&d){const e=()=>c.actions.leave();return window.addEventListener("unload",e),()=>{window.removeEventListener("unload",e)}}return()=>{}}),[d,c]),s.createElement(h.Provider,{value:c},e)},v=function(e){return(t,i=l)=>{t||d.Z.w("fetching full store without passing any selector may have a heavy performance impact on your website.");const n=(0,s.useContext)(e);if(!n)throw new Error(c);return(0,n.store)(t,i)}}(h),g=(function(e){}(h),()=>{const e=(0,s.useContext)(h);if(!e)throw new Error(c);return e.notifications}),m=()=>{const e=(0,s.useContext)(h);if(!e)throw new Error(c);return e.actions},f=e=>{const t=(0,s.useContext)(h),[i,n]=(0,s.useState)(null);if(!t)throw new Error(c);return(0,s.useEffect)((()=>{if(t.notifications)return t.notifications.onNotification((e=>{n(e)}),e)}),[t.notifications,e]),i}},13273:(e,t,i)=>{"use strict";var s,n;i.d(t,{Z:()=>a}),(n=s||(s={}))[n.VERBOSE=0]="VERBOSE",n[n.DEBUG=1]="DEBUG",n[n.INFO=2]="INFO",n[n.WARN=3]="WARN",n[n.ERROR=4]="ERROR",n[n.NONE=5]="NONE";class r{static v(e,...t){this.log(s.VERBOSE,e,...t)}static d(e,...t){this.log(s.DEBUG,e,...t)}static i(e,...t){this.log(s.INFO,e,...t)}static w(e,...t){this.log(s.WARN,e,...t)}static e(e,...t){this.log(s.ERROR,e,...t)}static log(e,t,...i){if(!(this.level.valueOf()>e.valueOf()))switch(e){case s.VERBOSE:console.log("HMSui-components: ",t,...i);break;case s.DEBUG:console.debug("HMSui-components: ",t,...i);break;case s.INFO:console.info("HMSui-components: ",t,...i);break;case s.WARN:console.warn("HMSui-components: ",t,...i);break;case s.ERROR:console.error("HMSui-components: ",t,...i)}}}r.level=s.VERBOSE;var a=r}}]);
//# sourceMappingURL=/packs/js/3739-df4e55d0430845d2ea7b.js.map